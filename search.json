[{"title":"alertmanager","url":"/2025/04/27/alertmanager/","content":"å®‰è£…curl -SL https://github.com/docker/compose/releases/download/v2.30.3/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose#å°†å¯æ‰§è¡Œæƒé™èµ‹äºˆå®‰è£…ç›®æ ‡è·¯å¾„ä¸­çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶sudo chmod +x /usr/local/bin/docker-composesudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-composeversion: &#x27;3&#x27;services:  alertmanager:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/alertmanager:v0.28.1    ports:      - &quot;9093:9093&quot;      - &quot;9094:9094&quot;    volumes:      - ./config:/etc/alertmanager      - alertmanager_data:/alertmanager    command:      - &#x27;--config.file=/etc/alertmanager/alertmanager.yml&#x27;      - &#x27;--storage.path=/alertmanager&#x27;      - &#x27;--cluster.advertise-address=alertmanager:9094&#x27;    networks:      - monitoring-netvolumes:  alertmanager_data:networks:  monitoring-net:    driver: bridge\né…ç½®æ–‡ä»¶è§£è¯»global: # å³ä¸ºå…¨å±€è®¾ç½®,åœ¨Alertmanageré…ç½®æ–‡ä»¶ä¸­,åªè¦å…¨å±€è®¾ç½®é…ç½®äº†çš„é€‰é¡¹,å…¨éƒ¨ä¸ºå…¬å…±è®¾ç½®,å¯ä»¥è®©å…¶ä»–è®¾ç½®ç»§æ‰¿,ä½œä¸ºé»˜è®¤å€¼,å¯ä»¥å­å‚æ•°ä¸­è¦†ç›–å…¶è®¾ç½®ã€‚  resolve_timeout: 1m # ç”¨äºè®¾ç½®å¤„ç†è¶…æ—¶æ—¶é—´,ä¹Ÿæ˜¯ç”Ÿå‘½è­¦æŠ¥çŠ¶æ€ä¸ºè§£å†³çš„æ—¶é—´,è¿™ä¸ªæ—¶é—´ä¼šç›´æ¥å½±å“åˆ°è­¦æŠ¥æ¢å¤çš„é€šçŸ¥æ—¶é—´,éœ€è¦è‡ªè¡Œç»“åˆå®é™…ç”Ÿäº§åœºæ™¯æ¥è®¾ç½®ä¸»æœºçš„æ¢å¤æ—¶é—´,é»˜è®¤æ˜¯5åˆ†é’Ÿã€‚  # æ•´åˆé‚®ä»¶  smtp_smarthost: &#x27;smtp.qq.com:465&#x27; # é‚®ç®±smtpæœåŠ¡å™¨  smtp_from: &#x27;1451578387@qq.com&#x27; # å‘ä»¶ç”¨çš„é‚®ç®±åœ°å€  smtp_auth_username: &#x27;1451578387@qq.com&#x27; # å‘ä»¶äººè´¦å·  smtp_auth_password: &#x27;dkuuifhdskaduasdsb&#x27; # å‘ä»¶äººé‚®ç®±å¯†ç   smtp_require_tls: false # ä¸è¿›è¡ŒtlséªŒè¯route: # è·¯ç”±åˆ†ç»„  group_by: [&#x27;alertname&#x27;] # æŠ¥è­¦åˆ†ç»„  group_wait: 10s # ç»„å†…ç­‰å¾…æ—¶é—´,åŒä¸€åˆ†ç»„å†…æ”¶åˆ°ç¬¬ä¸€ä¸ªå‘Šè­¦ç­‰å¾…å¤šä¹…å¼€å§‹å‘é€,ç›®æ ‡æ˜¯ä¸ºäº†åŒç»„æ¶ˆæ¯åŒæ—¶å‘é€,ä¸å ç”¨å‘Šè­¦ä¿¡æ¯,é»˜è®¤30sã€‚  group_interval: 10s # å½“ç»„å†…å·²ç»å‘é€è¿‡ä¸€ä¸ªå‘Šè­¦,ç»„å†…è‹¥æœ‰æ–°å¢å‘Šè­¦éœ€è¦ç­‰å¾…çš„æ—¶é—´,é»˜è®¤ä¸º5m,è¿™æ¡è¦ç¡®å®šç»„å†…ä¿¡æ¯æ˜¯å½±å“åŒä¸€ä¸šåŠ¡æ‰èƒ½è®¾ç½®,è‹¥åˆ†ç»„ä¸åˆç†,å¯èƒ½å¯¼è‡´å‘Šè­¦å»¶è¿Ÿ,é€ æˆå½±å“ã€‚  repeat_interval: 1h # å‘Šè­¦å·²ç»å‘é€,ä¸”æ— æ–°å¢å‘Šè­¦,è‹¥é‡å¤å‘Šè­¦éœ€è¦é—´éš”å¤šä¹…,é»˜è®¤4h,å±äºé‡å¤å‘Šè­¦,æ—¶é—´é—´éš”åº”æ ¹æ®å‘Šè­¦çš„ä¸¥é‡ç¨‹åº¦æ¥è®¾ç½®ã€‚  receiver: &#x27;webhook&#x27; # å‘Šè­¦çš„æ¥æ”¶è€…,éœ€è¦å’Œ receivers[n].name çš„å€¼ä¸€è‡´ã€‚  # ä¸Šé¢æ‰€æœ‰çš„å±æ€§éƒ½ç”±æ‰€æœ‰å­è·¯ç”±ç»§æ‰¿,å¹¶ä¸”å¯ä»¥åœ¨æ¯ä¸ªå­è·¯ç”±ä¸Šè¿›è¡Œè¦†ç›–ã€‚  # å½“æŠ¥è­¦ä¿¡æ¯ä¸­æ ‡ç­¾åŒ¹é…åˆ°team:nodeæ—¶ä¼šä½¿ç”¨emailå‘é€æŠ¥è­¦,å¦åˆ™ä½¿ç”¨webhookã€‚ templates:- &#x27;/etc/alertmanager/config/*.tmpl&#x27;# routeæ ¹è·¯ç”±,è¯¥æ¨¡å—ç”¨äºè¯¥æ ¹è·¯ç”±ä¸‹çš„èŠ‚ç‚¹åŠå­è·¯ç”±routesçš„å®šä¹‰,å­æ ‘èŠ‚ç‚¹å¦‚æœä¸å¯¹ç›¸å…³é…ç½®è¿›è¡Œé…ç½®,åˆ™é»˜è®¤ä¼šä»çˆ¶è·¯ç”±æ ‘ç»§æ‰¿è¯¥é…ç½®é€‰é¡¹ã€‚æ¯ä¸€æ¡å‘Šè­¦éƒ½è¦è¿›å…¥route,å³è¦æ±‚é…ç½®é€‰é¡¹group_byçš„å€¼èƒ½å¤ŸåŒ¹é…åˆ°æ¯ä¸€æ¡å‘Šè­¦çš„è‡³å°‘ä¸€ä¸ªlabelkey(å³é€šè¿‡POSTè¯·æ±‚å‘altermanageræœåŠ¡æ¥å£æ‰€å‘é€å‘Šè­¦çš„labelsé¡¹æ‰€æºå¸¦çš„&lt;labelname&gt;),å‘Šè­¦è¿›å…¥åˆ°routeå,å°†ä¼šæ ¹æ®å­è·¯ç”±routesèŠ‚ç‚¹ä¸­çš„é…ç½®é¡¹match_reæˆ–è€…matchæ¥ç¡®å®šèƒ½è¿›å…¥è¯¥å­è·¯ç”±èŠ‚ç‚¹çš„å‘Šè­¦(ç”±åœ¨match_reæˆ–è€…matchä¸‹é…ç½®çš„labelkey:labelvalueæ˜¯å¦ä¸ºå‘Šè­¦labelsçš„å­é›†å†³å®š,æ˜¯çš„è¯åˆ™ä¼šè¿›å…¥è¯¥å­è·¯ç”±èŠ‚ç‚¹,å¦åˆ™ä¸èƒ½æ¥æ”¶è¿›å…¥è¯¥å­è·¯ç”±èŠ‚ç‚¹)ã€‚route:  # ä¾‹å¦‚æ‰€æœ‰labelkey:labelvalueå«cluster=AåŠaltertname=LatencyHighçš„labelkeyçš„å‘Šè­¦éƒ½ä¼šè¢«å½’å…¥å•ä¸€ç»„ä¸­  group_by: [&#x27;job&#x27;, &#x27;altername&#x27;, &#x27;cluster&#x27;, &#x27;service&#x27;,&#x27;severity&#x27;]  # è‹¥ä¸€ç»„æ–°çš„å‘Šè­¦äº§ç”Ÿ,åˆ™ä¼šç­‰group_waitåå†å‘é€é€šçŸ¥,è¯¥åŠŸèƒ½ä¸»è¦ç”¨äºå½“å‘Šè­¦åœ¨å¾ˆçŸ­æ—¶é—´å†…æ¥è¿äº§ç”Ÿæ—¶,åœ¨group_waitå†…åˆå¹¶ä¸ºå•ä¸€çš„å‘Šè­¦åå†å‘é€  group_wait: 30s  # å†æ¬¡å‘Šè­¦æ—¶é—´é—´éš”  group_interval: 5m  # å¦‚æœä¸€æ¡å‘Šè­¦é€šçŸ¥å·²æˆåŠŸå‘é€,ä¸”åœ¨é—´éš”repeat_intervalå,è¯¥å‘Šè­¦ä»ç„¶æœªè¢«è®¾ç½®ä¸ºresolved,åˆ™ä¼šå†æ¬¡å‘é€è¯¥å‘Šè­¦é€šçŸ¥  repeat_interval: 12h  # é»˜è®¤å‘Šè­¦é€šçŸ¥æ¥æ”¶è€…,å‡¡æœªè¢«åŒ¹é…è¿›å…¥å„å­è·¯ç”±èŠ‚ç‚¹çš„å‘Šè­¦å‡è¢«å‘é€åˆ°æ­¤æ¥æ”¶è€…  receiver: &#x27;wechat&#x27;  # ä¸Šè¿°routeçš„é…ç½®ä¼šè¢«ä¼ é€’ç»™å­è·¯ç”±èŠ‚ç‚¹,å­è·¯ç”±èŠ‚ç‚¹è¿›è¡Œé‡æ–°é…ç½®æ‰ä¼šè¢«è¦†ç›–  # å­è·¯ç”±æ ‘  routes:  # è¯¥é…ç½®é€‰é¡¹ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…å‘Šè­¦çš„labels,ä»¥ç¡®å®šèƒ½å¦è¿›å…¥è¯¥å­è·¯ç”±æ ‘  # match_reå’Œmatchå‡ç”¨äºåŒ¹é…labelkeyä¸ºservice,labelvalueåˆ†åˆ«ä¸ºæŒ‡å®šå€¼çš„å‘Šè­¦,è¢«åŒ¹é…åˆ°çš„å‘Šè­¦ä¼šå°†é€šçŸ¥å‘é€åˆ°å¯¹åº”çš„receiver  - match_re:      service: ^(foo1|foo2|baz)$    receiver: &#x27;wechat&#x27;    # åœ¨å¸¦æœ‰serviceæ ‡ç­¾çš„å‘Šè­¦åŒæ—¶æœ‰severityæ ‡ç­¾æ—¶,ä»–å¯ä»¥æœ‰è‡ªå·±çš„å­è·¯ç”±,åŒæ—¶å…·æœ‰severity != criticalçš„å‘Šè­¦åˆ™è¢«å‘é€ç»™æ¥æ”¶è€…team-ops-mails,å¯¹severity == criticalçš„å‘Šè­¦åˆ™è¢«å‘é€åˆ°å¯¹åº”çš„æ¥æ”¶è€…å³team-ops-pager    routes:    - match:        severity: critical      receiver: &#x27;wechat&#x27;  # æ¯”å¦‚å…³äºæ•°æ®åº“æœåŠ¡çš„å‘Šè­¦,å¦‚æœå­è·¯ç”±æ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”çš„owneræ ‡ç­¾,åˆ™éƒ½é»˜è®¤ç”±team-DB-pageræ¥æ”¶  - match:      service: database    receiver: &#x27;wechat&#x27;  # æˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆæ ¹æ®æ ‡ç­¾service:databaseå°†æ•°æ®åº“æœåŠ¡å‘Šè­¦è¿‡æ»¤å‡ºæ¥,ç„¶åè¿›ä¸€æ­¥å°†æ‰€æœ‰åŒæ—¶å¸¦labelkeyä¸ºdatabase  - match:      severity: critical    receiver: &#x27;wechat&#x27;# æŠ‘åˆ¶è§„åˆ™,å½“å‡ºç°critical(å…³é”®çš„)å‘Šè­¦æ—¶å¿½ç•¥warningã€‚# ä¸‹é¢çš„è¿™æ®µé…ç½®æ˜¯æŒ‡å¦‚æœå‡ºç°æ ‡ç­¾ä¸ºseverity=criticalçš„å‘Šè­¦,åˆ™æŠ‘åˆ¶severity=warningçš„å‘Šè­¦inhibit_rules:- source_match:    severity: &#x27;critical&#x27;  target_match:    severity: &#x27;warning&#x27;  # å¦‚æœè­¦æŠ¥åç§°ç›¸åŒ,åˆ™åº”ç”¨æŠ‘åˆ¶ã€‚  # alertnameã€clusterå’Œserviceå¯¹åº”çš„æ ‡ç­¾å€¼éœ€è¦ç›¸ç­‰  equal: [&#x27;alertname&#x27;, &#x27;cluster&#x27;, &#x27;service&#x27;]# æ”¶ä»¶äººé…ç½®receivers:- name: &#x27;team-ops-mails&#x27;  email_configs:  - to: &#x27;dukuan@xxx.com&#x27;- name: &#x27;team-X-pager&#x27;  email_configs:  - to: &#x27;team-X+alerts-critical@example.org&#x27;  pagerduty_configs:  - service_key: &lt;team-X-key&gt;- name: &#x27;team-Y-mails&#x27;  email_configs:  - to: &#x27;team-Y+alerts@example.org&#x27;- name: &#x27;webhook&#x27;  webhook_configs:  - url: http://127.0.0.1:8060/dingtalk/webhook1/send    send_resolved: true\nåˆ†ç»„å’Œè·¯ç”±\n\nè·¯ç”±matchï¼ˆç²¾ç¡®åŒ¹é…ï¼‰match_reï¼ˆæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼‰æ¯ä¸€ä¸ªå‘Šè­¦éƒ½ä¼šä»é…ç½®æ–‡ä»¶ä¸­é¡¶çº§çš„routeè¿›å…¥è·¯ç”±æ ‘ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é¡¶çº§çš„routeå¿…é¡»åŒ¹é…æ‰€æœ‰å‘Šè­¦(å³ä¸èƒ½æœ‰ä»»ä½•çš„åŒ¹é…è®¾ç½®matchå’Œmatch_re)ï¼Œæ¯ä¸€ä¸ªè·¯ç”±éƒ½å¯ä»¥å®šä¹‰è‡ªå·±çš„æ¥å—äººä»¥åŠåŒ¹é…è§„åˆ™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘Šè­¦è¿›å…¥åˆ°é¡¶çº§routeåä¼šéå†æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°æœ€æ·±çš„åŒ¹é…routeï¼Œå¹¶å°†å‘Šè­¦å‘é€åˆ°è¯¥routeå®šä¹‰çš„receiverä¸­ã€‚ä½†å¦‚æœrouteä¸­è®¾ç½®continueçš„å€¼ä¸ºfalseï¼Œé‚£ä¹ˆå‘Šè­¦åœ¨åŒ¹é…åˆ°ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ä¹‹åå°±ç›´æ¥åœæ­¢ã€‚å¦‚æœcontinueä¸ºtrueï¼ŒæŠ¥è­¦åˆ™ä¼šç»§ç»­è¿›è¡Œåç»­å­èŠ‚ç‚¹çš„åŒ¹é…ã€‚å¦‚æœå½“å‰å‘Šè­¦åŒ¹é…ä¸åˆ°ä»»ä½•çš„å­èŠ‚ç‚¹ï¼Œé‚£è¯¥å‘Šè­¦å°†ä¼šåŸºäºå½“å‰è·¯ç”±èŠ‚ç‚¹çš„æ¥æ”¶å™¨é…ç½®æ–¹å¼è¿›è¡Œå¤„ç†\nåˆ†ç»„å‘Šè­¦é€šçŸ¥è¿›è¡Œåˆ†ç»„ï¼Œå°†å¤šæ¡å‘Šè­¦åˆåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨group_byæ¥å®šä¹‰åˆ†ç»„è§„åˆ™ã€‚åŸºäºå‘Šè­¦ä¸­åŒ…å«çš„æ ‡ç­¾ï¼Œå¦‚æœæ»¡è¶³group_byä¸­å®šä¹‰æ ‡ç­¾åç§°ï¼Œé‚£ä¹ˆè¿™äº›å‘Šè­¦å°†ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€ç»™æ¥æ”¶å™¨ã€‚æœ‰çš„æ—¶å€™ä¸ºäº†èƒ½å¤Ÿä¸€æ¬¡æ€§æ”¶é›†å’Œå‘é€æ›´å¤šçš„ç›¸å…³ä¿¡æ¯æ—¶ï¼Œå¯ä»¥é€šè¿‡group_waitå‚æ•°è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨ç­‰å¾…æ—¶é—´å†…å½“å‰groupæ¥æ”¶åˆ°äº†æ–°çš„å‘Šè­¦ï¼Œè¿™äº›å‘Šè­¦å°†ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘receiverå‘é€\n\n\nroute:  group_by: [&#x27;alertname&#x27;,&#x27;team&#x27;]   #åœ¨è¿™é‡Œæ·»åŠ teamåŒ¹é…çš„æ ‡ç­¾  group_wait: 5s  group_interval: 5s  repeat_interval: 5m  # é»˜è®¤å‘ç»™&quot;sre_system&quot;ç»„ç”¨æˆ·  receiver: &#x27;sre_system&#x27;  continue: false  # é…ç½®å­è·¯ç”±  routes:    - receiver: &#x27;sre_dba&#x27;      match_re:        job: test      # å»ºè®®å°†continueçš„å€¼è®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºå½“å‰çš„æ¡ä»¶æ˜¯å¦åŒ¹é…ï¼Œéƒ½å°†ç»§ç»­å‘ä¸‹åŒ¹é…è§„åˆ™      # è¿™æ ·åšçš„ç›®çš„æ˜¯å°†æ¶ˆæ¯å‘ç»™æœ€åçš„ç³»ç»Ÿç»„(sre_system)      continue: true==================================================================#rule.yml- name: grafana  rules:  - alert: node           #è¿™ä¸ªç›¸å½“äºalertnameçš„å€¼,ä¸ä¹‹å‰åŒ¹é…çš„ç›¸åŒ    expr: up&#123;job=&quot;grafana&quot;&#125; == 0    for: 10s                      labels:                         severity: 1       job: test  # å¯¹åº”ä¸Šé¢çš„ match_re      team: grafana        #è¿™é‡Œæ ‡ç­¾è®¾ç½®ä¸åŒçš„ä¸€ä¼šç”¨    annotations:                    summary: &quot;&#123;&#123; \\$labels.instance &#125;&#125; å·²åœæ­¢è¿è¡Œè¶…è¿‡ 15s&quot;      description: hello world alertname ç­‰äº node å¦‚æœç›¸åŒæŠ¥è­¦ä¼šä¸€èµ·å‘é€team ç­‰äº grafana \næŠ‘åˆ¶è§„åˆ™inhibit_rules:  - source_match:      severity: &#x27;å‘Šè­¦&#x27;    target_match:      severity: &#x27;æç¤º&#x27;    #equal: [&#x27;type&#x27;,&#x27;test&#x27;] è¦æ±‚ type å’Œ testç­¾å‡ç›¸åŒ     equal: [&#x27;type&#x27;]typeçš„å€¼å¿…é¡»ä¸€æ ·å½“åŒ¹é…åˆ° å‘Šè­¦ æ—¶å°±ä¼šæŠ‘åˆ¶æç¤ºçš„å‘Šè­¦é€šçŸ¥å¹¶æ£€æŸ¥ä»–ä»¬æ˜¯å¦æ¥è‡ªäºåŒä¸ªsslï¼ˆå³sslæ ‡ç­¾çš„å€¼ç›¸åŒæŠ‘åˆ¶æ‰ä¼šç”Ÿæ•ˆï¼‰å½“å­è·¯ç”±åŒ¹é…åˆ°ä¸åŒçš„ severity æ—¶å°±ä¼šå°†æ¶ˆæ¯å‘å¾€ä¸åŒçš„ receiverï¼Œå½“å­è·¯ç”±æ— æ³•åŒ¹é…åˆ°æ—¶ï¼Œæ¶ˆæ¯ä¼šé»˜è®¤å‘å¾€æ ¹è·¯ç”±çš„ receiverï¼Œå› æ­¤ï¼Œæ— è®ºæ˜¯å¦åŒ¹é…åˆ°å­è·¯ç”±è§„åˆ™ï¼Œæ¶ˆæ¯éƒ½ä¼šå‘å¾€æ ¹è·¯ç”±çš„ receiverå¯¹åº”æŠ¥è­¦è§„åˆ™é…ç½®ä¸ºgroups:- name: node-alerts  rules:  - alert: HighNodeCPU    expr: (1 - avg(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance)) * 100 &gt; 80    for: 5m    labels:      severity: &quot;å‘Šè­¦&quot;      type: ssl    annotations:      summary: &quot;é«˜èŠ‚ç‚¹CPUä½¿ç”¨ç‡ (&#123;&#123; $labels.instance &#125;&#125;)&quot;      description: &quot;èŠ‚ç‚¹ &#123;&#123; $labels.instance &#125;&#125; CPU ä½¿ç”¨ç‡è¶…è¿‡ 80% å·²æŒç»­ 5 åˆ†é’Ÿ&quot;- name: cluster-alerts  rules:  - alert: ClusterWideCPUProblem    expr: |      sum( (1 - avg(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance)) * 100 &gt; 80 )      /      count( (1 - avg(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance)) )      * 100 &gt; 50    for: 10m    labels:      severity: &quot;æç¤º&quot;      type: ssl    annotations:      summary: &quot;é›†ç¾¤çº§CPUé—®é¢˜&quot;      description: &quot;è¶…è¿‡ 50% çš„èŠ‚ç‚¹æŒç»­é«˜CPUä½¿ç”¨ç‡è¾¾ 10 åˆ†é’Ÿ&quot;\n\nalertmanageré›†æˆä¸‰æ–¹å‘Šè­¦\nåŸç”Ÿalertmanageråªæœ‰é‚®ä»¶å’Œwebhookå‘Šè­¦ï¼›Alertmanager çš„åŸç”Ÿ Webhook å‘Šè­¦æ˜¯ä¸€ç§é€šè¿‡ HTTP POST è¯·æ±‚å°†å‘Šè­¦ä¿¡æ¯å‘é€åˆ°è‡ªå®šä¹‰æ¥å£ï¼ˆWebhook æ¥æ”¶ç«¯ï¼‰çš„æœºåˆ¶ï¼›æ‰€ä»¥è¦å¯¹æ¥éœ€è¦å¼€å‘è€…è‡ªè¡Œå¼€å‘ï¼Œè¿™é‡Œæ¨èä¸¤ä¸ªç°æˆçš„å·¥å…·æ¥å¯¹æ¥\n\nPrometheusAlertä½¿ç”¨\nPrometheus Alert æ˜¯å¼€æºçš„è¿ç»´å‘Šè­¦ä¸­å¿ƒæ¶ˆæ¯è½¬å‘ç³»ç»Ÿï¼Œæ”¯æŒä¸»æµçš„ç›‘æ§ç³»ç»Ÿ Prometheusï¼Œæ—¥å¿—ç³»ç»Ÿ Graylog å’Œæ•°æ®å¯è§†åŒ–ç³»ç»Ÿ Grafana å‘å‡ºçš„é¢„è­¦æ¶ˆæ¯ã€‚é€šçŸ¥æ¸ é“æ”¯æŒé’‰é’‰ã€å¾®ä¿¡ã€åä¸ºäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡ã€è…¾è®¯äº‘ç”µè¯ã€é˜¿é‡Œäº‘çŸ­ä¿¡ã€é˜¿é‡Œäº‘ç”µè¯ç­‰ç­‰\n\nwget https://github.com/feiyu563/PrometheusAlert/releases/download/v4.8.1/linux.zipchmod +x PrometheusAlertå¯åŠ¨ nohup ./PrometheusAlert &amp; åå°è¿è¡Œ#alertmanager.ymlé…ç½®é›†æˆPrometheusAlertï¼›æ ¼å¼å¯ä»¥ç™»å½•PrometheusAlertæŸ¥çœ‹receivers:- name: &#x27;web.hook.prometheusalert&#x27;  webhook_configs:  - url: &#x27;http://192.168.197.142:8080/prometheusalert?type=wx&amp;tpl=prometheus-wx&amp;wxurl=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=53fdb356-4446-42e5-b8bd-f7da63bcfe76&#x27;\n\nprometheus-webhook-dingtalkä½¿ç”¨\nPrometheus çš„Alertmanagerè‡ªèº«ä¸æ”¯æŒé’‰é’‰æŠ¥è­¦ï¼Œéœ€è¦é€šè¿‡æ’ä»¶çš„æ–¹å¼æ¥è¾¾åˆ°æŠ¥è­¦æ¡ä»¶\n\nå®‰è£…wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gztar zxf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz mv prometheus-webhook-dingtalk-2.1.0.linux-amd64 /usr/local/prometheus-webhook-dingtalkcat &gt; /usr/lib/systemd/system/webhook-dingtalk.service &lt;&lt; EOF[Unit]Description=prometheus-webhook-dingtalkDocumentation=https://github.com/timonwong/prometheus-webhook-dingtalkAfter=network.target[Service]User=rootGroup=rootExecStart=/usr/local/prometheus-webhook-dingtalk/prometheus-webhook-dingtalk  --config.file=/usr/local/prometheus-webhook-dingtalk/config.ymlExecReload=/bin/kill -HUP $MAINPIDKillMode=processRestart=on-failure[Install]WantedBy=multi-user.targetEOF#é›†æˆæ¨¡ç‰ˆ/usr/local/prometheus-webhook-dingtalk/config.ymltemplates:    - /usr/local/prometheus/webhook-dingtalk/template.tmpltargets:  webhook1:    url: https://oapi.dingtalk.com/robot/send?access_token=9ac4354ab7c8#alertmanageré…ç½®å‘é€ç»™dingtalkæ’ä»¶receivers:  - name: &#x27;email&#x27;    email_configs:      - to: &#x27;xxxxx@163.com&#x27; #æŒ‡å®šå‘é€ç»™è°  - name: &#x27;webhook1&#x27;    webhook_configs:      - send_resolved: false        url: http://localhost:8060/dingtalk/webhook1/send\n\næŠ¥è­¦å†…å®¹æ¨¡ç‰ˆvim /usr/local/prometheus/webhook-dingtalk/template.tmpl&#123;&#123; define &quot;__subject&quot; &#125;&#125;[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status &quot;firing&quot; &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;]&#123;&#123; end &#125;&#125;  &#123;&#123; define &quot;__alert_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;---&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125; **å‘Šè­¦ä¸»é¢˜**: &#123;&#123; .Annotations.summary &#125;&#125;**å‘Šè­¦ç±»å‹**: &#123;&#123; .Labels.alertname &#125;&#125; **å‘Šè­¦çº§åˆ«**: &#123;&#123; .Labels.severity &#125;&#125;  **å‘Šè­¦ä¸»æœº**: &#123;&#123; .Labels.instance &#125;&#125;  **å‘Šè­¦ä¿¡æ¯**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125; **å‘Šè­¦æ—¶é—´**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125; &#123;&#123; define &quot;__resolved_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;---&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;**å‘Šè­¦ä¸»é¢˜**: &#123;&#123; .Annotations.summary &#125;&#125;**å‘Šè­¦ç±»å‹**: &#123;&#123; .Labels.alertname &#125;&#125;  **å‘Šè­¦çº§åˆ«**: &#123;&#123; .Labels.severity &#125;&#125; **å‘Šè­¦ä¸»æœº**: &#123;&#123; .Labels.instance &#125;&#125; **å‘Šè­¦ä¿¡æ¯**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125; **å‘Šè­¦æ—¶é—´**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125; **æ¢å¤æ—¶é—´**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.EndsAt) &quot;Asia/Shanghai&quot; &#125;&#125;&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;  &#123;&#123; define &quot;default.title&quot; &#125;&#125;&#123;&#123; template &quot;__subject&quot; . &#125;&#125;&#123;&#123; end &#125;&#125; &#123;&#123; define &quot;default.content&quot; &#125;&#125;&#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;**====ä¾¦æµ‹åˆ°&#123;&#123; .Alerts.Firing | len  &#125;&#125;ä¸ªæ•…éšœ====**&#123;&#123; template &quot;__alert_list&quot; .Alerts.Firing &#125;&#125;---&#123;&#123; end &#125;&#125; &#123;&#123; if gt (len .Alerts.Resolved) 0 &#125;&#125;**====æ¢å¤&#123;&#123; .Alerts.Resolved | len  &#125;&#125;ä¸ªæ•…éšœ====**&#123;&#123; template &quot;__resolved_list&quot; .Alerts.Resolved &#125;&#125;&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;  &#123;&#123; define &quot;ding.link.title&quot; &#125;&#125;&#123;&#123; template &quot;default.title&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;&#123;&#123; define &quot;ding.link.content&quot; &#125;&#125;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;&#123;&#123; template &quot;default.title&quot; . &#125;&#125;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;\næŠ¥è­¦è§„åˆ™ç¤ºä¾‹mkdir /usr/local/prometheus/prometheus/rulevim /usr/local/prometheus/prometheus/rule/node_exporter.ymlgroups:- name: æœåŠ¡å™¨èµ„æºç›‘æ§  rules:  - alert: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜    expr: 100 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 80    for: 3m     labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜, è¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123; $labels.instance &#125;&#125;å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%,å½“å‰ä½¿ç”¨ç‡&#123;&#123; $value &#125;&#125;%.&quot;            - alert: æœåŠ¡å™¨å®•æœº    expr: up == 0    for: 1s    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.instance&#125;&#125; æœåŠ¡å™¨å®•æœº, è¯·å°½å¿«å¤„ç†!&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; æœåŠ¡å™¨å»¶æ—¶è¶…è¿‡3åˆ†é’Ÿ,å½“å‰çŠ¶æ€&#123;&#123; $value &#125;&#125;. &quot;   - alert: CPUé«˜è´Ÿè·    expr: 100 - (avg by (instance,job)(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) * 100) &gt; 90    for: 5m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.instance&#125;&#125; CPUä½¿ç”¨ç‡è¿‡é«˜,è¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; CPUä½¿ç”¨å¤§äº90%,å½“å‰ä½¿ç”¨ç‡&#123;&#123; $value &#125;&#125;%. &quot;        - alert: ç£ç›˜IOæ€§èƒ½    expr: avg(irate(node_disk_io_time_seconds_total[1m])) by(instance,job)* 100 &gt; 90    for: 5m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå…¥ç£ç›˜IOä½¿ç”¨ç‡è¿‡é«˜,è¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå…¥ç£ç›˜IOå¤§äº90%,å½“å‰ä½¿ç”¨ç‡&#123;&#123; $value &#125;&#125;%.&quot;    - alert: ç½‘ç»œæµå…¥    expr: ((sum(rate (node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance,job)) / 100) &gt; 102400    for: 5m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå…¥ç½‘ç»œå¸¦å®½è¿‡é«˜ï¼Œè¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå…¥ç½‘ç»œå¸¦å®½æŒç»­5åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨é‡&#123;&#123;$value&#125;&#125;.&quot;   - alert: ç½‘ç»œæµå‡º    expr: ((sum(rate (node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance,job)) / 100) &gt; 102400    for: 5m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå‡ºç½‘ç»œå¸¦å®½è¿‡é«˜,è¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; æµå‡ºç½‘ç»œå¸¦å®½æŒç»­5åˆ†é’Ÿé«˜äº100M. RXå¸¦å®½ä½¿ç”¨é‡&#123;$value&#125;&#125;.&quot;    - alert: TCPè¿æ¥æ•°    expr: node_netstat_Tcp_CurrEstab &gt; 10000    for: 2m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot; TCP_ESTABLISHEDè¿‡é«˜ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; TCP_ESTABLISHEDå¤§äº100%,å½“å‰ä½¿ç”¨ç‡&#123;&#123; $value &#125;&#125;%.&quot;   - alert: ç£ç›˜å®¹é‡    expr: 100-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes &#123;fstype=~&quot;ext4|xfs&quot;&#125;*100) &gt; 90    for: 1m    labels:      severity: ä¸¥é‡å‘Šè­¦    annotations:      summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; ç£ç›˜åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼Œè¯·å°½å¿«å¤„ç†ï¼&quot;      description: &quot;&#123;&#123;$labels.instance&#125;&#125; ç£ç›˜åˆ†åŒºä½¿ç”¨å¤§äº90%ï¼Œå½“å‰ä½¿ç”¨ç‡&#123;&#123; $value &#125;&#125;%.&quot;\n","categories":["prometheus"]},{"title":"cosyvoice2","url":"/2025/09/23/cosyvoice2/","content":"CosyVoice å®‰è£…ä¸ä½¿ç”¨æŒ‡å—ç¯å¢ƒå‡†å¤‡1. å…‹éš†ä»£ç ä»“åº“git clone --recursive https://github.com/FunAudioLLM/CosyVoice.gitcd CosyVoice# è‹¥å­æ¨¡å—å…‹éš†å¤±è´¥ï¼Œé‡å¤æ‰§è¡Œç›´åˆ°æˆåŠŸgit submodule update --init --recursive\n\n2. å®‰è£…Minicondawget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.shbash Miniconda3-latest-Linux-x86_64.sh~/miniconda3/bin/conda init bashsource ~/.bashrc\n\n3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒconda create -n cosyvoice python=3.10conda activate cosyvoice\n\n4. å®‰è£…ç³»ç»Ÿä¾èµ–sudo yum install sox sox-develsudo yum groupinstall &quot;Development Tools&quot;sudo yum install python3-devel libsndfile-devel\n\nå®‰è£…ä¾èµ–# å¦‚æœä¸ä½¿ç”¨ttsfrd å°±å¿…é¡»ä¸‹è½½pyniniconda install -y -c conda-forge pynini==2.1.5pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host=mirrors.aliyun.com\n\næ¨¡å‹ä¸‹è½½mkdir pretrained_modelsmodelscope download --model=iic/CosyVoice-300M-SFT --local_dir pretrained_models/CosyVoice-300M-SFTmodelscope download --model=iic/CosyVoice-300M --local_dir pretrained_models/CosyVoice-300Mmodelscope download --model=iic/CosyVoice-300M-Instruct --local_dir pretrained_models/CosyVoice-300M-Instructmodelscope download --model=iic/CosyVoice-ttsfrd --local_dir pretrained_models/CosyVoice-ttsfrdcd pretrained_models/CosyVoice-ttsfrd/unzip resource.zip -d .pip install ttsfrd_dependency-0.1-py3-none-any.whl#å¯¹åº”python3.10ç‰ˆæœ¬pip install ttsfrd-0.4.2-cp310-cp310-linux_x86_64.whl\n\néªŒè¯å®‰è£…python -c &quot;import torch;print(torch.cuda.is_available())&quot;  # åº”è¾“å‡ºTrue\n\nåŠŸèƒ½éªŒè¯ç¤ºä¾‹é›¶æ ·æœ¬æ¨ç†æµ‹è¯•import timeimport torchaudio#from cosyvoice import CosyVoice2from cosyvoice.utils.file_utils import load_wavimport syssys.path.append(&#x27;third_party/Matcha-TTS&#x27;)from cosyvoice.cli.cosyvoice import CosyVoice, CosyVoice2# åˆå§‹åŒ–æ¨¡å‹cosyvoice = CosyVoice2(&#x27;/mnt/CosyVoice2-0.5B&#x27;, load_jit=False, load_trt=False, load_vllm=False, fp16=False)# å‡†å¤‡è¾“å…¥æ•°æ®prompt_speech_16k = load_wav(&#x27;./asset/zero_shot_prompt.wav&#x27;, 16000)text = &#x27;ä½ å¥½ã€‚&#x27;spk_text = &#x27;å¸Œæœ›ä½ ä»¥å&#x27;# å­˜å‚¨ TTFT ç»“æœttft_list = []# è¿è¡Œ10æ¬¡æ¨ç†for run in range(10):    start_time = time.time()  # è®°å½•å¼€å§‹æ—¶é—´    first_token_received = False    for i, j in enumerate(cosyvoice.inference_zero_shot(text, spk_text, prompt_speech_16k, stream=False)):        if not first_token_received:            ttft = (time.time() - start_time) * 1000  # å•ä½ï¼šæ¯«ç§’            print(f&quot;Run &#123;run+1&#125; TTFT: &#123;ttft:.2f&#125; ms&quot;)            ttft_list.append(ttft)            first_token_received = True        torchaudio.save(f&#x27;zero_shot_run&#123;run+1&#125;_&#123;i&#125;.wav&#x27;, j[&#x27;tts_speech&#x27;], cosyvoice.sample_rate)# è®¡ç®—å¹¶æ‰“å°å¹³å‡ TTFTaverage_ttft = sum(ttft_list) / len(ttft_list)print(f&quot;\\nAverage TTFT over 10 runs: &#123;average_ttft:.2f&#125; ms&quot;)\n\nè·¨è¯­è¨€æ¨ç†import syssys.path.append(&#x27;third_party/Matcha-TTS&#x27;)from cosyvoice.cli.cosyvoice import CosyVoice, CosyVoice2from cosyvoice.utils.file_utils import load_wavimport torchaudiocosyvoice = CosyVoice2(&#x27;/mnt/CosyVoice2-0.5B&#x27;, load_jit=False, load_trt=False, load_vllm=False, fp16=False)prompt_speech_16k = load_wav(&#x27;./asset/zero_shot_prompt.wav&#x27;, 16000)for i, j in enumerate(cosyvoice.inference_cross_lingual(&#x27;åœ¨ä»–è®²è¿°é‚£ä¸ªè’è¯æ•…äº‹çš„è¿‡ç¨‹ä¸­ï¼Œä»–çªç„¶[laughter]åœä¸‹æ¥ï¼Œå› ä¸ºä»–è‡ªå·±ä¹Ÿè¢«é€—ç¬‘äº†[laughter]ã€‚&#x27;, prompt_speech_16k, stream=False)):    torchaudio.save(&#x27;fine_grained_control_&#123;&#125;.wav&#x27;.format(i), j[&#x27;tts_speech&#x27;], cosyvoice.sample_rate)\n\néŸ³è‰²é€‰æ‹©ï¼ˆSFTæ¨¡å‹ï¼‰#å½“å‰æ”¯æŒçš„éŸ³è‰²åŒ…æ‹¬ï¼š[â€˜ä¸­æ–‡å¥³â€™, â€˜ä¸­æ–‡ç”·â€™, â€˜æ—¥è¯­ç”·â€™, â€˜ç²¤è¯­å¥³â€™, â€˜è‹±æ–‡å¥³â€™, â€˜è‹±æ–‡ç”·â€™, â€˜éŸ©è¯­å¥³â€™]import syssys.path.append(&#x27;third_party/Matcha-TTS&#x27;)from cosyvoice.cli.cosyvoice import CosyVoice, CosyVoice2from cosyvoice.utils.file_utils import load_wavimport torchaudiocosyvoice = CosyVoice(&#x27;pretrained_models/CosyVoice-300M-SFT&#x27;, load_jit=False, load_trt=False, fp16=False)# sft usageprint(cosyvoice.list_available_spks())# change stream=True for chunk stream inferencefor i, j in enumerate(cosyvoice.inference_sft(&#x27;ä½ å¥½ï¼Œæˆ‘æ˜¯é€šä¹‰ç”Ÿæˆå¼è¯­éŸ³å¤§æ¨¡å‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ&#x27;, &#x27;ä¸­æ–‡å¥³&#x27;, stream=False)):    torchaudio.save(&#x27;sft_&#123;&#125;.wav&#x27;.format(i), j[&#x27;tts_speech&#x27;], cosyvoice.sample_rate)\n\nWebç•Œé¢éƒ¨ç½²#å¿…é¡»ä½¿ç”¨CosyVoice-300M-SFTæ‰æœ‰éŸ³è‰²é€‰æ‹©å…¶ä»–çš„æ²¡æœ‰#éœ€è¦ä¸‹è½½ ffmpeg ä¸ç„¶æ— æ³•åˆæˆ# ä½¿ç”¨Dockerè¿è¡Œdocker run -it --gpus all  \\-v /mnt/CosyVoice-300M-SFT:/CosyVoice/pretrained_models/CosyVoice-300M-SFT \\--ipc=host --cap-add=SYS_PTRACE --network=host \\--name CosyVoice-web --privileged \\-d registry.cn-hangzhou.aliyuncs.com/lky-deploy/cosyvoice:v2-cu12-py3.10 \\/bin/bash -c &#x27;sleep inf&#x27;# å®‰è£…FFmpegconda install -c conda-forge ffmpeg=5.1.2pip install --force-reinstall pydub==0.25.1# å¯åŠ¨æœåŠ¡python webui.py --model_dir pretrained_models/CosyVoice-300M-SFT &amp;&gt; web.log &amp;\n\næ³¨æ„äº‹é¡¹\néŸ³è‰²é€‰æ‹©åŠŸèƒ½ä»…æ”¯æŒCosyVoice-300M-SFTæ¨¡å‹\nç¡®ä¿GPUå¯ç”¨ä¸”CUDAç¯å¢ƒæ­£ç¡®é…ç½®\né¦–æ¬¡è¿è¡Œéœ€ä¸‹è½½çº¦5GBçš„æ¨¡å‹æ–‡ä»¶\næ¨èä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿä¸‹è½½ï¼š-i https://mirrors.aliyun.com/pypi/simple/\n\nå‚è€ƒèµ„æº\nModelScope æ¨¡å‹æ–‡æ¡£\nGitHub é¡¹ç›®ä»“åº“\n\n","tags":["llm"]},{"title":"elastcisearch_dump","url":"/2025/08/12/elastcisearch-dump/","content":"esdumphttps://github.com/elasticsearch-dump/elasticsearch-dump\ndocker pull elasticdump/elasticsearch-dumporwget https://nodejs.org/dist/v16.18.0/node-v16.18.0-linux-x64.tar.xzexport PATH=$PATH:/root/node-v16.18.0-linux-x64/bin/npm install elasticdump -g#bashPREFIX=&quot;y-logs-&quot;curl -s &quot;http://localhost:9200/_cat/indices?h=index&quot; | grep &quot;^$&#123;PREFIX&#125;&quot; | while read -r INDEX_NAME; do#INDEX_NAME=&quot;y-logs-2025&quot;    for TYPE in &#123;settings,mapping,data&#125;;do        echo &quot;start $TYPE of index  [$INDEX_NAME]...&quot;        elasticdump  --input=http://localhost:9200/$INDEX_NAME     --output=http://username:passwd@dest_addr.com:9200/$INDEX_NAME     --type=$TYPE --limit 10000    done    echo &#x27;==============================================&#x27;    sleep 3done# --limit å¹¶å‘æ•°# --output=/data/es/$&#123;INDEX_NAME&#125;.json å¤‡ä»½å¯ä»¥ä¿å­˜åˆ°æ–‡ä»¶ # --httpAuthFileæŒ‡å®šHTTPè®¤è¯æ–‡ä»¶# --searchBody=&quot;&#123;\\&quot;query\\&quot;:&#123;\\&quot;term\\&quot;:&#123;\\&quot;username\\&quot;: \\&quot;admin\\&quot;&#125;&#125;&#125;&quot; è¿‡æ»¤\n\n\nsnapshot#è®¾ç½®fsç±»å‹ä»“åº“å­˜å‚¨è·¯å¾„ï¼›ç„¶åé‡å¯esexport path.repo=/usr/share/elasticsearch/data/es_snapshot#åˆ›å»ºä»“åº“curl -XPUT &#x27;http://localhost:9200/_snapshot/y_repo&#x27; \\  -H &#x27;Content-Type: application/json&#x27; \\  -d &#x27;&#123;    &quot;type&quot;: &quot;fs&quot;,    &quot;settings&quot;: &#123;      &quot;location&quot;: &quot;/usr/share/elasticsearch/data/es_snapshot&quot;,      &quot;compress&quot;: true    &#125;  &#125;&#x27;#locationå¿…é¡»å’Œpath.repoä¸€è‡´#æŸ¥çœ‹curl  -s localhost:9200/_snapshot/y_repo|jq#åˆ é™¤curl -XDELETE localhost:9200/_snapshot/y_repo=======================================================#åˆ›å»ºå¿«ç…§#ä¸æŒ‡å®šç´¢å¼•å°±æ˜¯å¿«ç…§æ‰€æœ‰curl -XPUT   localhost:9200/_snapshot/y_repo/snapshot_all  #?wait_for_completion=true #æŒ‡å®šç´¢å¼•å¿«ç…§curl -H &quot;Content-Type: application/json&quot; -XPUT localhost:9200/_snapshot/y_repo/snapshot_202508_01-02?pretty -d&#x27;&#123;&quot;indices&quot;: &quot;y-logs-2025.08.01,y-logs-2025.08.02&quot;&#125;&#x27;#æŸ¥çœ‹å¿«ç…§ä¿¡æ¯curl localhost:9200/_cat/snapshots/y_repo?vcurl localhost:9200/_cat/snapshots/_all?v#æŸ¥çœ‹å¿«ç…§åŒ…å«çš„ç´¢å¼•ä¿¡æ¯curl   -Ss localhost:9200/_snapshot/y_repo/_all|jqcurl   -Ss localhost:9200/_snapshot/y_repo/snapshot_202508_01-02|jqcurl   -Ss localhost:9200/_snapshot/y_repo/snapshot_202508_01-02/_status|jq=======================================================#æ¢å¤å¿«ç…§;ç›®æ ‡ç´¢å¼•åç§°å°½é‡ä¸è¦å­˜åœ¨åŒåcurl -X POST &quot;http://localhost:9200/_snapshot/y_repo/snapshot_all/_restore&quot; \\  -H &quot;Content-Type: application/json&quot; \\  -d &#x27;&#123;    &quot;indices&quot;: &quot;y-logs-2025.08.*&quot;,    &quot;rename_pattern&quot;: &quot;y-logs-2025.08.01&quot;,    &quot;rename_replacement&quot;: &quot;y_new_repo&quot;  &#125;&#x27;#indicesæŒ‡å®šæ¢å¤çš„ç´¢å¼•åç§°;éœ€è¦ç²¾ç¡®åŒ¹é…å¦‚æœèŒƒå›´è¾ƒå¤§ï¼Œrename_patternåŒ¹é…ä¸ä¸Šçš„ä¼šç›´æ¥åç§°ä¸å˜æ¢å¤#rename_pattern\tæ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…åŸå§‹ç´¢å¼•åç§°ä¸­çš„æ¨¡å¼ï¼ˆç”¨äºæ•è·éœ€è¦æ›¿æ¢çš„éƒ¨åˆ†ï¼‰#rename_replacement\tæ›¿æ¢åçš„æ–°ç´¢å¼•åç§°æ¨¡æ¿ï¼ˆä½¿ç”¨ $1ã€$2 ç­‰å¼•ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„æ•è·ç»„ï¼‰#ç¤ºä¾‹jsonå‚æ•°&#x27;&#123;  &quot;indices&quot;: &quot;y-logs-2025.08.01&quot;  // ä»…æ¢å¤è¯¥ç´¢å¼•ï¼Œåç§°ä¸å˜&#125;&#x27;&#x27;&#123;  &quot;indices&quot;: &quot;y-logs-2025.08.01&quot;,  &quot;rename_pattern&quot;: &quot;(.+)&quot;,          // åŒ¹é…æ•´ä¸ªåŸå§‹åç§°  &quot;rename_replacement&quot;: &quot;restored_$1&quot; // æ–°åç§°ï¼šrestored_y-logs-2025.08.01&#125;&#x27;&#x27;&#123;  &quot;indices&quot;: &quot;y-logs*&quot;,  &quot;rename_pattern&quot;: &quot;y-logs-(\\\\d&#123;4&#125;)\\\\.(\\\\d&#123;2&#125;)\\\\.(\\\\d&#123;2&#125;)&quot;,  // æ•è·å¹´ã€æœˆã€æ—¥  &quot;rename_replacement&quot;: &quot;archive_$1-$2-$3&quot;  // æ–°åç§°ï¼šarchive_2025-08-01&#125;&#x27;&#x27;&#123;    &quot;indices&quot;: &quot;*,-.security*,-.kibana*&quot;, //ä½¿ç”¨- è¿‡æ»¤ä¸è¿ç§»çš„ç´¢å¼•    &quot;ignore_unavailable&quot;: &quot;true&quot;&#125;&#x27;=========================================================================#æŸ¥çœ‹å¿«ç…§æ¢å¤æƒ…å†µcurl -s -X GET &quot;http://localhost:9200/_recovery/&quot;|jqcurl -X GET &quot;http://localhost:9200/_cat/recovery/?v&quot;curl -s -X GET &quot;http://localhost:9200/archive_2025-08-08/_recovery/&quot;|jqcurl -s -X GET &quot;http://localhost:9200/_cat/recovery/archive_2025-08-08?format=json&quot;|jq&#123;    &quot;index&quot;: &quot;archive_2025-08-08&quot;,    &quot;shard&quot;: &quot;0&quot;,    &quot;time&quot;: &quot;441ms&quot;, æ¢å¤æ€»è€—æ—¶ï¼ˆ441 æ¯«ç§’ï¼‰    &quot;type&quot;: &quot;snapshot&quot;, æ¢å¤ç±»å‹ä¸º å¿«ç…§æ¢å¤ï¼ˆä»å¿«ç…§ä»“åº“æ¢å¤æ•°æ®ï¼‰ã€‚    &quot;stage&quot;: &quot;done&quot;, å½“å‰æ¢å¤é˜¶æ®µï¼š- initï¼ˆåˆå§‹åŒ–ï¼‰- indexï¼ˆå¤åˆ¶ç´¢å¼•æ–‡ä»¶ï¼‰- translogï¼ˆä¼ è¾“äº‹åŠ¡æ—¥å¿—ï¼‰- finalizeï¼ˆå®Œæˆæ¢å¤ï¼‰- doneï¼ˆå·²å®Œæˆï¼‰    &quot;source_host&quot;: &quot;n/a&quot;, æºæ•°æ®èŠ‚ç‚¹çš„ä¸»æœºåæˆ– IPï¼ˆä»…åœ¨è·¨èŠ‚ç‚¹æ¢å¤æ—¶å‡ºç°ï¼Œå¦‚åˆ†ç‰‡è¿ç§»ï¼‰    &quot;source_node&quot;: &quot;n/a&quot;, æºèŠ‚ç‚¹çš„åç§°ï¼ˆElasticsearch é›†ç¾¤å†…å”¯ä¸€æ ‡è¯†ï¼‰ã€‚    &quot;target_host&quot;: &quot;172.26.0.2&quot;, ç›®æ ‡    &quot;target_node&quot;: &quot;be439083dc6b&quot;,    &quot;repository&quot;: &quot;y_repo&quot;,    &quot;snapshot&quot;: &quot;snapshot_all&quot;,    &quot;files&quot;: &quot;35&quot;, éœ€è¦æ¢å¤æ–‡ä»¶æ•°    &quot;files_recovered&quot;: &quot;35&quot;, å·²ç»æ¢å¤    &quot;files_percent&quot;: &quot;100.0%&quot;, è¿›åº¦    &quot;files_total&quot;: &quot;35&quot;, æ€»æ–‡ä»¶æ•°    &quot;bytes&quot;: &quot;3429792&quot;, å­—èŠ‚    &quot;bytes_recovered&quot;: &quot;3429792&quot;, å·²æ¢å¤å­—èŠ‚æ•°    &quot;bytes_percent&quot;: &quot;100.0%&quot;, è¿›åº¦    &quot;bytes_total&quot;: &quot;3429792&quot;,    &quot;translog_ops&quot;: &quot;0&quot;, éœ€è¦æ¢å¤çš„äº‹åŠ¡æ—¥å¿—æ“ä½œæ€»æ•°    &quot;translog_ops_recovered&quot;: &quot;0&quot;,     &quot;translog_ops_percent&quot;: &quot;100.0%&quot;  &#125;#æŸ¥çœ‹ä»“åº“çº§åˆ«çš„è¿›åº¦;åªæ˜¾ç¤ºæ­£åœ¨æ‰§è¡Œçš„å¿«ç…§ç›¸å…³æ“ä½œï¼Œå·²å®Œæˆçš„ä¸æ˜¾ç¤ºcurl -s -X GET &quot;http://localhost:9200/_snapshot/y_repo/_current&quot;|jq#é€šè¿‡ stats.processed_files å’Œ processed_size_in_bytes ä¼°ç®—å‰©ä½™æ—¶é—´&#123;  &quot;snapshots&quot;: [    &#123;      &quot;snapshot&quot;: &quot;snapshot_all&quot;,       // å¿«ç…§åç§°      &quot;uuid&quot;: &quot;ABC123&quot;,                    // å¿«ç…§å”¯ä¸€ID      &quot;state&quot;: &quot;IN_PROGRESS&quot;,              // æ‰§è¡ŒçŠ¶æ€      &quot;include_global_state&quot;: true,        // æ˜¯å¦åŒ…å«é›†ç¾¤å…¨å±€çŠ¶æ€      &quot;shards_stats&quot;: &#123;        &quot;initializing&quot;: 0,                 // åˆå§‹åŒ–ä¸­çš„åˆ†ç‰‡æ•°        &quot;started&quot;: 5,                      // è¿›è¡Œä¸­çš„åˆ†ç‰‡æ•°        &quot;finalizing&quot;: 0,                   // æœ€ç»ˆåŒ–ä¸­çš„åˆ†ç‰‡æ•°        &quot;done&quot;: 10,                        // å·²å®Œæˆçš„åˆ†ç‰‡æ•°        &quot;failed&quot;: 0,                       // å¤±è´¥çš„åˆ†ç‰‡æ•°        &quot;total&quot;: 15                        // æ€»åˆ†ç‰‡æ•°      &#125;,      &quot;stats&quot;: &#123;        &quot;number_of_files&quot;: 100,            // æ€»æ–‡ä»¶æ•°        &quot;processed_files&quot;: 80,             // å·²å¤„ç†æ–‡ä»¶æ•°        &quot;total_size_in_bytes&quot;: 1024000,    // æ€»å­—èŠ‚æ•°        &quot;processed_size_in_bytes&quot;: 819200  // å·²å¤„ç†å­—èŠ‚æ•°      &#125;,      &quot;indices&quot;: &#123;                         // æ¶‰åŠçš„ç´¢å¼•åŠå„è‡ªåˆ†ç‰‡çŠ¶æ€        &quot;logs-2023&quot;: &#123;          &quot;shards_stats&quot;: &#123; ... &#125;,          &quot;stats&quot;: &#123; ... &#125;        &#125;      &#125;,      &quot;start_time&quot;: &quot;2023-10-05T14:00:00.000Z&quot;,  // ä»»åŠ¡å¼€å§‹æ—¶é—´      &quot;end_time&quot;: null                     // ä»»åŠ¡ç»“æŸæ—¶é—´ï¼ˆæœªå®Œæˆæ—¶ä¸ºnullï¼‰    &#125;  ]&#125;\nè¿ç§»æ¢å¤åˆ°å…¶ä»–é›†ç¾¤\nesdumpç›´æ¥å¯¼å‡ºå¯¼å…¥å³å¯ä¸å¤šè®²\nsnapshotæ–¹å¼éœ€è¦å°†fsçš„ç‰©ç†å­˜å‚¨è·¯å¾„æ‹·è´åˆ°æ–°èŠ‚ç‚¹ï¼Œç„¶ååœ¨æ–°èŠ‚ç‚¹esé‡æ–°æ³¨å†ŒåŒåä»“åº“åå¿«ç…§å¯ä»¥ç›´æ¥æ¥ä½¿ç”¨æ¢å¤ï¼›å¦‚æœæ˜¯nfsæˆ–è€…s3ï¼ˆè‡ªå»ºminioè¿™ç§ï¼‰è¿™ç§ç±»å‹å°±ä¸éœ€è¦è¿ç§»æ–‡ä»¶ç›´æ¥æ³¨å†ŒåŒåä»“åº“åæ¢å¤å³å¯\n\n","categories":["ä¸­é—´ä»¶"],"tags":["es"]},{"title":"elfkéƒ¨ç½²ä½¿ç”¨","url":"/2025/04/18/elfk/","content":"\nfilebeatä¸å»ºè®®å®¹å™¨å¯åŠ¨ï¼Œé€‚åˆæ”¾åˆ°æ¯ä¸ªèŠ‚ç‚¹é‡‡é›†æ—¥å¿—ç»Ÿä¸€å‘ç»™logstashï¼›å¦‚æœå…¨éƒ¨è¾“å‡ºåˆ°elasticsearchä¼šå¯¼è‡´è´Ÿè½½æ¯”è¾ƒé«˜ï¼›ä¸å»ºè®®æ¯ä¸ªèŠ‚ç‚¹ç”¨logstashé‡‡é›†å› ä¸ºæ¯”è¾ƒé‡ï¼Œfilebeatæ¯”è¾ƒè½»é‡çº§\n\nå®‰è£…elfkcurl -SL https://github.com/docker/compose/releases/download/v2.30.3/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose#å°†å¯æ‰§è¡Œæƒé™èµ‹äºˆå®‰è£…ç›®æ ‡è·¯å¾„ä¸­çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶sudo chmod +x /usr/local/bin/docker-composesudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-composeyum install -y https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.3.2-x86_64.rpmcat &gt;&gt; ./elk.yml &lt;&lt; EOFversion: &#x27;3.8&#x27;services:  elasticsearch:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/elasticsearch:7.14.0    container_name: elasticsearch    environment:      - discovery.type=single-node  # å•èŠ‚ç‚¹æ¨¡å¼      - ES_JAVA_OPTS=-Xms512m -Xmx512m  # JVM å †å†…å­˜é™åˆ¶      - ELASTIC_PASSWORD=Ytest@123  # è®¾ç½® Elasticsearch å¯†ç     volumes:      - ./elasticsearch/data:/usr/share/elasticsearch/data  # æ•°æ®æŒä¹…åŒ–#      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  # è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰    ports:      - &quot;9200:9200&quot;  # REST API      - &quot;9300:9300&quot;  # é›†ç¾¤é€šä¿¡    networks:      - elk  logstash:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/logstash:7.14.0    container_name: logstash    volumes:      - ./logstash/config/logstash.conf:/usr/share/logstash/pipeline/logstash.conf  # è‡ªå®šä¹‰ Logstash ç®¡é“é…ç½®      - ./logstash/logs:/usr/share/logstash/logs  # æ—¥å¿—æŒä¹…åŒ–    environment:      - LS_JAVA_OPTS=-Xms512m -Xmx512m  # JVM å †å†…å­˜é™åˆ¶    ports:      - &quot;5044:5044&quot;  # Beats è¾“å…¥ç«¯å£ï¼ˆå¦‚ Filebeatï¼‰      - &quot;5000:5000/tcp&quot;  # TCP è¾“å…¥      - &quot;5000:5000/udp&quot;  # UDP è¾“å…¥    depends_on:      - elasticsearch    networks:      - elk  kibana:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/kibana:7.14.0    container_name: kibana    environment:      - I18N_LOCALE=zh-CN      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200  # æŒ‡å‘ Elasticsearch æœåŠ¡      - ELASTICSEARCH_USERNAME=elastic  # é»˜è®¤ç”¨æˆ·å      - ELASTICSEARCH_PASSWORD=Ytest@123  # ä¸ Elasticsearch å¯†ç ä¸€è‡´    ports:      - &quot;5601:5601&quot;  # Kibana Web ç•Œé¢    depends_on:      - elasticsearch    networks:      - elknetworks:  elk:    driver: bridgeEOFmkdir ./logstash/config -pcat &gt;&gt; ./logstash/config/logstash.conf &lt;&lt; EOF# ./logstash/config/logstash.confinput &#123;  tcp &#123;    port =&gt; 5000  # ç›‘å¬ TCP æ—¥å¿—  &#125;  beats &#123;    port =&gt; 5044  # æ¥æ”¶ Filebeat è¾“å…¥  &#125;&#125;filter &#123;  grok &#123;    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;  # è§£æ Apache æ—¥å¿—  &#125;  date &#123;    match =&gt; [ &quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]  # æ—¶é—´è§£æ  &#125;&#125;output &#123;  elasticsearch &#123;    hosts =&gt; [&quot;elasticsearch:9200&quot;]    user =&gt; &quot;elastic&quot;    password =&gt; &quot;Ytest@123&quot;    index =&gt; &quot;logs-%&#123;+YYYY.MM.dd&#125;&quot;  # æŒ‰æ—¥æœŸåˆ›å»ºç´¢å¼•  &#125;&#125;EOFchmod 777 elasticsearch/data\nfilebeatæ ¹æ®ä¸åŒtagå†™å…¥ä¸åŒçš„logstashåç»­åˆ†å‰²å’Œè¾“å‡ºå»ºç«‹ç´¢å¼•å¥½åŒºåˆ†\nfilebeat.inputs: # filebeat inputè¾“å…¥- type: log    # æ ‡å‡†è¾“å…¥  enabled: true  # å¯ç”¨æ ‡å‡†è¾“å…¥  paths:    - /var/log/*  tags: [&quot;system&quot;]  #  fields:  #    type: &quot;system_log&quot;- type: filestream  paths:    - &quot;/var/log/nginx/*.log&quot;  tags: [&quot;nginx&quot;]   # æ ‡è®°ä¸º nginx æ—¥å¿—#output.console:# enabled: true               # å¯ç”¨æ§åˆ¶å°è¾“å‡º  #  pretty: true                # ç¾åŒ– JSON æ ¼å¼  # codec.json:  #   pretty: true  # escape_html: false        # ä¸è½¬ä¹‰ HTML ç¬¦å·ï¼ˆä¿æŒåŸå§‹æ ¼å¼ï¼‰ # è¾“å‡ºåˆ° Logstash - ç”¨äºç”Ÿäº§æ•°æ®å¤„ç†output.logstash:  enabled: true               # å¯ç”¨ Logstash è¾“å‡º  #  when:  #    equals:  #      fields.type: &quot;system_log&quot;  hosts: [&quot;127.0.0.1:5044&quot;]  # Logstash çš„åœ°å€å’Œç«¯å£ï¼ˆæ”¯æŒå¤šä¸ªä¸»æœºè´Ÿè½½å‡è¡¡ï¼‰  when.contains:      tags: &quot;system&quot;  # åŒ¹é… tags åŒ…å« &quot;system&quot;  hosts: [&quot;127.0.0.1:5045&quot;]  enabled: true  when.contains:    tags: &quot;nginx&quot;  # åŒ¹é… tags åŒ…å« &quot;nginx&quot;\nlogstashæ ¹æ®ä¸åŒtypeè¿›è¡Œè¿‡æ»¤å’Œè¾“å‡ºç´¢å¼•\nLogstash Reference [7.10] | Elasticinput &#123;  tcp &#123;    port =&gt; 5000  # ç›‘å¬ TCP æ—¥å¿—  &#125;  beats &#123;    port =&gt; 5044  # æ¥æ”¶ Filebeat è¾“å…¥    type =&gt; &quot;system&quot;  &#125;  beats &#123;    port =&gt; 5045  # æ¥æ”¶ Filebeat è¾“å…¥    type =&gt; &quot;nginx&quot;  &#125;&#125;   filter &#123;  date &#123;    match =&gt; [ &quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]  # æ—¶é—´è§£æ  &#125;   if[type] == &quot;nginx&quot; &#123;    grok &#123;      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot; &#125;  # è§£æ nginx æ—¥å¿—,å¦‚æœä¸åŒºåˆ†ï¼›systemç±»å‹æ˜¯è§£æä¸äº†çš„ï¼Œä¼šç›´æ¥æŠ¥é”™      remove_field =&gt; [&quot;@version&quot;]     &#125;  &#125;  #å¯¹äºsystemç±»å‹å¯ä»¥å†å†™ä¸ªifæ¥å•ç‹¬è¿‡æ»¤  if[type] == &quot;system&quot; &#123;    grok &#123;      match =&gt;  &#123;&quot;message&quot; =&gt; &quot;%&#123;IPV4:ip&#125;&quot;&#125;        remove_field =&gt; [&quot;@version&quot;]     &#125;    mutate &#123;  #è¿™é‡Œè¿‡æ»¤å™¨ä¹±å†™çš„ï¼Œéœ€è¦æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡é…ç½®        remove_field =&gt; [&quot;timestamp&quot;]        gsub =&gt; [&quot;message&quot;,&quot;\\s&quot;,&quot;| &quot;]        split =&gt; [&quot;message&quot;,&quot;|&quot;]        replace =&gt; &#123; &quot;timenew&quot; =&gt;  &quot;%&#123;+yyyy-MM-dd&#125;&quot; &#125;        add_field =&gt; &#123;         &quot;year&quot; =&gt; &quot;%&#123;+yyyy&#125;&quot;         &quot;month&quot; =&gt; &quot;%&#123;+MM&#125;&quot;         &quot;day&quot; =&gt; &quot;%&#123;+dd&#125;&quot;         &quot;status&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;         &quot;code&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;        &#125;    &#125;  &#125;   &#125;#å¿…é¡»é€šè¿‡typeæŒ‡å®šä¸åŒè¾“å‡ºåˆ›å»ºä¸åŒçš„index =&gt;,å¦åˆ™indexçš„å­—æ®µä¸ä¸€æ ·ï¼Œå½“ç¬¬ä¸€ä¸ªindexç»“æ„ç¡®å®šåï¼Œç¬¬äºŒä¸ªè¾“å…¥æ— æ³•è¾“å‡ºåˆ°ç¬¬ä¸€ä¸ªindexï¼Œå› ä¸ºå­—æ®µä¸ä¸€æ ·output &#123;  if &quot;system&quot; in [tags] &#123;    elasticsearch &#123;      hosts =&gt; [&quot;elasticsearch:9200&quot;]      user =&gt; &quot;elastic&quot;      password =&gt; &quot;Ytest@123&quot;      index =&gt; &quot;filebeat-system-logs-%&#123;+YYYY.MM.dd&#125;&quot;  # æŒ‰æ—¥æœŸåˆ›å»ºç´¢å¼•    &#125;  &#125;    if &quot;nginx&quot; in [tags] &#123;    elasticsearch &#123;      hosts =&gt; [&quot;elasticsearch:9200&quot;]      user =&gt; &quot;elastic&quot;      password =&gt; &quot;Ytest@123&quot;      index =&gt; &quot;filebeat-nginx-logs-%&#123;+YYYY.MM.dd&#125;&quot;  # æŒ‰æ—¥æœŸåˆ›å»ºç´¢å¼•    &#125;  &#125;  &#125;\nelasticsearch\nå¸¸ç”¨è¯­æ³•\n\n&#x2F;_cat &#x2F;_cat&#x2F;master?help&#x2F;_cat&#x2F;indices?v  æ˜¾ç¤ºtitle&#x2F;_cat&#x2F;indiceslogs-2025.03.24 ä¸ºç´¢å¼•åç§°&#x2F;logs-2025.03.24&#x2F;_search æŸ¥çœ‹æ–‡æ¡£&#x2F;logs-2025.03.24&#x2F; æŸ¥çœ‹ç´¢å¼•ç»“æ„&#x2F;logs-2025.03.24&#x2F;_doc&#x2F;_search?q&#x3D;message:test\n\n\n","categories":["ä¸­é—´ä»¶"]},{"title":"ftp","url":"/2025/07/25/ftp/","content":"ä¸»åŠ¨æ¨¡å¼PORTä¸­æ–‡ç§°ä¸ºä¸»åŠ¨æ¨¡å¼ï¼Œå·¥ä½œçš„åŸç†ï¼š FTPå®¢æˆ·ç«¯è¿æ¥åˆ°FTPæœåŠ¡å™¨çš„21ç«¯å£ï¼Œå‘é€ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼Œç™»å½•æˆåŠŸåè¦liståˆ—è¡¨æˆ–è€…è¯»å–æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯éšæœºå¼€æ”¾ä¸€ä¸ªç«¯å£ï¼ˆ1024ä»¥ä¸Šï¼‰ï¼Œå‘é€ PORTå‘½ä»¤åˆ°FTPæœåŠ¡å™¨ï¼Œå‘Šè¯‰æœåŠ¡å™¨å®¢æˆ·ç«¯é‡‡ç”¨ä¸»åŠ¨æ¨¡å¼å¹¶å¼€æ”¾ç«¯å£ï¼›FTPæœåŠ¡å™¨æ”¶åˆ°PORTä¸»åŠ¨æ¨¡å¼å‘½ä»¤å’Œç«¯å£å·åï¼Œé€šè¿‡æœåŠ¡å™¨çš„20ç«¯å£å’Œå®¢æˆ·ç«¯å¼€æ”¾çš„ç«¯å£è¿æ¥ï¼Œå‘é€æ•°æ®ï¼ŒåŸç†å¦‚ä¸‹å›¾\nè¢«åŠ¨æ¨¡å¼PASVæ˜¯Passiveçš„ç¼©å†™ï¼Œä¸­æ–‡æˆä¸ºè¢«åŠ¨æ¨¡å¼ï¼Œå·¥ä½œåŸç†ï¼šFTPå®¢æˆ·ç«¯è¿æ¥åˆ°FTPæœåŠ¡å™¨çš„21ç«¯å£ï¼Œå‘é€ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼Œç™»å½•æˆåŠŸåè¦liståˆ—è¡¨æˆ–è€…è¯»å–æ•°æ®æ—¶ï¼Œå‘é€PASVå‘½ä»¤åˆ°FTPæœåŠ¡å™¨ï¼Œ æœåŠ¡å™¨åœ¨æœ¬åœ°éšæœºå¼€æ”¾ä¸€ä¸ªç«¯å£ï¼ˆ1024ä»¥ä¸Šï¼‰ï¼Œç„¶åæŠŠå¼€æ”¾çš„ç«¯å£å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œ å®¢æˆ·ç«¯å†è¿æ¥åˆ°æœåŠ¡å™¨å¼€æ”¾çš„ç«¯å£è¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒåŸç†å¦‚ä¸‹å›¾\nä»ä¸Šé¢çš„è¿è¡ŒåŸæ¥çœ‹åˆ°ï¼Œä¸»åŠ¨æ¨¡å¼å’Œè¢«åŠ¨æ¨¡å¼çš„ä¸åŒç®€å•æ¦‚è¿°ä¸ºï¼š ä¸»åŠ¨æ¨¡å¼ä¼ é€æ•°æ®æ—¶æ˜¯â€œæœåŠ¡å™¨â€è¿æ¥åˆ°â€œå®¢æˆ·ç«¯â€çš„ç«¯å£ï¼›è¢«åŠ¨æ¨¡å¼ä¼ é€æ•°æ®æ˜¯â€œå®¢æˆ·ç«¯â€è¿æ¥åˆ°â€œæœåŠ¡å™¨â€çš„ç«¯å£ã€‚ä¸»åŠ¨æ¨¡å¼éœ€è¦å®¢æˆ·ç«¯å¿…é¡»å¼€æ”¾ç«¯å£ç»™æœåŠ¡å™¨ï¼Œå¾ˆå¤šå®¢æˆ·ç«¯éƒ½æ˜¯åœ¨é˜²ç«å¢™å†…ï¼Œå¼€æ”¾ç«¯å£ç»™FTPæœåŠ¡å™¨è®¿é—®æ¯”è¾ƒå›°éš¾ã€‚è¢«åŠ¨æ¨¡å¼åªéœ€è¦æœåŠ¡å™¨ç«¯å¼€æ”¾ç«¯å£ç»™å®¢æˆ·ç«¯è¿æ¥å°±è¡Œäº†,æ‰€ä»¥æ¨èè¢«åŠ¨æ¨¡å¼ï¼Œä¸»åŠ¨æ¨¡å¼å¯èƒ½ä¼šè¢«å®¢æˆ·ç«¯æ‹¦æˆª\n","categories":["linux"]},{"title":"iptablesé˜²æ­¢ddos(cc)","url":"/2025/04/21/iptables%E9%98%B2%E6%AD%A2ddos-cc/","content":"\nåŸºæœ¬ä¸Šå‘è¡Œç‰ˆéƒ½æ˜¯è‡ªå¸¦çš„ï¼Œè½»é‡çº§ï¼Œä¸éœ€è¦é¢å¤–ä¸‹è½½Fail2Banä¹Ÿå¯ä»¥ä½†æ˜¯éœ€è¦é¢å¤–ä¸‹è½½\n\nå¦‚ä½•é…ç½®ä½¿ç”¨iptables -I INPUT -p tcp --dport 80 -m state --state NEW -m recent --setå‚æ•°    ä½œç”¨-I INPUT    å°†è§„åˆ™æ’å…¥åˆ° INPUT é“¾çš„æœ€å‰é¢-p tcp --dport 80    åŒ¹é…ç›®æ ‡ç«¯å£ä¸º 80 çš„ TCP æµé‡-m state --state NEW    ä»…åŒ¹é… æ–°å»ºè¿æ¥ï¼ˆå¦‚ TCP çš„ SYN åŒ…ï¼‰-m recent --set    å°†æ¥æº IP è®°å½•åˆ° recent æ¨¡å—çš„é»˜è®¤åˆ—è¡¨ï¼ˆ/proc/net/xt_recent/DEFAULTï¼‰iptables -I INPUT -p tcp --dport 80 -m state --state NEW -m recent --update --seconds 60 --hitcount 100 -j DROPå‚æ•°    ä½œç”¨-m recent --update --seconds 60 --hitcount 100    æ£€æŸ¥ IP åœ¨ 60 ç§’å†…æ˜¯å¦å‘èµ·è¶…è¿‡ 100 æ¬¡æ–°è¿æ¥-j DROP    è‹¥è¶…é™ï¼Œç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…\n\næ•ˆæœå›¾ï¼Œåˆ°æŒ‡å®šæ¬¡æ•°è‡ªåŠ¨ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œç«¯å£ä¸é€šï¼Œåˆ°è¾¾æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ¢å¤\nç»è¿‡æµ‹è¯• â€“hitcount å¤§äº20 ä¼šæŠ¥é”™\nè§£å†³åŠæ³•echo options xt_recent ip_pkt_list_tot=200 &gt; /etc/modprobe.d/xt.confmodprobe -r xt_recent &amp;&amp; modprobe xt_recent é‡æ–°åŠ è½½æŸ¥çœ‹ lsmod |grep xt  ï¼›cat /sys/module/xt_recent/parameters/ip_pkt_list_tot å¯¹åº” xt.conf\né¢å¤–è¡¥å……è‹¥å…¶ä»–è§„åˆ™ä¹Ÿä½¿ç”¨ recent é»˜è®¤åˆ—è¡¨ï¼Œå¯èƒ½å¯¼è‡´è¯¯åˆ¤ï¼Œå¯ä»¥é€šè¿‡â€“name æŒ‡å®šåç§°åˆ†ç±»\niptables -I INPUT -p tcp â€“dport 80 -m state â€“state NEW -m recent â€“set â€“name HTTP_CC\niptables -I INPUT -p tcp â€“dport 80 -m state â€“state NEW -m recent â€“update â€“seconds 60 â€“hitcount 200 â€“name HTTP_CC -j DROP\nåˆ™ &#x2F;proc&#x2F;net&#x2F;xt_recent&#x2F;HTTP_CC å« HTTP_CC\n","categories":["linux"]},{"title":"kubeclt-neat","url":"/2025/07/24/kubeclt-neat/","content":"kubeclt-neatä½¿ç”¨\nå¦‚æœéƒ¨ç½²çš„yamlä¸¢å¤±ï¼Œå¯ä»¥ä½¿ç”¨kubeclt-neatç²¾ç®€åç›´æ¥ä½¿ç”¨å¯¼å…¥æ–°çš„ç¯å¢ƒï¼Œé»˜è®¤çš„æ–‡ä»¶æœ‰å¤šä½™çš„ä¿¡æ¯æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨çš„yum -y install bash-completionsource /usr/share/bash-completion/bash_completionsource &lt;(kubectl completion bash)echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrcwget https://github.com/itaysk/kubectl-neat/releases/download/v2.0.3/kubectl-neat_linux_amd64.tar.gztar -zxvf kubectl-neat_linux_amd64.tar.gzmv kubectl-neat /usr/local/bin/kubectl get deploy my-deployment -o yaml | kubectl neat &gt; current-config.yamlkubectl apply -f current-config.yamldiff current-config.yaml new-config.yaml\n\n","categories":["k8s"]},{"title":"mcp","url":"/2025/12/23/mcp/","content":"MCP å·¥å…·ä½¿ç”¨æ–‡æ¡£https://gofastmcp.com/getting-started/installation\nå·¥å…·ç¤ºä¾‹åŸºç¡€å·¥å…·å®šä¹‰mcp = FastMCP(&quot;Demo ğŸš€&quot;)Starlette()@mcp.tool(name=&#x27;åŠ æ³•&#x27;)def add(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;    return a + b#fastmcp run my_server.py:mcp --transport sse --port 8000\n\nJSONæ•°æ®å¤„ç†å·¥å…·@mcp.tool(name=&#x27;ä»å…¬ç½‘URLä¸‹è½½JSONæ–‡ä»¶å¹¶æå–äº§å“ä¿¡æ¯&#x27;)def extract_product_info(url: str) -&gt; list[dict[str, Any]] | dict[str, str]:    &quot;&quot;&quot;    ä»å…¬ç½‘URLä¸‹è½½JSONæ–‡ä»¶å¹¶æå–äº§å“ä¿¡æ¯    Args:        url (str): åŒ…å«JSONæ•°æ®çš„å…¬ç½‘URLåœ°å€    Returns:        list[dict]: åŒ…å« product_name å’Œ product_image çš„å­—å…¸åˆ—è¡¨    Example:        extract_product_info(&quot;https://example.com/products.json&quot;)    &quot;&quot;&quot;    try:        response = requests.get(url, timeout=10)        response.encoding = &#x27;utf-8&#x27;        response.raise_for_status()        products_name = []        products_image = []        lines = response.text.splitlines()        for line in lines:            try:                product_data = json.loads(line.strip())                products_name.append(product_data[&quot;product_name&quot;])                products_image.append(product_data[&quot;product_image&quot;])            except (json.JSONDecodeError, KeyError) as e:                print(f&quot;å¤„ç†å¤±è´¥: &#123;e&#125;ï¼Œè¡Œå†…å®¹: &#123;line.strip()&#125;&quot;)        return products_name, products_image    except requests.exceptions.RequestException as e:        return &#123;&quot;error&quot;: f&quot;æ–‡ä»¶ä¸‹è½½å¤±è´¥: &#123;str(e)&#125;&quot;&#125;    except Exception as e:        return &#123;&quot;error&quot;: f&quot;å¤„ç†å¤±è´¥: &#123;str(e)&#125;&quot;&#125;\n\néŸ³é¢‘ä¸‹è½½å·¥å…·@mcp.tool(name=&#x27;ä¸‹è½½éŸ³é¢‘æ–‡ä»¶&#x27;)def download_audio(    url: str,     save_path: str = &#x27;../audio/oss_new_2min.wav&#x27;,    retries: int = 3) -&gt; bool:    &quot;&quot;&quot;    ä¸‹è½½è¿œç¨‹éŸ³é¢‘æ–‡ä»¶åˆ°æœ¬åœ°        :param url: éŸ³é¢‘æ–‡ä»¶URL    :param save_path: æœ¬åœ°ä¿å­˜è·¯å¾„ï¼ˆåŒ…å«æ–‡ä»¶åï¼‰    :param retries: å¤±è´¥é‡è¯•æ¬¡æ•°    :return: æ˜¯å¦ä¸‹è½½æˆåŠŸ    &quot;&quot;&quot;    try:        save_dir = os.path.dirname(save_path)        Path(save_dir).mkdir(parents=True, exist_ok=True)        if not url.startswith((&#x27;http://&#x27;, &#x27;https://&#x27;)):            print(f&quot;æ— æ•ˆçš„URLæ ¼å¼: &#123;url&#125;&quot;)            return False        for attempt in range(retries):            try:                with requests.get(url, stream=True, timeout=10, verify=False) as response:                    response.raise_for_status()                    total_size = int(response.headers.get(&#x27;content-length&#x27;, 0))                                        with open(save_path, &#x27;wb&#x27;) as f:                        downloaded = 0                        for chunk in response.iter_content(chunk_size=8192):                            if chunk:                                f.write(chunk)                                downloaded += len(chunk)                                if total_size &gt; 0:                                    print(f&quot;\\rä¸‹è½½è¿›åº¦: &#123;downloaded/total_size*100:.1f&#125;%&quot;, end=&#x27;&#x27;)                    return True            except Exception as e:                print(f&quot;å°è¯• &#123;attempt+1&#125;/&#123;retries&#125; å¤±è´¥: &#123;str(e)&#125;&quot;)                time.sleep(5)        return False\n\nMySQL-MCP é…ç½®æŒ‡å—ç¯å¢ƒå®‰è£…https://uv.doczh.com/getting-started/features/\n# ä½¿ç”¨ uv å®‰è£…curl -LsSf https://astral.sh/uv/install.sh | shuv python install 3.12uv init mysql-mcpcd mysql-mcpuv add mysql-mcp-server# ä½¿ç”¨ pip å®‰è£…python -m venv mysql-mcpsource mysql-mcp/bin/activatepip install mysql-mcp-serverpip show mysql-mcp-server\n\næœåŠ¡é…ç½®&#123;    &quot;mcpServers&quot;: &#123;        &quot;mysql&quot;: &#123;            &quot;isActive&quot;: true,            &quot;command&quot;: &quot;uv&quot;,            &quot;args&quot;: [                &quot;--directory&quot;,                &quot;D:/pycharm/.venv/Lib/site-packages/mysql_mcp_server&quot;,                &quot;run&quot;,                &quot;mysql_mcp_server&quot;            ],            &quot;env&quot;: &#123;                &quot;MYSQL_HOST&quot;: &quot;1.1.1.1&quot;,                &quot;MYSQL_PORT&quot;: &quot;31106&quot;,                &quot;MYSQL_USER&quot;: &quot;root&quot;,                &quot;MYSQL_PASSWORD&quot;: &quot;123456789&quot;,                &quot;MYSQL_DATABASE&quot;: &quot;app_db&quot;            &#125;,            &quot;name&quot;: &quot;mysql&quot;        &#125;    &#125;&#125;\n\nSSE è½¬æ¢é…ç½®https://github.com/supercorp-ai/supergateway\n# å®‰è£…ä¾èµ–yum install -y nodejs npmnpm install -g pm2# è®¾ç½®ç¯å¢ƒå˜é‡export MYSQL_HOST=&quot;127.0.0.1&quot;export MYSQL_PORT=&quot;31106&quot;export MYSQL_USER=&quot;root&quot;export MYSQL_PASSWORD=&quot;123456789&quot;export MYSQL_DATABASE=&quot;app_db&quot;# å¯åŠ¨æœåŠ¡pm2 start --name mcp-server npx -- -y supergateway \\    --port 8951 \\    --stdio &quot;python /root/mysql-mcp/lib/python3.12/site-packages/mysql_mcp_server/server.py&quot;\n\nSSE å®¢æˆ·ç«¯é…ç½®&#123;    &quot;mcpServers&quot;: &#123;        &quot;pm-mysql&quot;: &#123;            &quot;url&quot;: &quot;http://æœåŠ¡å™¨IP:8951/sse&quot;,            &quot;type&quot;: &quot;sse&quot;        &#125;    &#125;&#125;\n\n\næ³¨æ„äº‹é¡¹ï¼š\n\nWindowsè·¯å¾„å»ºè®®ä½¿ç”¨æ­£æ–œæ  /\nç”Ÿäº§ç¯å¢ƒå»ºè®®å°†å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­\nPM2è¿›ç¨‹éœ€è¦ä¿æŒå¸¸é©»ï¼Œå»ºè®®é…ç½®å¼€æœºå¯åŠ¨\nSSEæœåŠ¡éœ€è¦ç¡®ä¿é˜²ç«å¢™å¼€æ”¾å¯¹åº”ç«¯å£ï¼ˆ8951ï¼‰\n\n\n","categories":["python"],"tags":["llm"]},{"title":"miniconda3","url":"/2025/04/21/miniconda3/","content":"\ncondaæ˜¯ä¸€ä¸ªåŒ…å’Œç¯å¢ƒç®¡ç†å·¥å…·ï¼Œç”¨äºåˆ›å»ºã€ç®¡ç†å’Œåˆ‡æ¢Pythonçš„è™šæ‹Ÿç¯å¢ƒ\n\nå®‰è£…mkdir -p ~/miniconda3wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.shbash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3rm ~/miniconda3/miniconda.shsource ~/miniconda3/bin/activate\nä½¿ç”¨1. conda --version #æŸ¥çœ‹condaç‰ˆæœ¬ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…2. conda update conda #æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿä¼šæ›´æ–°å…¶å®ƒç›¸å…³åŒ…3. conda update --all #æ›´æ–°æ‰€æœ‰åŒ…4. conda update package_name #æ›´æ–°æŒ‡å®šçš„åŒ…5. conda create -n env_name package_name #åˆ›å»ºåä¸ºenv_nameçš„æ–°ç¯å¢ƒï¼Œå¹¶åœ¨è¯¥ç¯å¢ƒä¸‹å®‰è£…åä¸ºpackage_name çš„åŒ…ï¼Œå¯ä»¥æŒ‡å®šæ–°ç¯å¢ƒçš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ï¼šconda create -n python2 python=python2.7 numpy pandasï¼Œåˆ›å»ºäº†python2ç¯å¢ƒï¼Œpythonç‰ˆæœ¬ä¸º2.7ï¼ŒåŒæ—¶è¿˜å®‰è£…äº†numpy pandasåŒ…6. source activate env_name #åˆ‡æ¢è‡³env_nameç¯å¢ƒ7. source deactivate #é€€å‡ºç¯å¢ƒ8. conda info -e #æ˜¾ç¤ºæ‰€æœ‰å·²ç»åˆ›å»ºçš„ç¯å¢ƒ9. conda create --name new_env_name --clone old_env_name #å¤åˆ¶old_env_nameä¸ºnew_env_name10. conda remove --name env_name â€“all #åˆ é™¤ç¯å¢ƒ11. conda list #æŸ¥çœ‹æ‰€æœ‰å·²ç»å®‰è£…çš„åŒ…12. conda install package_name #åœ¨å½“å‰ç¯å¢ƒä¸­å®‰è£…åŒ…13. conda install --name env_name package_name #åœ¨æŒ‡å®šç¯å¢ƒä¸­å®‰è£…åŒ…14. conda remove -- name env_name package #åˆ é™¤æŒ‡å®šç¯å¢ƒä¸­çš„åŒ…15. conda remove package #åˆ é™¤å½“å‰ç¯å¢ƒä¸­çš„åŒ…16. conda env remove -n env_name #é‡‡ç”¨ç¬¬10æ¡çš„æ–¹æ³•åˆ é™¤ç¯å¢ƒå¤±è´¥æ—¶ï¼Œå¯é‡‡ç”¨è¿™ç§æ–¹æ³•\n\n\n\nä¸¤ä¸ªç¯å¢ƒï¼Œä¸€ä¸ªæœ‰requestä¸€ä¸ªæ²¡æœ‰ï¼Œéš”ç¦»ä½œç”¨\né•œåƒæº# æŸ¥çœ‹é•œåƒæºconda config --show-sources# æ·»åŠ é•œåƒæºconda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main# ä»é•œåƒæºä¸­å®‰è£…åŒ…æ—¶æ˜¾ç¤ºæ¥æºconda config --set show_channel_urls yes# åˆ é™¤é•œåƒæºconda config --remove channels https://XXX# åˆ é™¤é…ç½®çš„é•œåƒæºï¼Œä½¿ç”¨é»˜è®¤é•œåƒæºconda config --remove-key channels\n\næ‰“åŒ…è¿è¡Œç¯å¢ƒpip install conda-packconda pack -n my_env_name -o out_name.tar.gztar -zxvf 2.7.tar.gz -C 2.7conda info -esource activate my_env_name\n\n","categories":["python"]},{"title":"mq","url":"/2025/08/22/mq/","content":"rabbitMQ\nç”Ÿäº§è€…è·¯ç”±  vhost  &gt;  exchange  &gt;  queueæ¯ä¸€ä¸ªvhostæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªminiç‰ˆçš„RabbitMQæœåŠ¡å™¨ï¼Œæ‹¥æœ‰è‡ªå·±çš„äº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šç­‰ï¼Œæ‹¥æœ‰è‡ªå·±çš„æƒé™æœºåˆ¶version: &#x27;3&#x27;services:  rabbitmq:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mq:rabbit-3-management    container_name: rabbitmq    restart: always    ports:      - &quot;5672:5672&quot;      - &quot;15672:15672&quot;      - &quot;15692:15692&quot;  # Prometheus ç›‘æ§æŒ‡æ ‡ç«¯å£ï¼ˆå¯é€‰ï¼‰    environment:      RABBITMQ_DEFAULT_USER: admin      RABBITMQ_DEFAULT_PASS: secret      RABBITMQ_DEFAULT_VHOST: /prod  # æŒ‡å®šé»˜è®¤è™šæ‹Ÿä¸»æœº      ABBITMQ_NODE_IP_ADDRESS: 0.0.0.0    volumes:      - rabbitmq_data:/var/lib/rabbitmq  # æŒä¹…åŒ–æ•°æ®      - rabbitmq_logs:/var/log/rabbitmq  # æŒä¹…åŒ–æ—¥å¿—    healthcheck:      test: [&quot;CMD&quot;, &quot;rabbitmq-diagnostics&quot;, &quot;status&quot;]      interval: 30s      timeout: 10s      retries: 3volumes:  rabbitmq_data:  rabbitmq_logs:\nç®€å•ä½¿ç”¨demo#ç”Ÿäº§è€…import pikacredentials = pika.PlainCredentials(&#x27;admin&#x27;, &#x27;secret&#x27;)connection = pika.BlockingConnection(    pika.ConnectionParameters(host=&#x27;47.109.136.x&#x27;, port=5672, virtual_host=&#x27;/prod&#x27;, credentials=credentials))channel = connection.channel()channel.queue_declare(queue=&#x27;test_queue&#x27;)channel.basic_publish(exchange=&#x27;&#x27;, routing_key=&#x27;test_queue&#x27;, body=&#x27;Hello from Python!&#x27;)connection.close()#æ¶ˆè´¹è€…import pikadef callback(ch, method, properties, body):    print(f&quot;Received: &#123;body.decode()&#125;&quot;)credentials = pika.PlainCredentials(&#x27;admin&#x27;, &#x27;secret&#x27;)connection = pika.BlockingConnection(    pika.ConnectionParameters(host=&#x27;47.109.136.x&#x27;, port=5672, virtual_host=&#x27;/prod&#x27;, credentials=credentials))channel = connection.channel()channel.queue_declare(queue=&#x27;test_queue&#x27;)channel.basic_consume(queue=&#x27;test_queue&#x27;, on_message_callback=callback, auto_ack=True)print(&#x27;Waiting for messages...&#x27;)channel.start_consuming()\nå…³äºå›è°ƒå‡½æ•°class Library:    def __init__(self):        self.callback = None    def register_callback(self, callback_func):        self.callback = callback_func  # ä¿å­˜å‡½æ•°å¯¹è±¡    def trigger_event(self):        if self.callback:            # åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¹¶ä¼ å…¥å‚æ•°            self.callback(&quot;param1&quot;, &quot;param2&quot;)# ç”¨æˆ·å®šä¹‰çš„å‡½æ•°def my_callback(a, b):    print(f&quot;å›è°ƒè§¦å‘: &#123;a&#125;, &#123;b&#125;&quot;)# ä½¿ç”¨åº“lib = Library()lib.register_callback(my_callback)  # ä¼ é€’å‡½æ•°å¯¹è±¡lib.trigger_event()  # è¾“å‡º: å›è°ƒè§¦å‘: param1, param2\n\nkafka\nç”Ÿäº§è€…è·¯ç”±  group  &gt;   topic   &gt;  tag,é€‚åˆååé‡å¾ˆå¤§çš„åœºæ™¯æ¯”å¦‚å¤§æ•°æ®version: &#x27;3&#x27;services:  zookeeper:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mq:zk-3.8  # Zookeeper é•œåƒ    container_name: zookeeper    ports:      - &quot;2181:2181&quot;    environment:      - ALLOW_ANONYMOUS_LOGIN=yes  # å…è®¸åŒ¿åè®¿é—®ï¼ˆæµ‹è¯•ç”¨ï¼‰    networks:      - kafka-net    volumes:      - zookeeper_data:/bitnami/zookeeper  kafka:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mq:kafka-3.4   # Kafka é•œåƒ    container_name: kafka    ports:      - &quot;9092:9092&quot;    environment:      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181      - ALLOW_PLAINTEXT_LISTENER=yes  # å…è®¸æ˜æ–‡ç›‘å¬      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092  # å®¢æˆ·ç«¯è®¿é—®åœ°å€    depends_on:      - zookeeper    networks:      - kafka-net    volumes:      - kafka_data:/bitnami/kafkanetworks:  kafka-net:    driver: bridgevolumes:  zookeeper_data:  kafka_data:\n# åˆ›å»ºä¸»é¢˜ &quot;test-topic&quot;kafka-topics.sh --create \\  --bootstrap-server localhost:9092 \\  --replication-factor 1 \\  --partitions 1 \\  --topic test-topickafka-topics.sh    --bootstrap-server localhost:9092   --list# å¯åŠ¨ç”Ÿäº§è€…ï¼Œå‘é€æ¶ˆæ¯kafka-console-producer.sh \\  --bootstrap-server localhost:9092 \\  --topic test-topic# å¯åŠ¨æ¶ˆè´¹è€…ï¼Œæ¥æ”¶æ¶ˆæ¯kafka-console-consumer.sh \\  --bootstrap-server localhost:9092 \\  --topic test-topic \\  --from-beginning# ä¸åŒèŠ‚ç‚¹çš„é…ç½®å·®å¼‚ï¼ˆä»¥ 101 èŠ‚ç‚¹ä¸ºä¾‹ï¼‰broker.id=1  # 102 èŠ‚ç‚¹æ”¹ä¸º 2ï¼Œ103 èŠ‚ç‚¹æ”¹ä¸º 3listeners=PLAINTEXT://0.0.0.0:9092advertised.listeners=PLAINTEXT://192.168.1.101:9092  # ä¿®æ”¹ä¸ºå½“å‰èŠ‚ç‚¹ IP# æ‰€æœ‰èŠ‚ç‚¹ç›¸åŒé…ç½®zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181log.dirs=/data/kafka/logsnum.partitions=3  # é»˜è®¤åˆ†åŒºæ•°ï¼ˆå»ºè®® &gt;= Broker æ•°é‡ï¼‰default.replication.factor=3  # é»˜è®¤å‰¯æœ¬æ•°ï¼ˆå»ºè®® = Broker æ•°é‡ï¼‰offsets.topic.replication.factor=3transaction.state.log.replication.factor=3delete.topic.enable=true\n\n","categories":["ä¸­é—´ä»¶"]},{"title":"nginx_todo","url":"/2025/07/21/nginx-todo/","content":"proxy_passè½¬å‘ç­–ç•¥è¯·æ±‚urlå’Œè½¬å‘ä¸€è‡´åç«¯æœåŠ¡å®é™…å¤„ç†è·¯å¾„ä¸º /api/uploadï¼Œä¸å®¢æˆ·ç«¯è¯·æ±‚è·¯å¾„ä¸€è‡´ã€‚Nginxé…ç½®ï¼šlocation /api/ &#123;         # åŒ¹é…å®¢æˆ·ç«¯è¯·æ±‚ä¸­çš„ /api/ å‰ç¼€    proxy_pass http://backend;  # ä¸æ”¹å˜è·¯å¾„ï¼Œç›´æ¥è½¬å‘ /api/xxx åˆ°åç«¯&#125;è½¬å‘æ•ˆæœï¼šå®¢æˆ·ç«¯è¯·æ±‚ â†’ /api/uploadNginxè½¬å‘ â†’ http://backend/api/upload\n\nåç«¯æœåŠ¡éœ€è¦åŸºç¡€è·¯å¾„ï¼ˆå»æ‰&#x2F;api&#x2F;å‰ç¼€ï¼‰åç«¯è·¯ç”±ç¤ºä¾‹ï¼šåç«¯æœåŠ¡å¤„ç†æ ¹è·¯å¾„ /uploadï¼Œä¸éœ€è¦ /api/ å‰ç¼€ã€‚Nginxé…ç½®ï¼šnginxlocation /api/ &#123;    # é€šè¿‡ rewrite ç§»é™¤ /api/ å‰ç¼€    rewrite ^/api/(.*) /$1 break;      proxy_pass http://backend;  &#125;æˆ–location /api/ &#123;    # ç›´æ¥åœ¨ proxy_pass ä¸­è¿½åŠ è·¯å¾„    proxy_pass http://backend/;  # æ³¨æ„ç»“å°¾çš„æ–œæ &#125;â— è½¬å‘æ•ˆæœï¼šå®¢æˆ·ç«¯è¯·æ±‚ â†’ /api/uploadNginxè½¬å‘ â†’ http://backend/upload\n\nè½¬å‘åŠ urlæ³¨æ„ç‚¹curl http://127.0.0.1/api/client-testlocation /api/ &#123;    proxy_pass http://backend/test/;  # ç»“å°¾å¿…é¡»åŠ æ–œæ &#125;127.0.0.1- - [21/Jul/2025:14:32:45 +0800] &quot;GET /test/client-test HTTP/1.0&quot; 404 178 &quot;-&quot; &quot;curl/7.58.0&quot; &quot;-&quot;Proxy: http://-127.0.0.1- - [21/Jul/2025:14:32:45 +0800] &quot;GET /api/client-test HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;curl/7.58.0&quot; &quot;-&quot;Proxy: http://127.0.0.1å®¢æˆ·ç«¯è¯·æ±‚ /api/client-test â†’ åç«¯è·¯å¾„ /test/client-testcurl http://127.0.0.1/api-test/client-testlocation /api-test/ &#123;    proxy_pass http://backend/test;  # æ— æ–œæ  â†’ è·¯å¾„åˆå¹¶&#125;127.0.0.1- - [21/Jul/2025:14:32:28 +0800] &quot;GET /testclient-test HTTP/1.0&quot; 404 178 &quot;-&quot; &quot;curl/7.58.0&quot; &quot;-&quot;Proxy: http://-127.0.0.1- - [21/Jul/2025:14:32:28 +0800] &quot;GET /api-test/client-test HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;curl/7.58.0&quot; &quot;-&quot;Proxy: http://127.0.0.1å®¢æˆ·ç«¯è¯·æ±‚: http://example.com/api-test/client-testå®é™…è½¬å‘è·¯å¾„: http://backend/testclient-test\n\næ—¥å¿—è®°å½•å¸¸ç”¨å†…ç½®å˜é‡$http_ å˜é‡å¯ä»¥è‡ªå®šä¹‰æ¯”å¦‚$http_lky è¯·æ±‚å¤´é‡Œé¢æœ‰lky:valueåˆ™$http_lkyç­‰äºvalue$args ï¼š #è¿™ä¸ªå˜é‡ç­‰äºè¯·æ±‚è¡Œä¸­çš„å‚æ•°ï¼ŒåŒ$query_string$content_length ï¼š # è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µã€‚$content_type ï¼š # è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µã€‚$document_root ï¼š # å½“å‰è¯·æ±‚åœ¨rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ã€‚$host ï¼š # è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ã€‚$http_user_agent ï¼š#  å®¢æˆ·ç«¯agentä¿¡æ¯$http_cookie ï¼š # å®¢æˆ·ç«¯cookieä¿¡æ¯$limit_rate ï¼š # è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ã€‚$status  # è¯·æ±‚çŠ¶æ€$body_bytes_sent # å‘é€å­—èŠ‚$request_method ï¼š # å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨ä½œï¼Œé€šå¸¸ä¸ºGETæˆ–POSTã€‚$remote_addr ï¼š # å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚$remote_port ï¼š # å®¢æˆ·ç«¯çš„ç«¯å£ã€‚$remote_user ï¼š # å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·åã€‚$request_filename ï¼š # å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆã€‚$scheme ï¼š # HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰ã€‚$server_protocol ï¼š # è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ã€‚$server_addr ï¼š # æœåŠ¡å™¨åœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼ã€‚$server_name ï¼š # æœåŠ¡å™¨åç§°ã€‚$server_port ï¼š # è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·ã€‚$request_uri ï¼š # åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼šâ€/foo/bar.php?arg=bazâ€ã€‚$uri ï¼š # ä¸å¸¦è¯·æ±‚å‚æ•°çš„å½“å‰URIï¼Œ$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚â€/foo/bar.htmlâ€ã€‚$document_uri ï¼š # ä¸$uriç›¸åŒã€‚\næ—¥å¿—é…ç½®å˜é‡location / &#123;      proxy_pass [$Domain]; #å¿…é¡»      index index.html index.htm index.jsp index.shtml;      proxy_redirect off;      proxy_set_header Host $host;      proxy_set_header Lky $remote_addr;      proxy_set_header REMOTE-HOST $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header X-My-Header &quot;My Value&quot;;      #åœ¨æ—¥å¿—ä¸­ä½¿ç”¨$http_x_my_headerå°±å¯ä»¥è·å–åˆ°å€¼ï¼Œå¯ä»¥å†™æ­»ä¹Ÿå¯ä»¥ç”¨å†…ç½®å˜é‡æ¯”å¦‚setè‡ªå®šä¹‰      ç»æµ‹è¯• proxy_set_header ç¬¬ä¸€ä¸ªå­—æ¯å¿…é¡»å¤§å†™ï¼Œåªèƒ½ç”¨-ä¸èƒ½ç”¨_      log_format æ—¥å¿—æ ¼å¼å¿…é¡»æ˜¯$httpå¼€å¤´-éœ€è¦æ¢æˆ_è€Œä¸”å¿…é¡»å…¨éƒ¨å°å†™    &#125;log_format custom &#x27;$remote_addr [$time_local] &quot;$request&quot; &#x27;                  &#x27;Lky:$http_lky&#x27; ;access_log /var/log/nginx/access.log custom;#å¦‚æœæ˜¯  proxy_pass http://127.0.0.1:83 ç¬¬ä¸€è·³è®°å½•ä¸Šæ¸¸æ—¥å¿—åŒ…å«çœŸå®ipï¼Œç¬¬äºŒæ¡æ˜¯å®¢æˆ·ç«¯è®¿é—®çš„ä¸åŒ…å«Lkyï¼Œä¸€ä¸ªè¯·æ±‚æœ‰ä¸¤ä¸ªæ—¥å¿—è¾“å‡º#127.0.0.1 - - [23/May/2025:16:31:41 +0800] &quot;GET / HTTP/1.0&quot; 200 4833 &quot;-&quot; &quot;curl/7.60.0&quot; &quot;10.0.1.100&quot; 10.0.1.100Lky:&quot;10.0.1.100&quot;#è¿™é‡Œçš„æ—¥å¿—å¯ä»¥é€šè¿‡proxy_set_headerè‡ªå®šä¹‰ï¼Œæ¯”å¦‚è·å–å®¢æˆ·ç«¯çœŸå®IP#10.0.1.100 - - [23/May/2025:16:31:41 +0800] &quot;GET / HTTP/1.1&quot; 200 4833 &quot;-&quot; &quot;curl/7.60.0&quot; &quot;-&quot; 10.0.1.100:83Lky:&quot;-&quot;#è¿™ä¸ªåˆ™æ˜¯å®¢æˆ·ç«¯ç›´æ¥è¯·æ±‚çš„æ—¥å¿—ï¼Œå› ä¸º$remote_addrä¸ºç©º#æµ‹è¯•å“åº”å¤´add_header Lky $remote_addr always;GET / HTTP/1.1Host: example.comUser-Agent: Mozilla/5.0Lky: 192.168.1.100\n\n","categories":["ä¸­é—´ä»¶"]},{"title":"openvpn","url":"/2025/04/21/openvpn/","content":"å®‰è£…git clone https://github.com/likaiyuan00/openvpn-install.gitcd openvpn-install &amp;&amp; bash openvpn-install.sh#systemctl start openvpn@client.service å¯åŠ¨çš„è´¦å·å¯†ç   auth-user-pass æ§åˆ¶å®¢æˆ·ç«¯å¯†ç éªŒè¯echo &quot;test test@123&quot; &gt;  /etc/openvpn/userfile.sh\n\né…ç½®æ–‡ä»¶å­—æ®µè§£è¯»serverç«¯åœ¨#openvpnæœåŠ¡ç«¯çš„ç›‘å¬åœ°å€local 0.0.0.0#openvpnæœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤1194ï¼‰port 1115#ä½¿ç”¨çš„åè®®ï¼Œtcp/udpproto tcp#ä½¿ç”¨ä¸‰å±‚è·¯ç”±ipéš§é“ï¼ˆtunï¼‰ï¼Œè¿˜æ˜¯äºŒå±‚ä»¥å¤ªç½‘éš§é“ï¼ˆtapï¼‰ï¼Œä¸€èˆ¬ä½¿ç”¨tundev tun#caè¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€æœåŠ¡ç«¯ç§˜é’¥å’Œç§˜é’¥äº¤æ¢æ–‡ä»¶ca /etc/openvpn/server/ca.crtcert /etc/openvpn/server/server.crtkey /etc/openvpn/server/server.keydh /etc/openvpn/server/dh.pem#vpnæœåŠ¡ç«¯ä¸ºè‡ªå·±å’Œå®¢æˆ·ç«¯åˆ†é…çš„ipåœ°å€æ± ã€‚#æœåŠ¡ç«¯è‡ªå·±è·å–ç½‘æ®µçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼ˆæ­¤å¤„æ˜¯10.8.0.1ï¼‰ï¼Œåä¸ºå®¢æˆ·ç«¯åˆ†é…å…¶ä»–çš„å¯ç”¨åœ°å€ã€‚ä»¥åå®¢æˆ·ç«¯å°±å¯ä»¥å’Œ10.8.0.1è¿›è¡Œé€šä¿¡ã€‚æ³¨æ„ï¼šä»¥ä¸‹ç½‘æ®µåœ°å€ä¸è¦å’Œå·²æœ‰ç½‘æ®µå†²çªæˆ–é‡å¤server 10.8.0.0  255.255.255.0#ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶è®°å½•å·²åˆ†é…è™šæ‹Ÿipçš„å®¢æˆ·ç«¯å’Œè™šæ‹Ÿipçš„å¯¹åº”å…³ç³»ã€‚ä»¥åopenvpné‡å¯æ—¶ï¼Œå°†å¯ä»¥æŒ‰ç…§æ­¤æ–‡ä»¶ç»§ç»­ä¸ºå¯¹åº”çš„å®¢æˆ·ç«¯åˆ†é…æ­¤å‰ç›¸åŒçš„ipï¼ˆè‡ªåŠ¨ç»­å€Ÿipï¼‰ifconfig-pool-persist ipp.txt#ä½¿ç”¨tapæ¨¡å¼çš„æ—¶å€™è€ƒè™‘æ­¤é€‰é¡¹server-bridge XXXXXX#vpnæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€vpnæœåŠ¡ç«¯å†…ç½‘ç½‘æ®µçš„è·¯ç”±é…ç½®ï¼Œä»¥ä¾¿è®©å®¢æˆ·ç«¯èƒ½å¤Ÿæ‰¾åˆ°æœåŠ¡ç«¯çš„å†…ç½‘ã€‚å¤šæ¡è·¯ç”±å†™å¤šä¸ªpushæŒ‡ä»¤push &quot;route 10.0.10.0  255.255.255.0&quot;push &quot;route 192.168.10.0 255.255.255.0&quot;  #å…è®¸å®¢æˆ·ç«¯è®¿é—®çš„å†…ç½‘ç½‘æ®µ#è®©vpnå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥é€šä¿¡ã€‚é»˜è®¤æƒ…å†µå®¢æˆ·ç«¯åªèƒ½æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡#é»˜è®¤æ­¤é¡¹æ˜¯æ³¨é‡Šçš„ï¼Œå®¢æˆ·ç«¯ä¹‹é—´ä¸èƒ½ç›¸äº’é€šä¿¡client-to-client#å…è®¸å¤šä¸ªå®¢æˆ·ç«¯ä½¿ç”¨åŒä¸€ä¸ªvpnè´¦å·è¿æ¥æœåŠ¡ç«¯#é»˜è®¤æ˜¯æ³¨é‡Šçš„ï¼Œä¸æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯ç™»å½•ä¸€ä¸ªè´¦å·duplicate-cn#æ¯10ç§’pingä¸€æ¬¡ï¼Œ120ç§’åæ²¡æ”¶åˆ°pingå°±è¯´æ˜å¯¹æ–¹æŒ‚äº†keepalive 10 120#åŠ å¼ºè®¤è¯æ–¹å¼ï¼Œé˜²æ”»å‡»ã€‚å¦‚æœé…ç½®æ–‡ä»¶ä¸­å¯ç”¨æ­¤é¡¹ï¼ˆé»˜è®¤æ˜¯å¯ç”¨çš„ï¼‰ï¼Œéœ€è¦æ‰§è¡Œopenvpn --genkey --secret ta.keyï¼Œå¹¶æŠŠta.keyæ”¾åˆ°/etc/openvpn/server/ç›®å½•ï¼ŒæœåŠ¡ç«¯ç¬¬äºŒä¸ªå‚æ•°ä¸º0ï¼›åŒæ—¶å®¢æˆ·ç«¯ä¹Ÿè¦æœ‰æ­¤æ–‡ä»¶ï¼Œä¸”client.confä¸­æ­¤æŒ‡ä»¤çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦ä¸º1tls-auth /etc/openvpn/server/ta.key 0#é€‰æ‹©ä¸€ä¸ªå¯†ç ã€‚å¦‚æœåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨äº†cipheré€‰é¡¹ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡»åœ¨è¿™é‡ŒæŒ‡å®šå®ƒã€‚æ³¨æ„ï¼Œv2.4å®¢æˆ·ç«¯/æœåŠ¡ç«¯å°†åœ¨tlsæ¨¡å¼ä¸‹è‡ªåŠ¨åå•†AES-256-GCMcipher AES-256-CBC#openvpn 2.4ç‰ˆæœ¬çš„vpnæ‰èƒ½è®¾ç½®æ­¤é€‰é¡¹ã€‚è¡¨ç¤ºæœåŠ¡ç«¯å¯ç”¨lz4çš„å‹ç¼©åŠŸèƒ½ ï¼Œä¼ è¾“æ•°æ®ç»™å®¢æˆ·ç«¯æ—¶ä¼šå‹ç¼©æ•°æ®åŒ…ã€‚Pushååœ¨å®¢æˆ·ç«¯ä¹Ÿé…ç½®å¯ç”¨lz4çš„å‹ç¼©åŠŸèƒ½ï¼Œå‘æœåŠ¡ç«¯å‘æ•°æ®æ—¶ä¹Ÿä¼šå‹ç¼©ã€‚å¦‚æœæ˜¯2.4ç‰ˆæœ¬ä»¥ä¸‹çš„è€ç‰ˆæœ¬ï¼Œåˆ™ä½¿ç”¨ç”¨comp-lzoæŒ‡ä»¤compress lz4-v2push &quot;compress lz4-v2&quot;#å¯ç”¨lzoæ•°æ®å‹ç¼©æ ¼å¼ï¼Œæ­¤æŒ‡ä»¤ç”¨äºä½äº2.4ç‰ˆæœ¬çš„è€ç‰ˆæœ¬ï¼Œä¸”å¦‚æœæœåŠ¡ç«¯é…ç½®äº†è¯¥æŒ‡ä»¤ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¿…é¡»è¦é…ç½®comp-lzo#å¹¶å‘å®¢æˆ·ç«¯çš„è¿æ¥æ•°max-clients 1000#é€šè¿‡pingå¾—çŸ¥è¶…æ—¶æ—¶ï¼Œå½“é‡å¯vpnåå°†ä½¿ç”¨åŒä¸€ä¸ªç§˜é’¥æ–‡ä»¶ä»¥åŠä¿æŒtunè¿æ¥çŠ¶æ€persist-keypersist-tun#åœ¨æ–‡ä»¶ä¸­è¾“å‡ºå½“å‰çš„è¿æ¥ä¿¡æ¯ï¼Œæ¯åˆ†é’Ÿæˆªæ–­å¹¶é‡å†™ä¸€æ¬¡è¯¥æ–‡ä»¶status openvpn-status.log#logæŒ‡ä»¤è¡¨ç¤ºæ¯æ¬¡å¯åŠ¨vpnæ—¶è¦†ç›–å¼è®°å½•åˆ°æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¸­#log-appendåˆ™è¡¨ç¤ºæ¯æ¬¡å¯åŠ¨vpnæ—¶è¿½åŠ å¼çš„è®°å½•åˆ°æŒ‡å®šæ—¥å¿—ä¸­#ä½†ä¸¤è€…åªèƒ½é€‰å…¶ä¸€ï¼Œæˆ–è€…ä¸é€‰æ—¶è®°å½•åˆ°rsyslogä¸­log  /var/log/openvpn.loglog-append  /var/log/openvpn.log#æ—¥å¿—è®°å½•çš„è¯¦ç»†çº§åˆ«verb 3#å½“æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œé€šçŸ¥å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è‡ªåŠ¨é‡æ–°è¿æ¥ã€‚ä»…åœ¨UDPåè®®æ˜¯å¯ç”¨explicit-exit-notify 1#æ²‰é»˜çš„é‡å¤ä¿¡æ¯ã€‚æœ€å¤š20æ¡ç›¸åŒæ¶ˆæ¯ç±»åˆ«çš„è¿ç»­æ¶ˆæ¯å°†è¾“å‡ºåˆ°æ—¥å¿—mute 20\nclient#æ ‡è¯†è¿™æ˜¯ä¸ªå®¢æˆ·ç«¯client#ä½¿ç”¨çš„åè®®ï¼Œtcp/udpï¼ŒæœåŠ¡ç«¯æ˜¯ä»€ä¹ˆå®¢æˆ·ç«¯å°±æ˜¯ä»€ä¹ˆproto tcp#ä½¿ç”¨ä¸‰å±‚è·¯ç”±ipéš§é“ï¼ˆtunï¼‰ï¼Œè¿˜æ˜¯äºŒå±‚ä»¥å¤ªç½‘éš§é“ï¼ˆtapï¼‰ï¼ŒæœåŠ¡ç«¯æ˜¯ä»€ä¹ˆå®¢æˆ·ç«¯å°±æ˜¯ä»€ä¹ˆdev tun#æœåŠ¡ç«¯çš„åœ°å€å’Œç«¯å£remote 10.0.0.190 1194#ä¸€ç›´å°è¯•è§£æOpenVPNæœåŠ¡å™¨çš„ä¸»æœºåresolv-retry infinite#å¤§å¤šæ•°å®¢æˆ·æœºä¸éœ€è¦ç»‘å®šåˆ°ç‰¹å®šçš„æœ¬åœ°ç«¯å£å·nobind#åˆå§‹åŒ–åçš„é™çº§ç‰¹æƒ(ä»…éwindows)user nobodygroup nobody#å°è¯•åœ¨é‡æ–°å¯åŠ¨æ—¶ä¿ç•™æŸäº›çŠ¶æ€persist-keypersist-tun#caè¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯å¯†é’¥#å¦‚æœå®ƒä»¬å’Œclient.confæˆ–client.ovpnåœ¨åŒä¸€ä¸ªç›®å½•ä¸‹åˆ™å¯ä»¥ä¸å†™ç»å¯¹è·¯å¾„ï¼Œå¦åˆ™éœ€è¦å†™ç»å¯¹è·¯å¾„è°ƒç”¨ca ca.crtcert client.crtkey client.key#é€šè¿‡æ£€æŸ¥certicateæ˜¯å¦å…·æœ‰æ­£ç¡®çš„å¯†é’¥ä½¿ç”¨è®¾ç½®æ¥éªŒè¯æœåŠ¡å™¨è¯ä¹¦ã€‚remote-cert-tls server#åŠ å¼ºè®¤è¯æ–¹å¼ï¼Œé˜²æ”»å‡»ã€‚æœåŠ¡ç«¯æœ‰é…ç½®ï¼Œåˆ™å®¢æˆ·ç«¯å¿…é¡»æœ‰tls-auth ta.key 1#é€‰æ‹©ä¸€ä¸ªå¯†ç ã€‚å¦‚æœåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨äº†cipheré€‰é¡¹ï¼Œé‚£ä¹ˆæ‚¨ä¹Ÿå¿…é¡»åœ¨è¿™é‡ŒæŒ‡å®šå®ƒã€‚æ³¨æ„ï¼Œv2.4å®¢æˆ·ç«¯/æœåŠ¡å™¨å°†åœ¨TLSæ¨¡å¼ä¸‹è‡ªåŠ¨åå•†AES-256-GCMã€‚cipher AES-256-CBC# æœåŠ¡ç«¯ç”¨çš„ä»€ä¹ˆï¼Œå®¢æˆ·ç«¯å°±ç”¨çš„ä»€ä¹ˆ#è¡¨ç¤ºå®¢æˆ·ç«¯å¯ç”¨lz4çš„å‹ç¼©åŠŸèƒ½ï¼Œä¼ è¾“æ•°æ®ç»™å®¢æˆ·ç«¯æ—¶ä¼šå‹ç¼©æ•°æ®åŒ…comp-lzo# æ—¥å¿—çº§åˆ«verb 3#æ²‰é»˜çš„é‡å¤ä¿¡æ¯ã€‚æœ€å¤š20æ¡ç›¸åŒæ¶ˆæ¯ç±»åˆ«çš„è¿ç»­æ¶ˆæ¯å°†è¾“å‡ºåˆ°æ—¥å¿—mute 20\n\nå¦‚ä½•ç›´è¿openvpnæœåŠ¡ç«¯å…¶ä»–å±€åŸŸç½‘æœåŠ¡å™¨\nå®¢æˆ·ç«¯ï¼ˆ10.8.0.10ï¼‰ ping (æœåŠ¡ç«¯)172.16.1.7 æ­£å¸¸ ping (æœåŠ¡ç«¯å…¶ä»–å†…ç½‘æœºå™¨)172.16.1.8å¤±è´¥\n\n\nç¬¬ä¸€ç§æ–¹æ³• é…ç½®è·¯ç”±route add -net 10.8.0.0 netmask 255.255.255.0 gw 172.16.1.710.8.0.0  å®¢æˆ·ç«¯IP172.16.1.7 openvpn æœåŠ¡ç«¯IP\n\n\n\n\n\n\n\nç¬¬äºŒç§æ–¹æ³•ä½¿ç”¨snatè½¬å‘ iptables -t nat -A POSTROUTING -d 10.8.0.0&#x2F;24 -o eth0 -j MASQUERADEiptables -A FORWARD -s 10.8.0.0 -j ACCEPT\n\n\n\né¢å¤–æœåŠ¡ç«¯route 192.168.0.0 255.255.0.0   æŒ‡ä»¤ä½œç”¨æ˜¯åœ¨æœåŠ¡ç«¯åŠ ä¸€æ¡è·¯ç”±ï¼Œç½‘å…³æ˜¯å®¢æˆ·ç«¯ip\næœåŠ¡ç«¯åªèƒ½pingé€šå®¢æˆ·ç«¯çš„tun0çš„ipï¼Œå†…ç½‘ipä¸è¡Œï¼Œå³ä½¿åŠ äº†è·¯ç”±ä¹Ÿä¸è¡Œ\nå®¢æˆ·ç«¯push â€œroute 192.168.10.0 255.255.255.0â€ä½œç”¨æ˜¯åœ¨å®¢æˆ·ç«¯å¤šåŠ ä¸€æ¡è·¯ç”±ã€‚ç½‘å…³æ˜¯æœåŠ¡ç«¯çš„tun0IPï¼ˆä¹Ÿå°±æ˜¯server æŒ‡ä»¤é…ç½®åˆ†é…çš„åœ°å€æ± ï¼‰\n","categories":["linux"]},{"title":"prometheus","url":"/2025/04/18/prometheus/","content":"https://github.com/likaiyuan00/k8s-prometheus.git\nk8s-prometheuséƒ¨ç½²kubernetes_sd_configsé…ç½®æ–‡ä»¶åªé‡‡é›†äº†\n\n1 prometheus*  prometheus-server2 container*   kubelet çš„10250ç«¯å£  &#x2F;metrics&#x2F;cadvisor3 node*    node_exporter4 apiserver*  apiserver 6443 ç«¯å£ &#x2F;metrics5 kube*  kube-state-metricsç»„ä»¶ 8080ç«¯å£ &#x2F;metrics6 coredns*  kubernetes-pods è‡ªåŠ¨å‘ç° podéœ€è¦é…ç½® prometheus.io&#x2F;scrape: â€œtrueâ€ ä¸ç„¶æŠ“å–ä¸åˆ° é»˜è®¤flaseprometheus.io&#x2F;path: â€œ&#x2F;metricsâ€   # æŒ‡æ ‡è·¯å¾„ï¼ˆé»˜è®¤ &#x2F;metrics å¯ä¸å†™ï¼‰7 kubelet*  apiserverä»£ç†ç«¯ç‚¹ &#x2F;api&#x2F;v1&#x2F;nodes&#x2F;&lt;node-name&gt;&#x2F;proxy&#x2F;metricså…¶ä»–æœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œé…ç½®\n\nå¯¼å…¥é•œåƒï¼Œæ‰§è¡Œymlæ–‡ä»¶å³å¯\nprometheusæ•ˆæœå›¾\ngrafanaæ•ˆæœå›¾\nkubelet ç»„ä»¶ kubelet ä¸‰ä¸ªæŒ‡æ ‡ &#x2F;metrics&#x2F;probesï¼ˆæ¢é’ˆï¼‰ &#x2F;metrics&#x2F;cadvisorï¼ˆpodï¼‰ &#x2F;metricsï¼ˆnodeï¼‰\nå¯¹åº”apiserverçš„ &#x2F;api&#x2F;v1&#x2F;nodes&#x2F;${node-name}&#x2F;proxy&#x2F;${url};ä¸€èˆ¬ä¸ºäº†å‡å°‘apiserverçš„è´Ÿè½½ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ **\nç›´æ¥è®¿é—®ä¼šæŠ¥401æ²¡æœ‰æƒé™\néœ€è¦å…ˆè·å–tokenï¼Œä¸Šé¢æ–‡ä»¶æ‰§è¡Œå®Œä¼šæœ‰ä¸€ä¸ªprometheusç”¨æˆ·\npodå†…tokenè·¯å¾„ä¸º &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token\né€šè¿‡tokenå†å»è®¿é—®å‘ç°å°±æ­£å¸¸äº†\n/metricscurl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:6443/api/v1/nodes/master/proxy/metricscurl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:10250/metrics\n\nå¯¹åº”kubelet*å¼€å¤´\n/metrics/probesï¼ˆæ¢é’ˆï¼‰curl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:6443/api/v1/nodes/master/proxy/metrics/probescurl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:10250/metrics/probes\n\n/metrics/cadvisorï¼ˆpodï¼‰curl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:6443/api/v1/nodes/master/proxy/metrics/cadvisorcurl -k -sS  -H &quot;Authorization: Bearer $TOKEN&quot;  https://127.0.0.1:10250/metrics/cadvisor\n\nå¯¹åº”container*å¼€å¤´ï¼Œå®¹å™¨æŒ‡æ ‡\nnode_exporterç«¯å£æš´éœ²åˆ°èŠ‚ç‚¹äº†å°±ä¸éœ€è¦tokenäº†\nnode*å¼€å¤´ï¼ŒèŠ‚ç‚¹æŒ‡æ ‡\nkube-state-metricsé›†ç¾¤åº”ç”¨çŠ¶æ€ç›‘æ§æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªéœ€è¦å•ç‹¬å®‰è£…ä½¿ç”¨containerPort: 8080 æš´éœ²åˆ°èŠ‚ç‚¹äº†ä¸éœ€è¦token\nkube*å¼€å¤´\napiserverä¸»è¦æ˜¯ç›‘æ§apiserverçš„qps,æŸ¥è¯¢æˆåŠŸç‡å¤±è´¥ç‡ç­‰ä¿¡æ¯\napiserver*å¼€å¤´\nkubernetes-pods è‡ªåŠ¨å‘ç°å¦‚æœå…ƒæ•°æ®å†…è®¾ç½®trueï¼Œè¯¥podæ‰å¯ä»¥è¢«æŠ“å–ï¼Œé»˜è®¤false\nä»¥corednsä¸ºä¾‹\nä»¥coredns*å¼€å¤´\nè¿™ä¸ªè‡ªåŠ¨å‘ç°è¿˜å¯ä»¥é…ç½®è‡ªèº«ä¸šåŠ¡çš„ç›‘æ§ï¼Œåªæœ‰ä¿è¯å¼€å¯æŠ“å–ï¼Œå’Œç¬¦åˆprometheusæŠ“å–è§„èŒƒå°±å¯ä»¥ï¼Œå¦‚æœå¼€å¯äº†prometheus.io&#x2F;scrape ä½†æ˜¯podå¹¶æ²¡æœ‰æä¾›æ•°æ®æŒ‡æ ‡çš„èƒ½åŠ›å°±ä¼šç›´æ¥æŠ¥é”™ï¼Œå¦‚å›¾404\næ¯”å¦‚ç°åœ¨æˆ‘æƒ³åŠ ä¸€ä¸ªgrafanaçš„æ•°æ®ï¼Œåªéœ€è¦æ·»åŠ å¯¹åº”å…ƒæ•°æ®å°±å¯ä»¥äº†\nprometheuså°±è‡ªåŠ¨å‘ç°äº†podçš„ip\ngrafana*å¼€å¤´\n","categories":["prometheus"],"tags":["prometheus"]},{"title":"prometheusè¿›é˜¶","url":"/2025/08/22/prometheus%E8%BF%9B%E9%98%B6/","content":"deploy#!/bin/bash# åˆ›å»ºç›®å½•ç»“æ„mkdir -p monitoring/prometheuscd monitoring# ç”Ÿæˆdocker-compose.yml,nodeå’Œprocesså¿…é¡»ä½¿ç”¨hostå®¿ä¸»æœºç½‘ç»œï¼Œä¸ç„¶å¾ˆå¤šæŒ‡æ ‡åªèƒ½é‡‡é›†åˆ°å®¹å™¨é‡Œé¢çš„ä¿¡æ¯ä¸å‡†ç¡®cat &gt; docker-compose.yml &lt;&lt; EOFversion: &#x27;3.8&#x27;networks:  monitoring:    driver: bridgeservices:  prometheus:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/prometheus:v2.40.7    container_name: prometheus    restart: unless-stopped    ports:      - &quot;9090:9090&quot;    volumes:      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml      - prom_data:/prometheus    networks:      - monitoring    command:      - &#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;      - &#x27;--storage.tsdb.retention.time=30d&#x27;      - &#x27;--web.enable-lifecycle&#x27; #curl -X POST http://localhost:9090/-/reload  node-exporter:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/nodeexporter:v1.9.1    container_name: node-exporter    restart: unless-stopped    command:      - &#x27;--path.rootfs=/host&#x27;      - &#x27;--web.listen-address=:9400&#x27;   # networks:  # åŠ å…¥ç›‘æ§ç½‘ç»œ    #  - monitoring    network_mode: host  # ä½¿ç”¨hostç½‘ç»œ    pid: host    volumes:      - /:/host:ro,rslave  blackbox-exporter:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/nodeexporter:blackbox-exporterv0.27.0    container_name: blackbox-exporter    restart: unless-stopped    ports:      - &quot;9115:9115&quot;    networks:      - monitoring    volumes:      - ./blackbox.yml:/etc/blackbox_exporter/config.yml    command:      - &#x27;--config.file=/etc/blackbox_exporter/config.yml&#x27;  process-exporter:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/nodeexporter:process-exporter-v0.8.7    container_name: process-exporter    restart: unless-stopped    network_mode: host  # ä½¿ç”¨hostç½‘ç»œ   # networks:   #   - monitoring  # ä½¿ç”¨ç»Ÿä¸€ç½‘ç»œ    ports:      - &quot;9256:9256&quot;  # æ·»åŠ ç«¯å£æ˜ å°„    volumes:      - /proc:/host/proc:ro      - ./process-exporter.yml:/config.yml    command:      - &#x27;-config.path=/config.yml&#x27;      - &#x27;-procfs=/host/proc&#x27;volumes:  prom_data:EOF# ç”ŸæˆPrometheusé…ç½®cat &gt; prometheus/prometheus.yml &lt;&lt;EOFglobal:  scrape_interval: 15s  evaluation_interval: 15sscrape_configs:  - job_name: &#x27;prometheus&#x27;    static_configs:      - targets: [&#x27;localhost:9090&#x27;]  - job_name: &#x27;node&#x27;    static_configs:      - targets: [&#x27;node-exporter:9400&#x27;] #hostæ¨¡å¼éœ€è¦æ¢æˆå®¿ä¸»æœºip  - job_name: &#x27;blackbox-http&#x27;    metrics_path: /probe    params:      module: [http_2xx]    static_configs:      - targets:        - https://qq.com        - https://google.com    relabel_configs:      - source_labels: [__address__]        target_label: __param_target      - source_labels: [__param_target]        target_label: instance      - target_label: __address__        replacement: blackbox-exporter:9115  - job_name: &#x27;process-exporter&#x27;    static_configs:      - targets: [&#x27;process-exporter:9256&#x27;] #hostæ¨¡å¼éœ€è¦æ¢æˆå®¿ä¸»æœºipEOF# ç”ŸæˆBlackboxé…ç½®cat &gt; blackbox.yml &lt;&lt;EOFmodules:  http_2xx:    prober: http    timeout: 5s    http:      valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]      valid_status_codes: [200]      method: GET      preferred_ip_protocol: &quot;ip4&quot;EOF# ç”ŸæˆProcess Exporteré…ç½®cat &gt; process-exporter.yml &lt;&lt;EOFprocess_names:  - name: &quot;&#123;&#123;.Comm&#125;&#125;&quot;    cmdline:    - &#x27;.+&#x27;  # æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒ¹é…ä»»ä½•éç©ºå†…å®¹ï¼‰  #- name: &quot;&#123;&#123;.Matches&#125;&#125;&quot; #   cmdline: #     - &#x27;nginx&#x27;  # åªç›‘æ§ nginx è¿›ç¨‹ # - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;  #  cmdline:  #    - &#x27;docker&#x27;  # åªç›‘æ§ docker è¿›ç¨‹EOF# å¯åŠ¨æœåŠ¡docker compose up -decho -e &quot;\\n\\033[32méƒ¨ç½²å®Œæˆï¼ä»¥ä¸‹æ˜¯è®¿é—®ä¿¡æ¯ï¼š\\033[0m&quot;echo &quot;Prometheus:     http://localhost:9090&quot;echo &quot;Node Exporter:  http://localhost:9100/metrics&quot;echo &quot;Blackbox:       http://localhost:9115/metrics&quot;echo &quot;Process-Exporter: http://localhost:9256/metrics&quot;echo -e &quot;\\nè¯·ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶åé‡å¯æœåŠ¡ï¼š&quot;echo &quot;- blackbox.yml ä¸­çš„ç›‘æ§ç›®æ ‡&quot;echo &quot;- process-exporter.yml ä¸­çš„è¿›ç¨‹è¿‡æ»¤è§„åˆ™&quot;\n\n\nå¦‚æœèŠ‚ç‚¹è¾ƒå¤šprometheuså¯¹æ‰€æœ‰æŒ‡æ ‡çš„é‡‡é›†ä¼šå¯¹è´Ÿè½½å’Œç£ç›˜å ç”¨è¾ƒå¤šï¼Œå¯ä»¥é€šè¿‡relabel dropä¸éœ€è¦çš„æŒ‡æ ‡ï¼Œå‡è½»è´Ÿæ‹…#relabel_configs\tæŠ“å–å‰ï¼Œé’ˆå¯¹target#metric_relabel_configs æŠ“å–åï¼Œé’ˆå¯¹æŒ‡æ ‡åç§°scrape_configs:  - job_name: &#x27;node-drop&#x27;     static_configs:      - targets: [&#x27;localhost:9100&#x27;]    metric_relabel_configs:      - source_labels: [__name__]        regex: &#x27;^(node_cpu_seconds_total|node_memory_.*|node_disk_.*|node_network_.*)$&#x27;        action: keep  - job_name: &#x27;node&#x27;    static_configs:      - targets: [&#x27;node1:9100&#x27;, &#x27;node2:9100&#x27;,&#x27;master:9100&#x27;]    relabel_configs:      # æ ¹æ®ç›®æ ‡åœ°å€åŠ¨æ€æ·»åŠ  environment æ ‡ç­¾      - source_labels: [__address__]        regex: &#x27;node1:9100&#x27;        replacement: &#x27;prod&#x27;        target_label: environment      - source_labels: [__address__]        regex: &#x27;node2:9100&#x27;        replacement: &#x27;staging&#x27;        target_label: environment      # åªä¿ç•™ä¸»æœºååŒ…å« &quot;node&quot; çš„ç›®æ ‡      - source_labels: [__address__]        regex: &#x27;node[0-9]+:9100&#x27;  # æ­£åˆ™åŒ¹é… node1, node2 ç­‰        action: keep      - source_labels: [__meta_kubernetes_pod_label_app]        regex: &quot;nginx|api-server&quot;  # åªæŠ“å–å¸¦æœ‰ app=nginx æˆ– app=api-server æ ‡ç­¾çš„ Pod        action: keep# ä»…å¯ç”¨ cpu å’Œ meminfo æ”¶é›†å™¨;ä¸å¥½ç”¨node_exporter \\  --collector.cpu \\  --collector.meminfo \\  --no-collector.diskstats \\  --no-collector.netdev \\  --no-collector.filesystem \\  # ç¦ç”¨å…¶ä»–æ‰€æœ‰æ”¶é›†å™¨...\n\nfile_sdå¯ä»¥åŸºäºæ–‡ä»¶åŠ¨æ€æ›´æ–° prometheus çš„ç›‘æ§èŠ‚ç‚¹\n#æ–‡ä»¶ç±»å‹/etc/prometheus/targets/nodes.json[  &#123;    &quot;targets&quot;: [&quot;192.168.1.10:9100&quot;],  # ç›‘æ§ç›®æ ‡åœ°å€ï¼ˆIP:Portï¼‰    &quot;labels&quot;: &#123;                        # è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰      &quot;env&quot;: &quot;prod&quot;,      &quot;role&quot;: &quot;web-server&quot;    &#125;  &#125;,  &#123;    &quot;targets&quot;: [&quot;192.168.1.11:9100&quot;,&quot;192.168.3.11:9100&quot;],    &quot;labels&quot;: &#123;      &quot;env&quot;: &quot;staging&quot;,      &quot;role&quot;: &quot;db-server&quot;    &#125;  &#125;]#prometheusé…ç½®scrape_configs:  - job_name: &quot;node-exporter&quot;            # ä»»åŠ¡åç§°    file_sd_configs:                     # å¯ç”¨ file_sd      - files:          - &quot;/etc/prometheus/targets/*.json&quot;  # ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰          - &quot;/etc/prometheus/targets/mysql-exporters/*.json&quot; # MySQL ç›‘æ§        refresh_interval: 5m             # é‡æ–°åŠ è½½é—´éš”ï¼ˆé»˜è®¤ 5mï¼‰\nnode exporter textfile#!/bin/bashDURATION=15         # é»˜è®¤æŠ“åŒ…æ—¶é•¿ï¼ˆå»ºè®®æ¯” cron é—´éš”ç¨çŸ­ï¼‰INTERFACE=&quot;eth0&quot;OUTPUT_FILE=&quot;/tmp/traffic.pcap&quot;METRICS_FILE=&quot;/etc/node-exporter/textfile-collector/network_traffic.prom&quot;  # Node Exporter æ”¶é›†ç›®å½•# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœªå®‰è£…ï¼‰if ! command -v tcpdump &amp;&gt;/dev/null || ! command -v tshark &amp;&gt;/dev/null; then    echo &quot;å®‰è£…ä¾èµ–: tcpdump å’Œ tshark...&quot;    sudo apt-get update &amp;&amp; sudo apt-get install -y tcpdump tsharkfi# æ•è·æµé‡sudo timeout $DURATION tcpdump -i $INTERFACE -w $OUTPUT_FILE &gt;/dev/null 2&gt;&amp;1# ç”Ÿæˆ Prometheus æ ¼å¼çš„æŒ‡æ ‡sudo tshark -r $OUTPUT_FILE -T fields -e ip.src -e ip.dst -e frame.len 2&gt;/dev/null \\  | awk &#x27;    BEGIN &#123;        total_bytes = 0        delete bytes  # æ¸…ç©ºæ•°ç»„    &#125;    &#123;        bytes[$1] += $3;  # æºIPç»Ÿè®¡        bytes[$2] += $3;  # ç›®çš„IPç»Ÿè®¡        total_bytes += $3    &#125;    END &#123;        # è¾“å‡ºæ€»æµé‡æŒ‡æ ‡        print &quot;network_traffic_total_bytes &quot; total_bytes        # è¾“å‡ºæ¯ä¸ªIPçš„æµé‡æŒ‡æ ‡        for (ip in bytes) &#123;            if (ip != &quot;&quot;) &#123;  # è¿‡æ»¤ç©ºå€¼                printf &quot;network_traffic_bytes&#123;ip=\\&quot;%s\\&quot;&#125; %d\\n&quot;, ip, bytes[ip]            &#125;        &#125;    &#125;&#x27; &gt; &quot;$METRICS_FILE.$$&quot;  # å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶# åŸå­æ“ä½œæ›¿æ¢æ–‡ä»¶ï¼ˆé¿å…è¯»å–åŠæˆå“ï¼‰sudo mv &quot;$METRICS_FILE.$$&quot; &quot;$METRICS_FILE&quot;# æ¸…ç†sudo rm -f &quot;$OUTPUT_FILE&quot;./node_exporter  --web.listen-address=&quot;:900&quot; --collector.textfile.directory=/etc/node-exporter/textfile-collector/\n\n\n\n\n\n\n\nblackbox_exporter#blackbox.ymlé…ç½®ï¼Œproberç±»å‹å¯ä»¥è‡ªå®šä¹‰http,tcp,icmp,dnsmodules:  http_2xx:    prober: http    timeout: 5s    http:      valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]      valid_status_codes: [200]      method: GET      preferred_ip_protocol: &quot;ip4&quot;  ssh_banner_check:  # è‡ªå®šä¹‰æ¨¡å—å    prober: tcp    timeout: 10s    tcp:      query_response:        - expect: &quot;^SSH-2.0-OpenSSH&quot;          send: &quot;SSH-2.0-blackbox-ssh-check&quot;      preferred_ip_protocol: &quot;ip4&quot;# prometheusé›†æˆscrape_configs: - job_name: &#x27;blackbox-http&#x27;    metrics_path: /probe    params:      module: [http_2xx]    static_configs:      - targets:        - https://qq.com        - https://google.com    relabel_configs: &amp;common_relabel      - source_labels: [__address__]        target_label: __param_target      - source_labels: [__param_target]        target_label: instance      - target_label: __address__        replacement: blackbox-exporter:9115  - job_name: &#x27;blackbox-ssh&#x27;    metrics_path: /probe    params:      module: [ssh_banner_check]  # å¯¹åº”TCPæ¨¡å—    static_configs:      - targets:        - &#x27;127.0.0.1:22&#x27;        - &#x27;10.0.1.122:22&#x27;    relabel_configs: *common_relabel#relabel_configsé…ç½®è§£æPrometheus æŠ“å–ä»»åŠ¡ç”Ÿæˆâ”‚â”œâ”€ åŸå§‹ç›®æ ‡: example.com:80â”‚  â”‚â”‚  â”œâ”€ relabel è§„åˆ™1: å°†åœ°å€èµ‹å€¼ç»™ __param_target â†’ ?target=example.com:80â”‚  â”œâ”€ relabel è§„åˆ™2: ç”¨ __param_target æ ‡è®° instance â†’ instance=&quot;example.com:80&quot;â”‚  â””â”€ relabel è§„åˆ™3: é‡å†™åœ°å€ â†’ å®é™…è¯·æ±‚å‘é€åˆ° Blackbox Exporterâ”‚     â”‚â”‚     â””â”€ Blackbox Exporter æ”¶åˆ°è¯·æ±‚ï¼Œè§£æå‚æ•°åæ¢æµ‹ example.com:80â”‚â””â”€ åŸå§‹ç›®æ ‡: google.com:443   â””â”€ åŒç†ç”Ÿæˆè¯·æ±‚ http://192.168.100.100:9115/probe?target=google.com:443&amp;module=http_2xx#å‘Šè­¦ingprobe_success&#123;job=&quot;blackbox-http&quot;&#125; == 0#çŠ¶æ€ç probe_http_status_code&#123;job=&quot;blackbox-http&quot;&#125; &lt; 200 or probe_http_status_code&#123;job=&quot;blackbox-http&quot;&#125; &gt;= 300#è¯ä¹¦è¿‡æœŸæ—¶é—´probe_ssl_earliest_cert_expiry&#123;job=&quot;blackbox-http&quot;&#125; - time() &lt; 86400 * 30  # 30å¤©#tcpç«¯å£æ˜¯å¦é€šprobe_success&#123;job=&quot;blackbox-tcp&quot;&#125; == 0#å“åº”æ—¶é•¿probe_duration_seconds&#123;job=&quot;blackbox-http&quot;&#125; &gt; 1#è§£ææ—¶é•¿probe_dns_lookup_time_seconds\n\n\n\n\n\nprocess-exporter&#123;&#123;.Comm&#125;&#125; åŒ…å«åŸå§‹å¯æ‰§è¡Œæ–‡ä»¶çš„åŸºæœ¬åç§°ï¼Œå³ /proc/&lt;pid&gt;/stat ä¸­çš„ç¬¬ 2 ä¸ªå­—æ®µï¼Œå¹¶æˆªå–å‰15ä¸ªå­—ç¬¦&#123;&#123;.ExeBase&#125;&#125; åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„åŸºæœ¬åç§°  &#123;&#123;.ExeFull&#125;&#125; åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œå…¨é™å®šè·¯å¾„  &#123;&#123;.Username&#125;&#125; åŒ…å«æœ‰æ•ˆç”¨æˆ·çš„ç”¨æˆ·å  &#123;&#123;.Matches&#125;&#125; map åŒ…å«åº”ç”¨ cmdline æ­£åˆ™è¡¨è¾¾å¼äº§ç”Ÿçš„æ‰€æœ‰åŒ¹é…é¡¹&#123;&#123;.PID&#125;&#125; åŒ…å«è¿›ç¨‹çš„ PIDã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨ PID æ„å‘³ç€è¯¥ç»„å°†ä»…åŒ…å«ä¸€ä¸ªè¿›ç¨‹&#123;&#123;.StartTime&#125;&#125; åŒ…å«è¿›ç¨‹çš„å¼€å§‹æ—¶é—´ã€‚è¿™ä¸ PID ç»“åˆä½¿ç”¨æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸º PID ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œè¢«é‡ç”¨ã€‚&#123;&#123;.Cgroups&#125;&#125; åŒ…å«ï¼ˆå¦‚æœæ”¯æŒï¼‰è¿›ç¨‹çš„ cgroups ï¼ˆ/proc/self/cgroupï¼‰ã€‚è¿™å¯¹äºè¯†åˆ«è¿›ç¨‹å±äºå“ªä¸ªå®¹å™¨ç‰¹åˆ«æœ‰ç”¨#process-exporter.yml#å¸¸ç”¨çš„å°±commå’Œexefull,matchesprocess_names:  #- name: &quot;&#123;&#123;.ExeFull&#125;&#125;&quot;   #  cmdline:  #  - &#x27;.+&#x27;  # æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒ¹é…ä»»ä½•éç©ºå†…å®¹ï¼‰ä¸å¸¸ç”¨å¤ªå¤šäº†å½±å“èµ„æºæ¶ˆè€—  - name: &quot;&#123;&#123;.Comm&#125;&#125;&quot; #groupname=&quot;docker&quot;    cmdline:    - &#x27;docker*&#x27;   - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot; #groupname=&quot;map[:nginx]&quot;    cmdline:    - &#x27;nginx*&#x27;   - name: &quot;&#123;&#123;.ExeFull&#125;&#125;&quot;  #groupname=&quot;/usr/sbin/mysqld    cmdline:    - &#x27;mysql*&#x27;                #å‘Šè­¦...namedprocess_namegroup_num_procs&#123;groupname!~&quot;.*process-exporter.*&quot;&#125; == 0namedprocess_namegroup_states&#123;state=&quot;Z&quot;&#125; &gt; 0namedprocess_namegroup_num_procs&#123;groupname=&quot;nginx&quot;&#125; == 0#cpuç™¾åˆ†æ¯”100 * rate(namedprocess_namegroup_cpu_seconds_total&#123;groupname=&quot;java&quot;&#125;[5m])100 * rate(namedprocess_namegroup_cpu_seconds_total&#123;&#125;[5m]) &gt; 50#å†…å­˜ mbnamedprocess_namegroup_memory_bytes&#123;groupname=&quot;java&quot;&#125; / 1024^2é™¤äº#èŠ‚ç‚¹å†…å­˜ å°±æ˜¯å ç”¨å†…å­˜ç™¾åˆ†æ¯”node_memory_MemTotal_bytes / 1024 / 1024 # è¯»é€Ÿç‡ MB/Srate(namedprocess_namegroup_read_bytes_total&#123;groupname=&quot;mysql&quot;&#125;[5m]) / 1024^2# å†™é€Ÿç‡rate(namedprocess_namegroup_write_bytes_total&#123;groupname=&quot;mysql&quot;&#125;[5m]) / 1024^2\n\nprometheusè”é‚¦\næ•°é‡è¾ƒå¤šçš„æƒ…å†µä¸‹ä»å¤šä¸ªä¸‹çº§ Prometheus å®ä¾‹ä¸­æå–ç‰¹å®šæŒ‡æ ‡ï¼Œæ±‡æ€»åˆ°ä¸­å¿ƒ Prometheus                Central Prometheus                        â†‘        ä»å¤šä¸ªä¸‹çº§æ‹‰å–èšåˆåçš„æŒ‡æ ‡                        |        +---------------+---------------+        |               |               |   Region A       Region B       Region C   Prometheus    Prometheus    Prometheusscrape_configs:  - job_name: &#x27;federate-regions&#x27;        # ä»»åŠ¡åç§°    scrape_interval: 1m                # å»ºè®®æ¯”ä¸‹çº§é‡‡é›†é—´éš”é•¿    honor_labels: true                 # ä¿ç•™ä¸‹çº§æ ‡ç­¾ï¼ˆé¿å…è¦†ç›–ï¼‰    metrics_path: &#x27;/federate&#x27;          # è”é‚¦æ¥å£è·¯å¾„    params:      &#x27;match[]&#x27;:        - &#x27;&#123;job=&quot;api-server&quot;&#125;&#x27;         # æ‹‰å–ä¸‹çº§çš„æŒ‡å®š job æŒ‡æ ‡        - &#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;        - &#x27;up&#123;instance=~&quot;.+&quot;&#125;&#x27;         # æ‹‰å–æ‰€æœ‰ä¸‹çº§å®ä¾‹çš„ up çŠ¶æ€    static_configs:      - targets:          - &#x27;prometheus-region-a:9090&#x27; # ä¸‹çº§ Prometheus åœ°å€          - &#x27;prometheus-region-b:9090&#x27;          - &#x27;prometheus-region-c:9090&#x27;match[] è¿‡æ»¤æ¡ä»¶ç²¾ç¡®åŒ¹é…ï¼š&#x27;&#123;job=&quot;mysql&quot;&#125;&#x27; æ‹‰å–æ‰€æœ‰ job=mysql çš„æŒ‡æ ‡ã€‚æ­£åˆ™åŒ¹é…ï¼š&#x27;__name__=~&quot;http_request_.+&quot;&#x27; æ‹‰å–ä»¥ http_request_ å¼€å¤´çš„æŒ‡æ ‡ã€‚ç»„åˆæ¡ä»¶ï¼š&#x27;&#123;env=&quot;prod&quot;, app=~&quot;web|api&quot;&#125;&#x27; æ‹‰å– prod ç¯å¢ƒä¸‹ web æˆ– api åº”ç”¨çš„æŒ‡æ ‡ã€‚\n\n","categories":["prometheus"]},{"title":"proxysql","url":"/2025/08/19/proxysql/","content":"\nproxysqlæ˜¯ä¸€æ¬¾ä»£ç†æ•°æ®åº“çš„å¼€æºè½¯ä»¶ï¼Œæ­¤å¤–è¿˜æœ‰maxsaclehttps://github.com/sysown/proxysql\n\næ­å»ºè¯»å†™åˆ†ç¦»mkdir -p proxysql &amp;&amp; cd proxysqlmkdir -p mysql/&#123;master,proxysql,slave&#125;/conf#proxysql.cnfé…ç½®datadir=&quot;/var/lib/proxysql&quot;mysql_servers =(    &#123;        address = &quot;mysql-master&quot;        port = 3306        hostgroup = 10  # å†™ç»„        max_connections = 200    &#125;,    &#123;        address = &quot;mysql-slave&quot;        port = 3306        hostgroup = 20  # è¯»ç»„      #  weight = 110        max_connections = 1000    &#125;,    #  &#123;  #      address = &quot;mysql-slave2&quot;   # ä»åº“2  #      port = 3306  #      hostgroup_id = 20   #     weight = 100  #      max_connections = 500   # &#125;)#CREATE USER &#x27;appuser&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;AppUser123!&#x27;;#GRANT ALL PRIVILEGES ON *.* TO &#x27;appuser&#x27;@&#x27;%&#x27;;mysql_users =(    &#123;        username = &quot;appuser&quot; #åç«¯mysqlçš„ç”¨æˆ·        password = &quot;AppUser123!&quot;        default_hostgroup = 10    &#125;)mysql_query_rules =(    &#123;        rule_id = 100 #è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜        active = 1  #è§„åˆ™æ˜¯å¦å¯ç”¨ï¼š1 å¯ç”¨ï¼Œ0 ç¦ç”¨        match_pattern = &quot;^SELECT&quot; #åŒ¹é…è¯»è¯·æ±‚        destination_hostgroup = 20 #åŒ¹é…çš„ SQL è¯·æ±‚è·¯ç”±åˆ°çš„ä¸»æœºç»„        apply = 1 #æ˜¯å¦åœ¨åŒ¹é…åç»ˆæ­¢åç»­è§„åˆ™åŒ¹é…ï¼š1 ç»ˆæ­¢ï¼Œ0 ç»§ç»­    &#125;,    &#123;        rule_id = 200        active = 1        match_pattern = &quot;^((?!SELECT).)*$&quot;         destination_hostgroup = 10        apply = 1    &#125;)#docker exec -it proxysql-proxysql-1 mysql -uadmin -padmin -h127.0.0.1 -P6032#6032æ˜¯ç®¡ç†ç«¯å£ï¼Œæ˜¾ç¤ºçš„æ˜¯proxysqlçš„å…ƒæ•°æ®è¡¨ï¼Œ#å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ä¿®æ”¹é»˜è®¤å¯†ç admin#UPDATE global_variables SET variable_value=&#x27;admin:new_password&#x27; WHERE variable_name=&#x27;admin-admin_credentials&#x27;;#SELECT * FROM global_variables  WHERE variable_name LIKE &#x27;admin-admin_%&#x27;;#mysql -uappuser -pAppUser123! -h127.0.0.1 -P6033 #6033æ˜¯æœåŠ¡ç«¯å£ï¼Œç›´æ¥å¯ä»¥è·¯ç”±åˆ°åç«¯mysql#masteré…ç½®[mysqld]server_id = 1log_bin = mysql-binbinlog_format = ROW#slaveé…ç½®[mysqld]server_id = 2relay_log = mysql-relay-binread_only = 1#======================================================================================cat &gt;&gt; docker-compose.yaml &lt;&lt; &#x27;EOF&#x27;version: &#x27;3.8&#x27;services:  mysql-master:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mysql:8.0.43    networks:      - mysql-network    environment:      MYSQL_ROOT_PASSWORD: MasterRoot123!      MYSQL_REPLICATION_USER: repl      MYSQL_REPLICATION_PASSWORD: ReplPass123!    volumes:      - ./mysql/master/conf:/etc/mysql/conf.d      - ./mysql/master/data:/var/lib/mysql    command:      - --character-set-server=utf8mb4      - --collation-server=utf8mb4_unicode_ci  mysql-slave:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mysql:8.0.43    networks:      - mysql-network    environment:      MYSQL_ROOT_PASSWORD: SlaveRoot123!    volumes:      - ./mysql/slave/conf:/etc/mysql/conf.d      - ./mysql/slave/data:/var/lib/mysql    command:      - --character-set-server=utf8mb4      - --collation-server=utf8mb4_unicode_ci  proxysql:    image: registry.cn-hangzhou.aliyuncs.com/lky-deploy/mysql:proxysql    networks:      - mysql-network    ports:      - &quot;6033:6033&quot;      - &quot;6032:6032&quot;    volumes:      - ./mysql/proxysql/proxysql.cnf:/etc/proxysql.cnf    depends_on:      - mysql-master      - mysql-slavenetworks:  mysql-network:    driver: bridgeEOF#===================================================================================#é…ç½®ä¸»ä»å¤åˆ¶#8.4ç‰ˆæœ¬ä»¥ä¸Šè¯­æ³• SHOW BINARY LOG STATUS;docker exec -it proxysql-mysql-master-1 mysql -uroot -p&quot;MasterRoot123!&quot; -e \\&quot;CREATE USER &#x27;repl&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;ReplPass123!&#x27;; \\GRANT REPLICATION SLAVE ON *.* TO &#x27;repl&#x27;@&#x27;%&#x27;; \\FLUSH PRIVILEGES; \\SHOW MASTER STATUS;&quot;#MASTER_LOG_POSå¯ä»¥é€šè¿‡ SHOW MASTER STATUS;åœ¨masterèŠ‚ç‚¹æ‰§è¡ŒæŸ¥çœ‹docker exec -it proxysql-mysql-slave-1 mysql -uroot -pSlaveRoot123! -e \\&quot;CHANGE MASTER TO \\MASTER_HOST=&#x27;mysql-master&#x27;, \\MASTER_USER=&#x27;repl&#x27;, \\MASTER_PASSWORD=&#x27;ReplPass123!&#x27;, \\MASTER_LOG_FILE=&#x27;mysql-bin.000003&#x27;, \\MASTER_LOG_POS=827; \\START SLAVE; \\SHOW SLAVE STATUS\\G&quot;#SHOW MASTER STATUS;#SHOW SLAVE STATUS;#SHOW BINARY LOGS;#SHOW BINLOG EVENTS;#show binlog events in &#x27;mysql-bin.000002&#x27; from 219 limit 5;#reset master; #æ¸…ç©ºæ‰€æœ‰binlog#flush logs;  #åˆ·æ–°binlogï¼Œç›´æ¥ç”Ÿæˆæ–°çš„binlogæ–‡ä»¶#SHOW VARIABLES LIKE &quot;%expire_logs_days%&quot;;    #binlogä¿å­˜å¤šä¹… #SHOW VARIABLES LIKE &#x27;binlog_expire_logs_seconds&#x27;; ä¼˜å…ˆçº§æ¯”expire_logs_daysé«˜#SHOW VARIABLES LIKE &quot;%max_binlog%&quot;;  #å•ä¸ªbinlogåˆ°å¤šå¤§å¼€å§‹ç”Ÿæˆæ–°çš„#================================================================================#åˆ›å»ºproxysqlçš„ç›‘æ§åç«¯mysqlç”¨æˆ·ï¼Œæ³¨æ„åªéœ€è¦åœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼Œå› ä¸ºå·²ç»ä¸»ä»åŒæ­¥äº†ï¼Œä¸ç„¶ä¸»ä»ä¼šæŠ¥é”™åœæ­¢-- åˆ›å»ºç›‘æ§ç”¨æˆ·CREATE USER &#x27;monitor&#x27;@&#x27;%&#x27; IDENTIFIED  BY &#x27;MonitorPass123!&#x27;;-- æˆäºˆå¿…è¦æƒé™ï¼ˆProxySQL å¥åº·æ£€æŸ¥éœ€è¦ï¼‰GRANT USAGE, REPLICATION CLIENT ON *.* TO &#x27;monitor&#x27;@&#x27;%&#x27;;-- grant all privileges on *.* to &#x27;monitor&#x27;@&#x27;%&#x27; with grant option;-- åˆ·æ–°æƒé™FLUSH PRIVILEGES;#ç™»å½•proxysqldocker exec -it proxysql-proxysql-1 mysql -uadmin -padmin -h127.0.0.1 -P6032#proxysqlç›‘æ§ç”¨æˆ·åå’Œå¯†ç é»˜è®¤éƒ½æ˜¯monitorï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æŸ¥çœ‹SELECT * FROM global_variables WHERE variable_name IN (&#x27;mysql-monitor_username&#x27;, &#x27;mysql-monitor_password&#x27;);#ä¿®æ”¹å¯†ç UPDATE global_variables SET variable_value=&#x27;MonitorPass123!&#x27;WHERE variable_name=&#x27;mysql-monitor_password&#x27;;load mysql variables to runtime;save mysql variables to disk;#proxysqlçš„ç›¸å…³å…ƒæ•°æ®è¡¨SELECT hostgroup_id, hostname, status FROM main.mysql_servers;;hostgroup_idï¼šæœåŠ¡å™¨æ‰€å±ä¸»æœºç»„ï¼ˆå¦‚è¯»å†™åˆ†ç¦»çš„è¯»ç»„ 20 å’Œå†™ç»„ 10ï¼‰ã€‚hostnameï¼šæœåŠ¡å™¨åœ°å€ï¼ˆIP æˆ–åŸŸåï¼‰ã€‚statusï¼šèŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚ ONLINEï¼ˆæ­£å¸¸ï¼‰ã€OFFLINE_SOFTï¼ˆè½¯ä¸‹çº¿ï¼‰ã€OFFLINE_HARDï¼ˆç¡¬ä¸‹çº¿ï¼‰ã€SHUNNEDï¼ˆä¸´æ—¶å±è”½ï¼‰SELECT hostgroup, username, digest_text,count_star,sum_time FROM stats.stats_mysql_query_digest;digest_textï¼šå½’ä¸€åŒ–åçš„ SQL æ¨¡æ¿ï¼ˆå¦‚ SELECT * FROM users WHERE id=?ï¼‰ã€‚count_starï¼šè¯¥ SQL æ¨¡æ¿çš„æ‰§è¡Œæ¬¡æ•°ã€‚sum_timeï¼šè¯¥ SQL æ¨¡æ¿çš„æ€»è€—æ—¶ï¼ˆå¾®ç§’ï¼‰ã€‚hostgroupï¼šè¯·æ±‚è·¯ç”±åˆ°çš„ä¸»æœºç»„ã€‚usernameï¼šæ‰§è¡Œ SQL çš„å®¢æˆ·ç«¯ç”¨æˆ·ã€‚SELECT * FROM global_variables WHERE variable_name LIKE &#x27;mysql-monitor%&#x27;;mysql-monitor_usernameï¼šç›‘æ§ç”¨æˆ·ï¼ˆéœ€åœ¨åç«¯ MySQL å­˜åœ¨å¹¶æˆæƒï¼‰ã€‚mysql-monitor_ping_intervalï¼šPing æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰ã€‚mysql-monitor_read_only_intervalï¼šæ£€æŸ¥ä¸»åº“åªè¯»çŠ¶æ€çš„é¢‘ç‡ã€‚SELECT * FROM monitor.mysql_server_connect_log   ORDER BY time_start_us DESC           LIMIT 3;connect_errorï¼šå¤±è´¥åŸå› ï¼ˆå¦‚è¶…æ—¶ã€æƒé™æ‹’ç»ï¼‰ã€‚time_start_usï¼šè¿æ¥å¼€å§‹æ—¶é—´ï¼ˆå¾®ç§’ç²¾åº¦ï¼‰ã€‚\n\nä¸»ä»åŒæ­¥å¦‚æœæŠ¥é”™#ä¸»ä»é”™è¯¯ï¼Œåœ¨ä¸»åº“åˆ›å»ºå®Œç”¨æˆ·ä»åº“å°±ä¸ç”¨åˆ›å»ºäº†ï¼Œä¸ç„¶å†²çªä¸»ä»å°±åœæ­¢äº†#å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥è¯¢å¯¼è‡´ä¸»ä»åœæ­¢çš„è¯­å¥ï¼Œå¹¶ä¸”ä¿®æ”¹SELECT * FROM performance_schema.replication_applier_status_by_worker\\G#é‡æ–°å¯åŠ¨STOP REPLICA;START REPLICA;\n","categories":["ä¸­é—´ä»¶"]},{"title":"python ThreadPoolExecutor","url":"/2025/08/26/python-ThreadPoolExecutor/","content":"å¹¶å‘æ‰§è¡Œæ–¹æ³•å¯¹æ¯”ï¼ˆsubmit&#x2F;as_completed&#x2F;mapï¼‰æ ¸å¿ƒç‰¹æ€§å¯¹æ¯”è¡¨\n\n\nç‰¹å¾\nexecutor.map()\nsubmit+é¡ºåºå¤„ç†\nas_completed\n\n\n\næ‰§è¡Œé¡ºåº\nå¹¶å‘æ‰§è¡Œ\nå¹¶å‘æ‰§è¡Œ\nå¹¶å‘æ‰§è¡Œ\n\n\nç»“æœé¡ºåº\nä¿æŒè¾“å…¥é¡ºåº\nä¿æŒæäº¤é¡ºåº\næŒ‰å®Œæˆé¡ºåº\n\n\nå¼‚å¸¸å¤„ç†\né‡åˆ°ç¬¬ä¸€ä¸ªå¼‚å¸¸ç«‹å³æŠ›å‡º\nå¯é€ä¸ªå¤„ç†å¼‚å¸¸\nå¯å•ç‹¬å¤„ç†æ¯ä¸ªä»»åŠ¡å¼‚å¸¸\n\n\nä»£ç å¤æ‚åº¦\nâ˜…â˜†â˜† æœ€ç®€å•\nâ˜…â˜…â˜† ä¸­ç­‰\nâ˜…â˜…â˜… æœ€çµæ´»\n\n\nå†…å­˜æ¶ˆè€—\nä½ï¼ˆæƒ°æ€§è¿­ä»£ï¼‰\né«˜ï¼ˆéœ€å­˜å‚¨æ‰€æœ‰futureï¼‰\nä¸­ï¼ˆåŠ¨æ€å¤„ç†ï¼‰\n\n\nè¿›åº¦åé¦ˆ\næ— æ³•å®æ—¶è·å–\néœ€æ‰‹åŠ¨å®ç°\nè‡ªåŠ¨å®æ—¶åé¦ˆ\n\n\né€‚ç”¨åœºæ™¯\nç®€å•è½¬æ¢&#x2F;æ‰¹é‡å¤„ç†\néœ€è¦ä¸¥æ ¼é¡ºåºçš„ç»“æœ\néœ€è¦åŠæ—¶å¤„ç†å®Œæˆçš„åœºæ™¯\n\n\n\næ–¹æ³•è¯¦è§£1. executor.map()å…¸å‹ç”¨æ³•ï¼š\nfrom concurrent.futures import ThreadPoolExecutordef process_data(x):    return x * 2with ThreadPoolExecutor() as executor:    results = executor.map(process_data, [1, 2, 3])  # ä¿æŒè¾“å…¥é¡ºåº    for res in results:        print(res)  # æŒ‰1â†’2â†’3çš„é¡ºåºè¾“å‡º2,4,6#ç¤ºä¾‹ä¸‹è½½æœ‰é¡ºåºçš„å°è¯´def download_chapter(index, url):    # æ¨¡æ‹Ÿä¸‹è½½ï¼ˆå¹¶è¡Œï¼Œæ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼‰    return (index, f&quot;ç¬¬ &#123;index&#125; ç« å†…å®¹&quot;)# é€šè¿‡bs4è·å–åˆ—è¡¨ï¼Œè¾“å…¥æ˜¯æœ‰åºçš„ç« èŠ‚åˆ—è¡¨chapters = [    (1, &quot;http://example.com/ch1&quot;),    (2, &quot;http://example.com/ch2&quot;),    (3, &quot;http://example.com/ch3&quot;)]with ThreadPoolExecutor(max_workers=3) as executor:    # æäº¤ä»»åŠ¡ï¼ˆæŒ‰é¡ºåºï¼‰    results = executor.map(        lambda args: download_chapter(*args),        chapters    )    # æ‹†è§£å…ƒç»„å‚æ•°ä¸ºç‹¬ç«‹çš„å‚æ•°    lambda args: download_chapter(*args)    # ç­‰æ•ˆäºï¼š    # def unpack_and_call(args):    #     return download_chapter(args[0], args[1])  # è§£åŒ…å…ƒç»„    # æŒ‰è¾“å…¥é¡ºåºå†™å…¥æ–‡ä»¶    with open(&quot;book.txt&quot;, &quot;w&quot;, encoding=&quot;utf-8&quot;) as f:        for index, content in results:            f.write(f&quot;&#123;content&#125;\\n&quot;)\n\nç‰¹ç‚¹ï¼š\n\nè‡ªåŠ¨å°†å¯è¿­ä»£å‚æ•°æ˜ å°„åˆ°å‡½æ•°\nç»“æœé¡ºåºä¸è¾“å…¥å‚æ•°ä¸¥æ ¼ä¸€è‡´\né‡åˆ°ç¬¬ä¸€ä¸ªå¼‚å¸¸æ—¶ä¼šç«‹å³åœæ­¢è¿­ä»£\n\næœ€ä½³åœºæ™¯ï¼š\n\næ•°æ®å¹¶è¡Œè½¬æ¢ï¼ˆå¦‚æ‰¹é‡å›¾ç‰‡å‹ç¼©ï¼‰\néœ€è¦ä¿æŒè¾“å…¥è¾“å‡ºé¡ºåºå¯¹åº”çš„ä»»åŠ¡\n\n\n2. submit + é¡ºåºå¤„ç†å…¸å‹ç”¨æ³•ï¼šå‚æ•°å¿…é¡»æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œå¦‚ i for i in range(1, 4)ï¼›submitä¸éœ€è¦å› ä¸ºæ˜¯æ‰‹åŠ¨æäº¤\ndef multiply(x, y):    return x * ywith ThreadPoolExecutor() as executor:    # ç”Ÿæˆå™¨ä½œä¸ºå¯è¿­ä»£å¯¹è±¡    nums1 = (i for i in range(1, 4))    nums2 = (i for i in range(10, 13))    results = executor.map(multiply, nums1, nums2)    print(list(results))  # è¾“å‡º [10, 22, 36]# æäº¤å•ä¸ªä»»åŠ¡ï¼Œå‚æ•°ç›´æ¥ä¼ é€’ï¼Œå¯ä»¥ä¸ç”¨æ˜¯åˆ—è¡¨future = executor.submit(multiply, 2, 3)print(future.result())  # è¾“å‡º 8#ç¤ºä¾‹ä»£ç ï¼Œä¸åŒä»»åŠ¡ å®šä¹‰ä¸‰ç±»ä¸åŒå‚æ•°çš„ä»»åŠ¡å‡½æ•°def download(url, timeout):    &quot;&quot;&quot;æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡ï¼ˆå‚æ•°ï¼šURL + è¶…æ—¶æ—¶é—´ï¼‰&quot;&quot;&quot;    print(f&quot;å¼€å§‹ä¸‹è½½: &#123;url&#125;, è¶…æ—¶è®¾ç½®: &#123;timeout&#125;ç§’&quot;)    time.sleep(random.uniform(0.5, 2))    if random.random() &lt; 0.2:        raise URLError(f&quot;æ— æ³•è®¿é—® &#123;url&#125;&quot;)    return f&quot;ä¸‹è½½å®Œæˆ: &#123;url&#125;&quot;def calculate(a, b, operator):    &quot;&quot;&quot;æ¨¡æ‹Ÿè®¡ç®—ä»»åŠ¡ï¼ˆå‚æ•°ï¼šä¸¤ä¸ªæ•° + è¿ç®—ç¬¦ï¼‰&quot;&quot;&quot;    print(f&quot;è®¡ç®—: &#123;a&#125; &#123;operator&#125; &#123;b&#125;&quot;)    time.sleep(0.5)    if operator == &quot;+&quot;:        return a + b    elif operator == &quot;*&quot;:        return a * b    else:        raise ValueError(f&quot;ä¸æ”¯æŒçš„è¿ç®—ç¬¦: &#123;operator&#125;&quot;)def log_message(message, priority=&quot;INFO&quot;):    &quot;&quot;&quot;æ¨¡æ‹Ÿæ—¥å¿—ä»»åŠ¡ï¼ˆå‚æ•°ï¼šæ¶ˆæ¯ + ä¼˜å…ˆçº§ï¼‰&quot;&quot;&quot;    print(f&quot;[&#123;priority&#125;] è®°å½•æ—¥å¿—: &#123;message&#125;&quot;)    time.sleep(0.1)    return f&quot;æ—¥å¿—å·²ä¿å­˜: &#123;message&#125;&quot;if __name__ == &quot;__main__&quot;:    with ThreadPoolExecutor(max_workers=3) as executor:        futures = []        # åŠ¨æ€æäº¤ä¸åŒç±»å‹çš„ä»»åŠ¡        # ä»»åŠ¡1ï¼šä¸‹è½½ä»»åŠ¡ï¼ˆå‚æ•°ï¼šurl, timeoutï¼‰        futures.append(executor.submit(download, &quot;https://example.com&quot;, timeout=3))        # ä»»åŠ¡2ï¼šè®¡ç®—ä»»åŠ¡ï¼ˆå‚æ•°ï¼š5, 3, &quot;+&quot;ï¼‰        futures.append(executor.submit(calculate, 5, 3, &quot;+&quot;))        # ä»»åŠ¡3ï¼šæ—¥å¿—ä»»åŠ¡ï¼ˆå‚æ•°ï¼šmessage=&quot;ç³»ç»Ÿå¯åŠ¨&quot;, priority=&quot;HIGH&quot;ï¼‰        futures.append(executor.submit(log_message, &quot;ç³»ç»Ÿå¯åŠ¨&quot;, &quot;HIGH&quot;))        # åŠ¨æ€è¿½åŠ ä»»åŠ¡ï¼ˆæ ¹æ®æ¡ä»¶ï¼‰        if random.choice([True, False]):            # ä»»åŠ¡4ï¼šéšæœºæ·»åŠ ä¸€ä¸ªè®¡ç®—ä»»åŠ¡ï¼ˆå‚æ•°ï¼š8, 4, &quot;*&quot;ï¼‰            futures.append(executor.submit(calculate, 8, 4, &quot;*&quot;))        # å¤„ç†ç»“æœï¼ˆæŒ‰å®Œæˆé¡ºåºï¼Œç‹¬ç«‹æ•è·å¼‚å¸¸ï¼‰        for future in futures:            try:                result = future.result()                print(f&quot;ç»“æœ: &#123;result&#125;&quot;)            except URLError as e:                print(f&quot;ä¸‹è½½å¤±è´¥: &#123;e.reason&#125;&quot;)            except ValueError as e:                print(f&quot;è®¡ç®—é”™è¯¯: &#123;e&#125;&quot;)            except Exception as e:                print(f&quot;æœªçŸ¥é”™è¯¯: &#123;e&#125;&quot;)\n\nç‰¹ç‚¹ï¼š\n\næ‰‹åŠ¨æ§åˆ¶æ¯ä¸ªä»»åŠ¡çš„æäº¤\nç»“æœå¤„ç†é¡ºåºå›ºå®š\nå¯ä»¥å•ç‹¬å¤„ç†æ¯ä¸ªä»»åŠ¡çš„å¼‚å¸¸\n\næœ€ä½³åœºæ™¯ï¼š\n\néœ€è¦è·Ÿè¸ªä»»åŠ¡æ¥æºçš„åœºæ™¯\néœ€è¦é€æ­¥å¤„ç†ç»“æœçš„æ—¥å¿—ç³»ç»Ÿ\n\n\n3. as_completedå…¸å‹ç”¨æ³•ï¼š\nfrom concurrent.futures import as_completedfutures = [executor.submit(task, param) for param in params]for future in as_completed(futures):    res = future.result()    print(f&quot;æ”¶åˆ°ç»“æœ: &#123;res&#125;&quot;)  # æŒ‰å®Œæˆé¡ºåºè¾“å‡º\n\nç‰¹ç‚¹ï¼š\n\nå®æ—¶è·å–å·²å®Œæˆä»»åŠ¡ç»“æœ\nå¯ä»¥ä¼˜å…ˆå¤„ç†è€—æ—¶çŸ­çš„ä»»åŠ¡\néœ€è¦é¢å¤–ç»´æŠ¤futureåˆ—è¡¨\n\næœ€ä½³åœºæ™¯ï¼š\n\næ–‡ä»¶ä¸‹è½½ï¼ˆå°æ–‡ä»¶ä¼˜å…ˆå®Œæˆï¼‰\nå®æ—¶ä»ªè¡¨ç›˜æ›´æ–°\néœ€è¦å¿«é€Ÿè·å–éƒ¨åˆ†ç»“æœçš„åœºæ™¯\n\n\næ€§èƒ½ç‰¹å¾å¯¹æ¯”æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡ï¼ˆ3ä¸ªä»»åŠ¡åˆ†åˆ«éœ€è¦3s&#x2F;1s&#x2F;2sï¼‰import timefrom concurrent.futures import ThreadPoolExecutor, as_completeddef task(sec):    time.sleep(sec)    return f&quot;&#123;sec&#125;ç§’ä»»åŠ¡&quot;params = [3, 1, 2]\n\n\n\n\næ–¹æ³•\nè¾“å‡ºé¡ºåº\næ€»è€—æ—¶\né¦–ä¸ªç»“æœæ—¶é—´\n\n\n\nmap\n3â†’1â†’2\n3s\n3så\n\n\nsubmité¡ºåºå¤„ç†\n3â†’1â†’2\n3s\n3så\n\n\nas_completed\n1â†’2â†’3\n3s\n1så\n\n\n\næ€»ç»“å¯¹æ¯”\n\n\nç»´åº¦\nmap\nsubmit+é¡ºåº\nas_completed\n\n\n\nä»£ç ç®€æ´åº¦\næœ€ç®€æ´ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰\nä¸­ç­‰ï¼ˆéœ€æ‰‹åŠ¨ç»´æŠ¤ï¼‰\næœ€å¤æ‚ï¼ˆéœ€åŠ¨æ€å¤„ç†ï¼‰\n\n\nç»“æœé¡ºåº\nè¾“å…¥é¡ºåº\næäº¤é¡ºåº\nå®Œæˆé¡ºåº\n\n\nå®æ—¶åé¦ˆ\næ— \næ— \næœ‰\n\n\nå¼‚å¸¸å®¹å¿åº¦\nä½ï¼ˆé‡åˆ°é”™è¯¯ç«‹å³åœæ­¢ï¼‰\né«˜ï¼ˆå¯å•ç‹¬å¤„ç†ï¼‰\né«˜ï¼ˆå¯å•ç‹¬å¤„ç†ï¼‰\n\n\nå†…å­˜æ•ˆç‡\né«˜ï¼ˆæƒ°æ€§è¿­ä»£ï¼‰\nä½ï¼ˆå…¨å­˜å‚¨ï¼‰\nä¸­ï¼ˆåŠ¨æ€é‡Šæ”¾ï¼‰\n\n\n","categories":["python"]},{"title":"python as_completed","url":"/2025/08/26/python-as-completed/","content":"as_completed æ–¹æ³•è¯¦è§£ğŸ¯ æ ¸å¿ƒåŒºåˆ«ï¼šå¤„ç†é¡ºåº\n\n\næ–¹æ³•\næ‰§è¡Œé¡ºåº\nç»“æœè·å–é¡ºåº\né€‚ç”¨åœºæ™¯\n\n\n\nsubmit + é¡ºåºå¤„ç†\næŒ‰æäº¤é¡ºåºæ‰§è¡Œ\næŒ‰æäº¤é¡ºåºè·å–\néœ€è¦ä¸¥æ ¼ä¿æŒç»“æœé¡ºåºçš„åœºæ™¯\n\n\nas_completed\nå¹¶è¡Œæ‰§è¡Œ\næŒ‰å®Œæˆé¡ºåºè·å–\néœ€è¦åŠæ—¶å¤„ç†å·²å®Œæˆä»»åŠ¡çš„åœºæ™¯\n\n\n\nğŸ“Œ ä½¿ç”¨åœºæ™¯åˆ†æ1. submit + é¡ºåºå¤„ç†å…¸å‹ä»£ç ï¼š\nfrom concurrent.futures import ThreadPoolExecutorwith ThreadPoolExecutor() as executor:    futures = [executor.submit(task, param) for param in params_list]    for future in futures:  # æŒ‰æäº¤é¡ºåºå¤„ç†        print(future.result())\n\nç‰¹ç‚¹ï¼š\n\nå¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ª\nä¸¥æ ¼ä¿æŒä»»åŠ¡æäº¤é¡ºåº\né€‚åˆåœºæ™¯ï¼š\næ—¥å¿—å¤„ç†éœ€è¦æŒ‰æ—¶é—´é¡ºåºè®°å½•\nç»“æœéœ€è¦é¡ºåºå†™å…¥æ–‡ä»¶&#x2F;æ•°æ®åº“\n\n\n\n\n2. as_completedå…¸å‹ä»£ç ï¼š\nfrom concurrent.futures import as_completedwith ThreadPoolExecutor() as executor:    futures = [executor.submit(task, param) for param in params_list]    for future in as_completed(futures):  # æŒ‰å®Œæˆé¡ºåºå¤„ç†        print(future.result())\n\nç‰¹ç‚¹ï¼š\n\nä¼˜å…ˆå¤„ç†æœ€å¿«å®Œæˆçš„ä»»åŠ¡\nä¸ä¿è¯ç»“æœé¡ºåº\né€‚åˆåœºæ™¯ï¼š\néœ€è¦å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡\nå¤„ç†æ—¶é—´å·®å¼‚å¤§çš„ä»»åŠ¡ï¼ˆå¦‚ä¸åŒå¤§å°çš„æ–‡ä»¶ä¸‹è½½ï¼‰\nå¿«é€Ÿè·å–éƒ¨åˆ†å¯ç”¨ç»“æœï¼ˆå¦‚çˆ¬è™«å…ˆæŠ“å–å…ˆåˆ†æï¼‰\n\n\n\n\nğŸ§ª æ€§èƒ½å¯¹æ¯”å®éªŒæ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡import timefrom concurrent.futures import ThreadPoolExecutor, as_completeddef task(n):    time.sleep(n)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ    return f&quot;ä»»åŠ¡ &#123;n&#125;s å®Œæˆ&quot;if __name__ == &quot;__main__&quot;:    times = [3, 1, 2]  # ä¸‰ä¸ªä»»åŠ¡åˆ†åˆ«éœ€è¦3ç§’ã€1ç§’ã€2ç§’        with ThreadPoolExecutor() as executor:        futures = [executor.submit(task, t) for t in times]                print(&quot;--- ä½¿ç”¨ as_completed ---&quot;)        start = time.time()        for f in as_completed(futures):            print(f&quot;&#123;time.time()-start:.1f&#125;s æ”¶åˆ°: &#123;f.result()&#125;&quot;)                print(&quot;\\n--- æŒ‰æäº¤é¡ºåºå¤„ç† ---&quot;)        start = time.time()        for f in futures:            print(f&quot;&#123;time.time()-start:.1f&#125;s æ”¶åˆ°: &#123;f.result()&#125;&quot;)\n\nå®éªŒç»“æœ--- ä½¿ç”¨ as_completed ---1.0s æ”¶åˆ°: ä»»åŠ¡ 1s å®Œæˆ2.0s æ”¶åˆ°: ä»»åŠ¡ 2s å®Œæˆ3.0s æ”¶åˆ°: ä»»åŠ¡ 3s å®Œæˆ--- æŒ‰æäº¤é¡ºåºå¤„ç† ---3.0s æ”¶åˆ°: ä»»åŠ¡ 3s å®Œæˆ3.0s æ”¶åˆ°: ä»»åŠ¡ 1s å®Œæˆ3.0s æ”¶åˆ°: ä»»åŠ¡ 2s å®Œæˆ\n\n\nğŸ’¡ æœ€ä½³å®è·µå»ºè®®1. ä¼˜å…ˆä½¿ç”¨ as_completed å½“ï¼šâœ… éœ€è¦å®æ—¶æ˜¾ç¤ºè¿›åº¦çŠ¶æ€âœ… ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚è¾ƒå¤§ï¼ˆå¦‚åŒæ—¶å¤„ç†å›¾ç‰‡ç¼©ç•¥å›¾å’Œ4Kè§†é¢‘ï¼‰âœ… ä¸éœ€è¦ä¿æŒç»“æœé¡ºåºï¼ˆå¦‚ç‹¬ç«‹çš„æ•°æ®æŠ“å–ä»»åŠ¡ï¼‰\n2. ä½¿ç”¨é¡ºåºå¤„ç†å½“ï¼šâ›” å¿…é¡»ä¿æŒç»“æœé¡ºåºï¼ˆå¦‚æ—¶é—´åºåˆ—æ•°æ®åˆ†æï¼‰â›” åç»­ä»»åŠ¡ä¾èµ–å‰åºç»“æœï¼ˆå¦‚åˆ†æ­¥éª¤æ•°æ®å¤„ç†æµæ°´çº¿ï¼‰â›” éœ€è¦ä¸¥æ ¼æ§åˆ¶èµ„æºä½¿ç”¨ï¼ˆå¦‚é¡ºåºå†™å…¥æ•°æ®åº“ï¼‰\n3. æ··åˆä½¿ç”¨æŠ€å·§# åŒæ—¶è·å–ç»“æœå’ŒåŸå§‹ä»»åŠ¡ç´¢å¼•for future in as_completed(futures):    original_index = futures.index(future)  # è·å–æäº¤æ—¶çš„é¡ºåºç´¢å¼•    result = future.result()    print(f&quot;ç¬¬ &#123;original_index&#125; ä¸ªæäº¤çš„ä»»åŠ¡å®Œæˆï¼š&#123;result&#125;&quot;)\n\n\nğŸ“š æ‰©å±•çŸ¥è¯†concurrent.futures æ¨¡å—å¯¹æ¯”\n\n\næ–¹æ³•\nç‰¹ç‚¹\né€‚ç”¨åœºæ™¯\n\n\n\nThreadPoolExecutor\nä½¿ç”¨çº¿ç¨‹æ± ï¼Œé€‚åˆIOå¯†é›†å‹ä»»åŠ¡\nç½‘ç»œè¯·æ±‚&#x2F;æ–‡ä»¶æ“ä½œç­‰\n\n\nProcessPoolExecutor\nä½¿ç”¨è¿›ç¨‹æ± ï¼Œé€‚åˆCPUå¯†é›†å‹ä»»åŠ¡\næ•°å­¦è®¡ç®—&#x2F;å›¾åƒå¤„ç†ç­‰\n\n\n# è¿›ç¨‹æ± ç”¨æ³•ï¼ˆæ¥å£ä¸çº¿ç¨‹æ± ä¸€è‡´ï¼‰\nfrom concurrent.futures import ProcessPoolExecutor\nwith ProcessPoolExecutor() as executor:\n    ...\n\n","categories":["python"]},{"title":"python threading","url":"/2025/08/26/python-threading/","content":"threading.Thread\né€‚ç”¨åœºæ™¯ï¼šä»»åŠ¡é€»è¾‘å·®å¼‚å¤§ï¼›æ¯ä¸ªçº¿ç¨‹éœ€è¦æ‰§è¡Œå®Œå…¨ä¸åŒçš„é€»è¾‘\nä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°\n\n\né”ï¼šthreading.Lock()ä¸¤ç§ä½¿ç”¨æ–¹æ³•æ¨èwithä¸‹æ–¹æ¼”ç¤ºï¼Œç¬¬äºŒç§æ‰‹åŠ¨åŠ é”lock.acquire()ï¼Œç„¶åé‡Šæ”¾lock.release()\n#æœªä½¿ç”¨çš„æƒ…å†µä¸‹def sing():    #with stats_lock:        for i in range(3):            print(&quot;æ­£åœ¨å”±æ­Œ...%d&quot;%i)            sleep(1)def dance():    #with stats_lock:        for i in range(3):            print(&quot;æ­£åœ¨è·³èˆ...%d&quot;%i)            sleep(1)if __name__ == &#x27;__main__&#x27;:    print(&#x27;---å¼€å§‹---:%s&#x27;%ctime())    t1 = threading.Thread(target=sing)    t2 = threading.Thread(target=dance)    t1.start()    t2.start()#è¾“å‡ºæ˜¯æ··ä¹±çš„å°±æ˜¯å› ä¸ºæ²¡æœ‰ç»™çº¿ç¨‹åŠ é”---å¼€å§‹---:Tue Aug 26 10:19:56 2025æ­£åœ¨å”±æ­Œ...0æ­£åœ¨è·³èˆ...0æ­£åœ¨å”±æ­Œ...1æ­£åœ¨è·³èˆ...1æ­£åœ¨è·³èˆ...2æ­£åœ¨å”±æ­Œ...2======================================================================#åŠ é”åimport threadingfrom time import sleep,ctimestats_lock = threading.Lock()def sing():    with stats_lock:        #stats_lock.acquire()        for i in range(3):            print(&quot;æ­£åœ¨å”±æ­Œ...%d&quot;%i)            sleep(1)        #stats_lock.release()def dance():    with stats_lock:        for i in range(3):            print(&quot;æ­£åœ¨è·³èˆ...%d&quot;%i)            sleep(1)if __name__ == &#x27;__main__&#x27;:    print(&#x27;---å¼€å§‹---:%s&#x27;%ctime())    t1 = threading.Thread(target=sing)    t2 = threading.Thread(target=dance)    t1.start()    t2.start()#è¾“å‡ºæ­£å¸¸---å¼€å§‹---:Tue Aug 26 10:23:18 2025æ­£åœ¨å”±æ­Œ...0æ­£åœ¨å”±æ­Œ...1æ­£åœ¨å”±æ­Œ...2æ­£åœ¨è·³èˆ...0æ­£åœ¨è·³èˆ...1æ­£åœ¨è·³èˆ...2\n\n\n\nçº¿ç¨‹ä¸­çš„joinç­‰å¾…é˜»å¡å‡½æ•°\n\n\n\nå½“æœ‰çº¿ç¨‹åœ¨ç»Ÿè®¡ä¿¡æ¯æ—¶ï¼Œå¿…é¡»ç­‰å¾…æ‰§è¡Œå®Œæˆæ‰å¯ä»¥import threadingfrom time import sleep,ctimestats_lock = threading.Lock()def sing(num):    with stats_lock:        for i in range(num):            print(&quot;æ­£åœ¨å”±æ­Œ...%d&quot;%i)            sleep(1)def dance(num):    with stats_lock:        for i in range(num):            print(&quot;æ­£åœ¨è·³èˆ...%d&quot;%i)            sleep(1)if __name__ == &#x27;__main__&#x27;:    print(&#x27;---å¼€å§‹---:%s&#x27;%ctime())    t1 = threading.Thread(target=sing,args=(3,),name=&quot;å”±æ­Œçº¿ç¨‹&quot;)    t2 = threading.Thread(target=dance,args=(3,))    t1.start()    t2.start()    # t1.join()    # t2.join()    #sleep(5) # å±è”½æ­¤è¡Œä»£ç ï¼Œè¯•è¯•çœ‹ï¼Œç¨‹åºæ˜¯å¦ä¼šç«‹é©¬ç»“æŸï¼Ÿ    print(&#x27;---ç»“æŸ---:%s&#x27;%ctime())#æœªä½¿ç”¨joinç­‰å¾…å‡½æ•°è¾“å‡ºç»“æœ,ä¸»çº¿ç¨‹ç›´æ¥ç»“æŸï¼Œä¸ç¬¦åˆé¢„æœŸ---å¼€å§‹---:Tue Aug 26 10:35:09 2025æ­£åœ¨å”±æ­Œ...0---ç»“æŸ---:Tue Aug 26 10:35:09 2025æ­£åœ¨å”±æ­Œ...1æ­£åœ¨å”±æ­Œ...2æ­£åœ¨è·³èˆ...0æ­£åœ¨è·³èˆ...1æ­£åœ¨è·³èˆ...2#ä½¿ç”¨joinå---å¼€å§‹---:Tue Aug 26 10:36:35 2025æ­£åœ¨å”±æ­Œ...0æ­£åœ¨å”±æ­Œ...1æ­£åœ¨å”±æ­Œ...2æ­£åœ¨è·³èˆ...0æ­£åœ¨è·³èˆ...1æ­£åœ¨è·³èˆ...2---ç»“æŸ---:Tue Aug 26 10:36:41 2025=================================================================================#æ³¨æ„é”çš„é¢—ç²’åº¦ï¼Œå¦‚æœé”å¾ªç¯åˆ™æ˜¯çº¿ç¨‹äºŒè¦ç­‰çº¿ç¨‹ä¸€æ‰§è¡Œå®Œæ‰ä¼šè¿è¡Œå½±å“æ•ˆç‡import threadingfrom time import sleep,ctimestats_lock = threading.Lock()def sing(num):    #with stats_lock:        for i in range(num):            with stats_lock:                print(&quot;æ­£åœ¨å”±æ­Œ...%d&quot;%i)            sleep(1)def dance(num):    #with stats_lock:        for i in range(num):            with stats_lock:                print(&quot;æ­£åœ¨è·³èˆ...%d&quot;%i)            sleep(1)if __name__ == &#x27;__main__&#x27;:    print(&#x27;---å¼€å§‹---:%s&#x27;%ctime())    t1 = threading.Thread(target=sing,args=(3,),name=&quot;å”±æ­Œçº¿ç¨‹&quot;)    t2 = threading.Thread(target=dance,args=(3,))    t1.start()    t2.start()    t1.join()    t2.join()    #sleep(5) # å±è”½æ­¤è¡Œä»£ç ï¼Œè¯•è¯•çœ‹ï¼Œç¨‹åºæ˜¯å¦ä¼šç«‹é©¬ç»“æŸï¼Ÿ    print(&#x27;---ç»“æŸ---:%s&#x27;%ctime())#è¾“å‡ºç»“æœï¼ŒåŒæ­¥æ‰§è¡Œï¼Œåªé”è¾“å‡º---å¼€å§‹---:Tue Aug 26 10:39:38 2025æ­£åœ¨å”±æ­Œ...0æ­£åœ¨è·³èˆ...0æ­£åœ¨è·³èˆ...1æ­£åœ¨å”±æ­Œ...1æ­£åœ¨è·³èˆ...2æ­£åœ¨å”±æ­Œ...2---ç»“æŸ---:Tue Aug 26 10:39:41 2025\n\n\né˜Ÿåˆ—å‡½æ•° queue.Queue æ¥å®ç°çº¿ç¨‹é—´çš„é€šä¿¡å’Œæ•°æ®äº¤æ¢\n\n\nç”Ÿäº§è€…ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚æ¥æ”¶ï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆå¦‚ä»»åŠ¡å¤„ç†çº¿ç¨‹ï¼‰é€Ÿåº¦ä¸ä¸€è‡´å»ºè®®ä½¿ç”¨\næ¯”å¦‚çˆ¬å–m3u8è§†é¢‘ç‰‡æ®µï¼Œå°±éœ€è¦ä½¿ç”¨é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºä¸‹è½½é¿å…å¤šçº¿ç¨‹ç‰‡æ®µæ··ä¹±æ— æ³•ç»„åˆ\n\n\n\n\nä½œç”¨\nè¯´æ˜\n\n\n\nçº¿ç¨‹å®‰å…¨çš„æ•°æ®ä¼ é€’\nè‡ªåŠ¨å¤„ç†å¤šçº¿ç¨‹å¹¶å‘æ“ä½œï¼Œæ— éœ€æ‰‹åŠ¨åŠ é”&#x2F;é‡Šæ”¾é”ã€‚\n\n\nä»»åŠ¡è§£è€¦\nç”Ÿäº§ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆå¦‚ä¸»çº¿ç¨‹ï¼‰å’Œæ¶ˆè´¹ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆå·¥ä½œçº¿ç¨‹ï¼‰å®Œå…¨è§£è€¦ã€‚\n\n\næµé‡æ§åˆ¶\né€šè¿‡é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼ˆmaxsizeï¼‰é˜²æ­¢å†…å­˜çˆ†ç‚¸ã€‚\n\n\nä»»åŠ¡çŠ¶æ€è·Ÿè¸ª\næ”¯æŒ task_done() å’Œ join() æœºåˆ¶ï¼Œæ–¹ä¾¿ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚\n\n\n#æœªä½¿ç”¨tasks = []  # å…¨å±€ä»»åŠ¡åˆ—è¡¨lock = threading.Lock()# ç”Ÿäº§è€…çº¿ç¨‹def producer():    global tasks    for i in range(100):        with lock:            tasks.append(i)# æ¶ˆè´¹è€…çº¿ç¨‹def consumer():    while True:        with lock:            if not tasks:                break            item = tasks.pop(0)        process(item)#ä½¿ç”¨import threadingfrom queue import Queuetask_queue = Queue(maxsize=10)  # é˜Ÿåˆ—å®¹é‡é™åˆ¶def producer():    for i in range(100):        task_queue.put(i)  # è‡ªåŠ¨é˜»å¡é˜Ÿåˆ—æ»¡æ—¶def consumer():    while True:        item = task_queue.get()  # è‡ªåŠ¨é˜»å¡é˜Ÿåˆ—ç©ºæ—¶        process(item)        task_queue.task_done()# å¯åŠ¨çº¿ç¨‹producer_thread = threading.Thread(target=producer)consumer_thread = threading.Thread(target=consumer)producer_thread.start()consumer_thread.start()task_queue.join()  # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆproducer_thread.join()consumer_thread.join()#é¡ºåºå…ˆå…¥å…ˆå‡ºimport threadingfrom queue import Queueimport timeimport random# å…±äº«é˜Ÿåˆ—å’Œç»“æœå®¹å™¨task_queue = Queue()results = &#123;&#125;lock = threading.Lock()  # ä¿è¯ç»“æœå­—å…¸çš„çº¿ç¨‹å®‰å…¨def worker():    &quot;&quot;&quot;å·¥ä½œçº¿ç¨‹ï¼šå¤„ç†æ— åºä»»åŠ¡ï¼Œä¿å­˜ç»“æœåˆ°å­—å…¸&quot;&quot;&quot;    while True:        # è·å–ä»»åŠ¡ï¼ˆåŒ…å«åºå·å’Œå‚æ•°ï¼‰        index, url = task_queue.get()        print(f&quot;å¼€å§‹å¤„ç†ç¬¬ &#123;index&#125; ç« : &#123;url&#125;&quot;)        time.sleep(random.uniform(0.5, 2))  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ        content = f&quot;ç¬¬ &#123;index&#125; ç« å†…å®¹&quot;                # ä¿å­˜ç»“æœï¼ˆåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰        with lock:            results[index] = content                task_queue.task_done()def download_ordered_chapters(chapters):    &quot;&quot;&quot;ä¸»çº¿ç¨‹ï¼šæäº¤ä»»åŠ¡ã€å¯åŠ¨å·¥ä½œçº¿ç¨‹ã€ç­‰å¾…å¹¶æ’åºç»“æœ&quot;&quot;&quot;    # æäº¤ä»»åŠ¡åˆ°é˜Ÿåˆ—    for index, url in chapters:        task_queue.put((index, url))        # å¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼ˆ3ä¸ªçº¿ç¨‹ï¼‰    threads = []    for _ in range(3):        t = threading.Thread(target=worker, daemon=True)        t.start()        threads.append(t)        # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ    task_queue.join()     # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸï¼ˆéå®ˆæŠ¤çº¿ç¨‹å¿…é¡»è°ƒç”¨ join()ï¼‰    # for t in threads:    #     t.join()  # ç¡®ä¿çº¿ç¨‹å®Œå…¨ç»“æŸ        # æŒ‰åºå·æ’åºç»“æœ    sorted_indices = sorted(results.keys())    ordered_results = [results[i] for i in sorted_indices]        return ordered_results# ç¤ºä¾‹è°ƒç”¨if __name__ == &quot;__main__&quot;:    chapters = [        (1, &quot;http://example.com/ch1&quot;),        (2, &quot;http://example.com/ch2&quot;),        (3, &quot;http://example.com/ch3&quot;)    ]        ordered_contents = download_ordered_chapters(chapters)    for content in ordered_contents:        print(f&quot;ä¿å­˜: &#123;content&#125;&quot;)\n\n\n\n\n\nç»¼åˆç¤ºä¾‹ä»£ç import queueimport threadingimport timeimport requestsfrom queue import Queue# å‹æµ‹é…ç½®CONFIG = &#123;    &quot;target_url&quot;: &quot;http://localhost/&quot;,  # ç›®æ ‡åœ°å€    &quot;thread_num&quot;: 5000,  # å¹¶å‘çº¿ç¨‹æ•°    &quot;total_requests&quot;: 100000,  # æ€»è¯·æ±‚é‡ (è®¾ç½®ä¸º0è¡¨ç¤ºæ— é™æŒç»­)    &quot;timeout&quot;: 5,  # å•è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰    &quot;headers&quot;: &#123;  # è¯·æ±‚å¤´ï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰        &quot;User-Agent&quot;: &quot;Stress Test/1.0&quot;    &#125;&#125;# å…¨å±€ç»Ÿè®¡stats = &#123;    &#x27;total&#x27;: 0,    &#x27;success&#x27;: 0,    &#x27;fail&#x27;: 0,    &#x27;total_time&#x27;: 0.0,    &#x27;max_time&#x27;: 0.0,    &#x27;min_time&#x27;: float(&#x27;inf&#x27;)&#125;stats_lock = threading.Lock()  # çº¿ç¨‹å®‰å…¨é”# è¯·æ±‚ä»»åŠ¡é˜Ÿåˆ—task_queue = Queue()def worker():    &quot;&quot;&quot;å·¥ä½œçº¿ç¨‹å‡½æ•°&quot;&quot;&quot;    while True:        try:            # ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼ˆé˜»å¡æ¨¡å¼ï¼‰            task_id = task_queue.get(timeout=2)            start_time = time.time()            try:                # å‘é€è¯·æ±‚ï¼ˆå¯ä¿®æ”¹ä¸ºPOSTç­‰å…¶ä»–æ–¹æ³•ï¼‰                response = requests.get(                    CONFIG[&quot;target_url&quot;],                    headers=CONFIG[&quot;headers&quot;],                    timeout=CONFIG[&quot;timeout&quot;]                )                elapsed = time.time() - start_time                # æ›´æ–°ç»Ÿè®¡ï¼ˆ200~399çŠ¶æ€ç è§†ä¸ºæˆåŠŸï¼‰                with stats_lock:                    stats[&#x27;total&#x27;] += 1                    if 200 &lt;= response.status_code &lt; 400:                        stats[&#x27;success&#x27;] += 1                    else:                        stats[&#x27;fail&#x27;] += 1                    stats[&#x27;total_time&#x27;] += elapsed                    stats[&#x27;max_time&#x27;] = max(stats[&#x27;max_time&#x27;], elapsed)                    stats[&#x27;min_time&#x27;] = min(stats[&#x27;min_time&#x27;], elapsed)            except Exception as e:                with stats_lock:                    stats[&#x27;fail&#x27;] += 1                    stats[&#x27;total&#x27;] += 1            # æ ‡è®°ä»»åŠ¡å®Œæˆ            task_queue.task_done()        except queue.Empty:            breakdef print_stats():    &quot;&quot;&quot;å®æ—¶æ‰“å°ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;    start_time = time.time()    while True:        time.sleep(1)  # æ¯ç§’æ›´æ–°        with stats_lock:            if stats[&#x27;total&#x27;] == 0:                continue            duration = time.time() - start_time            qps = stats[&#x27;total&#x27;] / duration            avg_time = stats[&#x27;total_time&#x27;] / stats[&#x27;total&#x27;]            print(f&quot;\\r[STAT] &quot;                  f&quot;Requests: &#123;stats[&#x27;total&#x27;]&#125; | &quot;                  f&quot;Success: &#123;stats[&#x27;success&#x27;]&#125; | &quot;                  f&quot;Fail: &#123;stats[&#x27;fail&#x27;]&#125; | &quot;                  f&quot;QPS: &#123;qps:.1f&#125; | &quot;                  f&quot;Avg: &#123;avg_time:.3f&#125;s | &quot;                  f&quot;Min/Max: &#123;stats[&#x27;min_time&#x27;]:.3f&#125;s/&#123;stats[&#x27;max_time&#x27;]:.3f&#125;s&quot;,                  end=&#x27;&#x27;, flush=True)        # æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰ä»»åŠ¡        if CONFIG[&quot;total_requests&quot;] &gt; 0 and stats[&#x27;total&#x27;] &gt;= CONFIG[&quot;total_requests&quot;]:            breakif __name__ == &quot;__main__&quot;:    # åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—    if CONFIG[&quot;total_requests&quot;] &gt; 0:        for i in range(CONFIG[&quot;total_requests&quot;]):            task_queue.put(i)    else:  # æŒç»­æ¨¡å¼å¡«å……é˜Ÿåˆ—        while True:            task_queue.put(1)    # åˆ›å»ºå·¥ä½œè€…çº¿ç¨‹    threads = []    for _ in range(CONFIG[&quot;thread_num&quot;]):        t = threading.Thread(target=worker)        t.daemon = True        t.start()        threads.append(t)    # å¯åŠ¨ç»Ÿè®¡çº¿ç¨‹    stat_thread = threading.Thread(target=print_stats)    stat_thread.start()    # ç­‰å¾…ä»»åŠ¡å®Œæˆ    task_queue.join()    stat_thread.join()    print(&quot;\\nå‹åŠ›æµ‹è¯•å®Œæˆ&quot;)#ä½¿ç”¨äº†joinç­‰å¾…å‹æµ‹ç»“æŸç»Ÿè®¡ä¿¡æ¯#ä½¿ç”¨äº†queue.putå¡«å……é˜Ÿåˆ—ä¸ºè¯·æ±‚æ•°é‡ï¼Œçº¿ç¨‹ä¸ºå¹¶å‘æ•°é‡#ä½¿ç”¨äº†with stats_lockåŠ é”é¿å…çº¿ç¨‹å†²çª#æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå› ä¸ºæ˜¯å¤§é‡é‡å¤ä»»åŠ¡#ä½¿ç”¨ThreadPoolExecutorçº¿ç¨‹æ± ä¼˜åŒ–ï¼Œå› ä¸ºæ˜¯å¤§é‡é‡å¤ä»»åŠ¡ï¼Œthreadæ¯æ¬¡éƒ½è¦æ–°åˆ›å»ºçº¿ç¨‹æ¶ˆè€—è¾ƒå¤§import threadingimport timeimport requestsfrom concurrent.futures import ThreadPoolExecutorCONFIG = &#123;    &quot;target_url&quot;: &quot;http://localhost/&quot;,    &quot;thread_num&quot;: 300,    &quot;total_requests&quot;: 10000,    &quot;timeout&quot;: 5,    &quot;headers&quot;: &#123;        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36&quot;    &#125;,    &quot;show_progress&quot;: True&#125;stats = &#123;    &#x27;total&#x27;: 0, &#x27;success&#x27;: 0, &#x27;fail&#x27;: 0,    &#x27;total_time&#x27;: 0.0, &#x27;max_time&#x27;: 0.0, &#x27;min_time&#x27;: float(&#x27;inf&#x27;)&#125;stats_lock = threading.Lock()def worker(_):    start_time = time.time()    try:        response = requests.get(            CONFIG[&quot;target_url&quot;],            headers=CONFIG[&quot;headers&quot;],            timeout=CONFIG[&quot;timeout&quot;]        )        elapsed = time.time() - start_time        with stats_lock:            stats[&#x27;total&#x27;] += 1            if 200 &lt;= response.status_code &lt; 400:                stats[&#x27;success&#x27;] += 1            else:                stats[&#x27;fail&#x27;] += 1            stats[&#x27;total_time&#x27;] += elapsed            stats[&#x27;max_time&#x27;] = max(stats[&#x27;max_time&#x27;], elapsed)            stats[&#x27;min_time&#x27;] = min(stats[&#x27;min_time&#x27;], elapsed)    except Exception as e:        with stats_lock:            stats[&#x27;fail&#x27;] += 1            stats[&#x27;total&#x27;] += 1def print_stats():    start_time = time.time()    while True:        time.sleep(1)        with stats_lock:            current_total = stats[&#x27;total&#x27;]            duration = time.time() - start_time            qps = current_total / duration if duration &gt; 0 else 0            avg_time = stats[&#x27;total_time&#x27;] / current_total if current_total &gt; 0 else 0            progress_percent = (current_total / CONFIG[&quot;total_requests&quot;]) * 100 if CONFIG[&quot;total_requests&quot;] &gt; 0 else 0            progress_bar = &quot;&quot;            if CONFIG[&quot;show_progress&quot;] and CONFIG[&quot;total_requests&quot;] &gt; 0:                bar_length = 20                filled = int(bar_length * current_total // CONFIG[&quot;total_requests&quot;])                progress_bar = &quot;[&quot; + &quot;=&quot; * filled + &quot; &quot; * (bar_length - filled) + &quot;] &quot;            output = (                f&quot;\\r[STAT] &quot;                f&quot;è¿›åº¦: &#123;progress_bar&#125;&#123;progress_percent:.1f&#125;% | &quot;                f&quot;è¯·æ±‚: &#123;current_total&#125;/&#123;CONFIG[&#x27;total_requests&#x27;] if CONFIG[&#x27;total_requests&#x27;] &gt; 0 else &#x27;âˆ&#x27;&#125; | &quot;                f&quot;æˆåŠŸ: &#123;stats[&#x27;success&#x27;]&#125; | &quot;                f&quot;å¤±è´¥: &#123;stats[&#x27;fail&#x27;]&#125; | &quot;                f&quot;QPS: &#123;qps:.1f&#125; | &quot;                f&quot;å¹³å‡: &#123;avg_time:.3f&#125;s | &quot;                f&quot;æœ€æ…¢: &#123;stats[&#x27;max_time&#x27;]:.3f&#125;s&quot;            )            print(output, end=&#x27;&#x27;, flush=True)            if CONFIG[&quot;total_requests&quot;] &gt; 0 and current_total &gt;= CONFIG[&quot;total_requests&quot;]:                breakif __name__ == &quot;__main__&quot;:    stat_thread = threading.Thread(target=print_stats)    stat_thread.start()    with ThreadPoolExecutor(max_workers=CONFIG[&quot;thread_num&quot;]) as executor:        if CONFIG[&quot;total_requests&quot;] &gt; 0:            executor.map(worker, range(CONFIG[&quot;total_requests&quot;]))        else:            while True:                executor.submit(worker, None)    stat_thread.join()    print(&quot;\\nå‹åŠ›æµ‹è¯•å®Œæˆ&quot;)\n\né¢å¤–\nThreadPoolExecutor é€‚ç”¨åœºæ™¯ï¼šçŸ­æœŸã€æ‰¹é‡ã€åŒè´¨åŒ–ä»»åŠ¡\n\nmultiprocessing é€‚ç”¨åœºæ™¯ï¼šå¤§é‡cpuå¯†é›†å‹è®¡ç®—ï¼Œå¤šè¿›ç¨‹ç»•è¿‡GILï¼›ioå¯†é›†å‹å»ºè®®ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹\n\n\n","categories":["python"]},{"title":"rsync","url":"/2025/08/05/rsync/","content":"å‘½ä»¤ä¸»è¦å‚æ•°-a, â€“â€“archive\tå½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§ï¼Œç­‰ä»·äº -rlptgoD (æ³¨æ„ä¸åŒ…æ‹¬ -H)-r, â€“â€“recursive\tå¯¹å­ç›®å½•ä»¥é€’å½’æ¨¡å¼å¤„ç†-l, â€“â€“links\tä¿æŒç¬¦å·é“¾æ¥æ–‡ä»¶-H, â€“â€“hard-links\tä¿æŒç¡¬é“¾æ¥æ–‡ä»¶-p, â€“â€“perms\tä¿æŒæ–‡ä»¶æƒé™-t, â€“â€“times\tä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯-g, â€“â€“group\tä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯-o, â€“â€“owner\tä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯ (super-user only)-D\tä¿æŒè®¾å¤‡æ–‡ä»¶å’Œç‰¹æ®Šæ–‡ä»¶ (super-user only)-z, â€“â€“compress\tåœ¨ä¼ è¾“æ–‡ä»¶æ—¶è¿›è¡Œå‹ç¼©å¤„ç†â€“â€“exclude=PATTERN\tæŒ‡å®šæ’é™¤ä¸€ä¸ªä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶åŒ¹é…æ¨¡å¼â€“â€“exclude-from=FILE\tä» FILE ä¸­è¯»å–æ’é™¤è§„åˆ™â€“â€“include=PATTERN\tæŒ‡å®šéœ€è¦ä¼ è¾“çš„æ–‡ä»¶åŒ¹é…æ¨¡å¼â€“â€“include-from=FILE\tä» FILE ä¸­è¯»å–åŒ…å«è§„åˆ™â€“â€“copy-unsafe-links\tæ‹·è´æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾æ¥æ–‡ä»¶â€“â€“safe-links\tå¿½ç•¥æŒ‡å‘SRCè·¯å¾„ç›®å½•æ ‘ä»¥å¤–çš„é“¾æ¥æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰â€“â€“existing\tä»…ä»…æ›´æ–°é‚£äº›å·²ç»å­˜åœ¨äºæ¥æ”¶ç«¯çš„æ–‡ä»¶ï¼Œè€Œä¸å¤‡ä»½é‚£äº›æ–°åˆ›å»ºçš„æ–‡ä»¶â€“â€“ignore-existing\tå¿½ç•¥é‚£äº›å·²ç»å­˜åœ¨äºæ¥æ”¶ç«¯çš„æ–‡ä»¶ï¼Œä»…å¤‡ä»½é‚£äº›æ–°åˆ›å»ºçš„æ–‡ä»¶-b, â€“â€“backup\tå½“æœ‰å˜åŒ–æ—¶ï¼Œå¯¹ç›®æ ‡ç›®å½•ä¸­çš„æ—§ç‰ˆæ–‡ä»¶è¿›è¡Œå¤‡ä»½â€“â€“backup-dir=DIR\tä¸ -b ç»“åˆä½¿ç”¨ï¼Œå°†å¤‡ä»½çš„æ–‡ä»¶å­˜åˆ° DIR ç›®å½•ä¸­â€“â€“link-dest=DIR\tå½“æ–‡ä»¶æœªæ”¹å˜æ—¶åŸºäº DIR åˆ›å»ºç¡¬é“¾æ¥æ–‡ä»¶â€“â€“delete\tåˆ é™¤é‚£äº›æ¥æ”¶ç«¯è¿˜æœ‰è€Œå‘é€ç«¯å·²ç»ä¸å­˜åœ¨çš„æ–‡ä»¶â€“â€“delete-before\tæ¥æ”¶è€…åœ¨ä¼ è¾“ä¹‹å‰è¿›è¡Œåˆ é™¤æ“ä½œ (é»˜è®¤)â€“â€“delete-during\tæ¥æ”¶è€…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¿›è¡Œåˆ é™¤æ“ä½œâ€“â€“delete-after\tæ¥æ”¶è€…åœ¨ä¼ è¾“ä¹‹åè¿›è¡Œåˆ é™¤æ“ä½œâ€“â€“delete-excluded\tåœ¨æ¥æ”¶æ–¹åŒæ—¶åˆ é™¤è¢«æ’é™¤çš„æ–‡ä»¶-e, â€“â€“rsh=COMMAND\tæŒ‡å®šæ›¿ä»£ rsh çš„ shell ç¨‹åºâ€“â€“ignore-errors\tå³ä½¿å‡ºç° I/O é”™è¯¯ä¹Ÿè¿›è¡Œåˆ é™¤â€“â€“partial\tä¿ç•™é‚£äº›å› æ•…æ²¡æœ‰å®Œå…¨ä¼ è¾“çš„æ–‡ä»¶ï¼Œä»¥æ˜¯åŠ å¿«éšåçš„å†æ¬¡ä¼ è¾“â€“â€“progress\tåœ¨ä¼ è¾“æ—¶æ˜¾ç¤ºä¼ è¾“è¿‡ç¨‹-P\tç­‰ä»·äº â€“â€“partial â€“â€“progressâ€“â€“delay-updates\tå°†æ­£åœ¨æ›´æ–°çš„æ–‡ä»¶å…ˆä¿å­˜åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼ˆé»˜è®¤ä¸º â€œ.~tmp~â€ï¼‰ï¼Œå¾…ä¼ è¾“å®Œæ¯•å†æ›´æ–°ç›®æ ‡æ–‡ä»¶-v, â€“â€“verbose\tè¯¦ç»†è¾“å‡ºæ¨¡å¼-q, â€“â€“quiet\tç²¾ç®€è¾“å‡ºæ¨¡å¼-h, â€“â€“human-readable\tè¾“å‡ºæ–‡ä»¶å¤§å°ä½¿ç”¨æ˜“è¯»çš„å•ä½ï¼ˆå¦‚ï¼ŒKï¼ŒMç­‰ï¼‰-n, â€“â€“dry-run\tæ˜¾ç¤ºå“ªäº›æ–‡ä»¶å°†è¢«ä¼ è¾“â€“â€“list-only\tä»…ä»…åˆ—å‡ºæ–‡ä»¶è€Œä¸è¿›è¡Œå¤åˆ¶â€“â€“rsyncpath=PROGRAM\tæŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ rsync å‘½ä»¤æ‰€åœ¨è·¯å¾„â€“â€“password-file=FILE\tä» FILE ä¸­è¯»å–å£ä»¤ï¼Œä»¥é¿å…åœ¨ç»ˆç«¯ä¸Šè¾“å…¥å£ä»¤ï¼Œé€šå¸¸åœ¨ cron ä¸­è¿æ¥ rsync æœåŠ¡å™¨æ—¶ä½¿ç”¨-4, â€“â€“ipv4\tä½¿ç”¨ IPv4-6, â€“â€“ipv6\tä½¿ç”¨ IPv6\n\nå‘½ä»¤è¡Œæ¨¡å¼#å¸¸ç”¨å‚æ•°rsync -avzSP \\ #ç«¯ç‚¹ç»­ä¼ æ•´åˆå°æ–‡ä»¶  --contimeout=120 \\    # è¿æ¥è¶…æ—¶ 120 ç§’  --timeout=60 \\       # æ•°æ®ä¼ è¾“è¶…æ—¶ 60 ç§’  --delay-updates \\    # åŸå­æ€§æ›¿æ¢æ–‡ä»¶  --log-file=rsync.log  #æ—¥å¿—è®°å½•/cygdrive/c/     /cygdrive/d/ #windowså¿…é¡»åŠ ä¸Š/cygdriveå‰ç¼€#å¯é€‰å‚æ•° --delay-updates éœ€è¦ç›®æ ‡ç£ç›˜ç©ºé—´è¾ƒå¤§ï¼Œå¯¹æ­£åœ¨è¿›è¡Œioæ“ä½œçš„å…ˆè·³è¿‡åæ›´æ–°#--bwlimit=6000 é™åˆ¶å¸¦å®½åœ¨6MB/s#--exclude=&#x27;*.log&#x27; è¿‡æ»¤æ–‡ä»¶ä¸ä¼ è¾“æ”¯æŒæ­£åˆ™#--delete  ä¿è¯æºå’Œç›®æ ‡å®Œå…¨ä¸€è‡´#--password-file=/etc/rsyncd_users.db backuper@127.0.0.1::wwwroot# /lib/systemd/system/rsync.service[Unit]Description=fast remote file copy program daemonConditionPathExists=/etc/rsyncd.conf[Service]ExecStart=/usr/bin/rsync --daemon --no-detach[Install]WantedBy=multi-user.target\n\n\nåå°serveræ¨¡å¼linuxé…ç½®cat &gt;&gt; /etc/rsyncd.conf  &lt;&lt; EOFuid = root\t\t\t\t\t     gid = root\t\t\t\t\t    use chroot = yes\t\t\t\t\taddress = 0.0.0.0\t\t\tport 873\t\t\t\t\t\t    log file = /var/log/rsyncd.log\t\tpid file = /var/run/rsyncd.pid\t\thosts allow = *\t\t[wwwroot]\t\t\t\t\t        path = /data/\t\t\t\tcomment = Document Root read only = yes\t\t\t\t\t    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z  auth users = backuper srs\t\t\tsecrets file = /etc/rsyncd_users.db\t\t\t      EOFecho &#x27;backuper:backuperpasswd&#x27; |tee -a /etc/rsyncd_users.db\tchmod 600 /etc/rsyncd_users.db#å®¢æˆ·ç«¯æ“ä½œ\t#echo &#x27;backuperpasswd&#x27; |tee /etc/client.pass &amp;&amp; chmod 600 /etc/client.pass#æ‹‰å–#rsync -avzPS --password-file=/etc/client.pass backuper@127.0.0.1::wwwroot /tmp/rsync_daemon#å‘é€ï¼›ç›¸å½“äºæŠŠ/tmp/rsync_daemonåŒæ­¥åˆ°/data/ read only è¦è®¾ç½®æˆno#rsync -avzPS --password-file=/etc/client.pass /tmp/rsync_daemon backuper@127.0.0.1::wwwroot ==================================================================#æ­£å¸¸é…ç½®é‡Œé¢ä¸èƒ½æœ‰æ³¨é‡Šuid = root\t\t\t\t\t     gid = root\t\t\t\t\t    use chroot = yes\t\t\t\t\t#ç¦é”¢åœ¨æºç›®å½•address = 0.0.0.0\t\t\t#ç›‘å¬åœ°å€ï¼Œç›‘å¬æœ¬æœºåœ°å€port 873\t\t\t\t\t\t    #ç›‘å¬ç«¯å£ tcp/udp 873ï¼Œlog file = /var/log/rsyncd.log\t\t#æ—¥å¿—æ–‡ä»¶ä½ç½®pid file = /var/run/rsyncd.pid\t\t#å­˜æ”¾è¿›ç¨‹ ID çš„æ–‡ä»¶ä½ç½®hosts allow = *\t\t#å…è®¸åŒæ­¥çš„å®¢æˆ·æœºç½‘æ®µmax connections = 5 #æœ€å¤§äº”ä¸ªè¿æ¥ï¼Œé»˜è®¤æ²¡æœ‰é™åˆ¶[wwwroot]\t\t\t\t\t        #å…±äº«æ¨¡å—åç§°path = /data\t\t\t\t#æºç›®å½•çš„å®é™…è·¯å¾„ï¼ˆåŒæ­¥çš„ç›®å½•ï¼‰comment = Document Root read only = yes\t\t\t\t\t    #æ˜¯å¦ä¸ºåªè¯»dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z  #åŒæ­¥æ—¶ä¸å†å‹ç¼©çš„æ–‡ä»¶ç±»å‹auth users = backuper srs\t\t\t#æˆæƒè´¦æˆ·ï¼Œå¤šä¸ªè´¦å·ä»¥ç©ºæ ¼åˆ†éš”secrets file = /etc/rsyncd_users.db\t\t\t      #å­˜æ”¾è´¦æˆ·ä¿¡æ¯çš„æ•°æ®æ–‡ä»¶EOF\nwindowsé…ç½®cygwinä¸‹è½½åœ°å€\n#windowsuid = Administrator    gid = Users  use chroot = yesaddress = 0.0.0.0port 873    log file = /var/log/rsyncd.logpid file = /var/run/rsyncd.pidhosts allow = *[wwwroot]        path = /cygdrive/c/datacomment = Document Root read only = yes    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z  auth users = backuper srssecrets file = /etc/rsyncd_users.db#åœ¨cygwinç»ˆç«¯æ‰§è¡Œ#echo &#x27;backuperpasswd&#x27; |tee /etc/client.pass &amp;&amp; chmod 600 /etc/client.pass      #rsync -avzPS --password-file=/etc/client.pass backuper@127.0.0.1::wwwroot /cygdrive/c/rsync_daemon\n\né¢å¤–å¤§é‡æ–‡ä»¶æ·»åŠ å¤±è´¥é‡è¯•#!/bin/bash# é…ç½®å‚æ•°PASSWORD=&#x27;pass&#x27;#REMOTE_PATH=&quot;administrator@1.1.1.1:/cygdrive/c/data&quot;REMOTE_PATH=&quot;root@127.0.0.1:/data&quot;LOCAL_PATH=&quot;/tmp/rsync/&quot;#windowså¿…é€‰#RSYNC_PATH=&quot;C:\\\\cygwin64\\\\bin\\\\rsync.exe&quot;LOG_FILE=&quot;rsync.log&quot;# æœ€å¤§é‡è¯•æ¬¡æ•°MAX_RETRIES=10# é‡è¯•é—´éš”ï¼ˆç§’ï¼‰RETRY_INTERVAL=60# å¾ªç¯é‡è¯•retry=0while [ $retry -lt $MAX_RETRIES ]; do  echo &quot;$(date) - ç¬¬ $((retry+1)) æ¬¡å°è¯•åŒæ­¥...&quot; | tee -a &quot;$LOG_FILE&quot;    # æ‰§è¡ŒåŒæ­¥å‘½ä»¤  sshpass -p &quot;$PASSWORD&quot; rsync -avzSP \\    --log-file=&quot;$LOG_FILE&quot; \\  #  --rsync-path=&quot;$RSYNC_PATH&quot; \\    --timeout=30 \\    --contimeout=30 \\    &quot;$REMOTE_PATH&quot; &quot;$LOCAL_PATH&quot;    # æ£€æŸ¥é€€å‡ºçŠ¶æ€ç   if [ $? -eq 0 ]; then    echo &quot;$(date) - åŒæ­¥æˆåŠŸï¼&quot; | tee -a &quot;$LOG_FILE&quot;    exit 0  else    echo &quot;$(date) - åŒæ­¥å¤±è´¥ï¼Œ$&#123;RETRY_INTERVAL&#125;ç§’åé‡è¯•...&quot; | tee -a &quot;$LOG_FILE&quot;    sleep $RETRY_INTERVAL    ((retry++))  fidoneecho &quot;$(date) - è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒåŒæ­¥ç»ˆæ­¢ã€‚&quot; | tee -a &quot;$LOG_FILE&quot;exit 1\nä¸¤ç§åŒæ­¥æ¨¡å¼1.æœåŠ¡ç«¯æ¨é€ï¼›éœ€è¦æ¯ä¸ªå®¢æˆ·ç«¯å¯åŠ¨rsync â€“deamonæ·»åŠ é…ç½®æ–‡ä»¶ä¸ç„¶éœ€è¦ä½¿ç”¨sshæ¨¡å¼æ¶‰åŠå¯†ç ä¸å®‰å…¨,ç›‘æ§æœåŠ¡ç«¯æ–‡ä»¶å˜åŒ–å»åŒæ­¥å®¢æˆ·ç«¯èŠ‚ç‚¹å¤§éƒ¨åˆ†æƒ…å†µç”¨è¿™ç§ï¼Œå¼Šç«¯å°±æ˜¯èŠ‚ç‚¹è¾ƒå¤šæœåŠ¡ç«¯åŒæ­¥èµ·æ¥è´Ÿè½½ä¼šæ¯”è¾ƒé«˜2.å®¢æˆ·ç«¯æ¨é€ï¼›åªéœ€è¦åœ¨æœåŠ¡ç«¯é…ç½®rsync â€“deamonç›‘æ§å®¢æˆ·ç«¯æ–‡ä»¶å˜åŒ–å»æ¨é€æ•°æ®åˆ°æœåŠ¡ç«¯ï¼Œç”±äºå¤šèŠ‚ç‚¹å­˜åœ¨æ•°æ®ä¸ä¸€è‡´è¿™ç§æƒ…å†µå»ºè®®ä¸ä½¿ç”¨â€“deleteä¸ç„¶ä¸€ä¸ªèŠ‚ç‚¹æ“ä½œåˆ é™¤ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šè¢«åˆ é™¤ï¼›æˆ–è€…ä½¿ç”¨å®¢æˆ·ç«¯æ‹‰å–è¿™ç§æƒ…å†µåªæœ‰é€šè¿‡å®šæ—¶ä»»åŠ¡å®ç°å°±æ— æ³•ä½¿ç”¨ç›‘æ§ç¨‹åºäº†\nrsync+inotify\nå¼‚åœ°å¤‡ä»½cdnèŠ‚ç‚¹å°‘é‡åŒæ­¥ï¼›å˜åŠ¨ä¸é¢‘ç¹inotify-tools åŒ…å« inotifywatch  inotifywaitä¸¤ä¸ªå‘½ä»¤inotifywatch -v -t 60 -r /var/log #ç»Ÿè®¡æ¬¡æ•°inotifywait -mrq --format &quot;%T %w%f %e&quot; --timefmt &quot;%F-%T&quot; -e create,delete,move,modify,attrib /data/ |    while read TIME FILE EVENT; do  echo &quot;æ—¶é—´: $TIME | æ–‡ä»¶: $FILE | äº‹ä»¶: $EVENT &quot;done%T\tæ—¶é—´æˆ³ï¼ˆéœ€é…åˆ --timefmt å®šä¹‰æ ¼å¼ï¼‰%w\tç›‘æ§ç›®å½•çš„è·¯å¾„ï¼ˆç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„ï¼‰%f\tè§¦å‘äº‹ä»¶çš„æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰%e\täº‹ä»¶ç±»å‹ï¼ˆå¤šä¸ªäº‹ä»¶ç”¨é€—å·åˆ†éš”ï¼‰-m æŒç»­ç›‘å¬-r ä½¿ç”¨é€’å½’å½¢å¼ç›‘è§†ç›®å½•-q å‡å°‘å†—ä½™ä¿¡æ¯ï¼Œåªæ‰“å°å‡ºéœ€è¦çš„ä¿¡æ¯-e æŒ‡å®šè¦ç›‘è§†çš„äº‹ä»¶ï¼Œå¤šä¸ªæ—¶é—´ä½¿ç”¨é€—å·éš”å¼€â€“timefmt æ—¶é—´æ ¼å¼â€“format ç›‘å¬åˆ°çš„æ–‡ä»¶å˜åŒ–çš„ä¿¡æ¯access\tæ–‡ä»¶è¢«è¯»å–modify\tæ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹attrib\tæ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€æ—¶é—´æˆ³ï¼‰å˜æ›´create\tæ–‡ä»¶/ç›®å½•åˆ›å»ºdelete\tæ–‡ä»¶/ç›®å½•åˆ é™¤open, close\tæ–‡ä»¶è¢«æ‰“å¼€æˆ–å…³é—­#åœ¨clientè¿è¡Œè„šæœ¬ï¼Œclientç›®å½•å‘é€å˜åŒ–ä¼šåŒæ­¥åˆ°rsyncæœåŠ¡ç«¯cat &gt; ./inotify_rsync.sh &lt;&lt; &#x27;EOF&#x27;  #!/bin/bash# Rsyncé…ç½®RSYNC_CMD=&quot;rsync -avzS --partial --delay-updates --delete --password-file=/etc/client.pass /data/ backuper@10.0.1.122::wwwroot&quot;LOG_FILE=&quot;/var/log/inotify_rsync.log&quot;# åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰touch &quot;$LOG_FILE&quot;# å¼€å§‹ç›‘æ§å¹¶å¤„ç†äº‹ä»¶inotifywait -mrq --format &quot;%T %w%f %e&quot; --timefmt &quot;%F-%T&quot; -e create,delete,move,modify,attrib /data/ |  while read TIME FILE EVENT; do    # è®°å½•äº‹ä»¶åˆ°æ—¥å¿—    echo &quot;[äº‹ä»¶] æ—¶é—´: $TIME | æ–‡ä»¶: $FILE | æ“ä½œ: $EVENT&quot; &gt;&gt; &quot;$LOG_FILE&quot;        # æ‰§è¡ŒrsyncåŒæ­¥ï¼ˆæ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶ï¼‰    if ! $RSYNC_CMD &gt;&gt; &quot;$LOG_FILE&quot; 2&gt;&amp;1; then        echo &quot;[é”™è¯¯] åŒæ­¥å¤±è´¥ï¼æ—¶é—´: $(date &#x27;+%F-%T&#x27;)&quot; &gt;&gt; &quot;$LOG_FILE&quot;    else        echo &quot;[åŒæ­¥] æˆåŠŸå®Œæˆï¼æ—¶é—´: $(date &#x27;+%F-%T&#x27;)&quot; &gt;&gt; &quot;$LOG_FILE&quot;    fidoneEOFchmod +x inotify_rsync.shcat &gt;  /etc/systemd/system/inotify_rsync.service &lt;&lt; &#x27;EOF&#x27;  [Unit]Description=Auto Sync Service via inotify+rsync[Service]Type=simpleUser=rootExecStart=/tmp/rsync_daemon/inotify_rsync.shRestart=always[Install]WantedBy=multi-user.targetEOF\n\nrsync+lsyncd\né€‚åˆå¤§é‡æ•°æ®åŒæ­¥åœºæ™¯ï¼›å˜åŠ¨é¢‘ç¹å®˜æ–¹æ–‡æ¡£å‚æ•°è§£è¯»#ubuntu /etc/lsyncd/lsyncd.conf.luacat &gt; /etc/lsyncd.conf &lt;&lt; &#x27;EOF&#x27;settings &#123;  logfile = &quot;/var/log/lsyncd.log&quot;,  statusFile = &quot;/var/log/lsyncd.status&quot;,  insist = true,  statusInterval = 10&#125;sync &#123;  default.rsync,  source = &quot;/tmp/rsync_ly&quot;,  target = &quot;backuper@10.0.1.122::wwwroot&quot;,  -- excludeFrom = &quot;/etc/rsyncd.d/rsync_exclude.lst&quot;,  delete = true,  delay = 20,  maxDelays = 1,  rsync = &#123;    binary = &quot;/usr/bin/rsync&quot;,    archive = true,    compress = true,    verbose = false,    password_file = &quot;/etc/client.pass&quot;,    _extra    = &#123;            &quot;--partial&quot;,                      &quot;--timeout=300&quot;      --          &quot;--bwlimit=5000&quot;              &#125;,  &#125;&#125;EOF========================================================-- å…¨å±€é…ç½®ï¼šsettings &#123;        logfile =&quot;/var/log/lsyncd/lsyncd.log&quot;, -- å®šä¹‰æ—¥å¿—æ–‡ä»¶        statusFile =&quot;/var/log/lsyncd/lsyncd.status&quot;,  -- å®šä¹‰çŠ¶æ€æ–‡ä»¶        pidfile = &quot;/var/log/lsyncd/lsyncd.pid&quot;,-- å®šä¹‰pidæ–‡ä»¶        inotifyMode = &quot;CloseWrite&quot;,-- æŒ‡å®šinotifyç›‘æ§çš„äº‹ä»¶ï¼Œé»˜è®¤æ˜¯CloseWriteï¼Œè¿˜å¯ä»¥æ˜¯Modifyæˆ–CloseWrite or Modify      \tmaxProcesses = 7,-- åŒæ­¥è¿›ç¨‹çš„æœ€å¤§ä¸ªæ•°ã€‚å‡å¦‚åŒæ—¶æœ‰20ä¸ªæ–‡ä»¶éœ€è¦åŒæ­¥ï¼Œè€ŒmaxProcesses = 8ï¼Œåˆ™æœ€å¤§èƒ½çœ‹åˆ°æœ‰8ä¸ªrysncè¿›ç¨‹        nodaemon =true,-- è¡¨ç¤ºä¸å¯ç”¨å®ˆæŠ¤æ¨¡å¼ï¼Œé»˜è®¤ï¼›        maxDelays = 1, --  ç´¯è®¡åˆ°å¤šå°‘æ‰€ç›‘æ§çš„äº‹ä»¶æ¿€æ´»ä¸€æ¬¡åŒæ­¥ï¼Œå³ä½¿åé¢çš„delayå»¶è¿Ÿæ—¶é—´è¿˜æœªåˆ°        inist = ture --keep running at startup although one or more targets failed due to not being reachable.  ä¸€èˆ¬ä¸ç”¨é…ç½®       &#125;-- syncéƒ¨åˆ†é…ç½®ï¼šsync &#123;      default.rsync,     -- rsyncã€rsyncsshã€directä¸‰ç§æ¨¡å¼ï¼š    -- default.rsync ï¼šæœ¬åœ°ç›®å½•é—´åŒæ­¥ï¼Œä½¿ç”¨rsyncï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ä½¿ç”¨sshå½¢å¼çš„è¿œç¨‹rsyncæ•ˆæœï¼Œæˆ–daemonæ–¹å¼è¿æ¥è¿œç¨‹rsyncdè¿›ç¨‹ï¼›    -- default.direct ï¼šæœ¬åœ°ç›®å½•é—´åŒæ­¥ï¼Œä½¿ç”¨cpã€rmç­‰å‘½ä»¤å®Œæˆå·®å¼‚æ–‡ä»¶å¤‡ä»½ï¼›    -- default.rsyncssh ï¼šåŒæ­¥åˆ°è¿œç¨‹ä¸»æœºç›®å½•ï¼Œrsyncçš„sshæ¨¡å¼ï¼Œéœ€è¦ä½¿ç”¨keyæ¥è®¤è¯ï¼›      source = &quot;/tmp/src&quot;, -- source åŒæ­¥çš„æºç›®å½•ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„      target = &quot;/tmp/dest&quot;, -- target å®šä¹‰ç›®çš„åœ°å€.å¯¹åº”ä¸åŒçš„æ¨¡å¼æœ‰å‡ ç§å†™æ³•:    \t-- /tmp/dest ï¼šæœ¬åœ°ç›®å½•åŒæ­¥ï¼Œå¯ç”¨äºdirectå’Œrsyncæ¨¡å¼ï¼›    \t-- 10.4.7.10:/tmp/dest ï¼šåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ç›®å½•ï¼Œå¯ç”¨äºrsyncå’Œrsyncsshæ¨¡å¼ï¼Œæ‹¼æ¥çš„å‘½ä»¤ç±»ä¼¼äº/usr/bin/rsync -ltsd --delete --include-from=- --exclude=* SOURCE TARGETï¼Œå‰©ä¸‹çš„å°±æ˜¯rsyncçš„å†…å®¹äº†ï¼Œæ¯”å¦‚æŒ‡å®šusernameï¼Œå…å¯†ç åŒæ­¥ï¼›   \t\t-- 10.4.7.10::module ï¼šåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ç›®å½•ï¼Œç”¨äºrsyncæ¨¡å¼ï¼›      init = true,  -- init è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå½“init = falseï¼ŒåªåŒæ­¥è¿›ç¨‹å¯åŠ¨ä»¥åå‘ç”Ÿæ”¹åŠ¨äº‹ä»¶çš„æ–‡ä»¶ï¼ŒåŸæœ‰çš„ç›®å½•å³ä½¿æœ‰å·®å¼‚ä¹Ÿä¸ä¼šåŒæ­¥ã€‚é»˜è®¤æ˜¯trueï¼›      delay = 3, -- delay ç´¯è®¡äº‹ä»¶ï¼Œç­‰å¾…rsyncåŒæ­¥å»¶æ—¶æ—¶é—´ï¼Œé»˜è®¤15ç§’ï¼ˆæœ€å¤§ç´¯è®¡åˆ°1000ä¸ªä¸å¯åˆå¹¶çš„äº‹ä»¶ï¼‰ã€‚ä¹Ÿå°±æ˜¯15så†…ç›‘æ§ç›®å½•ä¸‹å‘ç”Ÿçš„æ”¹åŠ¨ï¼Œä¼šç´¯ç§¯åˆ°ä¸€æ¬¡rsyncåŒæ­¥ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„åŒæ­¥ã€‚ï¼ˆå¯åˆå¹¶çš„æ„æ€æ˜¯ï¼Œ15så†…ä¸¤æ¬¡ä¿®æ”¹äº†åŒä¸€æ–‡ä»¶ï¼Œæœ€ååªåŒæ­¥æœ€æ–°çš„æ–‡ä»¶ï¼‰;      excludeFrom = &quot;/etc/rsyncd.d/rsync_exclude.lst&quot;,  -- excludeFrom æ’é™¤é€‰é¡¹ï¼Œåé¢æŒ‡å®šæ’é™¤çš„åˆ—è¡¨æ–‡ä»¶ï¼Œå¦‚excludeFrom = &quot;/etc/lsyncd.exclude&quot;ï¼Œå¦‚æœæ˜¯ç®€å•çš„æ’é™¤ï¼Œå¯ä»¥ä½¿ç”¨exclude = LISTã€‚è¿™é‡Œçš„æ’é™¤è§„åˆ™å†™æ³•ä¸åŸç”Ÿrsyncæœ‰ç‚¹ä¸åŒï¼Œæ›´ä¸ºç®€å•ï¼š\t\t-- ç›‘æ§è·¯å¾„é‡Œçš„ä»»ä½•éƒ¨åˆ†åŒ¹é…åˆ°ä¸€ä¸ªæ–‡æœ¬ï¼Œéƒ½ä¼šè¢«æ’é™¤ï¼Œä¾‹å¦‚/bin/foo/barå¯ä»¥åŒ¹é…è§„åˆ™foo\t\t-- å¦‚æœè§„åˆ™ä»¥æ–œçº¿/å¼€å¤´ï¼Œåˆ™ä»å¤´å¼€å§‹è¦åŒ¹é…å…¨éƒ¨\t\t-- å¦‚æœè§„åˆ™ä»¥/ç»“å°¾ï¼Œåˆ™è¦åŒ¹é…ç›‘æ§è·¯å¾„çš„æœ«å°¾\t\t-- ?åŒ¹é…ä»»ä½•å­—ç¬¦ï¼Œä½†ä¸åŒ…æ‹¬/\t\t-- *åŒ¹é…0æˆ–å¤šä¸ªå­—ç¬¦ï¼Œä½†ä¸åŒ…æ‹¬/\t\t-- **åŒ¹é…0æˆ–å¤šä¸ªå­—ç¬¦ï¼Œå¯ä»¥æ˜¯/      delete\t=\t&#x27;running&#x27;,  -- delete ä¸ºäº†ä¿æŒtargetä¸souceå®Œå…¨åŒæ­¥ï¼ŒLsyncdé»˜è®¤ä¼šdelete = trueæ¥å…è®¸åŒæ­¥åˆ é™¤ã€‚å®ƒé™¤äº†falseï¼Œè¿˜æœ‰startupã€runningå€¼ï¼š      -- delete\t=\ttrue       # åœ¨ç›®æ ‡ä¸Šåˆ é™¤æºä¸­æ²¡æœ‰çš„å†…å®¹ã€‚åœ¨å¯åŠ¨æ—¶ä»¥åŠåœ¨æ­£å¸¸æ“ä½œæœŸé—´åˆ é™¤çš„å†…å®¹      -- delete\t=\tfalse      # ä¸ä¼šåˆ é™¤ç›®æ ‡ä¸Šçš„ä»»ä½•æ–‡ä»¶ã€‚ä¸åœ¨å¯åŠ¨æ—¶ä¹Ÿä¸åœ¨æ­£å¸¸æ“ä½œä¸Š      -- delete\t=\t&#x27;startup&#x27;  # Lsyncdå°†åœ¨å¯åŠ¨æ—¶åˆ é™¤ç›®æ ‡ä¸Šçš„æ–‡ä»¶ï¼Œä½†ä¸ä¼šåœ¨æ­£å¸¸æ“ä½œæ—¶åˆ é™¤      -- delete\t=\t&#x27;running&#x27;  # Lsyncdåœ¨å¯åŠ¨æ—¶ä¸ä¼šåˆ é™¤ç›®æ ‡ä¸Šçš„æ–‡ä»¶ï¼Œä½†ä¼šåˆ é™¤æ­£å¸¸æ“ä½œæœŸé—´åˆ é™¤çš„æ–‡ä»¶    -- rsyncéƒ¨åˆ†é…ç½®ï¼š          -- deleteå’Œexcludeæœ¬æ¥éƒ½æ˜¯rsyncçš„é€‰é¡¹ï¼Œä¸Šé¢æ˜¯é…ç½®åœ¨syncä¸­çš„ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯ä¸ºäº†å‡å°‘rsyncçš„å¼€é”€      rsync = &#123;             bwlimit=200, -- bwlimit é™é€Ÿï¼Œå•ä½kb/sï¼Œä¸rsyncç›¸åŒï¼ˆè¿™ä¹ˆé‡è¦çš„é€‰é¡¹åœ¨æ–‡æ¡£é‡Œç«Ÿç„¶æ²¡æœ‰æ ‡å‡ºï¼‰ï¼›             binary = &quot;/usr/bin/rsync&quot;, -- rsyncå¯æ‰§è¡Œç¨‹åºåœ°å€ï¼Œé»˜è®¤/usr/bin/rsync             archive = true, -- é»˜è®¤falseï¼Œä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§             compress = true,-- å‹ç¼©ä¼ è¾“é»˜è®¤ä¸ºtrueã€‚åœ¨å¸¦å®½ä¸cpuè´Ÿè½½ä¹‹é—´æƒè¡¡ï¼Œæœ¬åœ°ç›®å½•åŒæ­¥å¯ä»¥è€ƒè™‘æŠŠå®ƒè®¾ä¸ºfalseï¼›             verbose = true,--åŒæ­¥è¯¦ç»†æ¨¡å¼è¾“å‡º        \t perms = true -- perms ä¿ç•™æ–‡ä»¶æƒé™,é»˜è®¤ä¸ºtrueï¼›      &#125;&#125;#-- excludeFrom = &quot;/etc/rsyncd.d/rsync_exclude.lst&quot;, #*.log#/cache/#/temp/#.git/\n\n","categories":["linux"]},{"title":"screen","url":"/2025/04/27/screen/","content":"å¤šç»ˆç«¯ç®¡ç†ç¥å™¨ctrl +a + d é€€å‡ºç»ˆç«¯exit é€€å‡ºåŠ é”€æ¯ç»ˆç«¯\nå¸¸ç”¨å‚æ•°$&gt; screen [-AmRvx -ls -wipe][-d &lt;ä½œä¸šåç§°&gt;][-h &lt;è¡Œæ•°&gt;][-r &lt;ä½œä¸šåç§°&gt;][-s ][-S &lt;ä½œä¸šåç§°&gt;] -A ã€€å°†æ‰€æœ‰çš„è§†çª—éƒ½è°ƒæ•´ä¸ºç›®å‰ç»ˆç«¯æœºçš„å¤§å°ã€‚-d   &lt;ä½œä¸šåç§°&gt; ã€€å°†æŒ‡å®šçš„screenä½œä¸šç¦»çº¿ã€‚-h   &lt;è¡Œæ•°&gt; ã€€æŒ‡å®šè§†çª—çš„ç¼“å†²åŒºè¡Œæ•°ã€‚-m ã€€å³ä½¿ç›®å‰å·²åœ¨ä½œä¸šä¸­çš„screenä½œä¸šï¼Œä»å¼ºåˆ¶å»ºç«‹æ–°çš„screenä½œä¸šã€‚-r   &lt;ä½œä¸šåç§°&gt; ã€€æ¢å¤ç¦»çº¿çš„screenä½œä¸šã€‚-R ã€€å…ˆè¯•å›¾æ¢å¤ç¦»çº¿çš„ä½œä¸šã€‚è‹¥æ‰¾ä¸åˆ°ç¦»çº¿çš„ä½œä¸šï¼Œå³å»ºç«‹æ–°çš„screenä½œä¸šã€‚-s ã€€æŒ‡å®šå»ºç«‹æ–°è§†çª—æ—¶ï¼Œæ‰€è¦æ‰§è¡Œçš„shellã€‚-S   &lt;ä½œä¸šåç§°&gt; ã€€æŒ‡å®šscreenä½œä¸šçš„åç§°ã€‚-v ã€€æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ã€‚-x ã€€æ¢å¤ä¹‹å‰ç¦»çº¿çš„screenä½œä¸šã€‚-lsæˆ–--list ã€€æ˜¾ç¤ºç›®å‰æ‰€æœ‰çš„screenä½œä¸šã€‚-wipe ã€€æ£€æŸ¥ç›®å‰æ‰€æœ‰çš„screenä½œä¸šï¼Œå¹¶åˆ é™¤å·²ç»æ— æ³•ä½¿ç”¨çš„screenä½œä¸šã€‚screen -S yourname -&gt; æ–°å»ºä¸€ä¸ªå«yournameçš„sessionscreen -ls         -&gt; åˆ—å‡ºå½“å‰æ‰€æœ‰çš„sessionscreen -r yourname -&gt; å›åˆ°yournameè¿™ä¸ªsessionscreen -d yourname -&gt; è¿œç¨‹detachæŸä¸ªsessionscreen -d -r yourname -&gt; ç»“æŸå½“å‰sessionå¹¶å›åˆ°yournameè¿™ä¸ªsession\nå¸¸ç”¨å¿«æ·é”®C-a ? -&gt; æ˜¾ç¤ºæ‰€æœ‰é”®ç»‘å®šä¿¡æ¯C-a c -&gt; åˆ›å»ºä¸€ä¸ªæ–°çš„è¿è¡Œshellçš„çª—å£å¹¶åˆ‡æ¢åˆ°è¯¥çª—å£C-a n -&gt; Nextï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª window C-a p -&gt; Previousï¼Œåˆ‡æ¢åˆ°å‰ä¸€ä¸ª window C-a 0..9 -&gt; åˆ‡æ¢åˆ°ç¬¬ 0..9 ä¸ª windowCtrl+a [Space] -&gt; ç”±è§†çª—0å¾ªåºåˆ‡æ¢åˆ°è§†çª—9C-a C-a -&gt; åœ¨ä¸¤ä¸ªæœ€è¿‘ä½¿ç”¨çš„ window é—´åˆ‡æ¢ C-a x -&gt; é”ä½å½“å‰çš„ windowï¼Œéœ€ç”¨ç”¨æˆ·å¯†ç è§£é”C-a d -&gt; detachï¼Œæš‚æ—¶ç¦»å¼€å½“å‰sessionï¼Œå°†ç›®å‰çš„ screen session (å¯èƒ½å«æœ‰å¤šä¸ª windows) ä¸¢åˆ°åå°æ‰§è¡Œï¼Œå¹¶ä¼šå›åˆ°è¿˜æ²¡è¿› screen æ—¶çš„çŠ¶æ€ï¼Œæ­¤æ—¶åœ¨ screen session é‡Œï¼Œæ¯ä¸ª window å†…è¿è¡Œçš„ process (æ— è®ºæ˜¯å‰å°/åå°)éƒ½åœ¨ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿ logout ä¹Ÿä¸å½±å“ã€‚ C-a z -&gt; æŠŠå½“å‰sessionæ”¾åˆ°åå°æ‰§è¡Œï¼Œç”¨ shell çš„ fg å‘½ä»¤åˆ™å¯å›å»ã€‚C-a w -&gt; æ˜¾ç¤ºæ‰€æœ‰çª—å£åˆ—è¡¨C-a t -&gt; timeï¼Œæ˜¾ç¤ºå½“å‰æ—¶é—´ï¼Œå’Œç³»ç»Ÿçš„ load C-a k -&gt; kill windowï¼Œå¼ºè¡Œå…³é—­å½“å‰çš„ windowC-a [ -&gt; è¿›å…¥ copy modeï¼Œåœ¨ copy mode ä¸‹å¯ä»¥å›æ»šã€æœç´¢ã€å¤åˆ¶å°±åƒç”¨ä½¿ç”¨ vi ä¸€æ ·    C-b Backwardï¼ŒPageUp     C-f Forwardï¼ŒPageDown     H(å¤§å†™) Highï¼Œå°†å…‰æ ‡ç§»è‡³å·¦ä¸Šè§’     L Lowï¼Œå°†å…‰æ ‡ç§»è‡³å·¦ä¸‹è§’     0 ç§»åˆ°è¡Œé¦–     $ è¡Œæœ«     w forward one wordï¼Œä»¥å­—ä¸ºå•ä½å¾€å‰ç§»     b backward one wordï¼Œä»¥å­—ä¸ºå•ä½å¾€åç§»     Space ç¬¬ä¸€æ¬¡æŒ‰ä¸ºæ ‡è®°åŒºèµ·ç‚¹ï¼Œç¬¬äºŒæ¬¡æŒ‰ä¸ºç»ˆç‚¹     Esc ç»“æŸ copy mode C-a ] -&gt; pasteï¼ŒæŠŠåˆšåˆšåœ¨ copy mode é€‰å®šçš„å†…å®¹è´´ä¸Š\n","categories":["linux"]},{"title":"sglang","url":"/2025/09/23/sglang/","content":"SGLang éƒ¨ç½²ä¸ä½¿ç”¨æŒ‡å—ç›®å½•\nSGLang éƒ¨ç½²ä¸ä½¿ç”¨æŒ‡å—\nç›®å½•\nç¯å¢ƒå‡†å¤‡ä¸å®‰è£…\nåŸºç¡€ç¯å¢ƒé…ç½®\n\n\nDockerå®¹å™¨éƒ¨ç½²\næœåŠ¡å¯åŠ¨é…ç½®\nå•èŠ‚ç‚¹å¯åŠ¨\nåŒèŠ‚ç‚¹åˆ†å¸ƒå¼å¯åŠ¨\n\n\nåŠŸèƒ½æµ‹è¯•\næ€§èƒ½åŸºå‡†æµ‹è¯•\nPDåˆ†ç¦»éƒ¨ç½²\nç¯å¢ƒå‡†å¤‡\næœåŠ¡éƒ¨ç½²\n\n\nåˆ†å¸ƒå¼éƒ¨ç½² (2P1D)\nPrefillèŠ‚ç‚¹é…ç½®\nDecodeèŠ‚ç‚¹é…ç½®\n\n\n\n\n\n\nç¯å¢ƒå‡†å¤‡ä¸å®‰è£…åŸºç¡€ç¯å¢ƒé…ç½®# ç¦ç”¨IPv6sysctl -w net.ipv6.conf.all.disable_ipv6=1 sysctl -w net.ipv6.conf.default.disable_ipv6=1# è®¾ç½®ç½‘ç»œæ¥å£å’ŒNCCLå‚æ•°export GLOO_SOCKET_IFNAME=eth0#export NCCL_DEBUG=infoexport NCCL_IB_DISABLE=1\n\n\nDockerå®¹å™¨éƒ¨ç½²docker run -d -t --network=host --gpus all \\    --privileged \\    --ipc=host \\    --cap-add=SYS_PTRACE \\    --name sglang \\    --ulimit memlock=-1 \\    --ulimit stack=67108864 \\    -v /mnt:/mnt registry.cn-hangzhou.aliyuncs.com/lky-deploy/llm:sglang-0.4.2.post2 bash\n\n\næœåŠ¡å¯åŠ¨é…ç½®https://github.com/sgl-project/sglang/blob/main/benchmark/deepseek_v3/README.md\nå•èŠ‚ç‚¹å¯åŠ¨python3 -m sglang.launch_server \\    --port 40000 \\    --model-path /mnt/DeepSeek-R1 \\    --trust-remote-code \\    --tp 32 \\    --host 0.0.0.0 \\#å¯é€‰--enable-torch-compile --torch-compile-max-bs\n\nåŒèŠ‚ç‚¹åˆ†å¸ƒå¼å¯åŠ¨èŠ‚ç‚¹1 (Rank 0):\npython3 -m sglang.launch_server \\    --port 30000 \\    --model-path /mnt/7B \\    --mem-fraction-static 0.8 \\    --trust-remote-code \\    --tp 16 \\    --dp 2 \\    --enable-dp-attention \\    --dist-init-addr 10.0.1.105:20000 \\    --nnodes 2 \\    --node-rank 0\n\nèŠ‚ç‚¹2 (Rank 1):\n# ä¿®æ”¹node-rankå‚æ•°ä¸º1ï¼Œå…¶ä»–é…ç½®ä¿æŒä¸èŠ‚ç‚¹1ä¸€è‡´--node-rank 1\n\n\nåŠŸèƒ½æµ‹è¯•curl http://localhost:30000/generate \\ -H &quot;Content-Type: application/json&quot; \\ -d &#x27;&#123;  &quot;text&quot;: &quot;deepseekä¸­æœ‰å‡ ä¸ªeï¼Ÿ&quot;,  &quot;sampling_params&quot;: &#123;  &quot;max_new_tokens&quot;: 3000,  &quot;temperature&quot;: 0 &#125;&#125;&#x27;\n\n\næ€§èƒ½åŸºå‡†æµ‹è¯•python -m sglang.bench_serving \\--backend sglang --host 127.0.0.1 --port 30000 \\--model /mnt/DeepSeek-V3/DeepSeek-V3/ \\--dataset-name random \\--random-input-len 20000 \\--random-output-len 4096 \\--max-concurrency 8 \\--num-prompts 80 \\--dataset-path /root/ShareGPT_V3_unfiltered_cleaned_split.json &amp;&gt; 20k_8_80.txt &amp;\n\n\nPDåˆ†ç¦»éƒ¨ç½²https://docs.sglang.ai/advanced_features/pd_disaggregation.html#deepseek-multi-nodemooncakeéœ€è¦rdmaè¿™ç§InfiniBandè®¾å¤‡æ”¯æŒï¼Œnixlä¸éœ€è¦\nç¯å¢ƒå‡†å¤‡# å®‰è£…Minicondawget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.shbash Miniconda3-latest-Linux-x86_64.sh~/miniconda3/bin/conda init bashsource ~/.bashrc# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒconda create -n sglang python=3.10conda activate sglangpip install sglang[all]\n\næœåŠ¡éƒ¨ç½²PrefillæœåŠ¡:\n#nixl ä¾èµ–#yum install -y ninja-build openssl3#nixl==0.5.1 Python 3.10.12 Python 3.10.17#pip install nixl sglang-router  python -m sglang.launch_server \\  --model-path $path \\  --disaggregation-mode prefill \\  --port 30000 \\  --disaggregation-transfer-backend nixl#--disaggregation-bootstrap-port é»˜è®¤8998å¯¹åº”è·¯ç”±æœåŠ¡ç«¯å£\n\nDecodeæœåŠ¡:\npython -m sglang.launch_server \\  --model-path $path \\  --disaggregation-mode decode \\  --port 30001 \\  --base-gpu-id 1 \\  --disaggregation-transfer-backend nixl\n\nè·¯ç”±æœåŠ¡:https://docs.sglang.ai/advanced_features/router.html#mode-3-prefill-decode-disaggregation\npython -m sglang_router.launch_router \\--pd-disaggregation \\--prefill http://$&#123;p&#125;:30000 8998 \\--decode http://127.0.0.1:30001 \\--host 0.0.0.0 \\--port 8000\n\n\nåˆ†å¸ƒå¼éƒ¨ç½² (2P1D)PrefillèŠ‚ç‚¹é…ç½®èŠ‚ç‚¹0:\nexport CUDA_VISIBLE_DEVICES=0python -m sglang.launch_server \\  --model-path $path \\  --disaggregation-transfer-backend nixl \\  --disaggregation-mode prefill \\  --host 0.0.0.0 \\  --port 30000 \\  --dist-init-addr $&#123;prefill_master_ip&#125;:5000 \\  --nnodes 2 \\  --node-rank 0 \\  --tp-size 2\n\nèŠ‚ç‚¹1:\n# ä¿®æ”¹node-rankå‚æ•°ä¸º1--node-rank 1\n\nDecodeèŠ‚ç‚¹é…ç½®python -m sglang.launch_server \\  --model-path $path \\  --disaggregation-transfer-backend nixl \\  --disaggregation-mode decode \\  --port 30001 \\  --dist-init-addr $&#123;decode_master_ip&#125;:5000 \\  --nnodes 2 \\  --node-rank 0 \\  --tp-size 16 \\  --dp-size 8 \\  --enable-dp-attention\n\n\n","tags":["llm"]},{"title":"tcp","url":"/2025/07/25/tcp/","content":"ä¸‰æ¡å››æŒ¥\n ï¼ˆ1ï¼‰ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šClientå°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Jï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Serverï¼ŒClientè¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…Serverç¡®è®¤ã€‚  ï¼ˆ2ï¼‰ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šServeræ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“Clientè¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒServerå°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1ï¼Œack=J+1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=Kï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Clientä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒServerè¿›å…¥SYN_RCVDçŠ¶æ€ã€‚  ï¼ˆ3ï¼‰ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šClientæ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºJ+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1ï¼Œack=K+1ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Serverï¼ŒServeræ£€æŸ¥ackæ˜¯å¦ä¸ºK+1ï¼ŒACKæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼ŒClientå’ŒServerè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼ŒéšåClientä¸Serverä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†å®¢æˆ·ç«¯å‘èµ·finä½ä¸º1çš„FINæŠ¥æ–‡ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1çŠ¶æ€æœåŠ¡ç«¯æ¥å—åˆ°FIN æŠ¥æ–‡åï¼Œå‘é€ackåº”ç­”æŠ¥æ–‡ï¼Œæ­¤æ—¶æœåŠ¡ç«¯è¿›å…¥close_waitçŠ¶æ€å®¢æˆ·ç«¯æ¥å—åˆ°ackåº”ç­”æŠ¥æ–‡åï¼Œè¿›å…¥FIN_WAIT_2çŠ¶æ€æœåŠ¡ç«¯å¤„ç†å®Œæ•°æ®åï¼Œå‘å®¢æˆ·ç«¯å‘é€FINæŠ¥æ–‡ï¼Œæ­¤æ—¶æœåŠ¡ç«¯è¿›å…¥LAST_ACKçŠ¶æ€å®¢æˆ·ç«¯æ¥å—åˆ°FINæŠ¥æ–‡åï¼Œå®¢æˆ·ç«¯å‘é€åº”ç­”ackæŠ¥æ–‡ï¼Œè¿›å…¥TIME_WAITé˜¶æ®µæœåŠ¡ç«¯æ¥å—åˆ°ackæŠ¥æ–‡åï¼Œæ–­å¼€è¿æ¥ï¼Œå¤„äºcloseçŠ¶æ€å®¢æˆ·ç«¯è¿‡ä¸€æ®µæ—¶é—´åï¼Œä¹Ÿå°±æ˜¯2MSLåï¼Œè¿›å…¥closeçŠ¶æ€\n\n\n\n\nTime Waitæ¦‚å¿µ\nè°å…ˆå…³é—­è°æœ€åè¿›å…¥timewaitçŠ¶æ€ï¼Œtime_wait çŠ¶æ€ä¸‹ï¼ŒTCP è¿æ¥å ç”¨çš„ç«¯å£ï¼Œæ— æ³•è¢«å†æ¬¡ä½¿ç”¨close çŸ­è¿æ¥æ¯ä¸ªHTTPè¯·æ±‚éƒ½éœ€è¦é‡æ–°å®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œæ•°æ®ä¼ è¾“å®Œæˆåå››æ¬¡æŒ¥æ‰‹å…³é—­è¿æ¥keep-alive é•¿è¿æ¥åœ¨HTTP1.1åè®®ä¸­é»˜è®¤é•¿è¿æ¥ï¼Œæœ‰ä¸ª Connection å¤´ï¼ŒConnectionæœ‰ä¸¤ä¸ªå€¼ï¼Œcloseå’Œkeep-aliveï¼Œè¿™ä¸ªå¤´å°±ç›¸å½“äºå®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä½ æ‰§è¡Œå®Œæˆè¯·æ±‚ä¹‹åï¼Œæ˜¯å…³é—­è¿æ¥è¿˜æ˜¯ä¿æŒè¿æ¥ï¼Œä¿æŒè¿æ¥å°±æ„å‘³ç€åœ¨ä¿æŒè¿æ¥æœŸé—´ï¼Œåªèƒ½ç”±å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚è¿˜æœ‰ä¸€ä¸ªkeep-aliveçš„å¤´ï¼Œè®¾ç½®çš„å€¼å°±ä»£è¡¨äº†æœåŠ¡ç«¯ä¿æŒè¿æ¥ä¿æŒå¤šä¹…#ngxkeepalive 100;          # ä¿æŒçš„ç©ºé—²è¿æ¥æ•°keepalive_timeout 60s;   # ç©ºé—²è¶…æ—¶æ—¶é—´keepalive_requests 100;  # å•è¿æ¥æœ€å¤§è¯·æ±‚æ•°location / &#123;    proxy_pass http://backend_servers;    proxy_http_version 1.1;     # å…³é”®ï¼šä½¿ç”¨ HTTP/1.1    proxy_set_header Connection &quot;&quot;;  # æ¸…é™¤ Connection å¤´ï¼ˆé¿å…ä¼ é€’é”™è¯¯å€¼ï¼‰&#125;# Linux å†…æ ¸å‚æ•°ï¼ˆé»˜è®¤å€¼é€šå¸¸ä¸º 7200 ç§’ï¼‰é»˜è®¤ä¸å¯ç”¨sysctl -w net.ipv4.tcp_keepalive_time=1800  # ç©ºé—² 1800 ç§’åå‘é€æ¢é’ˆsysctl -w net.ipv4.tcp_keepalive_probes=3   # å‘é€ 3 æ¬¡æ— å“åº”åå…³é—­sysctl -w net.ipv4.tcp_keepalive_intvl=15   # æ¯æ¬¡æ¢é’ˆé—´éš” 15 ç§’\n\nç›¸å…³å‚æ•°netstat -ant | awk &#x27;/^tcp/ &#123;++y[$NF]&#125; END &#123;for(w in y) print w, y[w]&#125;&#x27;net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_tw_recycle = 1net.ipv4.tcp_fin_timeout = 30==============================================net.ipv4.tcp_tw_reuse = 1è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†ä¸€ä¸ªå¤„äºTIME-WAITçŠ¶æ€çš„ç«¯å£é‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼Œå…¶é˜²æ­¢é‡å¤æŠ¥æ–‡çš„åŸç†ä¹Ÿæ˜¯æ—¶é—´æˆ³net.ipv4.tcp_tw_recycle = 1è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œæ„æ€å°±æ˜¯ç³»ç»Ÿä¼šä¿å­˜æœ€è¿‘ä¸€æ¬¡è¯¥socketè¿æ¥ä¸Šçš„ä¼ è¾“æŠ¥æ–‡ï¼ˆåŒ…æ‹¬æ•°æ®æˆ–è€…ä»…ä»…æ˜¯ACKæŠ¥æ–‡ï¼‰çš„æ—¶é—´æˆ³ï¼Œå½“ç›¸åŒå››å…ƒç»„socketè¿‡æ¥çš„æŠ¥æ–‡çš„æ—¶é—´æˆ³å°äºç¼“å­˜ä¸‹æ¥çš„æ—¶é—´æˆ³åˆ™ä¸¢å¼ƒè¯¥æ•°æ®åŒ…ï¼Œå¹¶å›æ”¶è¿™ä¸ªsocketï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚å¼€å¯è¿™ä¸ªåŠŸèƒ½é£é™©æœ‰ç‚¹å¤§ï¼ŒNATç¯å¢ƒå¯èƒ½å¯¼è‡´DROPæ‰SYNåŒ…ï¼ˆå›å¤RSTï¼‰ï¼Œåœ¨NATåœºæ™¯ä¸‹ä¸è¦ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„åœ¨Linuxå†…æ ¸4.10ç‰ˆæœ¬ä»¥åè¯¥å‚æ•°å°±å·²ç»è¢«ç§»é™¤äº†ã€‚net.ipv4.tcp_fin_timeout = 60è¿™ä¸ªæ—¶é—´ä¸æ˜¯ä¿®æ”¹2MSLçš„æ—¶é•¿ï¼Œä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹æ¥æ”¶åˆ°ACKä¹‹åä¼šè¿›å…¥ï¼ŒFIN_WAIT-2çŠ¶æ€ï¼Œç„¶åç­‰å¾…è¢«åŠ¨å…³é—­ä¸€æ–¹å‘é€FINï¼Œè¿™ä¸ªæ—¶é—´æ˜¯è®¾ç½®ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ç­‰å¾…å¯¹æ–¹å‘é€FINçš„æœ€é•¿æ—¶é•¿ï¼Œé»˜è®¤æ˜¯60ç§’ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ç«¯å£æ˜¯ä¸å¯èƒ½è¢«é‡ç”¨çš„ï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œå†…å­˜ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºè¿™ä¸ªé˜¶æ®µè¢«åŠ¨å…³é—­çš„ä¸€æ–¹æœ‰å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘é€ï¼Œå› ä¸ºå¯¹ç«¯å¤„äºCLOSE_WAITçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…ä¸Šå±‚åº”ç”¨ç¨‹åºã€‚å…³äºè¿™ä¸ªçš„çœŸå®å«ä¹‰æˆ‘å¸Œæœ›å¤§å®¶æ¸…æ¥šï¼Œè€Œä¸”ä¸è¦è°ƒæ•´çš„å¤ªå°å½“ç„¶å¤ªå¤§ä¹Ÿä¸è¡Œï¼Œè‡³å°‘åœ¨3.10å†…æ ¸ç‰ˆæœ¬ä¸Šè¿™ä¸ªå‚æ•°ä¸æ˜¯è°ƒæ•´çš„TIME_WAITæ—¶é•¿ã€‚net.ipv4.ip_local_port_range = 32768 60999è¡¨ç¤ºç”¨äºå¤–è¿ä½¿ç”¨çš„éšæœºé«˜ä½ç«¯å£èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯ä½œä¸ºå®¢æˆ·ç«¯è¿æ¥å…¶ä»–æœåŠ¡çš„æ—¶å€™ç³»ç»Ÿä»è¿™ä¸ªèŒƒå›´éšæœºå–å‡ºä¸€ä¸ªç«¯å£æ¥ä½œä¸ºæºç«¯å£ä½¿ç”¨æ¥å»è¿æ¥å¯¹ç«¯æœåŠ¡å™¨ï¼Œè¿™ä¸ªèŒƒå›´ä¹Ÿå°±å†³å®šäº†æœ€å¤šä¸»åŠ¨èƒ½åŒæ—¶å»ºç«‹å¤šå°‘ä¸ªå¤–è¿ã€‚net.ipv4.tcp_max_tw_buckets = 6000åŒæ—¶ä¿æŒTIME_WAITå¥—æ¥å­—çš„æœ€å¤§ä¸ªæ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ•°å­—é‚£ä¹ˆè¯¥TIME_WAITå¥—æ¥å­—å°†ç«‹åˆ»è¢«é‡Šæ”¾å¹¶åœ¨/var/log/messageæ—¥å¿—ä¸­æ‰“å°è­¦å‘Šä¿¡æ¯ï¼ˆTCP: time wait bucket table overflowï¼‰ã€‚è¿™ä¸ªè¿‡å¤šä¸»è¦æ˜¯æ¶ˆè€—å†…å­˜ï¼Œå•ä¸ªTIME_WAITå ç”¨å†…å­˜éå¸¸å°ï¼Œä½†æ˜¯å¤šäº†å°±ä¸å¥½äº†ï¼Œè¿™ä¸ªä¸»è¦çœ‹å†…å­˜ä»¥åŠä½ çš„æœåŠ¡å™¨æ˜¯å¦ç›´æ¥å¯¹å¤–ã€‚ä½¿ç”¨net.ipv4.tcp_tw_reuseå’Œnet.ipv4.tcp_tw_recycle çš„å‰ææ˜¯å¼€å¯æ—¶é—´æˆ³net.ipv4.tcp_timestamps = 1ä¸è¿‡è¿™ä¸€é¡¹é»˜è®¤æ˜¯å¼€å¯çš„\n\nCLOSE_WAIT\nè¿™ç§çŠ¶æ€çš„å«ä¹‰å…¶å®æ˜¯è¡¨ç¤ºåœ¨ç­‰å¾…å…³é—­ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿå½“å¯¹æ–¹closeä¸€ä¸ªSOCKETåå‘é€FINæŠ¥æ–‡ç»™è‡ªå·±ï¼Œä½ ç³»ç»Ÿæ¯«æ— ç–‘é—®åœ°ä¼šå›åº”ä¸€ä¸ªACKæŠ¥æ–‡ç»™å¯¹æ–¹ï¼Œæ­¤æ—¶åˆ™è¿›å…¥åˆ°CLOSE_WAITçŠ¶æ€ã€‚æ¥ä¸‹æ¥å‘¢ï¼Œå®é™…ä¸Šä½ çœŸæ­£éœ€è¦è€ƒè™‘çš„äº‹æƒ…æ˜¯æŸ¥çœ‹ä½ æ˜¯å¦è¿˜æœ‰æ•°æ®å‘é€ç»™å¯¹æ–¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œé‚£ä¹ˆä½ ä¹Ÿå°±å¯ä»¥closeè¿™ä¸ªSOCKETï¼Œå‘é€FINæŠ¥æ–‡ç»™å¯¹æ–¹ï¼Œä¹Ÿå³å…³é—­è¿æ¥ã€‚æ‰€ä»¥ä½ åœ¨CLOSE_WAITçŠ¶æ€ä¸‹ï¼Œéœ€è¦å®Œæˆçš„äº‹æƒ…æ˜¯ç­‰å¾…ä½ å»å…³é—­è¿æ¥ã€‚CLOSE_WAITä¸€èˆ¬æ˜¯ç”±äºå¯¹ç«¯ä¸»åŠ¨å…³é—­ï¼Œè€Œæˆ‘æ–¹æ²¡æœ‰æ­£ç¡®å¤„ç†çš„åŸå› å¼•èµ·çš„ï¼Œä¸´æ—¶è§£å†³é‡å¯æœåŠ¡ï¼Œæ°¸ä¹…è§£å†³å°±æ˜¯ä¿®æ”¹ç¨‹åºé€»è¾‘å®¢æˆ·ç«¯ï¼ˆä¸»åŠ¨å…³é—­æ–¹ï¼‰          æœåŠ¡å™¨ï¼ˆè¢«åŠ¨å…³é—­æ–¹ï¼‰       |                               |       |--- GET /bigfile.zip ---------&gt;|        |&lt;--- 200 OK + æ–‡ä»¶æ•°æ® ---------|       |                               |       |--- FIN (æˆ‘è¦å…³é—­) ------------&gt;| â†’ å®¢æˆ·ç«¯è¿›å…¥ FIN_WAIT_1       |&lt;--- ACK ----------------------| â†’ æœåŠ¡ç«¯è¿›å…¥ CLOSE_WAIT       |                               |ï¼ˆæ­¤æ—¶æœåŠ¡ç«¯è¿˜åœ¨å‘é€å‰©ä½™æ–‡ä»¶æ•°æ®ï¼‰       |&lt;--- å‰©ä½™æ•°æ®åŒ… ----------------|       |&lt;--- FIN (æˆ‘ä¹Ÿå…³é—­) ------------| â†’ æœåŠ¡ç«¯è¿›å…¥ LAST_ACK       |--- ACK -----------------------&gt;| â†’ å®¢æˆ·ç«¯è¿›å…¥ TIME_WAIT                #æ²¡æœ‰è°ƒç”¨s.close()å…³é—­socketï¼Œä¼šé€ æˆå¤§é‡CLOSE_WAITimport socketimport timedef create_sockets(num_sockets):    sockets = []    for _ in range(num_sockets):        # åˆ›å»ºä¸€ä¸ª TCP å¥—æ¥å­—        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)        print(f&quot;åˆ›å»º socket &#123;_ + 1&#125;: &#123;s.fileno()&#125;ï¼ŒçŠ¶æ€ä¸º alloc&quot;)        sockets.append(s)    return socketsif __name__ == &quot;__main__&quot;:    num_sockets = 10    while True:        num_sockets  += 10        sockets = create_sockets(num_sockets)        print(f&quot;æ€»å…±åˆ›å»ºäº† &#123;num_sockets&#125; ä¸ª socket å¯¹è±¡ã€‚&quot;)        time.sleep(10)#shellcat /proc/net/sockstat | grep sockets | awk &#x27;&#123;print $3&#125;&#x27;netstat -n | awk &#x27;/^tcp/ &#123;++state[$NF]&#125; END &#123;for(key in state) print key,&quot;\\t&quot;,state[key]&#125;&#x27;for i in `ls /proc/ |grep &#x27;[0-9]&#x27;`do    mycount=`ls /proc/$i/fd|wc -l`    echo &quot;$i $mycount&quot;done\n\n","categories":["linux"]},{"title":"vllm","url":"/2025/09/23/vllm/","content":"vLLM åˆ†å¸ƒå¼æœåŠ¡éƒ¨ç½²ä¸å‹æµ‹æŒ‡å—ç›®å½•\nDocker éƒ¨ç½²\næœåŠ¡å¯åŠ¨\nAPI æµ‹è¯•\nå‹åŠ›æµ‹è¯•\nPDåˆ†ç¦»\n\n\nhttps://www.modelscope.cn/models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7Bhttps://docs.vllm.com.cn/en/latest/getting_started/quickstart.html#installation\nDocker éƒ¨ç½²å¯åŠ¨ vLLM æœåŠ¡å®¹å™¨docker run -t -d \\    --name=&quot;vllm&quot; \\    --ipc=host \\    --cap-add=SYS_PTRACE \\    --network=host \\    --gpus all \\    --privileged \\    --ulimit memlock=-1 \\    --ulimit stack=67108864 \\    -v /mnt:/mnt \\    registry.cn-hangzhou.aliyuncs.com/lky-deploy/llm:vllm-server-0.7.2\n\nå…³é”®å‚æ•°è¯´æ˜ï¼š\n\n--gpus allï¼šå¯ç”¨æ‰€æœ‰ GPU\n--network=hostï¼šä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼\n-v /mnt:/mntï¼šæŒ‚è½½å®¿ä¸»æœºå­˜å‚¨å·\n--privilegedï¼šèµ‹äºˆå®¹å™¨ç‰¹æƒæ¨¡å¼\n\n\næœåŠ¡å¯åŠ¨1. åˆå§‹åŒ–ç¯å¢ƒexport GLOO_SOCKET_IFNAME=eth0  # æŒ‡å®šç½‘ç»œæ¥å£export NCCL_SOCKET_IFNAME=eth0  # æŒ‡å®š NCCL ç½‘ç»œæ¥å£#ä¸»èŠ‚ç‚¹æ‰§è¡Œray start --head --dashboard-host 0.0.0.0#ä»èŠ‚ç‚¹æ‰§è¡Œray start --address=&#x27;$&#123;master_ip&#125;:6379&#x27;#æŸ¥çœ‹çŠ¶æ€ray status\n\n2. å¯åŠ¨ vLLM æœåŠ¡#å•èŠ‚ç‚¹vllm serve /mnt/7B \\--tensor-parallel-size 8 \\--served-model-name  vllm \\--trust-remote-code \\--enable-chunked-prefill \\--host 0.0.0.0#ä¸¤å°èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹8å¼ å¡vllm serve /mnt/DeepSeek-R1 \\  --tensor-parallel-size 16 \\  --trust-remote-code \\  --enable-chunked-prefill \\  --pipeline-parallel-size 2 \\  --host 0.0.0.0 \\  --max-num-batched-tokens 131072 &amp;&gt; vllm.log &amp;#--max-num-batched-tokens 131072#--max-model-len 131072#--enforce-eager #--dtype=half --quantization fp8 --no-enable-prefix-caching #--gpu-memory-utilization 0.95 --served-model-name  vllm\nå‚æ•°æ–‡æ¡£ï¼šhttps://docs.vllm.com.cn/en/latest/configuration/engine_args.html#modelconfigæ ¸å¿ƒå‚æ•°ï¼š\n\n\n\nå‚æ•°\nè¯´æ˜\n\n\n\n--tensor-parallel-size 16\nå¼ é‡å¹¶è¡Œåº¦\n\n\n--pipeline-parallel-size 2\næµæ°´çº¿å¹¶è¡Œåº¦\n\n\n--max-num-batched-tokens 131072\næœ€å¤§æ‰¹å¤„ç† token æ•°ï¼ˆçº¦ 128Kï¼‰\n\n\n\nAPI æµ‹è¯•1. èŠå¤©æ¥å£æµ‹è¯•curl http://localhost:8000/v1/chat/completions \\  -H &quot;Content-Type:application/json&quot; \\  -d &#x27;&#123;    &quot;model&quot;:&quot;/mnt/DeepSeek-V3/DeepSeek-V3/&quot;,    &quot;messages&quot;:[&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;å†™ä¸€é¦–20å­—çš„æœˆäº®è¯—&quot;&#125;],    &quot;stream&quot;:false&#125;&#x27;\n\n2. è¡¥å…¨æ¥å£æµ‹è¯•curl http://localhost:8000/v1/completions \\  -H &quot;Content-Type: application/json&quot; \\  -d &#x27;&#123;    &quot;model&quot;: &quot;/mnt/DeepSeek-R1&quot;,    &quot;prompt&quot;: &quot;å·´é»æ˜¯æ³•å›½çš„é¦–éƒ½å—ï¼Ÿ&quot;,    &quot;max_tokens&quot;: 50&#125;&#x27;\n\n\nå‹åŠ›æµ‹è¯•1. å¯åŠ¨å‹æµ‹å®¹å™¨docker run --name vllm-benchmark -it -v /mnt:/mnt -d \\  registry.cn-hangzhou.aliyuncs.com/lky-deploy/llm:vllm-benchmark-tagv0.7.2 bash\n\n2. å‡†å¤‡æµ‹è¯•æ•°æ®é›†modelscope download --dataset gliang1001/ShareGPT_V3_unfiltered_cleaned_split \\  ShareGPT_V3_unfiltered_cleaned_split.json --local_dir /root/\n\n3. æ‰§è¡Œå‹æµ‹è„šæœ¬#!/bin/bash# å®šä¹‰æ¨¡å‹åç§°ï¼ˆæ ¹æ®å®é™…æƒ…å†µæ›¿æ¢ï¼‰NAME=&quot;/mnt/DeepSeek-R1/&quot;# å®šä¹‰å¹¶å‘æ•°å’Œè¯·æ±‚æ•°çš„å¯¹åº”å…³ç³»æ•°ç»„ï¼ˆæ ¼å¼ï¼šconcurrency1:num_prompt1 concurrency2:num_prompt2 ...ï¼‰PAIRS=(  &quot;1:10&quot;  &quot;8:80&quot;  &quot;16:160&quot;  &quot;24:240&quot;  &quot;32:320&quot;)# å›ºå®šå‚æ•°ï¼ˆä¸åŸå§‹å‘½ä»¤ä¿æŒä¸€è‡´ï¼‰RANDOM_INPUT_LEN=1RANDOM_OUTPUT_LEN=128RANDOM_RANGE_RATIO=1# éå†æ‰€æœ‰é…å¯¹for pair in &quot;$&#123;PAIRS[@]&#125;&quot;; do  # ä»é…å¯¹ä¸­æå–å¹¶å‘æ•°å’Œè¯·æ±‚æ•°  IFS=&quot;:&quot; read -r concurrency num_prompt &lt;&lt;&lt; &quot;$pair&quot;    # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆæ ¼å¼ï¼šinputlen_outputlen_ratio_concurrency_prompts.txtï¼‰  output_file=&quot;$&#123;RANDOM_INPUT_LEN&#125;_$&#123;RANDOM_OUTPUT_LEN&#125;_$&#123;RANDOM_RANGE_RATIO&#125;_c$&#123;concurrency&#125;_n$&#123;num_prompt&#125;.txt&quot;    # æ‰§è¡ŒåŸºå‡†æµ‹è¯•å‘½ä»¤  python3 /root/vllm/benchmarks/benchmark_serving.py \\    --backend vllm \\    --model &quot;$NAME&quot; \\    --served-model-name &quot;$NAME&quot; \\    --trust-remote-code \\    --dataset-name random \\    --dataset-path /root/ShareGPT_V3_unfiltered_cleaned_split.json \\    --random-input-len $RANDOM_INPUT_LEN \\    --random-output-len $RANDOM_OUTPUT_LEN \\    --random-range-ratio $RANDOM_RANGE_RATIO \\    --num-prompts $num_prompt \\    --max-concurrency $concurrency \\    --request-rate inf \\    --host 10.112.201.25 \\    --port 8000 \\    --endpoint /v1/completions \\    &amp;&gt; &quot;$output_file&quot;    echo &quot;å·²å®Œæˆæµ‹è¯•ï¼šconcurrency=$&#123;concurrency&#125;, num_prompts=$&#123;num_prompt&#125;&quot;  sleep 3doneecho &quot;æ‰€æœ‰æµ‹è¯•ä»»åŠ¡å·²å®Œæˆï¼&quot;\n\nå‹æµ‹é…ç½®è¯´æ˜ï¼š\n\næµ‹è¯•æ¨¡å¼ï¼šéšæœºè¾“å…¥&#x2F;è¾“å‡ºé•¿åº¦\nè¾“å…¥é•¿åº¦ï¼š1 token\nè¾“å‡ºé•¿åº¦ï¼š128 tokens\nå¹¶å‘æ¢¯åº¦ï¼š1~32 å¹¶å‘\nè¯·æ±‚é‡æ¢¯åº¦ï¼š10~320 è¯·æ±‚\n\n\nPDåˆ†ç¦»å®˜æ–¹æ–‡æ¡£å‚è€ƒ\n1. é¢„å¡«å……èŠ‚ç‚¹é…ç½®ï¼ˆPrefillï¼‰vLLM ç›®å‰æ”¯æŒ 5 ç§ç±»å‹çš„è¿æ¥å™¨ï¼šSharedStorageConnector, é€šè¿‡å…±äº«å­˜å‚¨è·¯å¾„è¿›è¡Œ KV Cache å…±äº«LMCacheConnectorV1ï¼Œç»“åˆ LMCache ç¼“å­˜å’Œ NIXL ä¼ è¾“ KV CacheNixlConnectorï¼ŒåŸºäº NIXL ä¼ è¾“ KV CacheP2pNcclConnectorï¼Œåˆ©ç”¨ NVIDIA NCCL è¿›è¡Œ KV Cache ä¼ è¾“MultiConnectorï¼Œå¤šç§è¿æ¥å™¨ç»„åˆå‚è€ƒ https://docs.vllm.ai/en/latest/features/disagg_prefill.html?h=prefill#why-disaggregated-prefilling# é¢„å¡«å……èŠ‚ç‚¹1CUDA_VISIBLE_DEVICES=0 vllm serve /data/7B \\  --port 8100 \\  --max-model-len 100 \\  --gpu-memory-utilization 0.9 \\  --kv-transfer-config &#x27;&#123;    &quot;kv_connector&quot;: &quot;PyNcclConnector&quot;,    &quot;kv_role&quot;: &quot;kv_producer&quot;,             &quot;kv_rank&quot;: 0,                         &quot;kv_parallel_size&quot;: 2,                &quot;kv_ip&quot;: &quot;172.25.79.18&quot;,             &quot;kv_port&quot;: 14579                    &#125;&#x27;# é¢„å¡«å……èŠ‚ç‚¹2ï¼ˆéœ€ä¿®æ”¹ç«¯å£å’Œè®¾å¤‡å·ï¼‰CUDA_VISIBLE_DEVICES=1 vllm serve /data/7B \\  --port 8101 \\  ...  --kv-transfer-config &#x27;&#123;    ...     &quot;kv_rank&quot;: 1,    ...  &#125;&#x27;\n\n2. è§£ç èŠ‚ç‚¹é…ç½®ï¼ˆDecodeï¼‰# è§£ç èŠ‚ç‚¹1CUDA_VISIBLE_DEVICES=1 vllm serve /data/7B \\  --port 8200 \\  ...  --kv-transfer-config &#x27;&#123;     &quot;kv_role&quot;: &quot;kv_consumer&quot;,    &quot;kv_rank&quot;: 1,    ...  &#125;&#x27;# è§£ç èŠ‚ç‚¹2ï¼ˆéœ€ä¿®æ”¹ç«¯å£å’Œè®¾å¤‡å·ï¼‰CUDA_VISIBLE_DEVICES=2 vllm serve /data/7B \\  --port 8201 \\  ...  --kv-transfer-config &#x27;&#123;    ...    &quot;kv_rank&quot;: 0,    ...  &#125;&#x27;\n\n3. è·¯ç”±æœåŠ¡é…ç½®https://github.com/vllm-project/vllm/blob/main/examples/online_serving/disaggregated_serving/disagg_proxy_demo.py\npython3 examples/online_serving/disaggregated_serving/disagg_proxy_demo.py \\  --model your_model_name \\  --prefill localhost:8100 localhost:8101 \\  --decode localhost:8200 localhost:8201 \\  --port 8000#https://github.com/vllm-project/vllm/blob/main/benchmarks/disagg_benchmarks/disagg_prefill_proxy_server.pywget https://raw.githubusercontent.com/vllm-project/vllm/refs/heads/main/benchmarks/disagg_benchmarks/disagg_prefill_proxy_server.py -O disagg_prefill_proxy_server.pypython3 -m pip install --ignore-installed blinker quart -i https://pypi.tuna.tsinghua.edu.cn/simplewget https://raw.githubusercontent.com/vllm-project/vllm/refs/heads/main/benchmarks/disagg_benchmarks/rate_limiter.py -O  rate_limiter.pywget https://raw.githubusercontent.com/vllm-project/vllm/refs/heads/main/benchmarks/disagg_benchmarks/request_queue.py -O request_queue.py\n\n\nå‚æ•°è¯´æ˜å…¬å…±å‚æ•°\n\n\nå‚æ•°\nè¯´æ˜\n\n\n\n--max-model-len\næœ€å¤§åºåˆ—é•¿åº¦ï¼ˆéœ€ä¸å†…å­˜åŒ¹é…ï¼‰\n\n\n--gpu-memory-utilization\nGPU æ˜¾å­˜åˆ©ç”¨ç‡é˜ˆå€¼ï¼ˆ0.0~1.0ï¼‰\n\n\n--kv-parallel-size\nKV ä¼ è¾“å¹¶è¡Œåº¦ï¼ˆéœ€ä¸èŠ‚ç‚¹æ•°ä¸€è‡´ï¼‰\n\n\nKV ä¼ è¾“å‚æ•°&#123;  &quot;kv_connector&quot;: &quot;PyNcclConnector&quot;,  // ä¼ è¾“å®ç°æ–¹å¼  &quot;kv_role&quot;: [&quot;producer&quot;/&quot;consumer&quot;], // è§’è‰²ç±»å‹  &quot;kv_rank&quot;: 0,                      // èŠ‚ç‚¹ç¼–å·  &quot;kv_ip&quot;: &quot;master_ip&quot;,              // ä¸»èŠ‚ç‚¹IP  &quot;kv_port&quot;: 14579                   // é€šè®¯ç«¯å£&#125;\n\n\n","tags":["llm"]},{"title":"websocket","url":"/2025/05/28/websocket/","content":"å¼‚æ­¥å› ä¸ºwebsocketä¼šä½¿ç”¨åˆ°å¼‚æ­¥æ“ä½œå…ˆäº†è§£ä¸€ä¸‹å¼‚æ­¥\nimport asyncioimport timeasync def task(name, duration):    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] ä»»åŠ¡ &#123;name&#125; å¼€å§‹&quot;)    await asyncio.sleep(duration)  # æ¨¡æ‹Ÿå¹¶å‘ç­‰å¾…    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] ä»»åŠ¡ &#123;name&#125; å®Œæˆ&quot;)def task_(name, duration):    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] ä»»åŠ¡ &#123;name&#125; å¼€å§‹&quot;)    time.sleep(duration)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] ä»»åŠ¡ &#123;name&#125; å®Œæˆ&quot;)async def main():    start_time = time.time()    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] å¼‚æ­¥ä»»åŠ¡å¼€å§‹&quot;)    await asyncio.gather(        task(&quot;A&quot;, 2),        task(&quot;B&quot;, 3),        task(&quot;C&quot;, 1)    )    end_time = time.time()    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] å¼‚æ­¥ä»»åŠ¡æ€»è€—æ—¶: &#123;end_time - start_time:.2f&#125; ç§’&quot;)def main_():    start_time = time.time()    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] åŒæ­¥ä»»åŠ¡å¼€å§‹&quot;)    task_(&quot;A&quot;, 2)    task_(&quot;B&quot;, 3)    task_(&quot;C&quot;, 1)    end_time = time.time()    print(f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] åŒæ­¥ä»»åŠ¡æ€»è€—æ—¶: &#123;end_time - start_time:.2f&#125; ç§’&quot;)if __name__ == &quot;__main__&quot;:    print(&quot;======================å¼‚æ­¥==========================&quot;)    asyncio.run(main())    print(&quot;======================åŒæ­¥==========================&quot;)    main_()#ç»“æœå¯ä»¥çœ‹å‡ºå¼‚æ­¥ä¸éœ€è¦ç­‰å¾…ä¼šç›´æ¥æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œä»»åŠ¡å®Œæˆå¯ä»¥ä½¿ç”¨awaitæ¥å›è°ƒå¤„ç†å®Œæˆç»“æœ======================å¼‚æ­¥==========================[14:45:43] å¼‚æ­¥ä»»åŠ¡å¼€å§‹[14:45:43] ä»»åŠ¡ A å¼€å§‹[14:45:43] ä»»åŠ¡ B å¼€å§‹[14:45:43] ä»»åŠ¡ C å¼€å§‹[14:45:44] ä»»åŠ¡ C å®Œæˆ[14:45:45] ä»»åŠ¡ A å®Œæˆ[14:45:46] ä»»åŠ¡ B å®Œæˆ[14:45:46] å¼‚æ­¥ä»»åŠ¡æ€»è€—æ—¶: 3.00 ç§’======================åŒæ­¥==========================[14:45:46] åŒæ­¥ä»»åŠ¡å¼€å§‹[14:45:46] ä»»åŠ¡ A å¼€å§‹[14:45:48] ä»»åŠ¡ A å®Œæˆ[14:45:48] ä»»åŠ¡ B å¼€å§‹[14:45:51] ä»»åŠ¡ B å®Œæˆ[14:45:51] ä»»åŠ¡ C å¼€å§‹[14:45:52] ä»»åŠ¡ C å®Œæˆ[14:45:52] åŒæ­¥ä»»åŠ¡æ€»è€—æ—¶: 6.00 ç§’\nwebsocketæœåŠ¡ç«¯import asyncioimport websockets#https://websockets.readthedocs.io/en/stable/# å¤„ç†å®¢æˆ·ç«¯è¿æ¥async def handle_client(websocket):    async for message in websocket:        print(f&quot;æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯: &#123;message&#125;&quot;)        reply = f&quot;æœºå™¨äººå›å¤ï¼šä½ è¯´çš„æ˜¯ &#x27;&#123;message&#125;&#x27; å¯¹å—ï¼Ÿ&quot;        await websocket.send(reply)# async def main_logic(websocket, path):#    # await check_permit(websocket)##     await handle_client(websocket)# å¯åŠ¨æœåŠ¡å™¨async def main():    async with websockets.serve(handle_client, &quot;localhost&quot;, 8765):        print(&quot;WebSocket æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç«¯å£ 8765&quot;)        await asyncio.Future()  # æ°¸ä¹…è¿è¡Œasyncio.run(main())\n\n\n\nå®¢æˆ·ç«¯import asyncioimport websocketsasync def client():    async with websockets.connect(&quot;ws://localhost:8765&quot;) as websocket:        while True:            message = input(&quot;è¯·è¾“å…¥æ¶ˆæ¯ï¼ˆè¾“å…¥ q é€€å‡ºï¼‰: &quot;)            if message == &#x27;q&#x27;:                break            await websocket.send(message)            response = await websocket.recv()            print(f&quot;æ”¶åˆ°å›å¤: &#123;response&#125;&quot;)asyncio.run(client())#æ•ˆæœï¼Œç›¸å½“äºæ‰“å¼€äº†ä¸€ä¸ªé€šé“åŒæ–¹éƒ½å¯ä»¥å‘æ¶ˆæ¯WebSocket æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç«¯å£ 8765è¯·è¾“å…¥æ¶ˆæ¯ï¼ˆè¾“å…¥ q é€€å‡ºï¼‰: hello websocketsæ”¶åˆ°å›å¤: æœºå™¨äººå›å¤ï¼šä½ è¯´çš„æ˜¯ &#x27;hello websockets&#x27; å¯¹å—ï¼Ÿè¯·è¾“å…¥æ¶ˆæ¯ï¼ˆè¾“å…¥ q é€€å‡ºï¼‰: \né¢å¤–fastapiæ¡†æ¶ä½¿ç”¨websocketfrom fastapi import FastAPI, WebSocket, WebSocketDisconnectfrom fastapi.responses import HTMLResponsefrom fastapi.middleware.cors import CORSMiddlewareimport jsonapp = FastAPI()# é…ç½®CORSè·¨åŸŸapp.add_middleware(    CORSMiddleware,    allow_origins=[&quot;*&quot;],    allow_credentials=True,    allow_methods=[&quot;*&quot;],    allow_headers=[&quot;*&quot;],)# HTMLé¡µé¢ï¼ˆä¿®æ”¹äº†å‰ç«¯WebSocketå®ç°ï¼‰HTML_TEMPLATE = &#x27;&#x27;&#x27;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;    &lt;title&gt;FastAPI èŠå¤©&lt;/title&gt;    &lt;style&gt;        body &#123; max-width: 800px; margin: 20px auto; padding: 20px; &#125;        #output &#123;             height: 300px;             border: 1px solid #ccc;             overflow-y: auto;             padding: 10px;             margin-bottom: 10px;        &#125;        #input &#123;             width: 80%;             padding: 8px;            margin-right: 10px;        &#125;        button &#123;            padding: 8px 16px;            background: #007bff;            color: white;            border: none;            border-radius: 4px;            cursor: pointer;        &#125;        button:hover &#123;            opacity: 0.8;        &#125;    &lt;/style&gt;&lt;/head&gt;&lt;body&gt;    &lt;div id=&quot;output&quot;&gt;&lt;/div&gt;    &lt;input type=&quot;text&quot; id=&quot;input&quot; placeholder=&quot;è¾“å…¥æ¶ˆæ¯...&quot;&gt;    &lt;button onclick=&quot;sendMessage()&quot;&gt;å‘é€&lt;/button&gt;    &lt;script&gt;        // åˆå§‹åŒ–WebSocketè¿æ¥        const socket = new WebSocket(`ws://$&#123;window.location.host&#125;/ws`);        // è¿æ¥æˆåŠŸå›è°ƒ        socket.onopen = () =&gt; &#123;            addMessage(&#x27;ç³»ç»Ÿ&#x27;, &#x27;å·²è¿æ¥åˆ°æœåŠ¡å™¨&#x27;);        &#125;;        // æ¥æ”¶æ¶ˆæ¯å¤„ç†        socket.onmessage = (event) =&gt; &#123;            const data = JSON.parse(event.data);            addMessage(&#x27;æœºå™¨äºº&#x27;, data.message);        &#125;;        // é”™è¯¯å¤„ç†        socket.onerror = (error) =&gt; &#123;            addMessage(&#x27;ç³»ç»Ÿ&#x27;, `è¿æ¥é”™è¯¯: $&#123;error.message&#125;`);        &#125;;        // å…³é—­è¿æ¥å¤„ç†        socket.onclose = () =&gt; &#123;            addMessage(&#x27;ç³»ç»Ÿ&#x27;, &#x27;è¿æ¥å·²æ–­å¼€&#x27;);        &#125;;        // å‘é€æ¶ˆæ¯        function sendMessage() &#123;            const input = document.getElementById(&#x27;input&#x27;);            const message = input.value.trim();            if (message) &#123;                socket.send(JSON.stringify(&#123;                    type: &quot;user_message&quot;,                    content: message                &#125;));                addMessage(&#x27;æˆ‘&#x27;, message);                input.value = &#x27;&#x27;;            &#125;        &#125;        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢        function addMessage(sender, content) &#123;            const output = document.getElementById(&#x27;output&#x27;);            const div = document.createElement(&#x27;div&#x27;);            div.innerHTML = `&lt;strong&gt;$&#123;sender&#125;:&lt;/strong&gt; $&#123;content&#125;`;            output.appendChild(div);            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨            output.scrollTop = output.scrollHeight;        &#125;    &lt;/script&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;@app.get(&quot;/&quot;)async def index():    return HTMLResponse(HTML_TEMPLATE)# WebSocketç«¯ç‚¹@app.websocket(&quot;/ws&quot;)async def websocket_endpoint(websocket: WebSocket):    await websocket.accept()    try:        while True:            # æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯            data = await websocket.receive_text()            message_data = json.loads(data)            # å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯            if message_data[&#x27;type&#x27;] == &#x27;user_message&#x27;:                print(f&quot;æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯: &#123;message_data[&#x27;content&#x27;]&#125;&quot;)                # æ„é€ å›å¤æ¶ˆæ¯                reply = &#123;                    &quot;type&quot;: &quot;server_response&quot;,                    &quot;message&quot;: f&quot;æœºå™¨äººå›å¤ï¼šä½ è¯´çš„æ˜¯ &#x27;&#123;message_data[&#x27;content&#x27;]&#125;&#x27; å¯¹å—ï¼Ÿ&quot;                &#125;                # å‘é€å›å¤                await websocket.send_json(reply)    except WebSocketDisconnect:        print(&quot;å®¢æˆ·ç«¯æ–­å¼€è¿æ¥&quot;)    except Exception as e:        print(f&quot;å‘ç”Ÿé”™è¯¯: &#123;str(e)&#125;&quot;)if __name__ == &quot;__main__&quot;:    import uvicorn    uvicorn.run(app, host=&quot;0.0.0.0&quot;, port=8001)\nflaskä½¿ç”¨websocketimport eventleteventlet.monkey_patch()  # å…³é”®ï¼šå¯ç”¨å¼‚æ­¥æ”¯æŒfrom flask import Flask, render_template_string#pip install flask-socketio eventletfrom flask_socketio import SocketIO, emitapp = Flask(__name__)app.config[&#x27;SECRET_KEY&#x27;] = &#x27;secret!&#x27;socketio = SocketIO(app, cors_allowed_origins=&quot;*&quot;)  # å…è®¸è·¨åŸŸ@app.route(&#x27;/&#x27;)def index():    return render_template_string(&#x27;&#x27;&#x27;    &lt;!DOCTYPE html&gt;    &lt;html&gt;    &lt;head&gt;        &lt;title&gt;Socket.IO èŠå¤©&lt;/title&gt;        &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js&quot;&gt;&lt;/script&gt;        &lt;style&gt;            /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */            body &#123; max-width: 800px; margin: 20px auto; padding: 20px; &#125;            #output &#123; height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; &#125;        &lt;/style&gt;    &lt;/head&gt;    &lt;body&gt;        &lt;div id=&quot;output&quot;&gt;&lt;/div&gt;        &lt;input id=&quot;input&quot; placeholder=&quot;è¾“å…¥æ¶ˆæ¯&quot;&gt;        &lt;button onclick=&quot;send()&quot;&gt;å‘é€&lt;/button&gt;        &lt;script&gt;            const socket = io();  // è‡ªåŠ¨è¿æ¥å½“å‰åŸŸå            // è¿æ¥æˆåŠŸå›è°ƒ            socket.on(&#x27;connect&#x27;, () =&gt; &#123;                addMessage(&#x27;ç³»ç»Ÿ&#x27;, &#x27;å·²è¿æ¥åˆ°æœåŠ¡å™¨&#x27;);            &#125;);            // æ¥æ”¶æœåŠ¡å™¨æ¶ˆæ¯            socket.on(&#x27;server_response&#x27;, (data) =&gt; &#123;                addMessage(&#x27;æœºå™¨äºº&#x27;, data.message);            &#125;);            // å‘é€æ¶ˆæ¯            function send() &#123;                const input = document.getElementById(&#x27;input&#x27;);                const message = input.value.trim();                if (message) &#123;                    socket.emit(&#x27;client_message&#x27;, message);                    addMessage(&#x27;æˆ‘&#x27;, message);                    input.value = &#x27;&#x27;;                &#125;            &#125;            // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢            function addMessage(sender, content) &#123;                const div = document.createElement(&#x27;div&#x27;);                div.innerHTML = `&lt;strong&gt;$&#123;sender&#125;:&lt;/strong&gt; $&#123;content&#125;`;                document.getElementById(&#x27;output&#x27;).appendChild(div);                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨                const output = document.getElementById(&#x27;output&#x27;);                output.scrollTop = output.scrollHeight;            &#125;        &lt;/script&gt;    &lt;/body&gt;    &lt;/html&gt;    &#x27;&#x27;&#x27;)# Socket.IO äº‹ä»¶å¤„ç†@socketio.on(&#x27;client_message&#x27;)def handle_message(message):    print(f&#x27;æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯: &#123;message&#125;&#x27;)    # æ„é€ å›å¤æ¶ˆæ¯    reply = f&quot;æœºå™¨äººå›å¤ï¼šä½ è¯´çš„æ˜¯ &#x27;&#123;message&#125;&#x27; å¯¹å—ï¼Ÿ&quot;    # å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯    emit(&#x27;server_response&#x27;, &#123;&#x27;message&#x27;: reply&#125;)if __name__ == &#x27;__main__&#x27;:    socketio.run(app, host=&#x27;0.0.0.0&#x27;, port=8000, debug=True)\nå¤§æ¨¡å‹ä½¿ç”¨websocketèŠå¤©# main.pyfrom fastapi import FastAPI, WebSocketfrom fastapi.responses import HTMLResponseimport requestsimport jsonapp = FastAPI()# å­˜å‚¨å¯¹è¯å†å² (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ•°æ®åº“)conversation_history = []# é›†æˆå‰ç«¯é¡µé¢ä¸åç«¯é€»è¾‘HTML_TEMPLATE = &quot;&quot;&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;    &lt;title&gt;AI å¯¹è¯åŠ©æ‰‹&lt;/title&gt;    &lt;style&gt;        body &#123;            max-width: 800px;            margin: 0 auto;            padding: 20px;            font-family: Arial, sans-serif;        &#125;        #chatContainer &#123;            height: 60vh;            border: 1px solid #ddd;            border-radius: 8px;            overflow-y: auto;            padding: 15px;            margin-bottom: 15px;            background: #f9f9f9;        &#125;        .message &#123;            margin: 10px 0;            padding: 12px;            border-radius: 15px;            max-width: 80%;            word-wrap: break-word;        &#125;        .user-message &#123;            background: #e3f2fd;            margin-left: auto;            border-bottom-right-radius: 5px;        &#125;        .bot-message &#123;            background: #fff;            border: 1px solid #eee;            margin-right: auto;            border-bottom-left-radius: 5px;        &#125;        #inputContainer &#123;            display: flex;            gap: 10px;        &#125;        #userInput &#123;            flex: 1;            padding: 12px;            border: 1px solid #ddd;            border-radius: 25px;            outline: none;        &#125;        button &#123;            padding: 12px 25px;            background: #007bff;            color: white;            border: none;            border-radius: 25px;            cursor: pointer;            transition: background 0.3s;        &#125;        button:hover &#123;            background: #0056b3;        &#125;        .status &#123;            color: #666;            text-align: center;            padding: 10px;        &#125;    &lt;/style&gt;&lt;/head&gt;&lt;body&gt;    &lt;h1&gt;AI å¯¹è¯åŠ©æ‰‹&lt;/h1&gt;    &lt;div id=&quot;chatContainer&quot;&gt;&lt;/div&gt;    &lt;div id=&quot;inputContainer&quot;&gt;        &lt;input type=&quot;text&quot; id=&quot;userInput&quot; placeholder=&quot;è¾“å…¥æ¶ˆæ¯...&quot; /&gt;        &lt;button onclick=&quot;sendMessage()&quot;&gt;å‘é€&lt;/button&gt;    &lt;/div&gt;    &lt;div class=&quot;status&quot; id=&quot;status&quot;&gt;è¿æ¥çŠ¶æ€ï¼šæ­£å¸¸&lt;/div&gt;       // &lt;iframe   //      src=&quot;http://47.237.81.149/chatbot/9h9nyQcblGTesiGJ&quot;    //     style=&quot;width: 100%; height: 100%; min-height: 700px&quot;   //      frameborder=&quot;0&quot;  //       allow=&quot;microphone&quot;&gt;   // &lt;/iframe&gt;    &lt;script&gt;        const ws = new WebSocket(&#x27;ws://&#x27; + window.location.host + &#x27;/ws&#x27;);        const chatContainer = document.getElementById(&#x27;chatContainer&#x27;);        let isBotResponding = false;        // WebSocket äº‹ä»¶å¤„ç†        ws.onopen = () =&gt; updateStatus(&#x27;å·²è¿æ¥&#x27;);        ws.onclose = () =&gt; updateStatus(&#x27;è¿æ¥å·²æ–­å¼€&#x27;);        ws.onerror = () =&gt; updateStatus(&#x27;è¿æ¥é”™è¯¯&#x27;);        ws.onmessage = (event) =&gt; &#123;            const data = JSON.parse(event.data);            handleResponse(data);        &#125;;        function handleResponse(data) &#123;            switch(data.type) &#123;                case &#x27;user_message&#x27;:                    appendMessage(data.content, &#x27;user&#x27;);                    break;                case &#x27;assistant_start&#x27;:                    isBotResponding = true;                    appendMessage(&#x27;&#x27;, &#x27;bot&#x27;);                    break;                case &#x27;assistant_chunk&#x27;:                    appendChunk(data.content);                    break;                case &#x27;assistant_end&#x27;:                    isBotResponding = false;                    break;                case &#x27;error&#x27;:                    appendMessage(`é”™è¯¯ï¼š$&#123;data.content&#125;`, &#x27;error&#x27;);                    break;            &#125;        &#125;        function appendMessage(content, role) &#123;            const div = document.createElement(&#x27;div&#x27;);            div.className = `message $&#123;role&#125;-message`;            div.textContent = content;            chatContainer.appendChild(div);            scrollToBottom();        &#125;        function appendChunk(content) &#123;            const messages = document.getElementsByClassName(&#x27;bot-message&#x27;);            const lastMsg = messages[messages.length - 1];            lastMsg.textContent += content;            scrollToBottom();        &#125;        function scrollToBottom() &#123;            chatContainer.scrollTop = chatContainer.scrollHeight;        &#125;        function updateStatus(text) &#123;            document.getElementById(&#x27;status&#x27;).textContent = `çŠ¶æ€ï¼š$&#123;text&#125;`;        &#125;        function sendMessage() &#123;            const input = document.getElementById(&#x27;userInput&#x27;);            const message = input.value.trim();            if (message &amp;&amp; !isBotResponding) &#123;                ws.send(message);                input.value = &#x27;&#x27;;            &#125;        &#125;        // æ”¯æŒå›è½¦å‘é€        document.getElementById(&#x27;userInput&#x27;).addEventListener(&#x27;keypress&#x27;, (e) =&gt; &#123;            if (e.key === &#x27;Enter&#x27;) sendMessage();        &#125;);    &lt;/script&gt;&lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;@app.get(&quot;/&quot;)async def get():    return HTMLResponse(HTML_TEMPLATE)@app.websocket(&quot;/ws&quot;)async def websocket_endpoint(websocket: WebSocket):    await websocket.accept()    try:        while True:            # æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯            user_message = await websocket.receive_text()            # æ›´æ–°å¯¹è¯å†å²            conversation_history.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: user_message&#125;)            # å‘é€ç”¨æˆ·æ¶ˆæ¯åˆ°å‰ç«¯            await websocket.send_json(&#123;                &quot;type&quot;: &quot;user_message&quot;,                &quot;content&quot;: user_message            &#125;)            # å‡†å¤‡æµå¼è¯·æ±‚            await websocket.send_json(&#123;&quot;type&quot;: &quot;assistant_start&quot;&#125;)            # æ„é€ è¯·æ±‚æ•°æ®            request_data = &#123;                &quot;model&quot;: &quot;deepseek-r1:latest&quot;,                &quot;messages&quot;: conversation_history,                &quot;stream&quot;: True            &#125;            # æµå¼è·å–å“åº”            full_response = []            with requests.post(                    &quot;http://1.1.1.1:11434/api/chat&quot;,#å¤§æ¨¡å‹æ¥å£åœ°å€                    json=request_data,                    stream=True            ) as response:                response.raise_for_status()                for line in response.iter_lines():                    if line:                        chunk = json.loads(line.decode(&#x27;utf-8&#x27;))                        if &#x27;message&#x27; in chunk:                            content = chunk[&#x27;message&#x27;][&#x27;content&#x27;]                            full_response.append(content)                            await websocket.send_json(&#123;                                &quot;type&quot;: &quot;assistant_chunk&quot;,                                &quot;content&quot;: content                            &#125;)            # ä¿å­˜å®Œæ•´å“åº”            conversation_history.append(&#123;                &quot;role&quot;: &quot;assistant&quot;,                &quot;content&quot;: &quot;&quot;.join(full_response)            &#125;)            await websocket.send_json(&#123;&quot;type&quot;: &quot;assistant_end&quot;&#125;)    except Exception as e:        await websocket.send_json(&#123;            &quot;type&quot;: &quot;error&quot;,            &quot;content&quot;: f&quot;ç³»ç»Ÿé”™è¯¯: &#123;str(e)&#125;&quot;        &#125;)    finally:        await websocket.close()if __name__ == &quot;__main__&quot;:    import uvicorn    uvicorn.run(app, host=&quot;0.0.0.0&quot;, port=8000)","tags":["websocket"]},{"title":"ä½¿ç”¨kubekeyå¿«é€Ÿå®‰è£…k8s","url":"/2025/04/27/%E4%BD%BF%E7%94%A8kubekey%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85k8s/","content":"å®˜æ–¹åœ°å€https://github.com/kubesphere/kubekey\nå®‰è£…\ncurl -sfL https://get-kk.kubesphere.io | sh -\n\nå•èŠ‚ç‚¹æµ‹è¯•ä½¿ç”¨kk create cluster#é»˜è®¤ v1.23.17--with-kubernetes v1.24.1 #é»˜è®¤docker--container-manager containerd#å¦‚æœä¸ä½¿ç”¨--with-kubesphereé»˜è®¤ä¸å®‰è£…ï¼›é»˜è®¤ç‰ˆæœ¬ä¸º v3.4.1--with-kubesphere\nå¤šèŠ‚ç‚¹kk create config -f deploy.yml#-f æŒ‡å®šé…ç½®æ–‡ä»¶å¼€å§‹å®‰è£…kk create cluster -f deploy.yml#deploy.yml;å…¶ä»–èŠ‚ç‚¹çš„ipç”¨æˆ·åå¯†ç çš„ä¿®æ”¹æˆå®é™…çš„apiVersion: kubekey.kubesphere.io/v1alpha2kind: Clustermetadata:  name: samplespec:  hosts:  - &#123;name: node1, address: 172.16.0.2, internalAddress: 172.16.0.2, user: ubuntu, password: &quot;Qcloud@123&quot;&#125;  - &#123;name: node2, address: 172.16.0.3, internalAddress: 172.16.0.3, user: ubuntu, password: &quot;Qcloud@123&quot;&#125;  roleGroups:    etcd:    - node1    control-plane:     - node1    worker:    - node1    - node2  controlPlaneEndpoint:    ## Internal loadbalancer for apiservers     # internalLoadbalancer: haproxy    domain: lb.kubesphere.local    address: &quot;&quot;    port: 6443  kubernetes:    version: v1.23.17    clusterName: cluster.local    autoRenewCerts: true    containerManager: docker  etcd:    type: kubekey  network:    plugin: calico    kubePodsCIDR: 10.233.64.0/18    kubeServiceCIDR: 10.233.0.0/18    ## multus support. https://github.com/k8snetworkplumbingwg/multus-cni    multusCNI:      enabled: false  registry:    privateRegistry: &quot;&quot;    namespaceOverride: &quot;&quot;    registryMirrors: []    insecureRegistries: []  addons: []----------------------------------------------------#é»˜è®¤ä¸å®‰è£…kubesphereéœ€è¦æŒ‡å®š--with-kubespherekk create config --with-kubesphere -f deploy-with.yml\næ–°å¢åˆ é™¤#æ–°å¢èŠ‚ç‚¹æ¥å…¥é›†ç¾¤kk add nodes -f  deploy.yml#åˆ é™¤èŠ‚ç‚¹kk delete node &lt;nodeName&gt; -f deploy.yml#åˆ é™¤é›†ç¾¤kk delete cluster [-f deploy.yml]\n\nå‡çº§é›†ç¾¤ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬å‡çº§é›†ç¾¤ã€‚kk upgrade [--with-kubernetes version] [--with-kubesphere version] ä»…æ”¯æŒå‡çº§ Kubernetesã€‚ä»…æ”¯æŒå‡çº§ KubeSphereã€‚æ”¯æŒå‡çº§ Kubernetes å’Œ KubeSphereã€‚å¤šèŠ‚ç‚¹ä½¿ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶å‡çº§é›†ç¾¤ã€‚kk upgrade [--with-kubernetes version] [--with-kubesphere version] [(-f | --filename) path]å¦‚æœæŒ‡å®šäº†--with-kubernetesæˆ–--with-kubesphereï¼Œé…ç½®æ–‡ä»¶ä¹Ÿå°†è¢«æ›´æ–°ã€‚ç”¨äº-fæŒ‡å®šä¸ºé›†ç¾¤åˆ›å»ºè€Œç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚\n\næ›´æ–°é›†ç¾¤è¯ä¹¦\n#é»˜è®¤ä¸€å¹´kk  certs renew\n\n","categories":["k8s"]},{"title":"ä½¿ç”¨mavenæ‰“åŒ…","url":"/2025/05/12/%E4%BD%BF%E7%94%A8maven%E6%89%93%E5%8C%85/","content":"ä½¿ç”¨springboot&lt;parent&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;        &lt;version&gt;2.5.9&lt;/version&gt;        &lt;relativePath/&gt;    &lt;/parent&gt;    &lt;groupId&gt;org.ecs&lt;/groupId&gt;    &lt;artifactId&gt;springboot01&lt;/artifactId&gt;    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;    &lt;build&gt;        &lt;plugins&gt;            &lt;plugin&gt;                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;            &lt;/plugin&gt;        &lt;/plugins&gt;    &lt;/build&gt;\nå…¶ä»–&lt;groupId&gt;org.example&lt;/groupId&gt;    &lt;artifactId&gt;CpuLoad&lt;/artifactId&gt;    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;    &lt;build&gt;        &lt;plugins&gt;            &lt;plugin&gt;                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;                &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;                &lt;version&gt;3.1.0&lt;/version&gt;                &lt;configuration&gt;                    &lt;archive&gt;                        &lt;manifest&gt;                            &lt;!-- æŒ‡å®šå…¥å£å‡½æ•° --&gt;                             \t\t\t    &lt;mainClass&gt;org.example.CpuLoad&lt;/mainClass&gt;                            &lt;!-- æ˜¯å¦æ·»åŠ ä¾èµ–çš„jarè·¯å¾„é…ç½® --&gt;                            &lt;addClasspath&gt;true&lt;/addClasspath&gt;                            &lt;!-- ä¾èµ–çš„jaråŒ…å­˜æ”¾æœªçŸ¥ï¼Œå’Œç”Ÿæˆçš„jaræ”¾åœ¨åŒä¸€çº§ç›®å½•ä¸‹ --&gt;                            &lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;                        &lt;/manifest&gt;                    &lt;/archive&gt;                    &lt;!-- ä¸æ‰“åŒ…com.yh.excludesä¸‹é¢çš„æ‰€æœ‰ç±» --&gt;                    &lt;excludes&gt;com/xx/excludes/*&lt;/excludes&gt;                &lt;/configuration&gt;            &lt;/plugin&gt;        &lt;/plugins&gt;    &lt;/build&gt;\n","tags":["maven"]},{"title":"å¸¸ç”¨å‹æµ‹å‘½ä»¤","url":"/2025/08/28/%E5%B8%B8%E7%94%A8%E5%8E%8B%E6%B5%8B%E5%91%BD%E4%BB%A4/","content":"ä¸€ã€siege1. ä¸‹è½½ä¸å®‰è£…# Ubuntu/Debiansudo apt-get install siege# CentOS/RHELsudo yum install siege# macOSbrew install siege# éªŒè¯å®‰è£…siege --version\n\n2. æ ¸å¿ƒå‚æ•°\n\n\nå‚æ•°\nè¯´æ˜\nç¤ºä¾‹\n\n\n\n-c &lt;å¹¶å‘æ•°&gt;\nå¹¶å‘ç”¨æˆ·æ•°ï¼ˆå¿…é¡»å‚æ•°ï¼‰\n-c 100\n\n\n-t &lt;æ—¶é—´&gt;\nå‹æµ‹æŒç»­æ—¶é—´ï¼ˆs&#x2F;m&#x2F;hï¼‰\n-t 30s\n\n\n-r &lt;æ¬¡æ•°&gt;\næ¯ä¸ªç”¨æˆ·é‡å¤è¯·æ±‚æ¬¡æ•°\n-r 50\n\n\n-f &lt;æ–‡ä»¶&gt;\nä»æ–‡ä»¶è¯»å–å¤šä¸ªURLè¿›è¡Œå‹æµ‹\n-f urls.txt\n\n\n-i\néšæœºå‘é€æ–‡ä»¶ä¸­çš„URLè¯·æ±‚\n-i -f urls.txt\n\n\n-b\næ— å»¶è¿Ÿæ¨¡å¼ï¼ˆæœ€å¤§å‹åŠ›æµ‹è¯•ï¼‰\n-b\n\n\n-v\næ˜¾ç¤ºè¯¦ç»†è¯·æ±‚æ—¥å¿—\n-v\n\n\n3. ç¤ºä¾‹å‘½ä»¤# 100å¹¶å‘ç”¨æˆ·ï¼ŒæŒç»­30ç§’å‹æµ‹siege -c 100 -t 30s http://example.com# ä»æ–‡ä»¶åŠ è½½URLåˆ—è¡¨ï¼Œ50å¹¶å‘ç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·é‡å¤20æ¬¡siege -c 50 -r 20 -f urls.txt\n\n4. æµ‹è¯•ç»“æœè§£è¯»Transactions:              2000 hits        # æ€»è¯·æ±‚æ•°Availability:              99.50 %          # è¯·æ±‚æˆåŠŸç‡ï¼ˆå¤±è´¥ç‡=1 - Availabilityï¼‰Elapsed time:              59.99 sec        # æ€»è€—æ—¶Data transferred:          5.67 MB          # æ€»æ•°æ®ä¼ è¾“é‡Response time:             0.25 sec         # å¹³å‡å“åº”æ—¶é—´Transaction rate:          33.34 trans/sec  # æ¯ç§’å¤„ç†è¯·æ±‚æ•°ï¼ˆQPSï¼‰Longest transaction:       1.20 sec         # æœ€æ…¢è¯·æ±‚è€—æ—¶Shortest transaction:      0.05 sec         # æœ€å¿«è¯·æ±‚è€—æ—¶\n\n\n\näºŒã€abï¼ˆApacheBenchï¼‰1. ä¸‹è½½ä¸å®‰è£…# Ubuntu/Debiansudo apt-get install apache2-utils# CentOS/RHELsudo yum install httpd-tools# macOSï¼ˆé¢„è£…æˆ–ä½¿ç”¨Homebrewï¼‰ab -V# éªŒè¯å®‰è£…ab -V\n\n2. æ ¸å¿ƒå‚æ•°\n\n\nå‚æ•°\nè¯´æ˜\nç¤ºä¾‹\n\n\n\n-n &lt;æ€»æ•°&gt;\næ€»è¯·æ±‚æ•°ï¼ˆå¿…é¡»å‚æ•°ï¼‰\n-n 1000\n\n\n-c &lt;å¹¶å‘æ•°&gt;\nå¹¶å‘ç”¨æˆ·æ•°ï¼ˆå¿…é¡»å‚æ•°ï¼‰\n-c 100\n\n\n-k\nå¯ç”¨HTTP Keep-Aliveé•¿è¿æ¥\n-k\n\n\n-H &lt;å¤´éƒ¨&gt;\næ·»åŠ è‡ªå®šä¹‰HTTPå¤´éƒ¨\n-H &quot;Content-Type: application/json&quot;\n\n\n-p &lt;æ–‡ä»¶&gt;\nPOSTè¯·æ±‚æ—¶å‘é€çš„æ•°æ®æ–‡ä»¶\n-p data.json\n\n\n-T &lt;ç±»å‹&gt;\nPOST&#x2F;PUTå†…å®¹ç±»å‹\n-T application/json\n\n\n3. ç¤ºä¾‹å‘½ä»¤# æ€»è¯·æ±‚1000æ¬¡ï¼Œå¹¶å‘100ç”¨æˆ·ï¼Œå¯ç”¨Keep-Aliveab -n 1000 -c 100 -k http://example.com/# POSTè¯·æ±‚æµ‹è¯•ï¼ˆå‘é€JSONæ•°æ®ï¼‰ab -n 500 -c 50 -T application/json -p data.json http://example.com/api\n\n4. æµ‹è¯•ç»“æœè§£è¯»Concurrency Level:      100                 # å¹¶å‘æ•°Time taken for tests:   2.123 seconds       # æ€»è€—æ—¶Complete requests:      1000                # æˆåŠŸè¯·æ±‚æ•°Failed requests:        0                   # å¤±è´¥è¯·æ±‚æ•°Requests per second:    470.34 [#/sec]      # QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰Time per request:       212.300 [ms]        # å¹³å‡è¯·æ±‚è€—æ—¶ï¼ˆå¹¶å‘åœºæ™¯ï¼‰Time per request:       2.123 [ms]          # å¹³å‡è¯·æ±‚è€—æ—¶ï¼ˆå•ç”¨æˆ·ï¼‰Transfer rate:          512.34 [Kbytes/sec] # æ•°æ®ä¼ è¾“é€Ÿç‡Percentage of the requests served within a certain time (ms):  50%    25    # 50%çš„è¯·æ±‚åœ¨25mså†…å®Œæˆ  90%    50    # 90%çš„è¯·æ±‚åœ¨50mså†…å®Œæˆ  99%    200   # 99%çš„è¯·æ±‚åœ¨200mså†…å®Œæˆ\n\n\n\nä¸‰ã€wrk1. ä¸‹è½½ä¸å®‰è£…# æºç ç¼–è¯‘ï¼ˆéœ€æå‰å®‰è£…Gitå’ŒGCCï¼‰git clone https://github.com/wg/wrk.gitcd wrk &amp;&amp; make# macOSbrew install wrk# éªŒè¯å®‰è£…wrk --version\n\n2. æ ¸å¿ƒå‚æ•°\n\n\nå‚æ•°\nè¯´æ˜\nç¤ºä¾‹\n\n\n\n-t &lt;çº¿ç¨‹æ•°&gt;\nå·¥ä½œçº¿ç¨‹æ•°ï¼ˆå»ºè®®ä¸CPUæ ¸å¿ƒä¸€è‡´ï¼‰\n-t 4\n\n\n-c &lt;å¹¶å‘æ•°&gt;\nå¹¶å‘è¿æ¥æ•°ï¼ˆå¿…é¡»å‚æ•°ï¼‰\n-c 100\n\n\n-d &lt;æ—¶é—´&gt;\nå‹æµ‹æŒç»­æ—¶é—´ï¼ˆs&#x2F;m&#x2F;hï¼‰\n-d 30s\n\n\n-s &lt;è„šæœ¬&gt;\nä½¿ç”¨Luaè„šæœ¬å®šåˆ¶è¯·æ±‚ï¼ˆå¦‚POSTï¼‰\n-s post.lua\n\n\n--latency\nè¾“å‡ºè¯¦ç»†å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡\n--latency\n\n\n--timeout &lt;æ—¶é—´&gt;\nè®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´\n--timeout 10s\n\n\n3. ç¤ºä¾‹å‘½ä»¤# 4çº¿ç¨‹ã€100å¹¶å‘ã€æŒç»­30ç§’å‹æµ‹wrk -t4 -c100 -d30s http://example.com# ä½¿ç”¨Luaè„šæœ¬æ¨¡æ‹ŸPOSTè¯·æ±‚ï¼ˆè§ä¸‹æ–¹è„šæœ¬ç¤ºä¾‹ï¼‰wrk -t4 -c100 -d10s -s post.lua http://example.com/api\n\nLuaè„šæœ¬ç¤ºä¾‹ï¼ˆpost.luaï¼‰ï¼šwrk.method = &quot;POST&quot;wrk.headers[&quot;Content-Type&quot;] = &quot;application/json&quot;wrk.body = &#x27;&#123;&quot;username&quot;:&quot;test&quot;, &quot;password&quot;:&quot;123456&quot;&#125;&#x27;\n\n4. æµ‹è¯•ç»“æœè§£è¯»Running 30s test @ http://example.com  4 threads and 100 connections                  # çº¿ç¨‹æ•°ã€å¹¶å‘è¿æ¥æ•°  Thread Stats   Avg      Stdev     Max   +/- Stdev    Latency    45.76ms   12.34ms 200.15ms   85.23%  # å»¶è¿Ÿåˆ†å¸ƒï¼ˆå¹³å‡ã€æ ‡å‡†å·®ã€æœ€å¤§å€¼ã€åˆ†å¸ƒæ¯”ä¾‹ï¼‰    Req/Sec    550.12    120.45     2.34k    75.34% # æ¯ç§’è¯·æ±‚æ•°åˆ†å¸ƒ  Latency Distribution                           # å»¶è¿Ÿç™¾åˆ†æ¯”åˆ†å¸ƒ     50%   42.12ms     75%   50.23ms     90%   65.45ms     99%  185.67ms  65432 requests in 30.01s, 12.34MB read         # æ€»è¯·æ±‚æ•°ã€æ•°æ®è¯»å–é‡Requests/sec:   2180.23                          # QPSTransfer/sec:    420.45KB                        # æ¯ç§’æ•°æ®ä¼ è¾“é‡\n\n\n\nå››ã€å·¥å…·æ¨ªå‘å¯¹æ¯”\n\n\nç»´åº¦\nsiege\nab\nwrk\n\n\n\nå®‰è£…å¤æ‚åº¦\nâ­â­ï¼ˆåŒ…ç®¡ç†å™¨ç›´è£…ï¼‰\nâ­â­â­ï¼ˆApacheUtilsé›†æˆï¼‰\nâ­â­ï¼ˆéœ€ç¼–è¯‘æˆ–Homebrewï¼‰\n\n\næ€§èƒ½ä¸Šé™\nâ­â­ï¼ˆä¸‡çº§QPSï¼‰\nâ­â­â­ï¼ˆåä¸‡çº§QPSï¼‰\nâ­â­â­â­ï¼ˆç™¾ä¸‡çº§QPSï¼‰\n\n\nçµæ´»æ€§\nâ­â­ï¼ˆæ”¯æŒURLåˆ—è¡¨ã€éšæœºè¯·æ±‚ï¼‰\nâ­ï¼ˆä»…æ”¯æŒç®€å•é™æ€è¯·æ±‚ï¼‰\nâ­â­â­â­ï¼ˆLuaè„šæœ¬æ‰©å±•åŠ¨æ€åœºæ™¯ï¼‰\n\n\nç»“æœå¯è¯»æ€§\nâ­â­â­ï¼ˆæ¸…æ™°çš„æˆåŠŸç‡&#x2F;å“åº”æ—¶é—´ï¼‰\nâ­â­ï¼ˆQPSå’Œå»¶è¿Ÿåˆ†å¸ƒï¼‰\nâ­â­â­ï¼ˆçº¿ç¨‹çº§ç»Ÿè®¡+å»¶è¿Ÿåˆ†å¸ƒï¼‰\n\n\né€‚ç”¨åœºæ™¯\né¡µé¢çº§å‹æµ‹ã€æˆåŠŸç‡ç›‘æ§\nå¿«é€ŸåŸºå‡†æµ‹è¯•ã€ç®€å•æ¥å£éªŒè¯\né«˜å¹¶å‘æµ‹è¯•ã€å¤æ‚ä¸šåŠ¡é€»è¾‘æ¨¡æ‹Ÿ\n\n\nèµ„æºæ¶ˆè€—\né«˜ï¼ˆè¿›ç¨‹æ¨¡å‹ï¼‰\nä¸­ï¼ˆå•çº¿ç¨‹+å¤šè¿›ç¨‹ï¼‰\nä½ï¼ˆå¤šçº¿ç¨‹+äº‹ä»¶é©±åŠ¨ï¼‰\n\n\n\näº”ã€æœ€ç»ˆå»ºè®®\nç®€å•å¿«é€Ÿæµ‹è¯•ï¼šç”¨ abï¼Œä¸€æ¡å‘½ä»¤å³å¯è·å–QPSå’Œå»¶è¿Ÿåˆ†å¸ƒã€‚\né«˜å¹¶å‘&#x2F;å¤æ‚åœºæ™¯ï¼šé€‰ wrkï¼Œæ”¯æŒLuaè„šæœ¬æ¨¡æ‹ŸåŠ¨æ€è¯·æ±‚ï¼ˆå¦‚ç™»å½•ã€é‰´æƒï¼‰ã€‚\næˆåŠŸç‡éªŒè¯ï¼šç”¨ siegeï¼Œæ˜ç¡®å±•ç¤ºäº‹åŠ¡æˆåŠŸç‡å’Œå“åº”æ—¶é—´æå€¼ã€‚\nç”Ÿäº§çº§å‹æµ‹ï¼šç»“åˆå¤šå·¥å…·ç»“æœäº¤å‰éªŒè¯ï¼ˆå¦‚å…ˆç”¨ ab å¿«é€ŸéªŒè¯ï¼Œå†ç”¨ wrk å‹æµ‹æé™ï¼‰ã€‚\n\né™„ï¼šå„å·¥å…·å®˜ç½‘\n\nsiege: https://www.joedog.org/siege-home/\nab: Apache HTTP Server Documentation\nwrk: https://github.com/wg/wrk\n\n","categories":["linux"]},{"title":"å¸¸ç”¨å‘½ä»¤è®°å½•","url":"/2025/08/12/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95/","content":"perf#è¿›ç¨‹çƒ­ç‚¹å‡½æ•°åˆ†æperf top -g -p 21515perf record -F 99 -a -g -p $pid -- sleep 60-eé€‰é¡¹å…è®¸æ‚¨åœ¨perf listå‘½ä»¤ä¸­åˆ—å‡ºçš„å¤šä¸ªç±»åˆ«ä¸­é€‰æ‹©ä¸€ä¸ªäº‹ä»¶ç±»åˆ«ã€‚perf report -i æ–‡ä»¶ -gperf report -g graph,0.3#é»˜è®¤0.5ï¼Œä½äºä¸æ˜¾ç¤ºå †æ ˆ#éšè—CPUperf sched record -C 0 -- sleep 5 (-Cåé¢çš„å‚æ•°ï¼Œå¡«CPUä½¿ç”¨ç‡é«˜çš„cpuåºå·ï¼Œ0è¡¨ç¤ºç¬¬ä¸€ä¸ªCPU)perf report é€‰æ‹© sched:sched_switch æŒ‰å›è½¦é”®perf sched latency --sort max\nstracestrace -tt -T -v -f -e trace=file -o /data/log/strace.log -s 1024 -p 23489â— -ttï¼šåœ¨æ¯è¡Œè¾“å‡ºçš„å‰é¢ï¼Œæ˜¾ç¤ºæ¯«ç§’çº§åˆ«çš„æ—¶é—´â— -Tï¼šæ˜¾ç¤ºæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ‰€èŠ±è´¹çš„æ—¶é—´â— -vï¼šå¯¹äºæŸäº›ç›¸å…³è°ƒç”¨ï¼ŒæŠŠå®Œæ•´çš„ç¯å¢ƒå˜é‡ï¼Œæ–‡ä»¶ stat ç»“æ„ç­‰æ‰“å‡ºæ¥ã€‚â— -fï¼šè·Ÿè¸ªç›®æ ‡è¿›ç¨‹ï¼Œä»¥åŠç›®æ ‡è¿›ç¨‹åˆ›å»ºçš„æ‰€æœ‰å­è¿›ç¨‹â— -eï¼šæ§åˆ¶è¦è·Ÿè¸ªçš„äº‹ä»¶å’Œè·Ÿè¸ªè¡Œä¸ºï¼Œæ¯”å¦‚æŒ‡å®šè¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨åç§°â— -oï¼šæŠŠ strace çš„è¾“å‡ºå•ç‹¬å†™åˆ°æŒ‡å®šçš„æ–‡ä»¶â— -sï¼šå½“ç³»ç»Ÿè°ƒç”¨çš„æŸä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²æ—¶ï¼Œæœ€å¤šè¾“å‡ºæŒ‡å®šé•¿åº¦çš„å†…å®¹ï¼Œé»˜è®¤æ˜¯ 32 ä¸ªå­—èŠ‚â— -pï¼šæŒ‡å®šè¦è·Ÿè¸ªçš„è¿›ç¨‹ pidï¼Œè¦åŒæ—¶è·Ÿè¸ªå¤šä¸ª pidï¼Œé‡å¤å¤šæ¬¡ -p é€‰é¡¹å³å¯ã€‚-e trace=file     è·Ÿè¸ªå’Œæ–‡ä»¶è®¿é—®ç›¸å…³çš„è°ƒç”¨(å‚æ•°ä¸­æœ‰æ–‡ä»¶å)-e trace=process  å’Œè¿›ç¨‹ç®¡ç†ç›¸å…³çš„è°ƒç”¨ï¼Œæ¯”å¦‚fork/exec/exit_group-e trace=network  å’Œç½‘ç»œé€šä¿¡ç›¸å…³çš„è°ƒç”¨ï¼Œæ¯”å¦‚socket/sendto/connect-e trace=signal    ä¿¡å·å‘é€å’Œå¤„ç†ç›¸å…³ï¼Œæ¯”å¦‚kill/sigaction-e trace=desc  å’Œæ–‡ä»¶æè¿°ç¬¦ç›¸å…³ï¼Œæ¯”å¦‚write/read/select/epollç­‰\n\ndddd if=/dev/zero  of=/data/test  bs=10M status=progress  count=10000 oflag=direct  å†™å…¥dd if=/data/test  of=/dev/null   bs=10M  count=10000 oflag=direct  status=progress  è¯»å–#directã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€  è¯»å†™æ•°æ®é‡‡ç”¨ç›´æ¥IOæ–¹å¼ï¼›#status=progress æ˜¾ç¤ºè¿›åº¦\ntcpdumpâ€¢ é€‰æ‹©æ‰€æœ‰ç«¯å£ï¼ŒæŒ‡å®šhoståŸŸåæŠ“åŒ…ï¼ŒæŠ“åŒ…æ–‡ä»¶å­˜å…¥/tmp/ä¸­ï¼štcpdump â€“nni any â€“s 0 host www.ex.com â€“w /tmp/ex.com.pcapâ€¢ æŒ‡å®šeth0ï¼ŒæŒ‡å®šç›®æ ‡IPå’Œç«¯å£ï¼Œå¹¶æŒ‡å®šæŠ“å–1000ä¸ªæŠ¥æ–‡tcpdump â€“nni eth0 host 1.1.1.1 and port 80 â€“c 1000â€¢ æŒ‡å®šæŸç½‘æ®µï¼Œå¦‚ä¸‹è¡¨è¾¾å¼é»˜è®¤ä¸º/24ä½tcpdump â€“nni eth0 net 1.1.1.1 and portrange 8000-8080å¸¸ç”¨è¯­å¥â€¢å¾ªç¯æŠ“åŒ…ï¼ˆæŠ“å–å‰500ä¸ªå­—èŠ‚ï¼Œ500Mä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜10ä¸ªï¼‰tcpdump -i eth0 -s 500 host 1.1.1.1 -w /tmp/test.pcap -C 500 -W 10ç‰¹æ®Šåœºæ™¯è¯­å¥ï¼ŒæŠ“å–ç‰¹å®šçš„tcpç½®ä½æŠ¥æ–‡tcpdump -nni any tcp[tcpflags]=tcp-syn/tcp-rst/tcp-ack/tcp-ack\n\niperf3Client/Server: # å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…¬æœ‰çš„å‚æ•°æŒ‡å®šç«¯å£å·ï¼Œé»˜è®¤ä¸º5201                 -p, --port      #        server port to listen on/connect to å›æ˜¾æŠ¥å‘Šçš„é—´éš”æ—¶é—´                           -i, --interval  #        seconds between periodic bandwidth reports  æ˜¾ç¤ºå¸®åŠ©èœå•      -h, --help               print this message and quit   æ˜¾ç¤ºç‰ˆæœ¬    -v, --version            print version information and quit    Server specific:  #æœåŠ¡ç«¯ç§æœ‰å‚æ•°æŒ‡å®šä»¥æœåŠ¡ç«¯è¿è¡Œ                                                                -s, --server             run in server mode                                               Client specific:  #å®¢æˆ·ç«¯ç§æœ‰å‚æ•°å¸¦å®½å‚æ•°ï¼Œå•ä½ï¼šå­—èŠ‚æ¯ç§’ï¼šKMGï¼Œä¸º2çš„næ¬¡æ–¹ï¼Œæ¯”å¦‚1K=1024,ï¼›è®¾ç½®ä¸º0ä»£è¡¨æ— é™åˆ¶ï¼Œæ­¤å‚æ•°UDPé»˜è®¤1M/sï¼ŒTCPæ— é™åˆ¶     -b, --bandwidth #[KMG][/#] target bandwidth in bits/sec (0 for unlimited)                            (default 1 Mbit/sec for UDP, unlimited for TCP)                            (optional slash and packet count for burst mode) æŒ‡å®šä»¥å®¢æˆ·ç«¯è¿è¡Œï¼Œåé¢è¦å¸¦æœåŠ¡ç«¯çš„IPåœ°å€                                -c, --client    &lt;host&gt;   run in client mode, connecting to &lt;host&gt;   udpæ¨¡å¼ï¼Œä¸å¸¦-ué»˜è®¤ä¸ºtcpæ¨¡å¼    -u, --udp                use UDP rather than TCP   æŒ‡å®šæµ‹è¯•æ—¶é—´ï¼Œä¸å¸¦å‚æ•°é»˜è®¤æµ‹è¯•10s            -t, --time      #        time in seconds to transmit for (default 10 secs)  ç¿»è½¬æµ‹è¯•ï¼Œè¿™æ˜¯iperf3æ¯”iperf2æ–¹ä¾¿çš„ä¸»è¦äº®ç‚¹ï¼Œiperf2ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œæ— æ³•ä½¿ç”¨       -R, --reverse            reverse the test (client receives, server sends)  tcpçª—å£å¤§å°ï¼Œé»˜è®¤æ— ä¸Šé™ï¼Œå¯ä»¥ä¸è®¾æ­¤å‚æ•°ï¼Œä½œä¸ºudpæ¨¡å¼æµ‹è¯•æ—¶ä¹Ÿä¸éœ€è¦æ­¤å‚æ•° ï¼Œå•ä½ï¼šKMï¼Œ1K=1024         -w, --window    #[KMG]    set window size / socket buffer size  iperf -s -i 1# ä½œä¸ºæœåŠ¡ç«¯è¿è¡Œï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”æ—¶é—´1siperf3 -c 192.168.3.250 -i 1 -t 10 -b 7M#ä½œä¸ºå®¢æˆ·ç«¯ï¼Œè¿æ¥æœåŠ¡ç«¯ipåœ°å€192.168.3.250ï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”1sï¼Œæµ‹è¯•æ—¶é—´10s,å¸¦å®½é™åˆ¶ä¸º7Mã€‚iperf3 -c 192.168.3.250 -i 1 -t 10 -b 7M -R#ä½œä¸ºå®¢æˆ·ç«¯ï¼Œè¿æ¥æœåŠ¡ç«¯ipåœ°å€192.168.3.250ï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”1sï¼Œæµ‹è¯•æ—¶é—´10s,å¸¦å®½é™åˆ¶ä¸º7M,-Rä¸ºåå‘æµ‹è¯•ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯iperf3çš„ä¸»è¦äº®ç‚¹ï¼Œæ”¯æŒç›´æ¥è½¬æ¢æ•°æ®å‘é€æ–¹å‘#udpä¸æŒ‡å®š-bé»˜è®¤1Miperf -s -i 1# ä½œä¸ºæœåŠ¡ç«¯è¿è¡Œï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”æ—¶é—´1sï¼ŒæœåŠ¡ç«¯ä¸åŒºåˆ†tcpæˆ–udpiperf3 -u -c 192.168.3.250 -b 70M -i 1 -t 10#ä½œä¸ºå®¢æˆ·ç«¯è¿è¡Œï¼Œé™åˆ¶å¸¦å®½70Mï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”1sï¼Œæµ‹è¯•æ—¶é—´10siperf3 -u -c 192.168.3.250 -b 70M -i 1 -t 10 -R#ä½œä¸ºå®¢æˆ·ç«¯è¿è¡Œï¼Œé™åˆ¶å¸¦å®½70Mï¼ŒæŠ¥å‘Šå›æ˜¾é—´éš”1sï¼Œæµ‹è¯•æ—¶é—´10s\n\né¢å¤–å¸¸ç”¨æ—¶é—´while  true; do date +%Y-%m-%d&#x27; &#x27;%H:%M:%S.%N | cut -b 1-23 &amp;&amp; sleep 1;donecurlcurl localhost:3000/api/json -X POST -d &#x27;&#123;&quot;hello&quot;: &quot;world&quot;&#125;&#x27; --header &quot;Content-Type: application/jsoncurl -v -o output.html &quot;https://dana.lobn.com.cn/&quot; \\     --resolve dana.lobn.com.cn:443:8.152.0.157curl -L -XPOST -H &#x27;Cookie: authToken $token&#x27; -F &quot;uploadFiles=@/home/user/test1&quot; https://gdw-3.com/api/v1/detail/upload ç«¯å£nmap -v  -sS  -sV  -T 5 39.105.26.196  -p 9984sed -i.bak &#x27;/^\\s*[^#].*\\/data\\s/s/^/#/&#x27; /etc/fstab  badblocks -sv /dev/vdaâ— -vï¼šæ˜¾ç¤ºè¯¦æƒ…ã€‚â— -sï¼šæ˜¾ç¤ºè¿›åº¦ã€‚â— -wï¼šå†™æ¨¡å¼æµ‹è¯•ï¼ˆæ…ç”¨ï¼ä¼šè¦†ç›–æ•°æ®ï¼‰ç™»å½•æ—¥å¿—lastb | awk &#x27;&#123; print&quot; IPåœ°å€ä¸ºï¼š&quot; $3&#125;&#x27; | sort | uniq -c | sort -nr|headç½‘ç»œnetstat -ant | awk &#x27;/^tcp/ &#123;++y[$NF]&#125; END &#123;for(w in y) print w, y[w]&#125;&#x27;while true;do netstat -n | awk &#x27;/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a,S[a]&#125;&#x27;;sleep 1;done | grep TIME_WAITtraceroute  -n -T global-cs.aceux.net -p 80 || yum install traceroute -ynetstat -s |grep -e &quot;passive connections rejected because of time stamp&quot; netstat -s | grep &quot;SYNs to LISTEN&quot;netstat -s|egrep -i &#x27;syn|ignore|overflow|reject|becau|error|drop|back&#x27; è¿›ç¨‹ps -A -ostat,ppid,pid,cmd | grep -e &#x27;^[Zz]&#x27;ps  -e -L h o state,cmd,pid | awk &#x27;&#123;if($1==&quot;R&quot;||$1==&quot;D&quot;)&#123;print $0&#125;&#125;&#x27; | sort | uniq -c | sort -k 1nrps -auxww --sort=-%cpu|headps -eT -o%cpu,pid,tid,ppid,comm | grep -v CPU | sort -n -r | head -20ps -auxww --sort=-%mem|headps -T -o%cpu,pid,tid,ppid,comm -p           # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ps -Lf &lt;PID&gt;            # æ˜¾ç¤ºçº¿ç¨‹çš„è¯¦ç»†ä¿¡æ¯ps axjf --no-header  #è¿›ç¨‹æ ‘systemctl list-units --type=service --state=runningsystemctl list-units --type=service --state=running --no-pager |grep running |awk &#x27;&#123;print $1&#125;&#x27; |xargs systemctl cat |grep -i execstartlsof -nw|awk &#x27;&#123;print $2&#125;&#x27;| sort | uniq -c | sort -nr | head# è‡ªå®šä¹‰ç»ˆç«¯æç¤ºç¬¦PS1=&#x27;\\[\\e[38;5;208m\\]\\u@\\h\\[\\e[0m\\] \\[\\e[38;5;34m\\]\\D&#123;%H:%M:%S&#125;\\[\\e[0m\\] \\[\\e[38;5;33m\\]\\w\\[\\e[0m\\] \\[\\e[1;31m\\]$(git branch 2&gt;/dev/null | grep &quot;^*&quot; | colrm 1 2)\\[\\e[0m\\]\\n\\[\\e[1;32m\\]âœ \\[\\e[0m\\]&#x27;PS1=&#x27;\\[\\033[1;31m\\][\\t] \\[\\033[1;32m\\]\\u\\[\\033[1;36m\\]@\\[\\033[1;34m\\]\\h \\[\\033[1;33m\\]\\w\\[\\033[0m\\] &#x27;#pythonpip cache purgepip cache remove package-namepip install --no-cache-dir torch pip show  torchpip install --target=/mnt/xinference \\ --cache-dir=/mnt/xinference/pip_cache \\ &quot;xinference[all]&quot;python -c &quot;import os; print(&#x27;\\n&#x27;.join(dir(os)))&quot; | grep &#x27;kill&#x27;nginx -V 2&gt;&amp;1 | grep -o with-http_stub_status_module\n","categories":["linux"]},{"title":"æ•°æ®åº“","url":"/2025/07/24/%E6%95%B0%E6%8D%AE%E5%BA%93/","content":"æ•°æ®åº“mysqlç´¢å¼•å¤±æ•ˆæƒ…å†µ\nå›è¡¨æ¦‚å¿µ1.èšé›†ç´¢å¼•çš„B+æ ‘ï¼Œæ€§èƒ½æœ€ä¼˜ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯æ•´è¡Œçš„æ‰€æœ‰å­—æ®µæ•°æ®(ä¸»é”®ç´¢å¼•)2.éèšé›†ç´¢å¼•çš„B+æ ‘ï¼Œéèšé›†ç´¢å¼•åˆ—å¯èƒ½æ˜¯ä¸€åˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šåˆ—ï¼ˆè”åˆç´¢å¼•ï¼‰ï¼Œ  å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯éèšé›†ç´¢å¼•åˆ—ï¼ˆ1åˆ—æˆ–å¤šåˆ—ï¼‰çš„æ•°æ®å’Œèšé›†ç´¢å¼•åˆ—ç”¨æˆ·userè¡¨4åˆ—ï¼ˆid, userCode, userName, userSexï¼‰idæ˜¯ä¸»é”®ï¼ˆèšé›†ç´¢å¼•ï¼‰ï¼›userCode æ˜¯éèšé›†ç´¢å¼•ï¼Œæ­¤æ—¶ä¼šåˆ›å»º2ä¸ªç´¢å¼•çš„B+æ ‘èšé›†ç´¢å¼•çš„B+æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¿å­˜äº†4åˆ—ï¼ˆid, userCode, userName, userSexï¼‰çš„æ•°æ®éèšé›†ç´¢å¼•çš„B+æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¿å­˜äº†2åˆ—ï¼ˆid, userCodeï¼‰çš„æ•°æ®ä¸å›è¡¨èµ°ä¸»é”®ç´¢å¼•ä¸å›è¡¨ï¼Œå› ä¸ºæŒ‚è½½çš„æ˜¯æ•´åˆ—æ•°æ®select * from user where id = 1 èµ°éèšé›†ç´¢å¼•ä¸å›è¡¨ï¼Œå› ä¸ºå¶å­ç»“ç‚¹æŒ‚è½½äº†éèšé›†ç´¢å¼•å’Œèšé›†ç´¢å¼•çš„å€¼select id,userCode from user where userCode = 1 å›è¡¨å› ä¸ºæŸ¥è¯¢çš„åˆ—é™¤äº†ä¸»é”®idå’Œéèšé›†ç´¢å¼•userCodeè¿˜æœ‰userName, userSexï¼Œè¿™ä¸¤ä¸ªå¶å­èŠ‚ç‚¹æ²¡æœ‰å­˜æ•°æ®ï¼Œä¼šé€šè¿‡ä¸»é”®ç´¢å¼•idå›è¡¨æ¥æŸ¥è¯¢userName, userSexçš„å€¼ï¼Œå› ä¸ºä¸»é”®ç´¢å¼•idæŒ‚è½½çš„æ•´åˆ—çš„å€¼select id,userCodeï¼ŒuserSex from user where userCode = 1select id,userCodeï¼ŒuserName from user where userCode = 1select * from user where userCode = 1\nå¸¸ç”¨sqlå…ƒæ•°æ®#æŒ‡å®šæ•°æ®åº“çš„è¯¦ç»†ä¿¡æ¯SELECT   TABLE_SCHEMA AS &#x27;æ•°æ®åº“&#x27;,  TABLE_NAME AS &#x27;è¡¨å&#x27;,  TABLE_ROWS AS `è¡Œæ•°`,  ROUND( (DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) AS &#x27;æ€»å¤§å°(MB)&#x27;,  ROUND(DATA_LENGTH / 1024 / 1024, 2) AS &#x27;æ•°æ®å¤§å°(MB)&#x27;,  ROUND(INDEX_LENGTH / 1024 / 1024, 2) AS &#x27;ç´¢å¼•å¤§å°(MB)&#x27;,  TABLE_ROWS AS &#x27;æ•°æ®è¡Œæ•°ï¼ˆä¼°ç®—å€¼ï¼‰&#x27;FROM information_schema.TABLESWHERE TABLE_SCHEMA = &#x27;y_back&#x27;  -- æ›¿æ¢ä¸ºä½ çš„æ•°æ®åº“åORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC;  -- æŒ‰æ€»å¤§å°æ’åº#æ•°æ®åº“è¡¨çš„è¡Œæ•°SELECT   TABLE_NAME AS &#x27;è¡¨å&#x27;,  TABLE_ROWS AS &#x27;ä¼°ç®—è¡Œæ•°&#x27;,  (SELECT COUNT(*) FROM y_back.t_work) AS &#x27;ç²¾ç¡®è¡Œæ•°&#x27;  -- æ›¿æ¢ä¸ºå®é™…è¡¨åFROM information_schema.TABLESWHERE TABLE_SCHEMA = &#x27;y_back&#x27;;#allSELECT\ttable_schema AS &#x27;æ•°æ®åº“&#x27;,\tsum( table_rows ) AS &#x27;è®°å½•æ•°&#x27;,\tsum(\tTRUNCATE ( data_length / 1024 / 1024, 2 )) AS &#x27;æ•°æ®å®¹é‡(MB)&#x27;,\tsum(\tTRUNCATE ( index_length / 1024 / 1024, 2 )) AS &#x27;ç´¢å¼•å®¹é‡(MB)&#x27; FROM\tinformation_schema.TABLES GROUP BY\ttable_schema ORDER BY\tsum( data_length ) DESC,\tsum( index_length ) DESC;#è¿‡æ»¤å…ƒæ•°æ®åº“SELECT  table_schema AS &#x27;æ•°æ®åº“&#x27;,  SUM(table_rows) AS &#x27;è®°å½•æ•°&#x27;,  TRUNCATE(SUM(data_length) / 1024 / 1024, 2) AS &#x27;æ•°æ®å®¹é‡(MB)&#x27;,  -- å…ˆæ±‚å’Œå†è½¬æ¢å•ä½  TRUNCATE(SUM(index_length) / 1024 / 1024, 2) AS &#x27;ç´¢å¼•å®¹é‡(MB)&#x27;FROM  information_schema.TABLESWHERE  table_schema NOT IN (    &#x27;information_schema&#x27;,     &#x27;mysql&#x27;,     &#x27;performance_schema&#x27;,     &#x27;sys&#x27;  )GROUP BY  table_schemaORDER BY  SUM(data_length) DESC,  SUM(index_length) DESC;ANALYZE TABLE - æ›´æ–°ç»Ÿè®¡ä¿¡æ¯OPTIMIZE TABLE - è¡¨ä¼˜åŒ–é‡ç»„ä¿—ç§°æ¸…ç†ç¢ç‰‡#é€ æ•°æ®CREATE TABLE `t_work_db01` (  `id` bigint NOT NULL AUTO_INCREMENT,  `name` varchar(256) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,  `age` int DEFAULT NULL,  `sex` char(1) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,  `money` float DEFAULT NULL COMMENT &#x27;é‡‘é¢&#x27;,  PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=100001 DEFAULT CHARSET=utf8mb3 ROW_FORMAT=DYNAMICDELIMITER $$CREATE PROCEDURE InsertDummyData()BEGIN    DECLARE i INT DEFAULT 0;    WHILE i &lt; 100000 DO        INSERT INTO t_work (NAME, age, sex, money)        VALUES (            -- éšæœºç”Ÿæˆç”¨æˆ·åï¼ˆç¤ºä¾‹ï¼šUser_XXXXï¼‰            CONCAT(&#x27;User_&#x27;, SUBSTRING(MD5(RAND()) FROM 1 FOR 8)),            -- éšæœºå¹´é¾„ 18~65 å²            FLOOR(18 + RAND() * 48),            -- éšæœºæ€§åˆ«ï¼ˆM/Fï¼‰            IF(RAND() &lt; 0.5, &#x27;M&#x27;, &#x27;F&#x27;),            -- éšæœºé‡‘é¢ 1000~10000ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼‰            ROUND(1000 + RAND() * 9000, 2)        );        SET i = i + 1;    END WHILE;END$$DELIMITER ;-- æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹CALL InsertDummyData();DROP PROCEDURE IF EXISTS InsertDummyData;  -- å¼ºåˆ¶åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\nmysqlè¯»å†™åˆ†ç¦»github ProxySqlMaxScale\nmysqlåˆ†è¡¨åˆ†åº“mycat\npgsqlPostgreSQL psql å¸¸ç”¨å‘½ä»¤\næ¦‚å¿µPUBLIC æ˜¯ PostgreSQL æ•°æ®åº“ä¸­ä¸€ä¸ªç‰¹æ®Šçš„è§’è‰²ç»„ï¼Œåœ¨å…ƒæ•°æ®è¡¨ï¼ˆpg_rolesï¼‰ä¸­éƒ½æŸ¥ä¸åˆ°è¯¥è§’è‰²ï¼Œæ•°æ®åº“ä¸­æ‰€åˆ›å»ºçš„è§’è‰²éƒ½å¯ä»¥ç†è§£ä¸ºæ˜¯ PUBLIC è§’è‰²ç»„æˆå‘˜ã€‚è€Œä¸”å¯¹ PUBLIC æƒé™çš„ç»§æ‰¿å®Œå…¨ä¸å— NOINHERIT çš„æ§åˆ¶ï¼Œä¸€æ—¦åˆ›å»ºäº†ä¸€ä¸ªæ‹¥æœ‰ login æƒé™çš„è§’è‰²ï¼Œå®ƒä¼šç«‹å³ç»§æ‰¿ PUBLIC è§’è‰²ç»„æ‹¥æœ‰çš„æƒé™ï¼Œæ­¤æ—¶å¦‚æœæƒ³é€šè¿‡ revokeï¼ˆæ¯”å¦‚ revoke connect on databaseï¼‰æ¥å›æ”¶çš„è¯ä¸ä¼šæˆåŠŸï¼Œåªèƒ½ä» PUBLIC ç»„å›æ”¶ç›¸å…³æƒé™ï¼ˆæ¯”å¦‚ revoke connect on database from PUBLICï¼‰REVOKE CONNECT ON DATABASE test FROM PUBLIC;--è¿™æ ·æ™®é€šç”¨æˆ·å°±æ— æ³•è‡ªç”±åˆ‡æ¢æ•°æ®åº“ï¼Œé»˜è®¤æ•°æ®åº“ä¸‹é¢æœ‰ä¸€ä¸ªpublicçš„schemeMySQL çš„ datadir â‰ˆ PostgreSQL çš„é»˜è®¤è¡¨ç©ºé—´ pg_defaultPostgreSQL çš„ pg_default è¡¨ç©ºé—´å¯¹åº”é»˜è®¤æ•°æ®ç›®å½•ï¼ˆç”±å‚æ•° data_directory é…ç½®ï¼‰ï¼Œç±»ä¼¼äº MySQL çš„ datadirã€‚PostgreSQL çš„æ•°æ®åº“ â‰ˆ MySQL çš„å®ä¾‹ï¼ˆä½†æ›´è½»é‡ï¼‰ã€‚PostgreSQL çš„æ¨¡å¼ â‰ˆ MySQL çš„æ•°æ®åº“\n\nåŸºæœ¬ä½¿ç”¨å‘½ä»¤docker run -id --name=pgsql -v postgre-data:/var/lib/postgresql/data -p 54222:5432 -e POSTGRES_PASSWORD=123456 -e LANG=C.UTF-8 bitnami/postgresqldocker exec -it -uroot pgsql bashpsql -U postgres -W -ncat .psql_history psql -h host -p port -d dbname -U  user -Wä½¿ç”¨åæ–œçº¿ä½œä¸ºå‘½ä»¤å‰ç¼€.  postgres=# \\db# è¾“å‡ºçš„ä¿¡æ¯å¦‚ä¸‹ï¼š       List of tablespaces    Name    |  Owner   | Location ------------+----------+---------- pg_default | postgres |  pg_global  | postgres | (2 rows)é€€å‡º    \\q åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“      \\l åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“çš„å¤§å°      \\l+ æ›´æ”¹å½“å‰è¿æ¥çš„æ•°æ®åº“       \\c åˆ—å‡ºå½“å‰æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯    \\connect åˆ—å‡ºå½“å‰æ•°æ®åº“å’Œè¿æ¥çš„è¯¦ç»†ä¿¡æ¯ \\conninfo æŸ¥çœ‹å½“å‰æ•°æ®åº“é‡Œé¢çš„è¡¨å’Œæ‹¥æœ‰è€…å’Œè¡¨å¤§å°         \\dt+ å±•ç¤ºæ‰€æœ‰ç”¨æˆ·           \\dg â€‹æ¨¡å¼ \\dn æŸ¥çœ‹æ‰€æœ‰è¡¨åçš„åˆ—è¡¨             \\d è·å–è¡¨ç»“æ„                   \\da å±•ç¤ºæ‰€æœ‰ç”¨æˆ·               \\du æŸ¥çœ‹t_smsè¡¨çš„ç»“æ„      \\d t_sms  å±•ç¤ºæ•°æ®åº“é‡Œé¢çš„æ‰€æœ‰çš„è¡¨         \\dt åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ•°æ®åº“å¤§å°å’Œå­—ç¬¦æ ¼å¼ï¼‰         \\l+ æ˜¾ç¤ºç”¨æˆ·è®¿é—®æƒé™ã€‚                            \\zæˆ–\\dp æ˜¾ç¤ºæ‰€æœ‰å¯è®¾ç½®çš„è®¿é—®æƒé™                     \\h GRAN æ˜¾ç¤ºç”¨æˆ·çš„å¯¹æ‰€æœ‰æ•°æ®åº“è¡¨çš„è¯¦ç»†è®¿é—®æƒé™     \\dpæˆ–è€…\\z ç¡®è®¤å½“å‰è¿æ¥çš„ç”¨æˆ·ä¸ºè¶…çº§ç”¨æˆ·postgresï¼Œä¸”è¯¥ç”¨æˆ·ååˆ›å»ºè§’è‰²å’Œæ•°æ®åº“çš„æƒé™ç­‰     #select current_user; åœ¨è¶…çº§ç”¨æˆ·è¿æ¥postgresåï¼Œè®¾ç½®ä¸å…è®¸æ™®é€šç”¨æˆ·aè¿æ¥æ•°æ®åº“         #alter role a nologin; â€‹ ä½¿ç”¨æ™®é€šç”¨æˆ·aè¿æ¥æ•°æ®åº“æ­£å¸¸                   #\\c highgo aå¿«é€ŸæŸ¥çœ‹å½“å‰æ‰€æœ‰ç”¨æˆ·ï¼š\\duæŸ¥çœ‹è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ï¼šselect * from pg_user;æŸ¥çœ‹è¯¦ç»†è§’è‰²ä¿¡æ¯ï¼šselect * from pg_roles;æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·ï¼šselect user;ä¸€èˆ¬å»ºè®®å…ˆåˆ›å»ºç”¨æˆ·ç„¶åä½¿ç”¨è¿™ä¸ªç”¨æˆ·å»åˆ›å»ºæ•°æ®åº“æ¨¡å¼ï¼Œå› ä¸ºæ•°æ®åº“é‚£ä¸ªç”¨æˆ·åˆ›å»ºçš„é»˜è®¤Ownerå°±æ˜¯è¿™ä¸ªç”¨æˆ·åˆ›å»ºç”¨æˆ·ï¼šCREATE USER $user_name PASSWORD &#x27;$password&#x27;;åˆ›å»ºè§’è‰²ï¼šCREATE ROLE $role_name; ä¿®æ”¹ç”¨æˆ·ä¸è§’è‰²ï¼šALTER USER[ROLE] $user_name         e.g.        //ä¿®æ”¹ç”¨æˆ·åï¼šALTER USER U2 RENAME TO U22;        //ä¿®æ”¹ç”¨æˆ·çš„å¯†ç ï¼šALTER USER U22 PASSWORD&#x27;U22;        //ä¿®æ”¹ç”¨æˆ·çš„æƒé™ï¼šALTER USER u22 CREATEROLE;        //ä¿®æ”¹æ•°æ®åº“ testdbä¸­çš„å‚æ•°é‡è®¾ä¸ºé»˜è®¤å€¼ï¼šALTER USER u22 IN DATABASE testdb RESET all1;        //ä¿®æ”¹è§’è‰²çš„åå­—ï¼šALTER ROLE dev RENAME TO dev1;        //ä¿®æ”¹è§’è‰²çš„æƒé™ï¼šALTER ROLE dev1 SUPERUSER;        //ä¿®æ”¹è§’è‰²çš„æƒé™ï¼šALTER ROLE dev1 LOGIN; åˆ é™¤ç”¨æˆ·ä¸è§’è‰²ï¼šDROP USER[ROLE] [IF EXISTS] $user_name æˆæƒç”¨æˆ·æŸä¸ªè§’è‰²:GRANT $role_name TO $user_name;    (æˆæƒåset role $role_nameå¯ç”¨ç”Ÿæ•ˆï¼‰ create user test with password &#x27;rong &#x27;;CREATE DATABASE testdb OWNER test;GRANT ALL PRIVILEGES ON DATABASE testdb TO test;alter user qh with password &#x27;123&#x27;;\\password qh;  //éœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ï¼ˆæ¨èï¼‰\n\n\n\nmanggodbè¯¦ç»†ä½¿ç”¨æ•™ç¨‹\ndocker run -itd --name mongo -v /docker_volume/mongodb/data:/data/db -p 27017:27017 mongo:4.4 --authâ€“authï¼šéœ€è¦å¯†ç æ‰èƒ½è®¿é—®å®¹å™¨æœåŠ¡ï¼›mongodbå®‰è£…å¥½åç¬¬ä¸€æ¬¡è¿›å…¥æ˜¯ä¸éœ€è¦å¯†ç çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”¨æˆ·ï¼Œé€šè¿‡shellå‘½ä»¤å¯ç›´æ¥è¿›å…¥use admin ä½¿ç”¨adminæ•°æ®åº“å¹¶è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœä¸éªŒè¯ï¼Œæ˜¯åšä¸äº†ä»»ä½•æ“ä½œçš„db.auth(&quot;root&quot;,&quot;123456&quot;)  è¿”å›1è¡¨ç¤ºæˆåŠŸ éªŒè¯ä¹‹åè¿˜æ˜¯åšä¸äº†æ“ä½œï¼Œå› ä¸ºrootåªæœ‰ç”¨æˆ·ç®¡ç†æƒé™ï¼Œä¸‹é¢åˆ›å»ºç”¨æˆ·ï¼Œç”¨æˆ·éƒ½è·Ÿç€åº“èµ°use mydb db.createUser(&#123;user: &quot;admin&quot;,pwd: &quot;123456&quot;,roles: [&#123; role: &quot;readWrite&quot;, db: &quot;mydb&quot; &#125;]&#125;) é€šè¿‡adminç”¨æˆ·å¢åˆ æ”¹æŸ¥docker exec -it mongo mongo admindb.createUser(&#123; user:&#x27;root&#x27;,pwd:&#x27;123456&#x27;,roles:[ &#123; role:&#x27;userAdminAnyDatabase&#x27;, db: &#x27;admin&#x27;&#125;,&#x27;readWriteAnyDatabase&#x27;]&#125;);ã€role:â€˜userAdminAnyDatabaseâ€™ã€‘ï¼šåªåœ¨adminæ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰æ•°æ®åº“çš„userAdminæƒé™ã€db: â€˜adminâ€™ã€‘ï¼šå¯æ“ä½œçš„æ•°æ®åº“ã€â€˜readWriteAnyDatabaseâ€™ã€‘ï¼šèµ‹äºˆç”¨æˆ·è¯»å†™æƒé™mongoDB æ²¡æœ‰æ— æ•Œç”¨æˆ·rootï¼Œåªæœ‰èƒ½ç®¡ç†ç”¨æˆ·çš„ç”¨æˆ· userAdminAnyDatabase SQL æœ¯è¯­/æ¦‚å¿µ\tMongoDB æœ¯è¯­/æ¦‚å¿µ   è§£é‡Š/è¯´æ˜database\t    database\t       æ•°æ®åº“table\t        collection\t       æ•°æ®åº“è¡¨/é›†åˆrow\t            document\t       æ•°æ®è®°å½•è¡Œ/æ–‡æ¡£column\t        field\t           æ•°æ®å­—æ®µ/åŸŸindex\t        index\t           ç´¢å¼•table joins\t \tè¡¨è¿æ¥,            MongoDBä¸æ”¯æŒprimary key\t    primary key\t       ä¸»é”®,MongoDBè‡ªåŠ¨å°†_idå­—æ®µè®¾ç½®ä¸ºä¸»é”®\nsqlserverdocker run -d \\  --name sqlserver --user=root \\  -e &quot;ACCEPT_EULA=Y&quot; \\  -e &quot;SA_PASSWORD=Testing@123&quot;  -p 1433:1433  -v /data/sqlserver:/var/opt/mssql \\  --cap-add SYS_PTRACE mcr.microsoft.com/mssql/server:2019-latest  /opt/mssql-tools18/bin/sqlcmd -S localhost -U SA -P &quot;Testing@123&quot; -C  -- æ•°æ®åº“çº§  SELECT name, type_desc FROM sys.database_principals WHERE type IN (&#x27;S&#x27;, &#x27;U&#x27;, &#x27;G&#x27;);  select * from master.dbo.SysDatabases  --æœåŠ¡å™¨çº§  SELECT name, type_desc FROM sys.server_principals WHERE type IN (&#x27;S&#x27;, &#x27;U&#x27;, &#x27;G&#x27;);  go  SELECT DB_NAME() AS [CurrentDatabase];  USE master; SELECT name FROM sys.schemas  USE master; SELECT name FROM sys.tables  SELECT name, USER_NAME(principal_id) FROM sys.schemas;CREATE TABLE Users (    UserID INT PRIMARY KEY IDENTITY(1,1),     UserName NVARCHAR(50) NOT NULL,   Email NVARCHAR(100) NOT NULL, RegistrationDate DATETIME DEFAULT GETDATE(), IsActive BIT DEFAULT 1);INSERT INTO Users (UserName, Email) VALUES     (&#x27;ç‹äº”&#x27;, &#x27;wangwu@example.com&#x27;),    (&#x27;èµµå…­&#x27;, &#x27;zhaoliu@example.com&#x27;),    (&#x27;å­™ä¸ƒ&#x27;, &#x27;sunqi@example.com&#x27;);--cdcuse y_testEXEC sys.sp_cdc_enable_db;go SELECT name AS [y_test],    is_cdc_enabled AS [CDCEnabled]FROM   sys.databases WHERE     name = DB_NAME(); \n","categories":["db"]},{"title":"æ–—åœ°ä¸»","url":"/2025/08/15/%E6%96%97%E5%9C%B0%E4%B8%BB/","content":"\nç®€æ˜“guiæ–—åœ°ä¸»æ‘¸é±¼å°æ¸¸æˆï¼›å¯åŠ¨æœåŠ¡ç«¯å’Œä¸‰ä¸ªå®¢æˆ·ç«¯å³å¯ä½¿ç”¨\n\næœåŠ¡ç«¯#!/usr/bin/python# -*- coding: utf-8 -*-# æ–‡ä»¶åï¼šserver.pyimport socketimport jsonimport randomimport threadingimport timeClient_Number = 0  # å®¢æˆ·ç«¯æ•°FLAG = 0FLAG1 = 0FLAG2 = 0  # æŠ¢åœ°ä¸»åˆ¤å®šç¬¦# ç‰Œå‹å…¨å±€type = &#x27;init&#x27;value = 0seq_num = 0jumpCounter = 0POKER = [0 for i in range(54)]for i in range(1, 55):    POKER[i - 1] = irandom.shuffle(POKER)  # æ´—ç‰Œ# print(POKER)s = socket.socket()  # åˆ›å»º socket å¯¹è±¡#host = socket.gethostname()  # è·å–æœ¬åœ°ä¸»æœºåhost = &#x27;0.0.0.0&#x27;port = 12345  # è®¾ç½®ç«¯å£s.bind((host, port))  # ç»‘å®šç«¯å£s.listen(3)  # ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥def Turner(num):    if num == 0:        return 1    if num == 1:        return 2    if num == 2:        return 0def send_message(socket, string):    json = &#123;        &#x27;status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;message&#x27;,        &#x27;Card&#x27;: [0],        &#x27;message&#x27;: &#x27;&#x27;    &#125;    json[&#x27;message&#x27;] = string    socket.sendall(str.encode(str(json)))def ask_select(socket, socket1, socket2):    json = &#123;        &#x27;Status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;AskS&#x27;    &#125;    socket.sendall(str.encode(str(json)))    socket1.sendall(str.encode(str(json)))    socket2.sendall(str.encode(str(json)))def set_turn(socket, Type, value, seq_num):    json = &#123;        &#x27;Status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;SetTurn&#x27;,        &#x27;type&#x27;: Type,        &#x27;value&#x27;: value    &#125;    print(&#x27;sent:type=&#x27;, Type, &#x27; value=&#x27;, value, &#x27; seq_num=&#x27;, seq_num)    socket.sendall(str.encode(str(json)))def json_prase(js, socket=s, socket1=s, socket2=s):    recjs = eval(js)    global type    global value    global seq_num    global jumpCounter    if recjs[&#x27;Operation&#x27;] == &#x27;AnsS&#x27;:        return recjs[&#x27;message&#x27;]    elif recjs[&#x27;Operation&#x27;] == &#x27;AnsTurn&#x27;:        print(recjs)        # è¿™é‡Œä¼šæ”¶åˆ°å›ç‰Œ        json = &#123;            &#x27;Status&#x27;: 200,            &#x27;Operation&#x27;: &#x27;Announce&#x27;,            &#x27;message&#x27;: recjs[&#x27;message&#x27;]        &#125;        socket.sendall(str.encode(str(json)))        socket1.sendall(str.encode(str(json)))        socket2.sendall(str.encode(str(json)))        if recjs[&#x27;type&#x27;] == &#x27;Jump&#x27;:            if jumpCounter == 1:                type = &#x27;init&#x27;                value = 0                seq_num = 0                jumpCounter = 0            else:                jumpCounter += 1        else:            jumpCounter = 0            type = recjs[&#x27;type&#x27;]            value = recjs[&#x27;value&#x27;]            seq_num = recjs[&#x27;seq_num&#x27;]        print(&#x27;JC=&#x27;, jumpCounter)        time.sleep(0.5)    elif recjs[&#x27;Operation&#x27;] == &#x27;Clear&#x27;:        send_message(socket, &#x27;Game Over!&#x27;)        send_message(socket1, &#x27;Game Over!&#x27;)        send_message(socket2, &#x27;Game Over!&#x27;)        socket.close()        socket1.close()        socket2.close()    else:        print(&#x27;Unknown json&#x27;)        return -1def send_card(socket):    ADD = [0 for i in range(3)]    ADD[0] = POKER[53]    ADD[1] = POKER[52]    ADD[2] = POKER[51]    json = &#123;        &#x27;status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;Add&#x27;,        &#x27;message&#x27;: &#x27;&#x27;    &#125;    json[&#x27;message&#x27;] = ADD    print(json)    socket.sendall(str.encode(str(json)))def init_card(socket, socket1, socket2):    SET = [0 for i in range(20)]    SET1 = [0 for i in range(20)]    SET2 = [0 for i in range(20)]    for i in range(0, 17):        SET[i] = POKER[i]  # pokerçš„0åˆ°16å·        SET1[i] = POKER[i + 17]  # pokerçš„17åˆ°34        SET2[i] = POKER[i + 34]  # pokerçš„34åˆ°51    print(&#x27;SET:&#x27;)    print(sorted(SET))    print(&#x27;SET1&#x27;)    print(sorted(SET1))    print(&#x27;SET2&#x27;)    print(sorted(SET2))    json = &#123;        &#x27;status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;init&#x27;,        &#x27;Card&#x27;: [0],        &#x27;message&#x27;: SET    &#125;    json1 = &#123;        &#x27;status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;init&#x27;,        &#x27;Card&#x27;: [0],        &#x27;message&#x27;: SET1    &#125;    json2 = &#123;        &#x27;status&#x27;: 200,        &#x27;Operation&#x27;: &#x27;init&#x27;,        &#x27;Card&#x27;: [0],        &#x27;message&#x27;: SET2    &#125;    socket.sendall(str.encode(str(json)))    socket1.sendall(str.encode(str(json1)))    socket2.sendall(str.encode(str(json2)))# def receive_card(socket,socket1,socket2):# START REGISTERRINGwhile True:    if Client_Number == 9:  # æš‚å­˜        c, addr = s.accept()  # å»ºç«‹å®¢æˆ·ç«¯è¿æ¥ã€‚ cæ˜¯æœ¬è¿æ¥çš„socket        Client_Number = Client_Number + 1        print(&#x27;Connected by&#x27;, addr)  # è¾“å‡ºå®¢æˆ·ç«¯çš„IPåœ°å€        data = c.recv(1024)  # æŠŠæ¥æ”¶çš„æ•°æ®å®ä¾‹åŒ–        if len(data.strip()) == 0:            c.sendall(b&quot;Done&quot;)        else:            recData = eval(data)  # str è½¬ Dict            string = bytes.decode(data)  # byte to str            print(string)            print(recData[&#x27;massage&#x27;])        c.sendall(b&#x27;successfully connected&#x27;)    elif Client_Number == 0:        c, addr = s.accept()        Client_Number = Client_Number + 1        print(&#x27;Connected by&#x27;, addr)        # c.sendall(str.encode(&#x27;successfully connected from&#x27;+addr.__str__()))        send_message(c, &#x27;hello!&#x27;)    elif Client_Number == 1:        c1, addr1 = s.accept()        Client_Number = Client_Number + 1        print(&#x27;Connected by&#x27;, addr1)        # c1.sendall(str.encode(&#x27;successfully connected from&#x27;+addr1.__str__()))        send_message(c1, &#x27;hello!&#x27;)    else:        c2, addr2 = s.accept()        Client_Number = Client_Number + 1        print(&#x27;Connected By&#x27;, addr2)        # c2.sendall(str.encode(&#x27;successfully connected from&#x27;+addr1.__str__()))        send_message(c2, &#x27;hello!&#x27;)    if Client_Number == 3:        print(&#x27;Players all connected&#x27;)        time.sleep(2)        send_message(c, &#x27;Players all connected&#x27;)        send_message(c1, &#x27;Players all connected&#x27;)        send_message(c2, &#x27;Players all connected&#x27;)        break    # START PLAYINGtime.sleep(2)init_card(c, c1, c2)  # å‘ç‰Œ# START APPLICATINGTURN = 0while True:    ask_select(c, c1, c2)  # è¦æ±‚å®¢æˆ·ç«¯å›å¤æŠ¢åœ°ä¸»ç»“æœ    Client_Number = 0  ##æ”¶åˆ°å›åº”æ•°    time.sleep(1)    # Waiting for Client 0    receive = c.recv(1024)    if len(receive.strip()) == 0:        continue    else:        FLAG = json_prase(receive)        Client_Number = Client_Number + 1    # Waiting for Client 1    time.sleep(1)  # ç­‰å¾…buffer    receive1 = c1.recv(1024)    if len(receive1.strip()) == 0:        continue    else:        FLAG1 = json_prase(receive1)        Client_Number = Client_Number + 1    # Waiting for Client 2    time.sleep(1)    receive2 = c2.recv(1024)    if len(receive.strip()) == 0:        continue    else:        FLAG2 = json_prase(receive2)        Client_Number = Client_Number + 1    if Client_Number == 3:        # print(&#x27;FLAG=&#x27;,FLAG)        # print(&#x27;FLAG1=&#x27;,FLAG1)        # print(&#x27;FLAG2=&#x27;,FLAG2)        if FLAG + FLAG1 + FLAG2 == 0:            continue        elif FLAG + FLAG1 + FLAG2 != 1:            continue  # è¿™é‡Œä¹‹åè¦æœ‰ä¸ªåŠ å€ç§¯åˆ†çš„å‡½æ•°        else:            if FLAG == 1:                send_message(c, &#x27;You are the king!&#x27;)                send_message(c1, &#x27;Player0 is the king!&#x27;)                send_message(c2, &#x27;Player0 is the king!&#x27;)                time.sleep(2)                send_card(c)            if FLAG1 == 1:                send_message(c1, &#x27;You are the king!&#x27;)                send_message(c, &#x27;Player1 is the king!&#x27;)                send_message(c2, &#x27;Player1 is the king!&#x27;)                time.sleep(2)                send_card(c1)                TURN = 1            if FLAG2 == 1:                send_message(c2, &#x27;You are the king!&#x27;)                send_message(c, &#x27;Player2 is the king!&#x27;)                send_message(c1, &#x27;Player2 is the king!&#x27;)                time.sleep(2)                send_card(c2)                TURN = 2            break# GAME START!while True:    time.sleep(2)    if TURN == 0:        set_turn(c, type, value, seq_num)        while True:            time.sleep(0.1)            receive = c.recv(1024)            if len(receive.strip()) == 0:                continue            else:                json_prase(receive, c, c1, c2)                TURN = Turner(TURN)                break    elif TURN == 1:        set_turn(c1, type, value, seq_num)        while True:            time.sleep(0.1)            receive = c1.recv(1024)            if len(receive.strip()) == 0:                continue            else:                json_prase(receive, c, c1, c2)                TURN = Turner(TURN)                break    elif TURN == 2:        set_turn(c2, type, value, seq_num)        while True:            time.sleep(0.1)            receive = c2.recv(1024)            if len(receive.strip()) == 0:                continue            else:                json_prase(receive, c, c1, c2)                TURN = Turner(TURN)                breakprint(&#x27;Shutting down server...&#x27;)c.close()c1.close()c2.close()\n\n\n\nå®¢æˆ·ç«¯#!/usr/bin/python# -*- coding: utf-8 -*-import tkinter as tkfrom tkinter import ttk, messageboximport socketimport jsonimport threadingimport timeclass DouDiZhuGUI:    def __init__(self, root):        self.root = root        self.root.title(&quot;æ–—åœ°ä¸»æ¸¸æˆ&quot;)        self.root.geometry(&quot;800x600&quot;)        # æ¸¸æˆçŠ¶æ€å˜é‡        self.CARD = [0 for i in range(20)]        self.Card_num = 17        self.CURRENT = []        self.selected_cards = []  # å½“å‰é€‰ä¸­çš„ç‰Œ        # å½“å‰ç‰Œå‹è¦æ±‚        self.required_type = &#x27;init&#x27;        self.required_value = 0        self.required_count = 0        # ç©å®¶ä¿¡æ¯        self.player_id = 0  # é»˜è®¤ç©å®¶ID        self.current_player = 0  # å½“å‰å‡ºç‰Œç©å®¶        self.landlord = -1  # åœ°ä¸»ç©å®¶ID        # æ¸¸æˆçŠ¶æ€        self.game_over = False        # Socketè¿æ¥        self.s = None        self.connected = False        # æ‰‘å…‹ç‰Œæ˜ å°„        self.A = [&#x27;çº¢æ¡ƒ&#x27;, &#x27;é»‘æ¡ƒ&#x27;, &#x27;æ–¹ç‰‡&#x27;, &#x27;æ¢…èŠ±&#x27;]        self.B = [&#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;10&#x27;, &#x27;J&#x27;, &#x27;Q&#x27;, &#x27;K&#x27;, &#x27;A&#x27;, &#x27;2&#x27;]        self.POKERS = []        n = 1        for i in self.A:            for j in self.B:                self.POKERS.append(((i + j + &#x27;(&#x27; + str(n) + &#x27;)&#x27;)))                n += 1        self.POKERS.append(&#x27;å°ç‹(53)&#x27;)        self.POKERS.append(&#x27;å¤§ç‹(54)&#x27;)        # åˆ›å»ºUIç•Œé¢        self.create_widgets()        # å¯åŠ¨æ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹        self.receive_thread = None    def map_card(self, Cno):        &quot;&quot;&quot;å°†ç‰Œç¼–å·æ˜ å°„ä¸ºç‰Œé¢&quot;&quot;&quot;        if Cno == 0:            return None        else:            return self.POKERS[Cno - 1]    def get_card_color(self, card_num):        &quot;&quot;&quot;è·å–ç‰Œçš„é¢œè‰²&quot;&quot;&quot;        if card_num &gt;= 1 and card_num &lt;= 13:  # çº¢æ¡ƒ            return &quot;red&quot;        elif card_num &gt;= 14 and card_num &lt;= 26:  # é»‘æ¡ƒ            return &quot;black&quot;        elif card_num &gt;= 27 and card_num &lt;= 39:  # æ–¹ç‰‡            return &quot;red&quot;        elif card_num &gt;= 40 and card_num &lt;= 52:  # æ¢…èŠ±            return &quot;black&quot;        else:  # ç‹            return &quot;gold&quot;    def get_card_display_info(self, card_num):        &quot;&quot;&quot;è·å–ç‰Œçš„æ˜¾ç¤ºä¿¡æ¯ï¼ˆæ–‡æœ¬å’Œé¢œè‰²ï¼‰&quot;&quot;&quot;        card_text = self.map_card(card_num)        card_color = self.get_card_color(card_num)        return card_text, card_color    def sort_cards_for_display(self, cards):        &quot;&quot;&quot;æŒ‰ç‰Œé¢å¤§å°æ’åºï¼Œç›¸åŒå¤§å°çš„ç‰Œæ”¾åœ¨ä¸€èµ·&quot;&quot;&quot;        if not cards:            return []        # æŒ‰ç…§ç‰Œé¢å€¼åˆ†ç»„        card_groups = &#123;&#125;        for card in cards:            card_value = self.get_card_value(card)            if card_value not in card_groups:                card_groups[card_value] = []            card_groups[card_value].append(card)        # å¯¹ç»„è¿›è¡Œæ’åºï¼ˆæŒ‰ç‰Œå€¼å¤§å°ï¼‰        sorted_groups = sorted(card_groups.items(), key=lambda x: x[0])        # åˆå¹¶æ’åºåçš„ç‰Œ        sorted_cards = []        for value, group in sorted_groups:            # ç»„å†…æŒ‰èŠ±è‰²æ’åº            group.sort()            sorted_cards.extend(group)        return sorted_cards    def get_card_value(self, card_num):        &quot;&quot;&quot;è·å–ç‰Œçš„æ•°å€¼ç”¨äºæ¯”è¾ƒå¤§å°&quot;&quot;&quot;        if card_num == 53:  # å°ç‹            return 16        elif card_num == 54:  # å¤§ç‹            return 17        else:            return (card_num - 1) % 13 + 3  # 3åˆ°17çš„å€¼ï¼Œå…¶ä¸­3æœ€å°ï¼Œ2æœ€å¤§ï¼ˆ15ï¼‰    def parse_cards_type(self, cards):        &quot;&quot;&quot;åˆ†æç‰Œå‹&quot;&quot;&quot;        if not cards:            return None, 0, 0        sorted_cards = sorted(cards)        card_values = [self.get_card_value(card) for card in sorted_cards]        # ç‰¹æ®Šç‰Œå‹ï¼šç‹ç‚¸        if sorted_cards == [53, 54]:            return &#x27;DualKing&#x27;, 17, 2  # ç‹ç‚¸æ˜¯æœ€å¤§çš„ç‰Œå‹        # è·å–ç‰Œçš„ç‚¹æ•°åˆ†å¸ƒ        value_counts = &#123;&#125;        for value in card_values:            value_counts[value] = value_counts.get(value, 0) + 1        unique_values = sorted(value_counts.keys())        counts = sorted(value_counts.values(), reverse=True)        card_count = len(cards)        # åˆ†æç‰Œå‹        if card_count == 1:            # å•å¼             return &#x27;Single&#x27;, card_values[0], 1        elif card_count == 2:            if len(value_counts) == 1:                # å¯¹å­                return &#x27;Dual&#x27;, card_values[0], 2        elif card_count == 3:            if len(value_counts) == 1:                # ä¸‰å¼                 return &#x27;Tri&#x27;, card_values[0], 3        elif card_count == 4:            if len(value_counts) == 1:                # ç‚¸å¼¹                return &#x27;Quad&#x27;, card_values[0], 4            elif len(value_counts) == 2 and 3 in counts:                # ä¸‰å¸¦ä¸€                tri_value = [v for v, c in value_counts.items() if c == 3][0]                return &#x27;3+1&#x27;, tri_value, 4        elif card_count == 5:            if len(value_counts) == 2 and 3 in counts:                # ä¸‰å¸¦äºŒ                tri_value = [v for v, c in value_counts.items() if c == 3][0]                return &#x27;3+2&#x27;, tri_value, 5            elif len(value_counts) == 5:                # é¡ºå­ï¼ˆ5å¼ ï¼‰                if unique_values[-1] - unique_values[0] == 4 and len(unique_values) == 5:                    return &#x27;Sequ&#x27;, unique_values[0], 5        elif card_count &gt;= 5 and len(value_counts) == card_count:            # æ£€æŸ¥æ˜¯å¦ä¸ºé¡ºå­ï¼ˆæ‰€æœ‰ç‰Œç‚¹æ•°è¿ç»­ï¼Œä¸”æ— é‡å¤ï¼‰            if unique_values[-1] - unique_values[0] == card_count - 1:                # è¿˜éœ€è¦æ£€æŸ¥ä¸èƒ½åŒ…å«2ï¼ˆé™¤éæ˜¯æœ€åä¸€å¼ ï¼‰                if 15 not in unique_values or unique_values[-1] == 15:                    return &#x27;Sequ&#x27;, unique_values[0], card_count        elif card_count % 2 == 0 and card_count &gt;= 6:            # åŒé¡ºå­æ£€æŸ¥            if self._is_double_sequence(value_counts):                return &#x27;doubleSequ&#x27;, unique_values[0], card_count        elif card_count % 3 == 0 and card_count &gt;= 6:            # ä¸‰é¡ºå­æ£€æŸ¥            if self._is_triple_sequence(value_counts):                return &#x27;triSequ&#x27;, unique_values[0], card_count        # å…¶ä»–ç‰Œå‹        return None, 0, 0    def _is_double_sequence(self, value_counts):        &quot;&quot;&quot;æ£€æŸ¥æ˜¯å¦ä¸ºåŒé¡ºå­&quot;&quot;&quot;        # æ¯ä¸ªç‚¹æ•°éƒ½å¿…é¡»å‡ºç°2æ¬¡ï¼Œä¸”ç‚¹æ•°è¿ç»­        values = sorted(value_counts.keys())        counts = [value_counts[v] for v in values]        # æ£€æŸ¥æ¯ä¸ªç‚¹æ•°æ˜¯å¦éƒ½å‡ºç°2æ¬¡        if not all(c == 2 for c in counts):            return False        # æ£€æŸ¥ç‚¹æ•°æ˜¯å¦è¿ç»­ï¼ˆä¸èƒ½åŒ…å«2ï¼‰        if 15 in values:            return False        # æ£€æŸ¥æ˜¯å¦è¿ç»­        for i in range(1, len(values)):            if values[i] - values[i - 1] != 1:                return False        return True    def _is_triple_sequence(self, value_counts):        &quot;&quot;&quot;æ£€æŸ¥æ˜¯å¦ä¸ºä¸‰é¡ºå­&quot;&quot;&quot;        # æ¯ä¸ªç‚¹æ•°éƒ½å¿…é¡»å‡ºç°3æ¬¡ï¼Œä¸”ç‚¹æ•°è¿ç»­        values = sorted(value_counts.keys())        counts = [value_counts[v] for v in values]        # æ£€æŸ¥æ¯ä¸ªç‚¹æ•°æ˜¯å¦éƒ½å‡ºç°3æ¬¡        if not all(c == 3 for c in counts):            return False        # æ£€æŸ¥ç‚¹æ•°æ˜¯å¦è¿ç»­ï¼ˆä¸èƒ½åŒ…å«2ï¼‰        if 15 in values:            return False        # æ£€æŸ¥æ˜¯å¦è¿ç»­        for i in range(1, len(values)):            if values[i] - values[i - 1] != 1:                return False        return True    def is_valid_play(self, selected_cards, required_type, required_value, required_count):        &quot;&quot;&quot;éªŒè¯å‡ºç‰Œæ˜¯å¦ç¬¦åˆè§„åˆ™&quot;&quot;&quot;        if not selected_cards:            return False, &quot;æ²¡æœ‰é€‰æ‹©ç‰Œ&quot;        # åˆ†æå½“å‰å‡ºç‰Œçš„ç‰Œå‹        card_type, card_value, card_count = self.parse_cards_type(selected_cards)        if card_type is None:            return False, &quot;æ— æ•ˆçš„ç‰Œå‹&quot;        # å¦‚æœæ˜¯è·³è¿‡ï¼Œç›´æ¥è¿”å›True        if card_type == &#x27;Jump&#x27;:            return True, &quot;&quot;        # å¦‚æœæ˜¯åˆå§‹å‡ºç‰Œï¼ˆrequired_typeä¸º&#x27;init&#x27;ï¼‰ï¼Œåˆ™ä¸éœ€è¦åŒ¹é…ç‰Œå‹        if required_type == &#x27;init&#x27;:            return True, &quot;&quot;        # æ£€æŸ¥ç‰Œæ•°æ˜¯å¦åŒ¹é…        if required_count &gt; 0 and card_count != required_count and card_type not in [&#x27;Quad&#x27;, &#x27;DualKing&#x27;]:            return False, f&quot;ç‰Œæ•°ä¸åŒ¹é…ï¼Œéœ€è¦&#123;required_count&#125;å¼ &quot;        # ç‰¹æ®Šç‰Œå‹å¯ä»¥ç›´æ¥å‹åˆ¶ä»»ä½•éç‰¹æ®Šç‰Œå‹        if card_type == &#x27;Quad&#x27;:  # ç‚¸å¼¹å¯ä»¥å‹åˆ¶éç‚¸å¼¹            return True, &quot;&quot;        elif card_type == &#x27;DualKing&#x27;:  # ç‹ç‚¸æ˜¯æœ€å¤§çš„            return True, &quot;&quot;        # å¦‚æœä¸Šå®¶æ˜¯ç‰¹æ®Šç‰Œå‹ï¼Œå½“å‰ç‰Œå¿…é¡»ä¹Ÿæ˜¯ç‰¹æ®Šç‰Œå‹ä¸”èƒ½å‹åˆ¶        if required_type == &#x27;Quad&#x27; and card_type != &#x27;Quad&#x27; and card_type != &#x27;DualKing&#x27;:            return False, &quot;åªèƒ½ç”¨ç‚¸å¼¹æˆ–ç‹ç‚¸å‹åˆ¶ç‚¸å¼¹&quot;        elif required_type == &#x27;DualKing&#x27;:            return False, &quot;ç‹ç‚¸æ— æ³•è¢«å‹åˆ¶&quot;        # æ£€æŸ¥ç‰Œå‹æ˜¯å¦åŒ¹é…        if card_type != required_type:            return False, f&quot;ç‰Œå‹ä¸åŒ¹é…ï¼Œéœ€è¦&#123;required_type&#125;&quot;        # æ£€æŸ¥ç‰ŒåŠ›æ˜¯å¦è¶³å¤Ÿå¤§        if required_value &gt; 0 and card_value &lt;= required_value:            return False, f&quot;ç‰ŒåŠ›ä¸å¤Ÿå¤§ï¼Œéœ€è¦å¤§äº&#123;required_value&#125;&quot;        return True, &quot;&quot;    def create_widgets(self):        &quot;&quot;&quot;åˆ›å»ºGUIç•Œé¢&quot;&quot;&quot;        # é¡¶éƒ¨ä¿¡æ¯æ         self.info_frame = ttk.Frame(self.root)        self.info_frame.pack(fill=tk.X, padx=10, pady=5)        self.info_label = ttk.Label(self.info_frame, text=&quot;æ¬¢è¿æ¥åˆ°æ–—åœ°ä¸»æ¸¸æˆï¼&quot;)        self.info_label.pack(side=tk.LEFT)        # ç©å®¶ä¿¡æ¯æ ‡ç­¾        self.player_info_label = ttk.Label(self.info_frame, text=&quot;ç©å®¶ID: 0&quot;)        self.player_info_label.pack(side=tk.LEFT, padx=10)        # å½“å‰ç©å®¶æ ‡ç­¾        self.current_player_label = ttk.Label(self.info_frame, text=&quot;å½“å‰ç©å®¶: 0&quot;)        self.current_player_label.pack(side=tk.LEFT, padx=10)        # åœ°ä¸»æ ‡è¯†æ ‡ç­¾        self.landlord_label = ttk.Label(self.info_frame, text=&quot;åœ°ä¸»: æœªç¡®å®š&quot;)        self.landlord_label.pack(side=tk.LEFT, padx=10)        # è¿æ¥æŒ‰é’®        self.connect_button = ttk.Button(self.info_frame, text=&quot;è¿æ¥æœåŠ¡å™¨&quot;, command=self.connect_to_server)        self.connect_button.pack(side=tk.RIGHT)        # ä¸­é—´æ¸¸æˆåŒºåŸŸ        self.game_frame = ttk.Frame(self.root)        self.game_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)        # æ‰‹ç‰Œæ˜¾ç¤ºåŒºåŸŸ        self.hand_frame = ttk.LabelFrame(self.game_frame, text=&quot;æˆ‘çš„æ‰‹ç‰Œ&quot;)        self.hand_frame.pack(fill=tk.BOTH, expand=True, pady=5)        # æ‰‹ç‰Œç”»å¸ƒå’Œæ»šåŠ¨æ¡        self.hand_canvas = tk.Canvas(self.hand_frame, height=150)        self.hand_scrollbar = ttk.Scrollbar(self.hand_frame, orient=&quot;horizontal&quot;, command=self.hand_canvas.xview)        self.hand_scrollable_frame = ttk.Frame(self.hand_canvas)        self.hand_scrollable_frame.bind(            &quot;&lt;Configure&gt;&quot;,            lambda e: self.hand_canvas.configure(                scrollregion=self.hand_canvas.bbox(&quot;all&quot;)            )        )        self.hand_canvas.create_window((0, 0), window=self.hand_scrollable_frame, anchor=&quot;nw&quot;)        self.hand_canvas.configure(xscrollcommand=self.hand_scrollbar.set)        self.hand_canvas.pack(side=&quot;top&quot;, fill=&quot;both&quot;, expand=True)        self.hand_scrollbar.pack(side=&quot;bottom&quot;, fill=&quot;x&quot;)        # å‡ºç‰Œä¿¡æ¯åŒºåŸŸ        self.play_info_frame = ttk.Frame(self.game_frame)        self.play_info_frame.pack(fill=tk.X, pady=5)        self.current_type_label = ttk.Label(self.play_info_frame, text=&quot;å½“å‰ç‰Œå‹: æ— &quot;)        self.current_type_label.pack(side=tk.LEFT)        self.current_cards_label = ttk.Label(self.play_info_frame, text=&quot;å½“å‰å‡ºç‰Œ: æ— &quot;)        self.current_cards_label.pack(side=tk.RIGHT)        # æ“ä½œæŒ‰é’®åŒºåŸŸ        self.button_frame = ttk.Frame(self.root)        self.button_frame.pack(fill=tk.X, padx=10, pady=5)        self.play_button = ttk.Button(self.button_frame, text=&quot;å‡ºç‰Œ&quot;, command=self.play_cards, state=tk.DISABLED)        self.play_button.pack(side=tk.LEFT, padx=5)        self.pass_button = ttk.Button(self.button_frame, text=&quot;ä¸å‡º&quot;, command=self.pass_turn, state=tk.DISABLED)        self.pass_button.pack(side=tk.LEFT, padx=5)        self.show_hand_button = ttk.Button(self.button_frame, text=&quot;åˆ·æ–°æ‰‹ç‰Œ&quot;, command=self.show_hand)        self.show_hand_button.pack(side=tk.LEFT, padx=5)        # æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ        self.message_frame = ttk.LabelFrame(self.root, text=&quot;æ¸¸æˆæ¶ˆæ¯&quot;)        self.message_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)        self.message_text = tk.Text(self.message_frame, height=8)        self.message_scrollbar = ttk.Scrollbar(self.message_frame, orient=&quot;vertical&quot;, command=self.message_text.yview)        self.message_text.configure(yscrollcommand=self.message_scrollbar.set)        self.message_text.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)        self.message_scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;)        # åº•éƒ¨çŠ¶æ€æ         self.status_frame = ttk.Frame(self.root)        self.status_frame.pack(fill=tk.X, padx=10, pady=5)        self.status_label = ttk.Label(self.status_frame, text=&quot;æœªè¿æ¥&quot;)        self.status_label.pack()    def connect_to_server(self):        &quot;&quot;&quot;è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨&quot;&quot;&quot;        try:            if not self.connected:                self.s = socket.socket()                # host = &#x27;1.1.1.1&#x27;                host = socket.gethostname()                port = 12345                self.s.connect((host, port))                self.connected = True                self.connect_button.config(text=&quot;æ–­å¼€è¿æ¥&quot;)                self.add_message(&quot;æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨&quot;)                self.status_label.config(text=&quot;å·²è¿æ¥&quot;)                # å¯åŠ¨æ¥æ”¶æ¶ˆæ¯çº¿ç¨‹                self.receive_thread = threading.Thread(target=self.receive_messages, daemon=True)                self.receive_thread.start()            else:                # æ–­å¼€è¿æ¥                self.connected = False                if self.s:                    self.s.close()                self.connect_button.config(text=&quot;è¿æ¥æœåŠ¡å™¨&quot;)                self.add_message(&quot;å·²æ–­å¼€æœåŠ¡å™¨è¿æ¥&quot;)                self.status_label.config(text=&quot;æœªè¿æ¥&quot;)        except Exception as e:            messagebox.showerror(&quot;è¿æ¥é”™è¯¯&quot;, f&quot;æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: &#123;str(e)&#125;&quot;)    def receive_messages(self):        &quot;&quot;&quot;æ¥æ”¶æœåŠ¡å™¨æ¶ˆæ¯çš„çº¿ç¨‹å‡½æ•°&quot;&quot;&quot;        while self.connected:            try:                receive = self.s.recv(1024)                if len(receive.strip()) == 0:                    continue                else:                    self.root.after(0, self.json_parse, receive)            except Exception as e:                if self.connected:                    self.root.after(0, self.handle_receive_error, str(e))                break    def handle_receive_error(self, error):        &quot;&quot;&quot;å¤„ç†æ¥æ”¶æ¶ˆæ¯é”™è¯¯&quot;&quot;&quot;        self.add_message(f&quot;æ¥æ”¶æ¶ˆæ¯é”™è¯¯: &#123;error&#125;&quot;)        self.connected = False        self.connect_button.config(text=&quot;è¿æ¥æœåŠ¡å™¨&quot;)        self.status_label.config(text=&quot;è¿æ¥å·²æ–­å¼€&quot;)    def json_parse(self, js):        &quot;&quot;&quot;è§£ææœåŠ¡å™¨æ¶ˆæ¯&quot;&quot;&quot;        try:            recjs = eval(js)            if recjs[&#x27;Operation&#x27;] == &#x27;message&#x27;:                self.add_message(recjs[&#x27;message&#x27;])            elif recjs[&#x27;Operation&#x27;] == &#x27;init&#x27;:                self.CARD = recjs[&#x27;message&#x27;]                self.show_hand()                self.add_message(&quot;æ¸¸æˆå¼€å§‹ï¼Œæ‰‹ç‰Œå·²å‘æ”¾&quot;)            elif recjs[&#x27;Operation&#x27;] == &#x27;AskS&#x27;:                self.ask_king()            elif recjs[&#x27;Operation&#x27;] == &#x27;Add&#x27;:                self.Card_num = 20                EX_CARD = [0 for x in range(3)]                for i in range(0, 3):                    EX_CARD[i] = recjs[&#x27;message&#x27;][i]                    # å°†åº•ç‰Œæ·»åŠ åˆ°æ‰‹ç‰Œä¸­                    self.CARD.append(recjs[&#x27;message&#x27;][i])                self.add_message(f&quot;ä½ è·å¾—äº†åº•ç‰Œ: &#123;&#x27;, &#x27;.join(filter(None, (list(map(self.map_card, EX_CARD)))))&#125;&quot;)                self.show_hand()                # æ›´æ–°åœ°ä¸»æ ‡è¯†                self.landlord = self.player_id                self.landlord_label.config(text=f&quot;åœ°ä¸»: &#123;self.landlord&#125;&quot;)                if self.landlord == self.player_id:                    self.info_label.config(text=&quot;ä½ æ˜¯åœ°ä¸»ï¼&quot;)            elif recjs[&#x27;Operation&#x27;] == &#x27;SetTurn&#x27;:                # ä¿å­˜å½“å‰ç‰Œå‹è¦æ±‚                self.required_type = recjs.get(&#x27;type&#x27;, &#x27;init&#x27;)                self.required_value = recjs.get(&#x27;value&#x27;, 0)                self.required_count = recjs.get(&#x27;seq_num&#x27;, 0)                # æ›´æ–°å½“å‰ç©å®¶ä¿¡æ¯                self.current_player = recjs.get(&#x27;player&#x27;, 0)  # å‡è®¾æœåŠ¡å™¨ä¼šå‘é€playerå­—æ®µ                self.current_player_label.config(text=f&quot;å½“å‰ç©å®¶: &#123;self.current_player&#125;&quot;)                # å¯ç”¨å‡ºç‰ŒæŒ‰é’®                self.play_button.config(state=tk.NORMAL)                self.pass_button.config(state=tk.NORMAL)                self.add_message(&quot;è½®åˆ°ä½ å‡ºç‰Œäº†&quot;)                if self.required_type != &#x27;init&#x27;:                    self.current_type_label.config(                        text=f&quot;å½“å‰ç‰Œå‹: &#123;self.required_type&#125; (éœ€è¦å¤§äº&#123;self.required_value&#125;)&quot;)                else:                    self.current_type_label.config(text=&quot;å½“å‰ç‰Œå‹: æ— é™åˆ¶&quot;)            elif recjs[&#x27;Operation&#x27;] == &#x27;Announce&#x27;:                if recjs[&#x27;message&#x27;] == []:                    self.add_message(&#x27;ä¸Šå®¶é€‰æ‹©è·³è¿‡&#x27;)                else:                    played_cards = list(filter(None, (list(map(self.map_card, sorted(recjs[&#x27;message&#x27;]))))))                    self.add_message(f&quot;ä¸Šå®¶æ‰“å‡ºäº†: &#123;&#x27;, &#x27;.join(played_cards)&#125;&quot;)            elif recjs[&#x27;Operation&#x27;] == &#x27;GameOver&#x27;:                winner = recjs.get(&#x27;winner&#x27;, &#x27;æœªçŸ¥&#x27;)                role = recjs.get(&#x27;role&#x27;, &#x27;æœªçŸ¥&#x27;)                if winner == self.player_id:                    messagebox.showinfo(&quot;æ¸¸æˆç»“æŸ&quot;, f&quot;æ­å–œä½ èµ¢äº†ï¼ä½ çš„è§’è‰²æ˜¯&#123;role&#125;&quot;)                else:                    messagebox.showinfo(&quot;æ¸¸æˆç»“æŸ&quot;, f&quot;æ¸¸æˆç»“æŸï¼è·èƒœæ–¹æ˜¯ç©å®¶&#123;winner&#125;ï¼Œè§’è‰²æ˜¯&#123;role&#125;&quot;)                self.game_over = True                self.play_button.config(state=tk.DISABLED)                self.pass_button.config(state=tk.DISABLED)                self.add_message(f&quot;æ¸¸æˆç»“æŸï¼è·èƒœæ–¹æ˜¯ç©å®¶&#123;winner&#125;ï¼Œè§’è‰²æ˜¯&#123;role&#125;&quot;)            else:                self.add_message(&#x27;æœªçŸ¥æ¶ˆæ¯ç±»å‹&#x27;)        except Exception as e:            self.add_message(f&quot;æ¶ˆæ¯è§£æé”™è¯¯: &#123;str(e)&#125;&quot;)    def show_hand(self):        &quot;&quot;&quot;æ˜¾ç¤ºæ‰‹ç‰Œ&quot;&quot;&quot;        # æ¸…ç©ºå½“å‰æ‰‹ç‰Œæ˜¾ç¤º        for widget in self.hand_scrollable_frame.winfo_children():            widget.destroy()        # æ˜¾ç¤ºæ‰‹ç‰Œ        self.selected_cards = []  # æ¸…ç©ºé€‰ä¸­çŠ¶æ€        sorted_cards = self.sort_cards_for_display(self.CARD)        filtered_cards = list(filter(None, sorted_cards))  # è¿‡æ»¤æ‰0        for i, card_num in enumerate(filtered_cards):            card_text, card_color = self.get_card_display_info(card_num)            if card_text:                # åˆ›å»ºç‰ŒæŒ‰é’®                card_button = tk.Button(                    self.hand_scrollable_frame,                    text=card_text,                    width=12,                    height=4,                    fg=card_color,  # è®¾ç½®æ–‡å­—é¢œè‰²                    font=(&#x27;Arial&#x27;, 8),                    command=lambda idx=i, num=card_num: self.toggle_card_selection(idx, num, card_button)                )                card_button.pack(side=tk.LEFT, padx=2, pady=5)    def toggle_card_selection(self, idx, card_num, button):        &quot;&quot;&quot;åˆ‡æ¢ç‰Œçš„é€‰ä¸­çŠ¶æ€&quot;&quot;&quot;        if card_num in self.selected_cards:            self.selected_cards.remove(card_num)            button.config(relief=tk.RAISED, bg=&quot;lightgray&quot;)        else:            self.selected_cards.append(card_num)            button.config(relief=tk.SUNKEN, bg=&quot;yellow&quot;)        # æ›´æ–°å½“å‰é€‰ä¸­ç‰Œæ˜¾ç¤º        selected_names = list(filter(None, (list(map(self.map_card, sorted(self.selected_cards))))))        self.current_cards_label.config(text=f&quot;é€‰ä¸­çš„ç‰Œ: &#123;&#x27;, &#x27;.join(selected_names) if selected_names else &#x27;æ— &#x27;&#125;&quot;)    def play_cards(self):        &quot;&quot;&quot;å‡ºç‰Œ&quot;&quot;&quot;        if not self.selected_cards:            messagebox.showwarning(&quot;å‡ºç‰Œé”™è¯¯&quot;, &quot;è¯·å…ˆé€‰æ‹©è¦å‡ºçš„ç‰Œ&quot;)            return        # éªŒè¯å‡ºç‰Œæ˜¯å¦ç¬¦åˆè§„åˆ™        is_valid, message = self.is_valid_play(            self.selected_cards,            self.required_type,            self.required_value,            self.required_count        )        if not is_valid:            messagebox.showwarning(&quot;å‡ºç‰Œé”™è¯¯&quot;, message)            return        # åˆ†æå½“å‰å‡ºç‰Œçš„ç‰Œå‹        card_type, card_value, card_count = self.parse_cards_type(self.selected_cards)        # æ„é€ JSONæ¶ˆæ¯        json_data = &#123;            &#x27;Status&#x27;: 200,            &#x27;Operation&#x27;: &#x27;AnsTurn&#x27;,            &#x27;type&#x27;: card_type,            &#x27;seq_num&#x27;: card_count,  # å¯¹äºé¡ºå­ç­‰ç‰Œå‹ï¼Œè¿™ä¸ªè¡¨ç¤ºç‰Œçš„æ•°é‡            &#x27;message&#x27;: self.selected_cards,            &#x27;value&#x27;: card_value        &#125;        try:            self.s.sendall(str.encode(str(json_data)))            # ä»æ‰‹ç‰Œä¸­ç§»é™¤å·²å‡ºçš„ç‰Œ            for card in self.selected_cards:                if card in self.CARD:                    self.CARD.remove(card)            self.Card_num -= len(self.selected_cards)            # æ£€æŸ¥æ˜¯å¦å‡ºå®Œæ‰€æœ‰ç‰Œ            if self.Card_num == 0:                self.game_over = True                self.add_message(&quot;æ­å–œä½ å‡ºå®Œæ‰€æœ‰ç‰Œï¼&quot;)                # ç¦ç”¨æŒ‰é’®                self.play_button.config(state=tk.DISABLED)                self.pass_button.config(state=tk.DISABLED)            self.selected_cards = []            self.show_hand()            self.current_cards_label.config(text=&quot;é€‰ä¸­çš„ç‰Œ: æ— &quot;)            self.play_button.config(state=tk.DISABLED)            self.pass_button.config(state=tk.DISABLED)        except Exception as e:            messagebox.showerror(&quot;å‡ºç‰Œé”™è¯¯&quot;, f&quot;å‡ºç‰Œå¤±è´¥: &#123;str(e)&#125;&quot;)    def pass_turn(self):        &quot;&quot;&quot;è·³è¿‡å‡ºç‰Œ&quot;&quot;&quot;        json_data = &#123;            &#x27;Status&#x27;: 200,            &#x27;Operation&#x27;: &#x27;AnsTurn&#x27;,            &#x27;type&#x27;: &#x27;Jump&#x27;,            &#x27;seq_num&#x27;: 0,            &#x27;message&#x27;: [],            &#x27;value&#x27;: 0        &#125;        try:            self.s.sendall(str.encode(str(json_data)))            self.selected_cards = []            self.current_cards_label.config(text=&quot;é€‰ä¸­çš„ç‰Œ: æ— &quot;)            self.play_button.config(state=tk.DISABLED)            self.pass_button.config(state=tk.DISABLED)        except Exception as e:            messagebox.showerror(&quot;æ“ä½œé”™è¯¯&quot;, f&quot;è·³è¿‡å‡ºç‰Œå¤±è´¥: &#123;str(e)&#125;&quot;)    def ask_king(self):        &quot;&quot;&quot;è¯¢é—®æ˜¯å¦æŠ¢åœ°ä¸»&quot;&quot;&quot;        result = messagebox.askyesno(&quot;æŠ¢åœ°ä¸»&quot;, &quot;æ˜¯å¦æŠ¢åœ°ä¸»?&quot;)        json_data = &#123;            &#x27;Status&#x27;: 200,            &#x27;Operation&#x27;: &#x27;AnsS&#x27;,            &#x27;message&#x27;: 1 if result else 0        &#125;        try:            self.s.sendall(str.encode(str(json_data)))        except Exception as e:            messagebox.showerror(&quot;æ“ä½œé”™è¯¯&quot;, f&quot;æŠ¢åœ°ä¸»é€‰æ‹©å‘é€å¤±è´¥: &#123;str(e)&#125;&quot;)    def add_message(self, message):        &quot;&quot;&quot;æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯æ¡†&quot;&quot;&quot;        self.message_text.insert(tk.END, f&quot;[&#123;time.strftime(&#x27;%H:%M:%S&#x27;)&#125;] &#123;message&#125;\\n&quot;)        self.message_text.see(tk.END)def main():    root = tk.Tk()    app = DouDiZhuGUI(root)    root.mainloop()if __name__ == &quot;__main__&quot;:    main()\n","categories":["python"]},{"title":"éƒ¨ç½²æœ¬åœ°å¤§æ¨¡å‹","url":"/2025/05/12/%E9%83%A8%E7%BD%B2%E6%9C%AC%E5%9C%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B/","content":"æ¨¡å‹æ¡†æ¶\n\nä¼ä¸šçº§æœåŠ¡ï¼ŒSGLang æ˜¯ä¸äºŒä¹‹é€‰ï¼šå‡­å€Ÿå“è¶Šçš„æ€§èƒ½ï¼Œå…¶ååé‡å’Œç»“æ„åŒ–è¾“å‡ºèƒ½åŠ›å ªç§°è¡Œä¸šç¿˜æ¥šï¼Œä¸ºä¼ä¸šçº§åº”ç”¨ç­‘ç‰¢æ ¹åŸºã€‚https://docs.sglang.ai/start/install.htmlhttps://github.com/sgl-project/sglang\nåœ¨çº¿é«˜å¹¶å‘åœºæ™¯ï¼ŒVLLM ç‹¬å é³Œå¤´ï¼šå‡­å€ŸåŠ¨æ€æ‰¹å¤„ç†å’Œå…ˆè¿›çš„å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œç¡®ä¿æœåŠ¡åœ¨é«˜å¹¶å‘å‹åŠ›ä¸‹ä¾ç„¶ç¨³å®šé«˜æ•ˆï¼Œä¿éšœä¸šåŠ¡æµç•…è¿è¡Œã€‚https://docs.vllm.com.cn/en/latest/getting_started/installation/gpu.htmlhttps://github.com/vllm-project/vllm\nä¸ªäººå¼€å‘é¢†åŸŸï¼ŒOllama å´­éœ²å¤´è§’ï¼šç®€å•æ˜“ç”¨ï¼Œè·¨å¹³å°æ”¯æŒæ­é…ä¸°å¯Œçš„æ¨¡å‹åº“ï¼Œè®©åˆ›æ„çµæ„Ÿç¬é—´è§¦æ‰‹å¯åŠï¼ŒåŠ©åŠ›ä¸ªäººå¼€å‘è€…å¿«é€Ÿå®ç°æƒ³æ³•ã€‚https://github.com/ollama/ollama?tab=readme-ov-file\n\n\nLLM webui\n\nDifyï¼šé€‚åˆä¼ä¸šå¼€å‘å¤æ‚ AI åº”ç”¨ï¼Œå¦‚æ™ºèƒ½å®¢æœã€åˆåŒå¤„ç†ç³»ç»Ÿç­‰ï¼Œæ”¯æŒå¤šæ¨¡å‹åä½œå’Œä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–ã€‚https://dify.ai/zhhttps://github.com/langgenius/dify/blob/main/README_CN.md\nOpen-WebUIï¼šé€‚åˆä¸ªäººå¼€å‘è€…å¿«é€Ÿæµ‹è¯•æœ¬åœ°æ¨¡å‹ï¼ˆå¦‚ Ollama éƒ¨ç½²çš„ Llama3ï¼‰ï¼Œæˆ–ä½œä¸º ChatGPT æ›¿ä»£å“è¿›è¡Œæ—¥å¸¸äº¤äº’ã€‚https://docs.openwebui.com/\nChatboxï¼šé¢å‘éæŠ€æœ¯ç”¨æˆ·ï¼Œæä¾›æ— éœ€ä»£ç çš„å¯¹è¯ç•Œé¢ï¼Œæ”¯æŒå¿«é€Ÿä½“éªŒå¤šæ¨¡å‹ï¼ˆå¦‚ GPTã€Claudeï¼‰çš„èŠå¤©èƒ½åŠ›ã€‚https://chatboxai.app/zhhttps://github.com/chatboxai/chatbox\n\n\néƒ¨ç½²\nç”±äºvllmå’Œsglangéœ€è¦èµ„æºè¾ƒå¤šï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨ollama + openwebui + deepseek\nå‰ææ¡ä»¶æœåŠ¡å™¨å·²ç»é…ç½®äº†é©±åŠ¨å’Œcuda nvidia-smiï¼ˆé©±åŠ¨å‘½ä»¤ï¼‰nvccï¼ˆcudaå‘½ä»¤ï¼‰\nhttps://www.nvidia.cn/drivers/lookup/ æ˜¾å¡ä¸‹è½½runè„šæœ¬è¿è¡Œ\nhttps://developer.nvidia.com/cuda-toolkit-archive cudaä¸‹è½½\n\nå®‰è£…ollama#https://github.com/ollama/ollama/tree/main/docs#OLLAMA_MODELS æ¨¡å‹ä¸‹è½½ä½ç½®é»˜è®¤/usr/share/ollama/.ollama/models#OLLAMA_HOST ç›‘æ§åœ°å€é»˜è®¤127.0.0.1curl -fsSL https://ollama.com/install.sh | shsed -i &#x27;/^Environment=&quot;PATH=/a Environment=&quot;OLLAMA_HOST=0.0.0.0&quot;&#x27; /etc/systemd/system/ollama.servicesystemctl daemon-reloadsystemctl restart ollama.serviceollama run deepseek-r1\nå®‰è£…dockerå’Œnvidia-container-toolkit#æ·»åŠ Dockerè½¯ä»¶åŒ…æº#æ·»åŠ Dockerè½¯ä»¶åŒ…æºsudo wget -O /etc/yum.repos.d/docker-ce.repo http://mirrors.cloud.aliyuncs.com/docker-ce/linux/centos/docker-ce.reposudo sed -i &#x27;s|https://mirrors.aliyun.com|http://mirrors.cloud.aliyuncs.com|g&#x27; /etc/yum.repos.d/docker-ce.repo#å®‰è£…Dockerç¤¾åŒºç‰ˆæœ¬ï¼Œå®¹å™¨è¿è¡Œæ—¶containerd.ioï¼Œä»¥åŠDockeræ„å»ºå’ŒComposeæ’ä»¶sudo yum -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin#å¯åŠ¨Dockersudo systemctl start docker#è®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨sudo systemctl enable docker#é…ç½®ç”Ÿäº§å­˜å‚¨åº“curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo#å®‰è£… NVIDIA Container Toolkit è½¯ä»¶åŒ…sudo yum install -y nvidia-container-toolkit#é‡å¯dockersudo systemctl restart docker\nå®‰è£…webui#å¯ä»¥é€šè¿‡-e OLLAMA_BASE_URL é…ç½®ollamaåœ°å€,è¿›å…¥webç•Œé¢ä¹Ÿå¯ä»¥é…ç½®,é•œåƒå·®ä¸å¤š9G,åœ¨å›½å¤–éœ€è¦é…ç½®åŠ é€Ÿæºdocker run -d -p 3000:8080 --gpus all -v open-webui:/app/backend/data --name open-webui ghcr.io/open-webui/open-webui:cuda\n\né¢å¤–\ndifyåŠŸèƒ½æ¯”Open-WebUIæ›´å¼ºå¤§ï¼Œæ”¯æŒagentå’Œå·¥ä½œæµå’Œå¾ˆå¤šæ’ä»¶ï¼Œå¦‚æœä¸æƒ³åªå•ç‹¬é€šè¿‡webuiæ¥äº¤äº’å»ºè®®ä½¿ç”¨difycurl -SL https://github.com/docker/compose/releases/download/v2.30.3/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose#å°†å¯æ‰§è¡Œæƒé™èµ‹äºˆå®‰è£…ç›®æ ‡è·¯å¾„ä¸­çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶sudo chmod +x /usr/local/bin/docker-composesudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-composegit clone https://github.com/langgenius/dify.gitcd difycd dockercp .env.example .envdocker compose up -d\n\n","tags":["llm"]}]